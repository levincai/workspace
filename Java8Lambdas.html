<!--if IE]><![endif]-->
<!DOCTYPE html>
<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/cover.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="cover.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->
<html class="js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__learning_oreilly_com fa-events-icons-ready" data-account-type="B2B" data-activated-trial-date="11/06/2017" data-archive="9781449370831" data-csrf-cookie="csrfsafari" data-debug="0" data-epub-title="Java 8 Lambdas" data-highlight-privacy="" data-htmlfile-name="cover.html" data-login-url="/accounts/login/" data-offline-url="/" data-publishers="O&apos;Reilly Media, Inc." data-testing="0" data-url="/library/view/java-8-lambdas/9781449370831/cover.html" data-user-id="3866890" data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca" data-username="levinxccai" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" style="">
<!--![endif]-->

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <link href="cid:css-f399f367-9ba5-4ca9-abd7-59ea322380f2@mhtml.blink" rel="stylesheet" type="text/css"/>
    <link href="cid:css-29308a37-e2ce-44ea-8934-68e6e2de1e5c@mhtml.blink" rel="stylesheet" type="text/css"/>
    <link href="cid:css-d3bea876-e371-40fe-8cd4-0d26dd74269d@mhtml.blink" rel="stylesheet" type="text/css"/>
    <link href="cid:css-8c7f9a28-5ad0-487b-803d-03826bc7e8bf@mhtml.blink" rel="stylesheet" type="text/css"/>
    <link href="cid:css-e4b3853c-3ea8-4cb3-b4c9-9d0d82e814f0@mhtml.blink" rel="stylesheet" type="text/css"/>
    <link href="cid:css-f2f7179c-7ec5-435d-a8d2-a9aef92aa306@mhtml.blink" rel="stylesheet" type="text/css"/>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="Safari Books Online" name="author"/>
    <meta content="telephone=no" name="format-detection"/>
    <meta content="on" http-equiv="cleartype"/>
    <meta content="True" name="HandheldFriendly"/>
    <meta content="320" name="MobileOptimized"/>
    <meta content="app-id=881697395, app-argument=safaridetail://9781449370831" name="apple-itunes-app"/>
    <meta content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0" name="viewport"/>
    <meta content="4503599627559754" property="twitter:account_id"/>
    <title>Java8Lambdas</title>
    <link href="https://learning.oreilly.com/static/CACHE/css/output.8054605313ed.css" rel="stylesheet" type="text/css"/>
    <link href="https://learning.oreilly.com/static/css/annotator.e3b0c44298fc.css" rel="stylesheet" type="text/css"/>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/cover.html" rel="canonical"/>
    <link href="https://use.fontawesome.com/840a321d95.css" media="all" rel="stylesheet"/>
</head>

<body class="reading sidenav nav-collapsed  scalefonts day-mode library" data-gr-c-s-loaded="true">
<a name="1_"></a>

    <div class="application" id="container" style="height: auto;">
      <div class="js-toc">
        <section role="document">
          <div id="sbo-rt-content" style="transform: none;">
              <div class="annotator-wrapper">
                    <div id="cover-image"><img alt="First Edition" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/cover.png.jpg" height="1000" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/cover.png.jpg" width="761"/></div>
                    <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
            </div>
          </div>
        </section>
      </div>
    </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch01.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch01.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="2_"></a>

   
        <section role="document">
          <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
              <div class="annotator-wrapper">
                    <section class="chapter" epub:type="chapter" id="intro_java_8">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title">Chapter 1. Introduction</h2>
                                </div>
                            </div>
                        </div>
                        <p>Before we begin our exploration of what lambda expressions are and how we canuse them, you should at least understand why they exist to begin with.In this chapter, I’ll cover that and also explain the structure and motivationof
                            this book.</p>
                        <div class="sect1">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title" id="_why_did_they_need_to_change_java_again" style="clear: both">Why Did They Need to Change Java Again?</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="2_id338481"></a>Java 1.0 was released in January 1996, and the world of programming has changedquite a bit since then. Businesses are requiring ever more complexapplications, and most programs are executed
                                on machines with powerfulmulticore CPUs. The rise of Java Virtual Machines (JVM), with efficient runtimecompilers has meant that programmers can focus more on writing clean,maintainable code, rather than on code that’s
                                efficiently using every CPU clockcycle and every byte of memory.</p>
                            <p><a class="indexterm" id="2_id300098"></a>The elephant in the room is the rise of multicore CPUs. Programmingalgorithms involving locks is error-prone and time-consuming. The<a class="indexterm" id="2_id302490"></a><code class="literal">java.util.concurrent</code>                                package and the wealth of external libraries havedeveloped a variety of concurrency abstractions that begin to help programmerswrite code that performs well on multicore CPUs. Unfortunately, we haven’t gonefar enough—until
                                now.</p>
                            <p>There are limits to the level of abstractions that library writerscan use in Java today. A good example of this is the lack of efficientparallel operations over large collections of data. Java 8 allows you to write complex
                                collection-processing algorithms, and simply by changing a singlemethod call you can efficiently execute this code on multicore CPUs. In orderto enable writing of these kinds of bulk data parallel libraries, however, Java
                                needed a new languagechange: lambda expressions.</p>
                            <p>Of course there’s a cost, in that you must learn to write and read lambda-enabled code, but it’s a good trade-off. It’s easier for programmers to learn a small amount of new syntax and a few new idioms than to have to handwrite
                                a large quantity of complex thread-safe code. Good libraries and frameworkshave significantly reduced the cost and time associated with developingenterprise business applications, and any barrier to developing easy-to-use
                                andefficient libraries should be removed.</p>
                            <p>Abstraction is a concept that is familiar to us all from object-oriented programming. The difference is that object-oriented programming is mostly about abstracting over data, while functional programming is mostlyabout abstracting
                                over behavior. The real world has both of these things, andso do our programs, so we can and should learn from both influences.</p>
                            <p>There are other benefits to this new abstraction as well. For many of us whoaren’t writing performance-critical code all the time, these are more importantwins. You can write easier-to-read code—code that spends time expressing
                                theintent of its business logic rather than the mechanics of how it’s achieved.Easier-to-read code is also easier to maintain, more reliable, and lesserror-prone.</p>
                            <p><a class="indexterm" id="2_id361372"></a><a class="indexterm" id="2_id302896"></a>You don’t need to deal with the verbosity and readbility issues surroundinganonymous inner classes when writing callbacks and event handlers. This
                                approach allowsprogrammers to work on event processing systems more easily. Being ableto pass functions around easily also makes it easier to write lazy code that initializes values only when necessary.</p>
                            <p>In addition, the language changes that enable the additional collectionmethods, <code class="literal">default</code> methods, can be used by everyday programmers who aremaintaining their own libraries.</p>
                            <p>It’s not your grandfather’s Java any longer, and that’s a good thing.</p>
                        </div>
                        <div class="sect1">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title" id="_what_is_functional_programming" style="clear: both">What Is Functional Programming?</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="2_id382272"></a><a class="indexterm" id="2_id357260"></a><span class="emphasis"><em>Functional programming</em></span> is a term that means different things to differentpeople. At the heart of functional
                                programming is thinking about your problemdomain in terms of immutable values and functions that translate between them.</p>
                            <p>The communities that have developed around different programming languages each tendto think that the set of features that have been incorporated into theirlanguage are the key ones. At this stage, it’s a bit too early to tell
                                howJava programmers will define functional programming. In a sense, it’sunimportant; what we really care about is writing <span class="emphasis"><em>good</em></span> code rather thanfunctional code.</p>
                            <p>In this book, I focus on pragmatic functional programming, including techniques thatcan be used and understood by most developers and that help them writeprograms that are easier to read and maintain.</p>
                        </div>
                        <div class="sect1">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title" id="example_domain" style="clear: both">Example Domain</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="2_id370267"></a>Throughout the book, examples are structured around a common problem domain:music. Specifically, the examples represent the kind of information you might see onalbums. Here’s a brief summary
                                of the terms:</p>
                            <div class="variablelist">
                                <dl><dt><span class="term"><span class="strong"><strong>Artist</strong></span></span></dt>
                                    <dd>
                                        <p class="simpara">An individual or group who creates music</p>
                                        <div class="itemizedlist">
                                            <ul class="itemizedlist">
                                                <li class="listitem"><span class="emphasis"><em>name</em></span>: The name of the artist (e.g., “The Beatles”)</li>
                                                <li class="listitem"><span class="emphasis"><em>members</em></span>: A set of other artists who comprise this group (e.g., “John Lennon”); this field might be empty</li>
                                                <li class="listitem"><span class="emphasis"><em>origin</em></span>: The primary location of origin of the group (e.g., “Liverpool”).</li>
                                            </ul>
                                        </div>
                                    </dd><dt><span class="term"><span class="strong"><strong>Track</strong></span></span></dt>
                                    <dd>
                                        <p class="simpara">A single piece of music</p>
                                        <div class="itemizedlist">
                                            <ul class="itemizedlist">
                                                <li class="listitem"><span class="emphasis"><em>name</em></span>: The name of the track (e.g., “Yellow Submarine”)</li>
                                            </ul>
                                        </div>
                                    </dd><dt><span class="term"><span class="strong"><strong>Album</strong></span></span></dt>
                                    <dd>
                                        <p class="simpara">A single release of music, comprising several tracks</p>
                                        <div class="itemizedlist">
                                            <ul class="itemizedlist">
                                                <li class="listitem"><span class="emphasis"><em>name</em></span>: The name of the album (e.g., “Revolver”)</li>
                                                <li class="listitem"><span class="emphasis"><em>tracks</em></span>: A list of tracks</li>
                                                <li class="listitem"><span class="emphasis"><em>musicians</em></span>: A list of artists who helped create the music on this album</li>
                                            </ul>
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                            <p>This domain is used to illustrate how to use functional programmingtechniques within a normal business domain or Java application. You may notconsider it the perfect example subject, but it’s simple, and many of the codeexamples
                                in this book will bear similarity to those that you may see in yourbusiness domain.</p>
                        </div>
                    </section>
                    <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
            </div>
          </div>
        </section>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch02.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch02.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="3_"></a>

    <div class="application" id="container" style="height: auto;">
      <div class="js-toc">
        <section role="document">
          <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
              <div class="annotator-wrapper">
                    <section class="chapter" epub:type="chapter" id="lambda_expressions_chp">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title">Chapter 2. Lambda Expressions</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="3_ix_ch02-asciidoc0"></a>The biggest language change in Java 8 is the introduction of lambda expressions—a compact way of passing around behavior. They are also a pretty fundamental building block that the
                            rest of this book depends upon, so let’s get into what they’re all about.</p>
                        <div class="sect1">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title" id="_your_first_lambda_expression" style="clear: both">Your First Lambda Expression</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="3_id321879"></a><a class="indexterm" id="3_id321885"></a><span class="emphasis"><em>Swing</em></span> is a platform-agnostic Java library for writing graphical user interfaces (GUIs). It has a fairly common
                                idiom in which, in order to find out what your user did, you register an <span class="emphasis"><em>event listener</em></span>. The event listener can then perform some action in response to the user input (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#lambda_button_class">Example 2-1</a>).</p>
                            <div class="example"><a id="3_lambda_button_class"></a>
                                <div class="example-title">Example 2-1. Using an anonymous inner class to associate behavior with a button click</div>
                                <div class="example-contents">
                                  <pre style="background:#fff;color:#000">button<span style="color:#00f;font-weight:700">.</span>addActionListener(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ActionListener</span>() {
 <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">actionPerformed</span>(<span style="color:#00f;font-weight:700">ActionEvent</span> <span style="font-style:italic">event</span>) {
  <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">"button clicked"</span>);
 }
});
</pre>
                                </div>
                            </div>
                            <p>In this example, we’re creating a new object that provides an implementationof the <code class="literal">ActionListener</code> class. This interface has a single method,<code class="literal">actionPerformed</code>, which is
                                called by the <code class="literal">button</code> instance when a user actuallyclicks the on-screen button. The<a class="indexterm" id="3_id357520"></a> anonymous inner class provides theimplementation of this method. In
                                <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#lambda_button_class">Example 2-1</a>, all it does is printout a message to say that the button has been clicked.</p>
                            <div class="note">
                                <h3 class="title">Note</h3>
                                <p><a class="indexterm" id="3_id334977"></a>This is actually an example of using <span class="emphasis"><em>code as data</em></span>—we’re giving the buttonan object that represents an action.</p>
                        </div>
                        <p>Anonymous inner classes were designed to make it easier for Java programmers to pass around code as data. Unfortunately, they don’t make it easy enough. There are still four lines of boilerplate code required in order to call the
                            single line of important logic. Look how much gray we get if we color out the boilerplate:</p>
                        <pre style="background:#fff;color:#000">button<span style="color:#00f;font-weight:700">.</span>addActionListener(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ActionListener</span>() {
 <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">actionPerformed</span>(<span style="color:#00f;font-weight:700">ActionEvent</span> <span style="font-style:italic">event</span>) {
  <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">"button clicked"</span>);
 }
});
</pre>
                        <p>Boilerplate isn’t the only issue, though: this code is fairly hard to readbecause it obscures the programmer’s intent. We don’t want to pass in anobject; what we really want to do is pass in some behavior. In Java 8, we wouldwrite
                            this code example as a lambda expression, as shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#lambda_button_lambda">Example 2-2</a>.</p>
                        <div class="example"><a id="3_lambda_button_lambda"></a>
                          <div class="example-title">Example 2-2. Using a lambda expression to associate behavior with a button click</div>
                            <div class="example-contents">
                                <pre class="programlisting"><code class="n">button</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">event</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">button clicked</code><code class="o">));</code></pre>
                            </div>
                        </div>
                        <p>Instead of passing in an object that implements an interface, we’re passing ina block of code—a function without a name. <code class="literal">event</code> is the name of aparameter, the same parameter as in the anonymous inner
                            class example. <code class="literal">-&gt;</code>separates the parameter from the body of the lambda expression, which is justsome code that is run when a user clicks our button.</p>
                        <p>Another difference between this example and the anonymous inner class is how wedeclare the variable <code class="literal">event</code>. Previously, we needed to explicitly provide itstype—<code class="literal">ActionEvent event</code>.
                            In this example, we haven’t provided the type atall, yet this example still compiles. What is happening under the hood isthat <code class="literal">javac</code> is inferring the type of the variable <code class="literal">event</code>                            from its context—here, from the signature of <code class="literal">addActionListener</code>. What this means is that you don’t need to explicitly write out the type when it’s obvious. We’ll cover this inference in more detail
                            soon, but first let’s take a look at the different ways we can write lambda expressions.</p>
                        <div class="note">
                            <h3 class="title">Note</h3>
                            <p>Although lambda method parameters require less boilerplate code than was needed previously,they are still statically typed. For the sake of readability and familiarity, youhave the option to include the type declarations, and
                                sometimes thecompiler just can’t work it out!</p>
                        </div>
                </div>
                <div class="sect1">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h2 class="title" id="_how_to_spot_a_lambda_in_a_haystack" style="clear: both">How to Spot a Lambda in a Haystack</h2>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="3_ix_ch02-asciidoc1"></a>There are a number of variations of the basic format for writinglambda expressions, which are listed in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#all_lambda_forms">Example 2-3</a>.</p>
                    <div class="example"><a id="3_all_lambda_forms"></a>
                        <div class="example-title">Example 2-3. Some different ways of writing lambda expressions</div>
                        <div class="example-contents">
                            
                            
                            
                            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>Runnable noArguments = () -&gt; System.out.println(&quot;Hello World&quot;); <a id="3_CO1-1"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/> 
ActionListener oneArgument = event -&gt; System.out.println(&quot;button clicked&quot;); <a id="3_CO1-2"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>
Runnable multiStatement = () -&gt; { <a id="3_CO1-3"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/>
 System.out.print(&quot;Hello&quot;);System.out.println(&quot; World&quot;);
};
BinaryOperator &lt; Long &gt; add = (x, y) -&gt; x + y; <a id="3_CO1-4"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/>
BinaryOperator &lt; Long &gt; addExplicit = (Long x, Long y) -&gt; x + y; <a id="3_CO1-5"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/>
</code></pre>
                        </div>
                </div>
                <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-1"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>                    shows how it’s possible to have a lambda expression with no arguments atall. You can use an empty pair of parentheses, <code class="literal">()</code>, to signify that there are noarguments. This is a lambda expression implementing
                    <code class="literal">Runnable</code>, whose only method,<code class="literal">run</code>, takes no arguments and is a <code class="literal">void</code> return type.</p>
                <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-2"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>                    we have only one argument to the lambda expression, which lets us leave out theparentheses around the arguments. This is actually the same form that we used in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#lambda_button_lambda">Example 2-2</a>.</p>
                <p>Instead of the body of the lambda expression being just an expression, in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-3"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>it’s
                    a full block of code, bookended by curly braces (<code class="literal">{}</code>). These code blocks followthe usual rules that you would expect from a method. For example, you can returnor throw exceptions to exit them. It’s also
                    possible to use braces with a single-linelambda, for example to clarify where it begins and ends.</p>
                <p>Lambda expressions can also be used to represent methods that take more thanone argument, as in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-4"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></a>.
                    <a class="indexterm" id="3_id400960"></a>At this juncture, it’s worth reflecting onhow to <span class="emphasis"><em>read</em></span> this lambda expression. This line of code doesn’t add up twonumbers; it creates a function that adds
                    together two numbers. The variable called<code class="literal">add</code> that’s a <code class="literal">BinaryOperator&lt;Long&gt;</code> isn’t the result of adding up two numbers;it is code that adds together two numbers.</p>
                <p>So far, all the types for lambda expression parameters have been inferred for usby the compiler. This is great, but it’s sometimes good to have the option ofexplicitly writing the type, and when you do that you need to surround the<a class="indexterm" id="3_id351820"></a>arguments to the lambda expression with parentheses. The parentheses are alsonecessary if you’ve got multiple arguments. This approach is demonstrated in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-5"><img alt="5" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/></a>.</p>
                <div class="note">
                    <h3 class="title">Note</h3>
                    <p><a class="indexterm" id="3_id351811"></a>The <span class="emphasis"><em>target type</em></span> of a lambda expression is the type of the context in which thelambda expression appears—for example, a local variable that it’s assigned
                        to ora method parameter that it gets passed into.</p>
            </div>
            <p>What is implicit in all these examples is that a lambda expression’s type iscontext dependent. It gets inferred by the compiler. This target typing isn’tentirely new, either. As shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#ARRAY_INFERENCE">Example 2-4</a>,
                the types of arrayinitializers in Java have always been inferred from their contexts. Anotherfamiliar example is <code class="literal">null</code>. You can know what the type of <code class="literal">null</code> is only onceyou actually
                assign it to something.<a class="indexterm" id="3_id292920"></a></p>
            <div class="example"><a id="3_ARRAY_INFERENCE"></a>
                <div class="example-title">Example 2-4. The righthand side doesn’t specify its type; it is inferred from the context</div>
                <div class="example-contents">
                    <pre class="programlisting">    <code class="kd">final</code> <code class="n">String</code><code class="o">[]</code> <code class="n">array</code> <code class="o">=</code> <code class="o">{</code> <code class="s">hello</code><code class="o">,</code> <code class="s">world</code> <code class="o">};</code></pre>
                </div>
            </div>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_using_values" style="clear: both">Using Values</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="3_id373217"></a><a class="indexterm" id="3_id373221"></a><a class="indexterm" id="3_id397656"></a><a class="indexterm" id="3_id397664"></a><a class="indexterm" id="3_id354619"></a><a class="indexterm" id="3_id354627"></a>When you’ve
            used anonymous inner classes in the past, you’ve probablyencountered a situation in which you wanted to use a variable from the surroundingmethod. In order to do so, you had to make the variable <code class="literal">final</code>, as demonstratedin
            <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#variable_capture1">Example 2-5</a>. Making a variable <code class="literal">final</code> means that you can’treassign to that variable.
            It also means that whenever you’re using a <code class="literal">final</code>variable, you know you’re using a specific value that has been assigned to thevariable.</p>
        <div class="example"><a id="3_variable_capture1"></a>
            <div class="example-title">Example 2-5. A final local variable being captured by an anonymous inner class</div>
            <div class="example-contents">
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> getUserName();
button<span style="color:#00f;font-weight:700">.</span>addActionListener(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ActionListener</span>() {
 <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">actionPerformed</span>(<span style="color:#00f;font-weight:700">ActionEvent</span> <span style="font-style:italic">event</span>) {
  <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">"hi "</span> <span style="color:#00f;font-weight:700">+</span> name);
 }
});
</pre>
            </div>
        </div>
        <p>This restriction is relaxed a bit in Java 8. It’spossible to refer to variables that aren’t <code class="literal">final</code>; however, they still have tobe <span class="emphasis"><em>effectively</em></span> <code class="literal">final</code>.
            Although you haven’t declared the variable(s) as<code class="literal">final</code>, you still cannot use them as nonfinal variable(s) if they are to beused in lambda expressions. If you do use them as nonfinal variables, then thecompiler will
            show an error.</p>
        <p>The implication of being effectively <code class="literal">final</code> is that you can assign to the variableonly once. Another way to understand this distinction is that lambda expressionscapture <span class="emphasis"><em>values</em></span>,
            not variables. In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#variable_capture2">Example 2-6</a>, <code class="literal">name</code> is aneffectively <code class="literal">final</code>            variable.</p>
        <div class="example"><a id="3_variable_capture2"></a>
            <div class="example-title">Example 2-6. An effectively final variable being captured by an anonymous inner class</div>
            <div class="example-contents">
                <pre class="programlisting"><code class="n">String</code> <code class="n">name</code> <code class="o">=</code> <code class="n">getUserName</code><code class="o">();</code><code class="n">button</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">event</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">hi </code> <code class="o">+</code> <code class="n">name</code><code class="o">));</code></pre>
            </div>
        </div>
        <p><a class="indexterm" id="3_id321770"></a>I often find it easier to read code like this when the <code class="literal">final</code> is left out, because it can be just line noise. Of course, there are situations where it can be easier to understand
            code with an explicit <code class="literal">final</code>. Whether to use the effectively <code class="literal">final</code> feature comes down to personal choice.</p>
        <p>If you assign to the variable multiple times and then try to use it in a lambda expression, you’ll get a compile error. For example,<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#variable_capture3">Example 2-7</a>            will fail to compile with the error message: <code class="literal">local variables referenced from a lambda expression must be final or effectively final</code>.</p>
        <div class="example"><a id="3_variable_capture3"></a>
            <div class="example-title">Example 2-7. Fails to compile due to the use of a not effectively final variable</div>
            <div class="example-contents">
              <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> getUserName();
name <span style="color:#00f;font-weight:700">=</span> formatUserName(name);
button<span style="color:#00f;font-weight:700">.</span>addActionListener(event <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">"hi "</span> <span style="color:#00f;font-weight:700">+</span> name));
</pre>
            </div>
        </div>
        <p><a class="indexterm" id="3_id380463"></a>This behavior also helps explain one of the reasons some people refer to lambda expressions as “closures.” The variables that aren’t assigned to are <span class="emphasis"><em>closed</em></span> over the
            surrounding state in order to bind them to a value. Among the chattering classes of the programminglanguage world, there has been much debate over whether Java really has closures, because you can refer to only effectively <code class="literal">final</code>            variables. To paraphrase Shakespeare: <span class="emphasis"><em>A closure by any other name will function all the same</em></span>. In an effort to avoid such pointless debate, I’ll be referring to them as “lambda expressions” throughout
            this book. Regardless of what we call them, I’ve already mentioned that lambdaexpressions are statically typed, so let’s investigate the types of lambda expressions themselves: these types are called <span class="emphasis"><em>functional interfaces</em></span>.</p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_functional_interfaces" style="clear: both">Functional Interfaces</h2>
                </div>
            </div>
        </div>
        <div class="note">
            <h3 class="title">Note</h3>
            <p>A functional interface is an interface with a single abstract method that is used as the type of a lambda expression.</p>
        </div>
        <p><a class="indexterm" id="3_ix_ch02-asciidoc2"></a><a class="indexterm" id="3_ix_ch02-asciidoc3"></a><a class="indexterm" id="3_id289730"></a><a class="indexterm" id="3_id289737"></a>In Java, all method parameters have types; if we were passing <code class="literal">3</code>            as anargument to a method, the parameter would be an <code class="literal">int</code>. So what’s thetype of a lambda expression?</p>
        <p>There is a really old idiom of using an interface with a single method torepresent a method and reusing it. It’s something we’re all familiar with fromprogramming in Swing, and it is exactly what was going on in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#lambda_button_lambda">Example 2-2</a>.
            There’s no need for new magic to be employed here.The exact same idiom is used for lambda expressions, and we call this kind ofinterface a <span class="emphasis"><em>functional interface</em></span>. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#ActionListener_interface">Example 2-8</a>            shows the functional interface from the previousexample.</p>
        <div class="example"><a id="3_ActionListener_interface"></a>
            <div class="example-title">Example 2-8. The ActionListener interface: from an ActionEvent to nothing</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">ActionListener</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">EventListener</span> {
 <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">actionPerformed</span>(<span style="color:#00f;font-weight:700">ActionEvent</span> <span style="font-style:italic">event</span>);
}
</pre>
            </div>
        </div>
        <p><code class="literal">ActionListener</code> has only one abstract method, <code class="literal">actionPerformed</code>, and we use itto <span class="emphasis"><em>represent</em></span> an action that takes one argument and produces no result.Remember,
            because <code class="literal">actionPerformed</code> is defined in an interface, it doesn’tactually need the <code class="literal">abstract</code> keyword in order to be abstract. It also has aparent interface, <code class="literal">EventListener</code>,
            with no methods at all.</p>
        <p>So it’s a functional interface. It doesn’t matter what the single method onthe interface is called—it’ll get matched up to your lambda expression as longas it has a compatible method signature. Functional interfaces also let us givea useful name
            to the type of the parameter—something that can help usunderstand what it’s used for and aid readability.</p>
        <p>The functional interface here takes one <code class="literal">ActionEvent</code> parameter and doesn’treturn anything (<code class="literal">void</code>), but functional interfaces can come in many kinds. Forexample, they may take two parameters
            and return a value. They can also usegenerics; it just depends upon what you want to use them for.</p>
        <p>From now on, I’ll use diagrams to represent the different kinds offunctional interfaces you’re encountering. The arrows going into the functionrepresent arguments, and if there’s an arrow coming out, it represents thereturn type. For example,
            an <code class="literal">ActionListener</code> would look like<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#ActionListener_diagram">Figure 2-1</a>.</p>
        <div class="figure-float" style="float: right;">
            <div class="figure"><a id="3_ActionListener_diagram"></a>
                <div class="figure-contents">
                    <div class="mediaobject"><img alt="the ActionListener interface" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0201.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0201.png" width="539"/></div>
                </div>
                <div class="figure-title">Figure 2-1. The ActionListener interface showing an ActionEvent going in and nothing (void) coming out</div>
            </div>
        </div>
        <p>Over time you’ll encounter many functional interfaces, but there is a coregroup in the Java Development Kit (JDK) that you will see time and time again. I’ve listed some of themost important functional interfaces in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#functional_interface_table">Table 2-1</a>.</p>
        <div class="table"><a id="3_functional_interface_table"></a>
            <div class="table-title">Table 2-1. Important functional interfaces in Java</div>
            <div class="table-contents">
                <table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; ">
                    <colgroup>
                        <col class="col_1">
                        <col class="col_2">
                        <col class="col_3">
                        <col class="col_4">
                    </colgroup>
                    <thead>
                        <tr>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Interface name </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Arguments</td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Returns </td>
                            <td style="border-bottom: 0.5pt solid ; "> Example</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">Predicate&lt;T&gt;</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">boolean</code></p>
                            </td>
                            <td style="border-bottom: 0.5pt solid ; ">
                                <p>Has this album been released yet?</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">Consumer&lt;T&gt;</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">void</code></p>
                            </td>
                            <td style="border-bottom: 0.5pt solid ; ">
                                <p>Printing out a value</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">Function&lt;T,R&gt;</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">R</code></p>
                            </td>
                            <td style="border-bottom: 0.5pt solid ; ">
                                <p>Get the name from an <code class="literal">Artist</code> object</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">Supplier&lt;T&gt;</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>None</p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td style="border-bottom: 0.5pt solid ; ">
                                <p>A factory method</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">UnaryOperator&lt;T&gt;</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td style="border-bottom: 0.5pt solid ; ">
                                <p>Logical not (<code class="literal">!</code>)</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="border-right: 0.5pt solid ; ">
                                <p><code class="literal">BinaryOperator&lt;T&gt;</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; ">
                                <p><code class="literal">(T, T)</code></p>
                            </td>
                            <td style="border-right: 0.5pt solid ; ">
                                <p><code class="literal">T</code></p>
                            </td>
                            <td>
                                <p>Multiplying two numbers (<code class="literal">*</code>)</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
    </div>
    <p>I’ve talked about what types functional interfaces take and mentioned that<code class="literal">javac</code> can automatically infer the types of parameters and that you canmanually provide them, but when do you know whether to provide them?Let’s
        look a bit more at the details of type inference.<a class="indexterm" id="3_id367126"></a><a class="indexterm" id="3_id320321"></a></p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_type_inference" style="clear: both">Type Inference</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="3_ix_ch02-asciidoc4"></a><a class="indexterm" id="3_ix_ch02-asciidoc5"></a>There are certain circumstances in which you need to manually provide typehints, and my advice is to do what you and your team find easiest to read.Sometimes
            leaving out the types removes line noise and makes it easier to seewhat is going on. Sometimes leaving them in can make it clearer what is goingon. I’ve found that at first they can sometimes be helpful, but over timeyou’ll switch to adding
            them in only when they are actually needed. You canfigure out whether they are needed from a few simple rules that I’ll introduce in this chapter.</p>
        <p>The type inference used in lambdas is actually an extension of the target typeinference introduced in Java 7. You might be familiar with Java 7 allowing youto use a<a class="indexterm" id="3_id320885"></a> <code class="literal">diamond</code> operator
            that asks <code class="literal">javac</code> to <span class="emphasis"><em>infer</em></span> the generic argumentsfor you. You can see this in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#diamond_inference_eg">Example 2-9</a>.</p>
        <div class="example"><a id="3_diamond_inference_eg"></a>
            <div class="example-title">Example 2-9. Diamond inference for variables</div>
            <div class="example-contents">
                       
              <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>Map &lt; String, Integer &gt; oldWordCounts = new HashMap &lt; String, Integer &gt; ();<a id="3_CO1-6"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>
Map &lt; String, Integer &gt; diamondWordCounts = new HashMap &lt; &gt; ();<a id="3_CO1-7"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>
</code></pre>  
                
                
            </div>
    </div>
    <p>For the variable <code class="literal">oldWordCounts</code> <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-6"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>        we have explicitly added the generictypes, but <code class="literal">diamondWordCounts</code> <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-7"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>        uses the <code class="literal">diamond</code> operator. The generictypes aren’t written out—the compiler just figures out what you wantto do by itself. Magic!</p>
    <p>It’s not really magic, of course. Here, the generic types to <code class="literal">HashMap</code> can beinferred from the type of <code class="literal">diamondWordCounts</code> <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#CO1-7"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>        . You still need to providegeneric types on the variable that is being assigned to, though.</p>
    <p>If you’re passing theconstructor straight into a method, it’s also possible to infer the generictypes from that method. In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#diamond_inference_method">Example 2-10</a>,
        we pass a <code class="literal">HashMap</code> asan argument that already has the generic types on it.</p>
    <div class="example"><a id="3_diamond_inference_method"></a>
        <div class="example-title">Example 2-10. Diamond inference for methods</div>
        <div class="example-contents">
            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>String name = getUserName();
button.addActionListener(event -&gt; System.out.println(&quot;hi &quot; + name));
</code></pre>
        </div>
    </div>
    <p>In the same way that Java 7 allowed you to leave out the generic types for aconstructor, Java 8 allows you to leave out the types for whole parameters oflambda expressions. Again, it’s not magic: <code class="literal">javac</code> looks for information
        closeto your lambda expression and uses this information to figure out what thecorrect type should be. It’s still type checked and provides all the safetythat you’re used to, but you don’t have to state the types explicitly. This iswhat we mean
        by <span class="emphasis"><em>type inference</em></span>.</p>
    <div class="note">
        <h3 class="title">Note</h3>
        <p><a class="indexterm" id="3_id289056"></a><a class="indexterm" id="3_id289044"></a>It’s also worth noting that in Java 8 the type inference has been improved. Theearlier example of passing <code class="literal">new HashMap&lt;&gt;()</code> into a
            <code class="literal">useHashmap</code> method actuallywouldn’t have compiled in Java 7, even though the compiler had all the informationit needed to figure things out.</p>
    </div>
    <p>Let’s go into a little more detail on this point with some examples.</p>
    <p>In both of these cases we’re assigning the variables to a functional interface,so it’s easier to see what’s going on. The first example (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#type_inference_examples">Example 2-11</a>)
        is a lambda thattells you whether an <code class="literal">Integer</code> is greater than 5. This is actually a<code class="literal">Predicate</code>—a functional interface that checks whether something is true orfalse.</p>
    <div class="example"><a id="3_type_inference_examples"></a>
        <div class="example-title">Example 2-11. Type inference</div>
        <div class="example-contents">
            <pre class="programlisting"><code class="n">Predicate</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">&gt;</code> <code class="n">atLeast5</code> <code class="o">=</code> <code class="n">x</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="mi">5</code><code class="o">;</code></pre>
        </div>
    </div>
    <p><a class="indexterm" id="3_id367193"></a>A <code class="literal">Predicate</code> is also a lambda expression that returns a value, unlike the previous<code class="literal">ActionListener</code> examples. In this case we’ve used an expression,
        <code class="literal">x &gt;5</code>, as the body of the lambda expression. When that happens, the return valueof the lambda expression is the value its body evaluates to.</p>
    <p><a class="indexterm" id="3_id295077"></a>You can see from <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#predicate_interface">Example 2-12</a> that <code class="literal">Predicate</code> has
        a single generictype; here we’ve used an <code class="literal">Integer</code>. The only argument of the lambda expressionimplementing <code class="literal">Predicate</code> is therefore inferred as an <code class="literal">Integer</code>.
        <code class="literal">javac</code> canalso check whether the return value is a <code class="literal">boolean</code>, as that is the return typeof the <code class="literal">Predicate</code> method (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#Predicate_diagram">Figure 2-2</a>).</p>
    <div class="example"><a id="3_predicate_interface"></a>
        <div class="example-title">Example 2-12. The predicate interface in code, generating a boolean from an Object</div>
        <div class="example-contents">
            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>public interface Predicate &lt; T &gt; {
 boolean test(T t);
}</code></pre>
        </div>
        </div>
        <div class="figure"><a id="3_Predicate_diagram"></a>
            <div class="figure-contents">
                <div class="mediaobject"><img alt="the Predicate interface" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0202.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0202.png" width="581"/></div>
            </div>
            <div class="figure-title">Figure 2-2. The Predicate interface diagram, generating a boolean from an Object</div>
        </div>
        <p>Let’s look at another, slightly more complex functional interface example: the<a class="indexterm" id="3_id292530"></a><code class="literal">BinaryOperator</code> interface, which is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#type_inference_examples2">Example 2-13</a>.This
            interface takes two arguments and returns a value, all of whichare the same type. In the code example we’ve used, this type is <code class="literal">Long</code>.</p>
        <div class="example"><a id="3_type_inference_examples2"></a>
            <div class="example-title">Example 2-13. A more complex type inference example</div>
            <div class="example-contents">
                <pre class="programlisting"><code class="n">BinaryOperator</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code> <code class="n">addLongs</code> <code class="o">=</code> <code class="o">(</code><code class="n">x</code><code class="o">,</code> <code class="n">y</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code><code class="o">;</code></pre>
            </div>
        </div>
        <p>The inference is smart, but if it doesn’t have enoughinformation, it won’t be able to make the right decision. In these cases, insteadof making a wild guess it’ll just stop what it’s doing and ask for help in the form of a compile error. For example,
            if we removesome of the type information from the previous example, we get the code in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#generics_compile_error">Example 2-14</a>.</p>
        <div class="example"><a id="3_generics_compile_error"></a>
            <div class="example-title">Example 2-14. Code doesn’t compile due to missing generics</div>
            <div class="example-contents">
                <pre class="programlisting"><code class="n">BinaryOperator</code> <code class="n">add</code> <code class="o">=</code> <code class="o">(</code><code class="n">x</code><code class="o">,</code> <code class="n">y</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code><code class="o">;</code></pre>
            </div>
            </div>
            <p>This code results in the following error message:</p>
            <pre class="screen">Operator &apos;+&apos; cannot be applied to java.lang.Object, java.lang.Object.</pre>
            <p>That looks messy: what is going on here? Remember that<code class="literal">BinaryOperator</code> was a functional interface that had a generic argument. Theargument is used as the type of both arguments, <code class="literal">x</code> and
                <code class="literal">y</code>, and also for itsreturn type. In our code example, we didn’t give any generics to our <code class="literal">add</code>variable. It’s the very definition of a <span class="emphasis"><em>raw</em></span> type.
                Consequently, ourcompiler thinks that its arguments and return values are all instances of<code class="literal">java.lang.Object</code>.</p>
            <p>We will return to the topic of type inference and its interaction with methodoverloading in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#overload_resolution_sec">Overload Resolution</a>,
                but there’s no need to understandmore detail until then.<a class="indexterm" id="3_id400706"></a><a class="indexterm" id="3_id400690"></a></p>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_key_points" style="clear: both">Key Points</h2>
                        </div>
                    </div>
                </div>
                <div class="itemizedlist">
                    <ul class="itemizedlist">
                        <li class="listitem">A lambda expression is a method without a name that is used to pass around behavioras if it were data.</li>
                        <li class="listitem">Lambda expressions look like this: <code class="literal">BinaryOperator&lt;Integer&gt; add = (x, y) → x + y</code>.</li>
                        <li class="listitem">A functional interface is an interface with a single abstract method that isused as the type of a lambda expression.<a class="indexterm" id="3_id319977"></a></li>
                    </ul>
                </div>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_exercises" style="clear: both">Exercises</h2>
                        </div>
                    </div>
                </div>
                <p>At the end of each chapter is a series of exercises togive you an opportunity to practice what you’ve learned during the chapter and help you learn the new concepts. The answers to these exercises can befound on <a class="ulink" href="https://github.com/RichardWarburton/java-8-lambdas-exercises" target="_top">GitHub</a>.</p>
                <div class="orderedlist">
                    <ol class="orderedlist" type="1">
                        <li class="listitem">
                            <p class="simpara">Questions about the <code class="literal">Function</code> functional interface (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html#functional_functional_interface">Example 2-15</a>).</p>
                            <div class="example"><a id="3_functional_functional_interface"></a>
                                <div class="example-title">Example 2-15. The function functional interface</div>
                                <div class="example-contents">
                                    <pre class="programlisting"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">Function</code><code class="o">&lt;</code><code class="n">T</code><code class="o">,</code> <code class="n">R</code><code class="o">&gt;</code> <code class="o">{</code>    <code class="n">R</code> <code class="nf">apply</code><code class="o">(</code><code class="n">T</code> <code class="n">t</code><code class="o">);</code><code class="o">}</code></pre>
                                </div>
                </div>
                <div class="orderedlist">
                    <ol class="orderedlist" type="a">
                        <li class="listitem">Can you draw this functional interface diagrammatically?</li>
                        <li class="listitem">What kind of lambda expressions might you use this functional interface for if you were writing a software calculator?</li>
                        <li class="listitem">
                            <p class="simpara">Which of these lambda expressions are valid <code class="literal">Function&lt;Long,Long&gt;</code> implementations?</p>
                            <pre class="programlisting"><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">+</code> <code class="mi">1</code><code class="o">;</code><code class="o">(</code><code class="n">x</code><code class="o">,</code> <code class="n">y</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">+</code> <code class="mi">1</code><code class="o">;</code><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">==</code> <code class="mi">1</code><code class="o">;</code></pre>
                        </li>
                    </ol>
                </div>
                </li>
                <li class="listitem">
                    <p class="simpara"><span class="emphasis"><em>ThreadLocal lambda expressions</em></span>. Java has a class called <code class="literal">ThreadLocal</code> that acts as a container for a value that’s local to your current thread. In Java 8 there is a
                        new factory method for <code class="literal">ThreadLocal</code> that takes a lambda expression, letting you create a new <code class="literal">ThreadLocal</code> without the syntactic burden of subclassing.</p>
                    <div class="orderedlist">
                        <ol class="orderedlist" type="a">
                            <li class="listitem">Find the method in Javadoc or using your IDE.</li>
                            <li class="listitem">The Java <code class="literal">DateFormatter</code> class isn’t thread-safe. Use the constructor to create a thread-safe <code class="literal">DateFormatter</code> instance that prints dates like this: “01-Jan-1970”.</li>
                        </ol>
                    </div>
                </li>
                <li class="listitem">
                    <p class="simpara"><span class="emphasis"><em>Type inference rules</em></span>. Here are a few examples of passing lambda expressions into functions. Can <code class="literal">javac</code> infer correct argument types for the lambda expressions? In other
                        words, will they compile?</p>
                    <div class="orderedlist">
                        <ol class="orderedlist" type="a">
                            <li class="listitem"><code class="literal">Runnable helloWorld = () -&gt; System.out.println(&quot;hello world&quot;);</code></li>
                            <li class="listitem">
                                <p class="simpara">The lambda expression being used as an <code class="literal">ActionListener</code>:</p>
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">JButton</span> button <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">JButton</span>();
button<span style="color:#00f;font-weight:700">.</span>addActionListener(event <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(event<span style="color:#00f;font-weight:700">.</span>getActionCommand()));
</pre>
                            </li>
                            <li class="listitem">
                                <p class="simpara">Would <code class="literal">check(x -&gt; x &gt; 5)</code> be inferred, given the following overloads for <code class="literal">check</code>?</p>
                                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">IntPred</span> {
 <span style="color:#00f;font-weight:700">boolean</span> <span style="color:#0000a2;font-weight:700">test</span>(<span style="color:#00f;font-weight:700">Integer</span> <span style="font-style:italic">value</span>);
}
<span style="color:#00f;font-weight:700">boolean</span> check(<span style="color:#00f;font-weight:700">Predicate</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">></span> predicate);
<span style="color:#00f;font-weight:700">boolean</span> check(<span style="color:#00f;font-weight:700">IntPred</span> predicate);
</pre>
                            </li>
                        </ol>
                    </div>
                </li>
                </ol>
            </div>
            <div class="tip">
                <h3 class="title">Tip</h3>
                <p>You might want to look up the method argument types in Javadoc or in yourIDE in order to determine whether there are multiple valid overloads.</p>
            </div>
            </div>
            </section>
            <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
            </div>
          </div>
        </section>
      </div>
    </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch03.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch03.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="4_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="streams_chapter">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 3. Streams</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="4_ix_ch03-asciidoc0"></a><a class="indexterm" id="4_ix_ch03-asciidoc1"></a>The language changes introduced in Java 8 are intended to help us write better code. New core libraries are a key part of that,
                                so in this chapter we start to look at them. The most important core library changes are focused around the Collections API and its new addition: <span class="emphasis"><em>streams</em></span>. Streams allow us to write
                                collections-processing code at a higher level of abstraction.</p>
                            <p>The <code class="literal">Stream</code> interface contains a series of functions that we’ll explore throughout this chapter, each of which corresponds to a common operation that you might perform on a <code class="literal">Collection</code>.</p>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="internal_iteration_section" style="clear: both">From External Iteration to Internal Iteration</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="tip">
                                    <h3 class="title">Tip</h3>
                                    <p>A lot of the examples in this chapter and the rest of the book refer todomain classes, which were introduced in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch01.html#example_domain">Example Domain</a>.</p>
                                </div>
                                <p><a class="indexterm" id="4_ix_ch03-asciidoc2"></a><a class="indexterm" id="4_ix_ch03-asciidoc3"></a><a class="indexterm" id="4_ix_ch03-asciidoc4"></a><a class="indexterm" id="4_ix_ch03-asciidoc5"></a><a class="indexterm" id="4_ix_ch03-asciidoc6"></a>A
                                    common pattern for Java developers when working with collections is to iterate over a collection, operating on each element in turn. For example, if we wanted to add up the number of musicians who are from London, we
                                    would write the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#external_count_londoners">Example 3-1</a>.</p>
                                <div class="example"><a id="4_external_count_londoners"></a>
                                    <div class="example-title">Example 3-1. Counting London-based artists using a for loop</div>
                                    <div class="example-contents">
                                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">int</span> count <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Artist</span> artist<span style="color:#00f;font-weight:700">:</span> allArtists) {
 <span style="color:#00f;font-weight:700">if</span> (artist<span style="color:#00f;font-weight:700">.</span>isFrom(<span style="color:#036a07">"London"</span>)) {
  count<span style="color:#00f;font-weight:700">++</span>;
 }
}
</pre>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="4_id370089"></a>There are several problems with this approach, though. It involves a lot of boilerplate code that needs to be written every time you want to iterate over the collection. It’s also
                                    hard to write a parallel version of this <code class="literal">for</code> loop. You would need to rewrite every <code class="literal">for</code> loop individually in order to make them operate in parallel.</p>
                                <p>Finally, the code here doesn’t fluently convey the intent of the programmer. The boilerplate <code class="literal">for</code> loop structure obscures meaning; to understand anything we must read though the body of the loop.
                                    For a single <code class="literal">for</code> loop, doing this isn’t too bad, but when you have a large code base full of them it becomes a burden (especially with nested loops).</p>
                                <p>Looking under the covers a little bit, the <code class="literal">for</code> loop is actually syntactic sugar that wraps up the iteration and hides it. It’s worth taking a moment to look at what’s going on under the hood
                                    here. The first step in this process is a call to the<a class="indexterm" id="4_id320643"></a> <code class="literal">iterator</code> method, which creates a new <code class="literal">Iterator</code> object in order to
                                    control the iteration process. We call this <span class="emphasis"><em>external iteration</em></span>. The iteration then proceeds by explicitly calling the <code class="literal">hasNext</code> and <code class="literal">next</code>                                    methods on this <code class="literal">Iterator</code>. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#external_count_londoners_expanded">Example 3-2</a> demonstrates
                                    the expanded code in full, and <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#external_iteration_diagram">Figure 3-1</a> shows the pattern of method calls
                                    that happen.</p>
                                <div class="example"><a id="4_external_count_londoners_expanded"></a>
                                    <div class="example-title">Example 3-2. Counting London-based artists using an iterator</div>
                                    <div class="example-contents">
                                  <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">int</span> count <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
<span style="color:#00f;font-weight:700">Iterator</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">></span> iterator <span style="color:#00f;font-weight:700">=</span> allArtists<span style="color:#00f;font-weight:700">.</span>iterator();
<span style="color:#00f;font-weight:700">while</span> (iterator<span style="color:#00f;font-weight:700">.</span>hasNext()) {
 <span style="color:#00f;font-weight:700">Artist</span> artist <span style="color:#00f;font-weight:700">=</span> iterator<span style="color:#00f;font-weight:700">.</span>next();
 <span style="color:#00f;font-weight:700">if</span> (artist<span style="color:#00f;font-weight:700">.</span>isFrom(<span style="color:#036a07">"London"</span>)) {
  count<span style="color:#00f;font-weight:700">++</span>;
 }
}
</pre>
                                    </div>
                                </div>
                                <div class="figure"><a id="4_external_iteration_diagram"></a>
                                    <div class="figure-contents">
                                        <div class="mediaobject"><img alt=".External Iteration" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0301.png" height="534" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0301.png" width="601"/></div>
                                    </div>
                                    <div class="figure-title">Figure 3-1. External iteration</div>
                                </div>
                                <p>External iteration has some negative issues associated with it, too. First, it becomes hard to abstract away the different behavioral operations that we’ll encounter later in this chapter. It is also an approach that is
                                    inherently serial in nature. The big-picture issue here is that using a <code class="literal">for</code> loop conflates what you are doing with how you are doing it.</p>
                                <p>An alternative approach, <span class="emphasis"><em>internal iteration</em></span>, is shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#internal_count_londoners">Example 3-3</a>.
                                    The first thing to notice is the call to<code class="literal">stream()</code>, which performs a similar role to the call to <code class="literal">iterator()</code> in theprevious example. Instead of returning an
                                    <code class="literal">Iterator</code> to control the iteration,it returns the equivalent interface in the internal iteration world: <code class="literal">Stream</code>.</p>
                                <div class="example"><a id="4_internal_count_londoners"></a>
                                    <div class="example-title">Example 3-3. Counting London-based artists using internal iteration</div>
                                    <div class="example-contents">
                                       <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>long count = allArtists.stream().filter(artist -&gt; artist.isFrom(&quot;London&quot;)).count();</code></pre>
                                    </div>
                                </div>
                                <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#internal_iteration_diagram">Figure 3-2</a> depicts the flow of method calls with respect to the library; compare
                                    it with <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#external_iteration_diagram">Figure 3-1</a>.</p>
                                <div class="figure"><a id="4_internal_iteration_diagram"></a>
                                    <div class="figure-contents">
                                        <div class="mediaobject"><img alt=".Internal Iteration" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0302.png" height="534" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0302.png" width="655"/></div>
                                    </div>
                                    <div class="figure-title">Figure 3-2. Internal iteration</div>
                                </div>
                                <div class="note">
                                    <h3 class="title">Note</h3>
                                    <p>A <code class="literal">Stream</code> is a tool for building up complex operations on collections using a functional approach.</p>
                                </div>
                                <p>We can actually break this example into two simpler operations:</p>
                                <div class="itemizedlist">
                                    <ul class="itemizedlist">
                                        <li class="listitem">Finding all the artists from London</li>
                                        <li class="listitem">Counting a list of artists</li>
                                    </ul>
                                </div>
                                <p>Both of these operations correspond to a method on the <code class="literal">Stream</code> interface. In order tofind artists from London, we <code class="literal">filter</code> the <code class="literal">Stream</code>.
                                    Filtering in this case means“keep only objects that pass a test.” The test is defined by a function,which returns either <code class="literal">true</code> or <code class="literal">false</code> depending on whether the
                                    artist is fromLondon. Because we’re practicing functional programming when using theStreams API, we aren’t changing the contents of the <code class="literal">Collection</code>; we’re just declaringwhat the contents
                                    of the <code class="literal">Stream</code> will be. The <code class="literal">count()</code> method counts how manyobjects are in a given <code class="literal">Stream</code>.<a class="indexterm" id="4_id322169"></a>
                                    <a class="indexterm" id="4_id293574"></a><a class="indexterm" id="4_id293581"></a><a class="indexterm" id="4_id293587"></a><a class="indexterm" id="4_id293593"></a></p>
                    </div>
                    <div class="sect1">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title" id="_what_8217_s_actually_going_on" style="clear: both">What’s Actually Going On</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="4_id369042"></a><a class="indexterm" id="4_id369051"></a>When I wrote the previous example, I broke it up into two simpler operations: filtering and counting. You may think that this is pretty wasteful—when
                            I wrote the <code class="literal">for</code> loop in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#external_count_londoners">Example 3-1</a>, there was only one
                            loop. It looks like you would need two here, as there are two operations. In fact, the library has been cleverly designed so that it iterates over the list of artists only once.</p>
                        <p>In Java, when you call a method it traditionally corresponds to the computer actually doing something; for example, <code class="literal">System.out.println(&quot;Hello World&quot;);</code> prints output to your terminal. Some of the methods
                            on <code class="literal">Stream</code> work a little bit differently. They are normal Java methods, but the <code class="literal">Stream</code> object returned isn’t a new collection—it’s a recipe for creating a new collection.
                            So just think for a second about what the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#filter_londoners">Example 3-4</a> does. Don’t worry if you get stuck—I’ll
                            explain in a bit!</p>
                        <div class="example"><a id="4_filter_londoners"></a>
                            <div class="example-title">Example 3-4. Just the filter, no collect step</div>
                            <div class="example-contents">
                                <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>allArtists.stream()..filter(artist -&gt; artist.isFrom(&quot;London&quot;));</code></pre>
                            </div>
                        </div>
                        <p>It actually doesn’t do very much at all—the call to <code class="literal">filter</code> builds up a<code class="literal">Stream</code> recipe, but there’s nothing to force this recipe to be used.<a class="indexterm" id="4_id322003"></a>Methods
                            such as <code class="literal">filter</code> that build up the <code class="literal">Stream</code> recipe but don’t forcea new value to be generated at the end are referred to as <span class="emphasis"><em>lazy</em></span>.
                            <a class="indexterm" id="4_id343931"></a>Methods such as <code class="literal">count</code> that generate a final value out of the <code class="literal">Stream</code> sequenceare called <span class="emphasis"><em>eager</em></span>.</p>
                        <p>The easiest way of seeing that is if we add in a <code class="literal">println</code> statement as part ofthe filter in order to print out the artists’ names. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#filter_londoners_printed">Example 3-5</a>is
                            a modified version of <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#filter_londoners">Example 3-4</a> with such a printout. If we runthis code, the program doesn’t
                            print anything when it’s executed.</p>
                        <div class="example"><a id="4_filter_londoners_printed"></a>
                            <div class="example-title">Example 3-5. Not printing out artist names due to lazy evaluation</div>
                            <div class="example-contents">
                       <pre style="background:#fff;color:#000">allArtists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>filter(artist <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> {
 <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(artist<span style="color:#00f;font-weight:700">.</span>getName());
 <span style="color:#00f;font-weight:700">return</span> artist<span style="color:#00f;font-weight:700">.</span>isFrom(<span style="color:#036a07">"London"</span>);
});
</pre>
                            </div>
                        </div>
                        <p>If we add the same printout to a stream that has a terminal step,such as the counting operation from <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#internal_count_londoners">Example 3-3</a>,
                            thenwe will see the names of our artists printed out (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#internal_count_londoners_printed">Example 3-6</a>).</p>
                        <div class="example"><a id="4_internal_count_londoners_printed"></a>
                            <div class="example-title">Example 3-6. Printing out artist names</div>
                            <div class="example-contents">
                         <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">long</span> count <span style="color:#00f;font-weight:700">=</span> allArtists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>filter(artist <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> {
 <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(artist<span style="color:#00f;font-weight:700">.</span>getName());
 <span style="color:#00f;font-weight:700">return</span> artist<span style="color:#00f;font-weight:700">.</span>isFrom(<span style="color:#036a07">"London"</span>);
})<span style="color:#00f;font-weight:700">.</span>count();
</pre>
                            </div>
                        </div>
                        <p>So, if you ran <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#internal_count_londoners_printed">Example 3-6</a> with the members of The Beatles as your list of artists,
                            then you would see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#the_beatles_sample_output">Example 3-7</a> printed out on your command line.</p>
                        <div class="example"><a id="4_the_beatles_sample_output"></a>
                            <div class="example-title">Example 3-7. Sample output showing the members of The Beatles being printed</div>
                            <div class="example-contents">
                                <pre class="screen">John LennonPaul McCartneyGeorge HarrisonRingo Starr</pre>
                            </div>
                        </div>
                        <p>It’s very easy to figure out whether an operation is eager or lazy: look at what it returns. If it gives you back a <code class="literal">Stream</code>, it’s lazy; if it gives you back another value or <code class="literal">void</code>,
                            then it’s eager. This makes sense because the preferred way of using these methods is to form a sequence of lazy operations chained together and then to have a single eager operation at the end that generates your result. This
                            is how our counting example operates, but it’s the simplest case: only two operations.</p>
                        <p>This whole approach is somewhat similar to the familiar<a class="indexterm" id="4_id365068"></a> <span class="emphasis"><em>builder</em></span> pattern. Inthe builder pattern, there are a sequence of calls that set up properties
                            orconfiguration, followed by a single call to a<a class="indexterm" id="4_id365062"></a> <code class="literal">build</code> method. The object beingcreated isn’t created until the call to <code class="literal">build</code> occurs.</p>
                        <p>I’m sure you’re asking, “Why would we want to have thedifferentiator between lazy and eager options?” By waiting until we know moreabout what result and operations are needed, we can perform thecomputations more efficiently. A
                            good example is finding the firstnumber that is <code class="literal">&gt; 10</code>. We don’t need to evaluate all the elements to figurethis out—only enough to find our first match. It also means thatwe can string together
                            lots of different operations over our collectionand iterate over the collection only once.</p>
                    </div>
                    <div class="sect1">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title" id="_common_stream_operations" style="clear: both">Common Stream Operations</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="4_ix_ch03-asciidoc7"></a><a class="indexterm" id="4_ix_ch03-asciidoc8"></a>At this point, it’s worth just having a look back at some common <code class="literal">Stream</code>operations in order to get more
                            of a feel of what’s available in the API. Aswe will cover only a few important examples, I recommend looking at the Javadocfor the new API to see what else is available.</p>
                        <div class="sect2">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h3 class="title" id="_collect_tolist">collect(toList())</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="note">
                                <h3 class="title">Note</h3>
                                <p><code class="literal">collect(toList())</code> is an eager operation that generates a list from the values in a <code class="literal">Stream</code>.</p>
                            </div>
                            <p><a class="indexterm" id="4_id364463"></a><a class="indexterm" id="4_id350482"></a>The values in the <code class="literal">Stream</code> that are operated on are derived from the initialvalues and the recipe produced by the sequence
                                of <code class="literal">Stream</code> calls. In fact,<code class="literal">collect</code> is a very general and powerful construct, and we’ll look into itsother uses in more detail in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html">Chapter 5</a>.
                                Here’s an example of this operation:</p>
                         
                            
                            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>List &lt; String &gt; collected = Stream.of(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)<a id="4_CO1-8"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>.collect(Collectors.toList());<a id="4_CO1-9"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>
assertEquals(Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;), collected);<a id="4_CO1-10"></a><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></code></pre>
                            
                            
                            
                          <p>This example shows how <code class="literal">collect(toList())</code> can be used to build aresult list out of a <code class="literal">Stream</code>. It’s important to remember, as discussed inthe previous section, that because
                                many <code class="literal">Stream</code> functions are lazy, you do needto use an eager operation such as <code class="literal">collect</code> at the end of a sequence ofchained method calls.</p>
                            <p>This example also shows the general format for all the examples in thissection. It starts by taking a <code class="literal">Stream</code> from a <code class="literal">List</code> <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#CO1-8"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>.
                                There is someoperation, followed by collecting into a list <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#CO1-9"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>.
                                Finally, we perform an assertto show you what the results are equal to <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#CO1-10"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>.</p>
                            <p>You can think of the opening call to <code class="literal">stream</code> and the closing call to a<code class="literal">collect</code> or other terminal method as<a class="indexterm" id="4_id343860"></a> <span class="emphasis"><em>bun</em></span>                                methods. They aren’t theactual filling of our stream burger, but they do help us see where theoperations begin and end.</p>
                        </div>
                        <div class="sect2">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h3 class="title" id="_map">map</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="note">
                                <h3 class="title">Note</h3>
                                <p>If you’ve got a function that converts a value of one type into another, <code class="literal">map</code> lets youapply this function to a stream of values, producing another stream of the new values.</p>
                            </div>
                            <p><a class="indexterm" id="4_id387359"></a><a class="indexterm" id="4_id387366"></a>You’ll probably notice fairly soon that you’ve been doing some kindof map operations for years already. Say you are writing Java code thattakes a
                                list of strings and converts them to their uppercase equivalents.You would loop over all the values in the list and call <code class="literal">toUppercase</code> oneach element. You would then add each of the resulting
                                values into a new <code class="literal">List</code>.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#map_example_2">Example 3-8</a> is code written in this style.</p>
                            <div class="example"><a id="4_map_example_2"></a>
                                <div class="example-title">Example 3-8. Converting strings to uppercase equivalents using a for loop</div>
                                <div class="example-contents">
                                 <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> collected <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ArrayList</span> &lt; > ();
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">String</span> string<span style="color:#00f;font-weight:700">:</span> asList(<span style="color:#036a07">"a"</span>, <span style="color:#036a07">"b"</span>, <span style="color:#036a07">"hello"</span>)) {
 <span style="color:#00f;font-weight:700">String</span> uppercaseString <span style="color:#00f;font-weight:700">=</span> string<span style="color:#00f;font-weight:700">.</span>toUpperCase();
 collected<span style="color:#00f;font-weight:700">.</span>add(uppercaseString);
}
assertEquals(asList(<span style="color:#036a07">"A"</span>, <span style="color:#036a07">"B"</span>, <span style="color:#036a07">"HELLO"</span>), collected);
</pre>
                                </div>
                        </div>
                        <p><code class="literal">map</code> is one of the most commonly used <code class="literal">Stream</code> operations (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#jvld_0303">Figure 3-3</a>).
                            You could probablyhave guessed this, given how frequently you have implemented something similar tothe aforementioned <code class="literal">for</code> loop. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#map_example_1">Example 3-9</a>                            is the same example of turning alist of strings into their uppercase equivalents using the stream framework.</p>
                        <div class="figure"><a id="4_jvld_0303"></a>
                            <div class="figure-contents">
                                <div class="mediaobject"><img alt="the map operation" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0303.png" height="533" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0303.png" width="745"/></div>
                            </div>
                            <div class="figure-title">Figure 3-3. The map operation</div>
                        </div>
                        <div class="example"><a id="4_map_example_1"></a>
                            <div class="example-title">Example 3-9. Converting strings to uppercase equivalents using map</div>
                            <div class="example-contents">
                               
                                
                                
                                <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>List &lt; String &gt; collected = Stream.of(&quot;a&quot;, &quot;b&quot;, &quot;hello&quot;).map(string -&gt; string.toUpperCase())<span class="programlisting"><a id="4_CO1-11"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></span>.collect(toList());
assertEquals(asList(&quot;A&quot;, &quot;B&quot;, &quot;HELLO&quot;), collected);
</code></pre>
                            </div>
                        </div>
                        <p>The lambda expression passed into <code class="literal">map</code> <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#CO1-11"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>                            both takes a <code class="literal">String</code> as its onlyargument and returns a <code class="literal">String</code>. It isn’t necessary for both the argumentand the result to be the same type, but the lambda expression passed
                            in must bean instance of<a class="indexterm" id="4_id364999"></a> <code class="literal">Function</code> (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#Function_diagram">Figure 3-4</a>).
                            This is a generic functional interface withonly one argument.</p>
                        <div class="figure"><a id="4_Function_diagram"></a>
                            <div class="figure-contents">
                                <div class="mediaobject"><img alt="the Function interface" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0304.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0304.png" width="496"/></div>
                            </div>
                            <div class="figure-title">Figure 3-4. The Function interface</div>
                        </div>
                    </div>
                    <div class="sect2">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h3 class="title" id="_filter">filter</h3>
                                </div>
                            </div>
                        </div>
                        <div class="note">
                            <h3 class="title">Note</h3>
                            <p><a class="indexterm" id="4_id293162"></a><a class="indexterm" id="4_id293168"></a><a class="indexterm" id="4_id293177"></a>Any time you’re looping over some data and checking each element, you might want to think about using the
                                new <code class="literal">filter</code> method on <code class="literal">Stream</code> (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#jvld_0305">Figure 3-5</a>).</p>
                        </div>
                        <div class="figure"><a id="4_jvld_0305"></a>
                            <div class="figure-contents">
                                <div class="mediaobject"><img alt="the filter operation" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0305.png" height="533" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0305.png" width="744"/></div>
                            </div>
                            <div class="figure-title">Figure 3-5. The filter operation</div>
                        </div>
                        <p>We’ve already looked at a <code class="literal">filter</code> example, so you may want to skip thissection if you feel familiar with the concept. Still here? Good! Supposewe’ve got a list of strings and we want to find all the
                            strings that startwith a digit. So, <code class="literal">1abc</code> would be accepted and <code class="literal">abc</code> wouldn’t. We mightwrite some code that loops over a list and uses an <code class="literal">if</code>                            statement to see whatthe first character is, something like the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#strings_numbers_for">Example 3-10</a>.</p>
                        <div class="example"><a id="4_strings_numbers_for"></a>
                            <div class="example-title">Example 3-10. Looping over a list and using an if statement</div>
                            <div class="example-contents">
                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> beginningWithNumbers <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ArrayList</span> &lt; > ();
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">String</span> value<span style="color:#00f;font-weight:700">:</span> asList(<span style="color:#036a07">"a"</span>, <span style="color:#036a07">"1abc"</span>, <span style="color:#036a07">"abc1"</span>)) {
 <span style="color:#00f;font-weight:700">if</span> (isDigit(value<span style="color:#00f;font-weight:700">.</span>charAt(<span style="color:#0000cd">0</span>))) {
  beginningWithNumbers<span style="color:#00f;font-weight:700">.</span>add(value);
 }
}
assertEquals(asList(<span style="color:#036a07">"1abc"</span>), beginningWithNumbers);
</pre>
                            </div>
                    </div>
                    <p>I’m sure you’ve written some code that looks like this: it’s called the<code class="literal">filter</code> pattern. The central idea of <code class="literal">filter</code> is to retain some elements ofthe <code class="literal">Stream</code>,
                        while throwing others out. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#strings_numbers_filter">Example 3-11</a> shows how you would write the samecode in a functional
                        style.</p>
                    <div class="example"><a id="4_strings_numbers_filter"></a>
                        <div class="example-title">Example 3-11. Functional style</div>
                        <div class="example-contents">
                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> beginningWithNumbers <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Stream</span><span style="color:#00f;font-weight:700">.</span>of(<span style="color:#036a07">"a"</span>, <span style="color:#036a07">"1abc"</span>, <span style="color:#036a07">"abc1"</span>)<span style="color:#00f;font-weight:700">.</span>filter(value <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> isDigit(value<span style="color:#00f;font-weight:700">.</span>charAt(<span style="color:#0000cd">0</span>)))<span style="color:#00f;font-weight:700">.</span>collect(toList());
assertEquals(asList(<span style="color:#036a07">"1abc"</span>), beginningWithNumbers);
</pre>
                        </div>
                    </div>
                    <p>Much like <code class="literal">map</code>, <code class="literal">filter</code> is a method that takes just a single function as anargument—here we’re using a lambda expression. This function does the samejob that the expression in
                        the <code class="literal">if</code> statement did earlier. Here, itreturns <code class="literal">true</code> if the <code class="literal">String</code> starts with a digit. If you’re refactoringlegacy code, the presence of an
                        <code class="literal">if</code> statement in the middle of a <code class="literal">for</code>loop is a pretty strong indicator that you really want to use <code class="literal">filter</code>.</p>
                    <p>Because this function is doing the same job as the <code class="literal">if</code> statement, it must returneither <code class="literal">true</code> or <code class="literal">false</code> for a given value. The <code class="literal">Stream</code>                        after the filter hasthe elements of the <code class="literal">Stream</code> beforehand, which evaluated to <code class="literal">true</code>. Thefunctional interface for this type of function is our old friend from theprevious
                        chapter, the<a class="indexterm" id="4_id320686"></a> <code class="literal">Predicate</code> (shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#Predicate_diagram2">Figure 3-6</a>).</p>
                    <div class="figure"><a id="4_Predicate_diagram2"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt="the Predicate interface" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0202.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0202.png" width="581"/></div>
                        </div>
                        <div class="figure-title">Figure 3-6. The Predicate interface</div>
                </div>
        </div>
        <div class="sect2">
            <div class="titlepage">
                <div>
                    <div>
                        <h3 class="title" id="_flatmap">flatMap</h3>
                    </div>
                </div>
            </div>
            <div class="note">
                <h3 class="title">Note</h3>
                <p><a class="indexterm" id="4_id292345"></a><a class="indexterm" id="4_id292351"></a><code class="literal">flatMap</code> (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#jvld_0307">Figure 3-7</a>)
                    lets you replace a value with a <code class="literal">Stream</code> and concatenates all the streams together.</p>
            </div>
            <div class="figure"><a id="4_jvld_0307"></a>
                <div class="figure-contents">
                    <div class="mediaobject"><img alt="the flatMap operation" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0307.png" height="579" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0307.png" width="850"/></div>
                </div>
                <div class="figure-title">Figure 3-7. The flatMap operation</div>
            </div>
            <p>You’ve already seen the <code class="literal">map</code> operation, which replaces a value in a <code class="literal">Stream</code>with a new value. Sometimes you want a variant of <code class="literal">map</code> in which you produce a new
                <code class="literal">Stream</code> object as the replacement. Frequently you don’t want to end upwith a stream of streams, though, and this is where <code class="literal">flatMap</code> comes in handy.</p>
            <p>Let’s look at a simple example. We’ve got a <code class="literal">Stream</code> of lists of numbers, and we wantall the numbers from these in sequences. We can solve this problem using an approachlike the one in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#stream-list-example">Example 3-12</a>.</p>
            <div class="example"><a id="4_stream-list-example"></a>
                <div class="example-title">Example 3-12. Stream list</div>
                <div class="example-contents">
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">></span> together <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Stream</span><span style="color:#00f;font-weight:700">.</span>of(asList(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">2</span>), asList(<span style="color:#0000cd">3</span>, <span style="color:#0000cd">4</span>))<span style="color:#00f;font-weight:700">.</span>flatMap(numbers <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> numbers<span style="color:#00f;font-weight:700">.</span>stream())<span style="color:#00f;font-weight:700">.</span>collect(toList());
assertEquals(asList(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">4</span>), together);
</pre>
                </div>
        </div>
        <p>In each case, we replace the <code class="literal">List</code> with a <code class="literal">Stream</code> using the <code class="literal">stream</code> method,and <code class="literal">flatMap</code> does the rest. Its associated functional interface
            is the sameas<a class="indexterm" id="4_id302681"></a> <code class="literal">map</code>’s—the <code class="literal">Function</code>—but its return type is restricted to streamsand not any value.</p>
    </div>
    <div class="sect2">
        <div class="titlepage">
            <div>
                <div>
                    <h3 class="title" id="_max_and_min">max and min</h3>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="4_id302708"></a><a class="indexterm" id="4_id302713"></a><a class="indexterm" id="4_id367285"></a><a class="indexterm" id="4_id367293"></a>A pretty common operation that we might want to perform on streams is findingthe maximum
            or minimum element. Fortunately, this case is very well covered bythe <code class="literal">max</code> and <code class="literal">min</code> operations that are provided by the Streams API. As ademonstration of these operations, <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#streamsMaxLength">Example 3-13</a> provides some code thatfinds the shortest track on an album. In order to make it easier to see thatwe’ve got the
            right result, I’ve explicitly listed the tracks on this album inthe code snippet; I’ll admit that it’s not the best-known album.</p>
        <div class="example"><a id="4_streamsMaxLength"></a>
            <div class="example-title">Example 3-13. Finding the shortest track with streams</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Track</span> <span style="color:#00f;font-weight:700">></span> tracks <span style="color:#00f;font-weight:700">=</span> asList(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Track</span>(<span style="color:#036a07">"Bakai"</span>, <span style="color:#0000cd">524</span>), <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Track</span>(<span style="color:#036a07">"Violets for Your Furs"</span>, <span style="color:#0000cd">378</span>), <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Track</span>(<span style="color:#036a07">"Time Was"</span>, <span style="color:#0000cd">451</span>));
<span style="color:#00f;font-weight:700">Track</span> shortestTrack <span style="color:#00f;font-weight:700">=</span> tracks<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>min(<span style="color:#00f;font-weight:700">Comparator</span><span style="color:#00f;font-weight:700">.</span>comparing(track <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> track<span style="color:#00f;font-weight:700">.</span>getLength()))<span style="color:#00f;font-weight:700">.</span>get();
assertEquals(tracks<span style="color:#00f;font-weight:700">.</span>get(<span style="color:#0000cd">1</span>), shortestTrack);
</pre>
            </div>
        </div>
        <p>When we think about maximum and minimum elements, the first thing we need tothink about is the ordering that we’re going to be using. When it comesto finding the shortest track, the ordering is provided by the length ofthe tracks.</p>
        <p>In order to inform the <code class="literal">Stream</code> that we’re using the length of the track, wegive it a<a class="indexterm" id="4_id320093"></a><a class="indexterm" id="4_id367350"></a><a class="indexterm" id="4_id320099"></a> <code class="literal">Comparator</code>.
            Conveniently, Java 8 has added a static method called<code class="literal">comparing</code> that lets us build a comparator using keys. Previously, we alwaysencountered an ugly pattern in which we had to write code that got a field out ofboth
            the objects being compared, then compare these field values. Now,to get the same element out of both elements being compared, we just provide agetter function for the value. In this case we’ll use <code class="literal">length</code>, which
            is agetter function in disguise.</p>
        <p>It’s worth reflecting on the <code class="literal">comparing</code> method for a moment. This is actually afunction that takes a function and returns a function. Pretty meta, I know, butalso incredibly useful. At any point in the past, this method
            could havebeen added to the Java standard library, but the poor readability and verbosityissues surrounding anonymous inner classes would have made it impractical. Now,with lambda expressions, it’s convenient and concise.</p>
        <p>It’s now possible for <code class="literal">max</code> to be called on an empty <code class="literal">Stream</code> so that it returnswhat’s known as an<a class="indexterm" id="4_id299875"></a> <code class="literal">Optional</code> value. An
            <code class="literal">Optional</code> value is a bit like analien: it represents a value that may exist, or may not. If our <code class="literal">Stream</code> isempty, then it won’t exist; if it’s not empty, then it will. Let’s not worryabout the details of
                <code class="literal">Optional</code> for the moment, since we’ll be discussing it indetail in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#Optional_sec">Optional</a>. The only thing to remember is that
                    we can pullout the value by calling the<a class="indexterm" id="4_id299887"></a> <code class="literal">get</code> method.</p>
    </div>
    <div class="sect2">
        <div class="titlepage">
            <div>
                <div>
                    <h3 class="title" id="_a_common_pattern_appears">A Common Pattern Appears</h3>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="4_id321355"></a><code class="literal">max</code> and <code class="literal">min</code> are both forms of a more general pattern of coding. Theeasiest way to see this is by taking our code from <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#streamsMaxLength">Example 3-13</a>            andrewriting it into a <code class="literal">for</code> loop: we’ll then extract the general pattern.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#imperativeMaxLength">Example 3-14</a>            performs the same role as <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#streamsMaxLength">Example 3-13</a>: itfinds the shortest track on an album, but using a <code class="literal">for</code>            loop.</p>
        <div class="example"><a id="4_imperativeMaxLength"></a>
            <div class="example-title">Example 3-14. Finding the shortest track with a for loop</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Track</span> <span style="color:#00f;font-weight:700">></span> tracks <span style="color:#00f;font-weight:700">=</span> asList(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Track</span>(<span style="color:#036a07">"Bakai"</span>, <span style="color:#0000cd">524</span>), <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Track</span>(<span style="color:#036a07">"Violets for Your Furs"</span>, <span style="color:#0000cd">378</span>), <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Track</span>(<span style="color:#036a07">"Time Was"</span>, <span style="color:#0000cd">451</span>));
<span style="color:#00f;font-weight:700">Track</span> shortestTrack <span style="color:#00f;font-weight:700">=</span> tracks<span style="color:#00f;font-weight:700">.</span>get(<span style="color:#0000cd">0</span>);
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Track</span> track<span style="color:#00f;font-weight:700">:</span> tracks) {
 <span style="color:#00f;font-weight:700">if</span> (track<span style="color:#00f;font-weight:700">.</span>getLength() <span style="color:#00f;font-weight:700">&lt;</span> shortestTrack<span style="color:#00f;font-weight:700">.</span>getLength()) {
  shortestTrack <span style="color:#00f;font-weight:700">=</span> track;
 }
}
assertEquals(tracks<span style="color:#00f;font-weight:700">.</span>get(<span style="color:#0000cd">1</span>), shortestTrack);
</pre>
            </div>
        </div>
        <p>The code starts by initializing our <code class="literal">shortestTrack</code> variable with thefirst element of the list. Then it goes through the tracks. If there’s ashorter track, it replaces the <code class="literal">shortestTrack</code>.
            At the end, our <code class="literal">shortestTrack</code>variable contains its namesake. Doubtless you’ve written thousands of <code class="literal">for</code>loops in your coding career, and many of them follow this pattern. Thepseudocode
            in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#reduce_pattern">Example 3-15</a> characterizes the general form.</p>
        <div class="example"><a id="4_reduce_pattern"></a>
            <div class="example-title">Example 3-15. The reduce pattern</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Object</span> accumulator <span style="color:#00f;font-weight:700">=</span> initialValue;
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Object</span> element<span style="color:#00f;font-weight:700">:</span> collection) {
 accumulator <span style="color:#00f;font-weight:700">=</span> combine(accumulator, element);
}
</pre>
            </div>
        </div>
        <p>An<a class="indexterm" id="4_id366143"></a> <code class="literal">accumulator</code> gets pushed through the body of the loop, with the finalvalue of the <code class="literal">accumulator</code> being the value that we were trying to compute.The
            <code class="literal">accumulator</code> starts with an <code class="literal">initialValue</code> and then gets folded togetherwith each <code class="literal">element</code> of the list by calling <code class="literal">combine</code>.</p>
        <p>The things that differ between implementations of this pattern arethe <code class="literal">initialValue</code> and the <code class="literal">combine</code> function. In the original example, weused the first element in the list as our <code class="literal">initialValue</code>,
            but it doesn’t haveto be. In order to find the shortest value, our <code class="literal">combine</code> returned the shortertrack of out of the current <code class="literal">element</code> and the <code class="literal">accumulator</code>.</p>
        <p>We’ll now take a look at how this general pattern can be codified by anoperation in the Streams API itself.</p>
    </div>
    <div class="sect2">
        <div class="titlepage">
            <div>
                <div>
                    <h3 class="title" id="_reduce">reduce</h3>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="4_ix_ch03-asciidoc9"></a><a class="indexterm" id="4_ix_ch03-asciidoc10"></a>Use the <code class="literal">reduce</code> operation when you’ve got a collection of values and youwant to generate a single result. In earlier examples,
            we used the <code class="literal">count</code>,<code class="literal">min</code>, and <code class="literal">max</code> methods, which are all in the standard library because theyare common use cases. All of these are forms of reduction.</p>
        <p>Let’s demonstrate the <code class="literal">reduce</code> operation by adding up streams of numbers. Theoverall pattern is demonstrated in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#reduce_example_1_diagram">Figure 3-8</a>.
            We start witha count of 0—the count of an empty <code class="literal">Stream</code>—and fold together each elementwith an accumulator, adding the element to the accumulator at every step. Whenwe reach the final <code class="literal">Stream</code>            element, our accumulator has the sum of all theelements.</p>
        <div class="figure"><a id="4_reduce_example_1_diagram"></a>
            <div class="figure-contents">
                <div class="mediaobject"><img alt="Implementing addition using the reduce operation" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0308.png" height="539" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0308.png" width="554"/></div>
            </div>
            <div class="figure-title">Figure 3-8. Implementing addition using the reduce operation</div>
        </div>
        <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#reduce_example_1">Example 3-16</a> shows what is going on in code. The lambda expression,known as a <span class="emphasis"><em>reducer</em></span>,
            performs the summing and takes two arguments. <code class="literal">acc</code> is theaccumulator and holds the current sum. It is also passed in the current element in the <code class="literal">Stream</code>.</p>
        <div class="example"><a id="4_reduce_example_1"></a>
            <div class="example-title">Example 3-16. Implementing sum using reduce</div>
            <div class="example-contents">
               <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>int count = Stream.of(1, 2, 3).reduce(0, (acc, element) -&gt; acc + element);
assertEquals(6, count);
</code></pre>
            </div>
        </div>
        <p>The lambdaexpression returns the new <code class="literal">acc</code> value, which is the previous <code class="literal">acc</code> added tothe current element. The type of the reducer is a <code class="literal">BinaryOperator</code>, which weencountered
            in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html">Chapter 2</a>.</p>
        <div class="note">
            <h3 class="title">Note</h3>
            <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#primitives_section">Primitives</a> also refers to an implementation of <code class="literal">sum</code> within thestandard library, which
                is recommended instead of the approach shown in this example in real code.</p>
        </div>
        <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#reduce_example_table">Table 3-1</a> shows the intermediate values for these variables foreach element in the <code class="literal">Stream</code>.
            In fact, we could expand all the functionapplications that <code class="literal">reduce</code> to produce the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#reduce_example_expanded">Example 3-17</a>.</p>
        <div class="example"><a id="4_reduce_example_expanded"></a>
            <div class="example-title">Example 3-17. Expanding the application of reduce</div>
            <div class="example-contents">
              <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>BinaryOperator &lt; Integer &gt; accumulator = (acc, element) -&gt; acc + element;
int count = accumulator.apply(accumulator.apply(accumulator.apply(0, 1), 2), 3);
</code></pre>
            </div>
    </div>
    <div class="table"><a id="4_reduce_example_table"></a>
        <div class="table-title">Table 3-1. Evaluating a sum reduce</div>
        <div class="table-contents">
            <table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; ">
                <colgroup>
                    <col class="col_1">
                    <col class="col_2">
                    <col class="col_3">
                </colgroup>
                <thead>
                    <tr>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">element</td>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">acc</td>
                        <td style="border-bottom: 0.5pt solid ; ">Result</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                            <p>N/A</p>
                        </td>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                            <p>N/A</p>
                        </td>
                        <td style="border-bottom: 0.5pt solid ; ">
                            <p>0</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                            <p>1</p>
                        </td>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                            <p>0</p>
                        </td>
                        <td style="border-bottom: 0.5pt solid ; ">
                            <p>1</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                            <p>2</p>
                        </td>
                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                            <p>1</p>
                        </td>
                        <td style="border-bottom: 0.5pt solid ; ">
                            <p>3</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="border-right: 0.5pt solid ; ">
                            <p>3</p>
                        </td>
                        <td style="border-right: 0.5pt solid ; ">
                            <p>3</p>
                        </td>
                        <td>
                            <p>6</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <p>Let’s look at the equivalent imperative Java code, written in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#reduce_example_2">Example 3-18</a>, so we can see how the functional and imperative
        versionsmatch up.</p>
    <div class="example"><a id="4_reduce_example_2"></a>
        <div class="example-title">Example 3-18. Imperative implementation of summing</div>
        <div class="example-contents">
            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>int acc = 0;
for (Integer element: asList(1, 2, 3)) {
 acc = acc + element;
}
assertEquals(6, acc);
</code></pre>
        </div>
    </div>
    <p>In the imperative version, we can see that the accumulator is a variable we update onevery loop iteration. We also update it by adding the element. The loop isexternal to the collection and all updates to the variable are managedmanually.<a class="indexterm" id="4_id331973"></a><a class="indexterm" id="4_id361103"></a></p>
    </div>
    <div class="sect2">
        <div class="titlepage">
            <div>
                <div>
                    <h3 class="title" id="_putting_operations_together">Putting Operations Together</h3>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="4_id361079"></a><a class="indexterm" id="4_id361088"></a>With so many different operations related to the <code class="literal">Stream</code> interface, it cansometimes seem like you’re wandering around a labyrinth looking
            for what youwant. So let’s work through a problem and see how it breaks down into simple<code class="literal">Stream</code> operations.</p>
        <p>Our first problem to solve is, for a given album, to find the nationality of everyband playing on that album. The artists who play each track can be soloartists or they can be in a band. We’re going to use domain knowledge andartistic license
            to pretend that a band is really an artist whose name beginswith <span class="emphasis"><em>The</em></span>. This isn’t exactly right, but it’s pretty close!</p>
        <p>The first thing to recognize is that the solution isn’t just the simple applicationof any individual API call. It’s not transforming the values like a <code class="literal">map</code>, it’snot filtering, and it’s not just getting a single value
            out of a <code class="literal">Stream</code> at the end.We can break the problem down into parts:</p>
        <div class="orderedlist">
            <ol class="orderedlist" type="1">
                <li class="listitem">Get all the artists for an album.</li>
                <li class="listitem">Figure out which artists are bands.</li>
                <li class="listitem">Find the nationalities of each band.</li>
                <li class="listitem">Put together a set of these values.</li>
            </ol>
        </div>
        <p>Now it’s easier to see how these steps fit into the API:</p>
        <div class="orderedlist">
            <ol class="orderedlist" type="1">
                <li class="listitem">There’s a nice <code class="literal">getMusicians</code> method on our <code class="literal">Album</code> class that returns a <code class="literal">Stream</code>.</li>
                <li class="listitem">We use <code class="literal">filter</code> to trim down the artists to include only bands.</li>
                <li class="listitem">We use <code class="literal">map</code> to turn the band into its nationality.</li>
                <li class="listitem">We use <code class="literal">collect(toList())</code> to put together a list of these nationalities.</li>
            </ol>
        </div>
        <p>When we put everything together, it ends up like this:</p>
        <div class="informalexample"><a id="4_origins_bands_the"></a>
            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>Set &lt; String &gt; origins = album.getMusicians().filter(artist -&gt; artist.getName().startsWith(&quot;The&quot;)).map(artist -&gt; artist.getNationality()).collect(toSet());
</code></pre>
        </div>
        <p>This example shows the idiom of chaining operations a bit more clearly. Thecalls to <code class="literal">musicians</code>, <code class="literal">filter</code>, and <code class="literal">map</code> all return <code class="literal">Stream</code>            objects, so theyare lazy, while the <code class="literal">collect</code> method is eager. The <code class="literal">map</code> method is anotherfunction that takes just a lambda and whose purpose is to apply the function toevery element in
            the <code class="literal">Stream</code>, returning a new <code class="literal">Stream</code>.</p>
        <p>Our domain class here is actually quite convenient for us, in that it returns a <code class="literal">Stream</code>when we want to get a list of the musicians on our album. In your existingdomain classes, you probably don’t have a method that
            returns streams—you returnexisting collection classes such as <code class="literal">List</code> or <code class="literal">Set</code>. This is OK; all you need todo is call the <code class="literal">stream</code> method on your <code class="literal">List</code>            or <code class="literal">Set</code>.</p>
        <p><a class="indexterm" id="4_id345317"></a>Now is probably a good time to think about whether you really want to expose<code class="literal">List</code> and <code class="literal">Set</code> objects in your domain model, though. Perhaps a <code class="literal">Stream</code>            factorywould be a better choice. The big win of only exposing collections via<code class="literal">Stream</code> is that it better encapsulates your domain model’s data structure.It’s impossible for any use of your domain classes to affect
            the inner workingsof your <code class="literal">List</code> or <code class="literal">Set</code> simply by exposing a <code class="literal">Stream</code>.</p>
        <p>It also encourages users of your domain class to write code in a more modernJava 8 style. It’s possible to incrementally refactor to this style by keepingyour existing getters and adding new <code class="literal">Stream</code>-returning getters.
            Over time, youcan rewrite your legacy code until you’ve finally deleted all getters that returna <code class="literal">List</code> or <code class="literal">Set</code>. This kind of refactoring feels really good once you’vecleared out all the
            legacy code!<a class="indexterm" id="4_id298912"></a><a class="indexterm" id="4_id298903"></a></p>
    </div>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_refactoring_legacy_code" style="clear: both">Refactoring Legacy Code</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="4_ix_ch03-asciidoc11"></a><a class="indexterm" id="4_ix_ch03-asciidoc12"></a><a class="indexterm" id="4_ix_ch03-asciidoc13"></a>Having talked a bit about refactoring already, let’s look at an exampleof some legacy collections
            code that uses loops to perform a task anditeratively refactor it into a stream-based implementation. At eachstep of the refactor, the code continues to pass its tests, though you’lleither have to trust me on that one or test it yourself!</p>
        <p>This example finds the names of all tracks that are over a minute in length,given some albums. Our legacy code is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#findLongTracks_0">Example 3-19</a>.
            We startoff by initializing a <code class="literal">Set</code> that we’ll store all the track names in. The codethen iterates, using a <code class="literal">for</code> loop, over all the albums, then iterates againover all the tracks in an
            album. Once we’ve found a track, we check whetherthe length is over 60 seconds, and if it is the name gets added toa <code class="literal">Set</code> of names.</p>
        <div class="example"><a id="4_findLongTracks_0"></a>
            <div class="example-title">Example 3-19. Legacy code finding names of tracks over a minute in length</div>
            <div class="example-contents">
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> findLongTracks(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">></span> albums) {
 <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> trackNames <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; > ();
 <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Album</span> album<span style="color:#00f;font-weight:700">:</span> albums) {
  <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Track</span> track<span style="color:#00f;font-weight:700">:</span> album<span style="color:#00f;font-weight:700">.</span>getTrackList()) {
   <span style="color:#00f;font-weight:700">if</span> (track<span style="color:#00f;font-weight:700">.</span>getLength() <span style="color:#00f;font-weight:700">></span> <span style="color:#0000cd">60</span>) {
    <span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> track<span style="color:#00f;font-weight:700">.</span>getName();
    trackNames<span style="color:#00f;font-weight:700">.</span>add(name);
   }
  }
 }
 <span style="color:#00f;font-weight:700">return</span> trackNames;
}
</pre>
            </div>
        </div>
        <p>We’ve stumbled across this code in our code base and noticed that it has a coupleof nested loops. It’s not quite clear what the purpose of this code is just fromlooking at it, so we decide to undertake our refactor. (There are lots ofdifferent
            approaches to refactoring legacy code for using streams—this isjust one. In fact, once you are more familiar with the API itself, it’spretty likely that you won’t need to proceed in such small steps. It serveseducational purposes here to go
            a bit slower than you would in your professional job.)</p>
        <p><a class="indexterm" id="4_ix_ch03-asciidoc14"></a>The first thing that we’re going to change is the <code class="literal">for</code> loops. We’ll keep theirbodies in the existing Java coding style for now and move to using the<code class="literal">forEach</code>            method on <code class="literal">Stream</code>. This can be a pretty handy trick for intermediaterefactoring steps. Let’s use the <code class="literal">stream</code> method on our album list in order toget the first stream. It’s also good to
            remember from the previous section thatour domain already has the <code class="literal">getTracks</code> method on the album, which provides us a<code class="literal">Stream</code> of tracks. The code after we’ve completed step 1 is listed
            in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#findLongTracks_1">Example 3-20</a>.</p>
        <div class="example"><a id="4_findLongTracks_1"></a>
            <div class="example-title">Example 3-20. Refactor step 1: finding names of tracks over a minute in length</div>
            <div class="example-contents">
             <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> findLongTracks(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">></span> albums) {
 <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> trackNames <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; > ();
 albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>forEach(album <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> {
  album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>forEach(track <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> {
   <span style="color:#00f;font-weight:700">if</span> (track<span style="color:#00f;font-weight:700">.</span>getLength() <span style="color:#00f;font-weight:700">></span> <span style="color:#0000cd">60</span>) {
    <span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> track<span style="color:#00f;font-weight:700">.</span>getName();
    trackNames<span style="color:#00f;font-weight:700">.</span>add(name);
   }
  });
 });
 <span style="color:#00f;font-weight:700">return</span> trackNames;
}
</pre>
            </div>
        </div>
        <p>In step 1, we moved to using streams, but we didn’t really get their full potential.In fact, if anything the code is even less pretty than it was to begin with—d’oh!So, it’s high time we introduced a bit more stream style into our coding. The
            inner<code class="literal">forEach</code> call looks like a prime target for refinement.</p>
        <p>We’re really doing three things here: finding only tracks over a minute in length,getting their names, and adding their names into our name <code class="literal">Set</code>. That means weneed to call three <code class="literal">Stream</code> operations
            in order to get the job done. Finding tracksthat meet a criterion sounds like a job for <code class="literal">filter</code>. Transforming tracks into their namesis a good use of <code class="literal">map</code>. For the moment we’re still
            going to add the tracksto our <code class="literal">Set</code>, so our terminal operation will still be a <code class="literal">forEach</code>. If we splitout the inner <code class="literal">forEach</code> block, we end up with <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#findLongTracks_2">Example 3-21</a>.</p>
        <div class="example"><a id="4_findLongTracks_2"></a>
            <div class="example-title">Example 3-21. Refactor step 2: finding names of tracks over a minute in length</div>
            <div class="example-contents">
          <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> findLongTracks(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">></span> albums) {
 <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> trackNames <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; > ();
 albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>forEach(album <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> {
  album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>filter(track <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> track<span style="color:#00f;font-weight:700">.</span>getLength() <span style="color:#00f;font-weight:700">></span> <span style="color:#0000cd">60</span>)<span style="color:#00f;font-weight:700">.</span>map(track <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> track<span style="color:#00f;font-weight:700">.</span>getName())<span style="color:#00f;font-weight:700">.</span>forEach(name <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> trackNames<span style="color:#00f;font-weight:700">.</span>add(name));
 });
 <span style="color:#00f;font-weight:700">return</span> trackNames;
}
</pre>
            </div>
        </div>
        <p>Now we’ve replaced our inner loop with something a bit more streamy, but we stillhave this pyramid of doom in our code. We don’t really want to have nestedstream operations; we want one simple and clean sequence of method calls.</p>
        <p>What we really want to do is find a way of transforming our album into astream of tracks. We know that whenever we want to <span class="emphasis"><em>transform</em></span> or <span class="emphasis"><em>replace</em></span>code, the operation to
            use is <code class="literal">map</code>. This is the more complex case of <code class="literal">map</code>,<code class="literal">flatMap</code>, for which the output value is also a <code class="literal">Stream</code> and we want them mergedtogether.
            So, if we replace that <code class="literal">forEach</code> block with a <code class="literal">flatMap</code> call,we end up at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#findLongTracks_3">Example 3-22</a>.</p>
        <div class="example"><a id="4_findLongTracks_3"></a>
            <div class="example-title">Example 3-22. Refactor step 3: finding names of tracks over a minute in length</div>
            <div class="example-contents">
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> findLongTracks(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">></span> albums) {
 <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">></span> trackNames <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; > ();
 albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>flatMap(album <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> album<span style="color:#00f;font-weight:700">.</span>getTracks())<span style="color:#00f;font-weight:700">.</span>filter(track <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> track<span style="color:#00f;font-weight:700">.</span>getLength() <span style="color:#00f;font-weight:700">></span> <span style="color:#0000cd">60</span>)<span style="color:#00f;font-weight:700">.</span>map(track <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> track<span style="color:#00f;font-weight:700">.</span>getName())<span style="color:#00f;font-weight:700">.</span>forEach(name <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">></span> trackNames<span style="color:#00f;font-weight:700">.</span>add(name));
 <span style="color:#00f;font-weight:700">return</span> trackNames;
}



</pre>
            </div>
    </div>
    <p>That looks a lot better, doesn’t it? Instead of two nested <code class="literal">for</code> loops, we’ve gota single clean sequence of method calls performing the entire operation. It’snot quite there yet, though. We’re still creating a <code class="literal">Set</code>        by hand and addingevery element in at the end. We really want the entire computation to justbe a chain of <code class="literal">Stream</code> calls.</p>
    <p>I haven’t yet shown you the recipe for this transformation, but you’ve met one of itsfriends. Just as you can use <code class="literal">collect(toList())</code> to build up a <code class="literal">List</code> ofvalues at the end, you can also use
        <code class="literal">collect(toSet())</code> to build up a <code class="literal">Set</code>of values. So, we replace our final <code class="literal">forEach</code> call with this <code class="literal">collect</code> call, andwe can now delete
        the <code class="literal">trackNames</code> variable, arriving at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#findLongTracks_4">Example 3-23</a>.<a class="indexterm" id="4_id290828"></a></p>
    <div class="example"><a id="4_findLongTracks_4"></a>
        <div class="example-title">Example 3-23. Refactor step 4: finding names of tracks over a minute in length</div>
        <div class="example-contents">
          <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>public Set &lt; String &gt; findLongTracks(List &lt; Album &gt; albums) {
 return albums.stream().flatMap(album -&gt; album.getTracks()).filter(track -&gt; track.getLength() &gt; 60).map(track -&gt; track.getName()).collect(toSet());
}
</code></pre>
        </div>
        </div>
        <p>In summary, we’ve taken a snippet of legacy code and refactored it to useidiomatic streams. At first we just converted to introduce streams and didn’tintroduce any of the useful operations on streams. At each subsequent step, we moved to amore
            idiomatic coding style. One thing that I haven’t mentioned thus far butthat was very helpful when actually writing the code samples is that at eachstep of the way I continued to run unit tests in order to make sure the codeworked. Doing so
            is very helpful when refactoring legacy code.<a class="indexterm" id="4_id326405"></a><a class="indexterm" id="4_id296005"></a><a class="indexterm" id="4_id296011"></a></p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_multiple_stream_calls" style="clear: both">Multiple Stream Calls</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="4_id394614"></a>Rather than chaining the method calls, you could force the evaluation of eachfunction individually following a sequence of steps. <span class="emphasis"><em>Please</em></span> don’t do this.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#stream_misuse_1">Example 3-24</a> shows our earlier origins of bands example written inthat style. The original example is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#origins_bands_the_misuse">Example 3-25</a> in order tomake the comparison easier.</p>
            <div class="example"><a id="4_stream_misuse_1"></a>
                <div class="example-title">Example 3-24. Stream misuse</div>
                <div class="example-contents">
                   <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>List &lt; Artist &gt; musicians = album.getMusicians().collect(toList());
List &lt; Artist &gt; bands = musicians.stream().filter(artist -&gt; artist.getName().startsWith(&quot;The&quot;)).collect(toList());
Set &lt; String &gt; origins = bands.stream().map(artist -&gt; artist.getNationality()).collect(toSet());
</code></pre>
                </div>
            </div>
            <div class="example"><a id="4_origins_bands_the_misuse"></a>
                <div class="example-title">Example 3-25. Idiomatically chained stream calls</div>
                <div class="example-contents">
                    <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>Set &lt; String &gt; origins = album.getMusicians().filter(artist -&gt; artist.getName().startsWith(&quot;The&quot;)).map(artist -&gt; artist.getNationality()).collect(toSet());
</code></pre>
                </div>
            </div>
            <p>There are several reasons why the version in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#stream_misuse_1">Example 3-24</a> is worse than the idiomatic, chained version:</p>
            <div class="itemizedlist">
                <ul class="itemizedlist">
                    <li class="listitem">It’s harder to read what’s going on because the ratio of boilerplate code to actual business logic is worse.</li>
                    <li class="listitem">It’s less efficient because it requires eagerly creating new collection objects at each intermediate step.</li>
                    <li class="listitem">It clutters your method with meaningless garbage variables that are needed only as intermediate results.</li>
                    <li class="listitem">It makes operations harder to automatically parallelize.</li>
                </ul>
        </div>
        <p>Of course, if you’re writing your first few <code class="literal">Stream</code>-based examples, it’sperfectly normal to write code that’s a little bit like this. But if youfind yourself writing blocks of operations like this often, you should
            stand backand see whether you can refactor them into a more concise and readable form.</p>
        <div class="note">
            <h3 class="title">Note</h3>
            <p>If at this stage you feel uncomfortable with the amount of method chaining in theAPI, that’s entirely natural. With more experience and more time these concepts will beginto feel quite natural, and it’s not a reason to write Java code that
                splits up chainsof operations as in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#stream_misuse_1">Example 3-24</a>. Ensuring that you format the code line by line,as you would
                when using the builder pattern, will boost your comfort level as well.</p>
        </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_higher_order_functions" style="clear: both">Higher-Order Functions</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="4_id323453"></a><a class="indexterm" id="4_id323465"></a>What we’ve repeatedly encountered throughout this chapter are what functionalprogrammers call <span class="emphasis"><em>higher-order functions</em></span>. A higher-order
                function is afunction that either takes another function as an argument or returns afunction as its result. It’s very easy to spot a higher-order function: justlook at its signature. If a functional interface is used as a parameter orreturn
                type, you have a higher-order function.</p>
            <p><code class="literal">map</code> is a higher-order function because its <code class="literal">mapper</code> argument is afunction. In fact, nearly all the functions that we’ve encountered on the<code class="literal">Stream</code> interface
                are higher-order functions. In our earlier sorting example,we also used the <code class="literal">comparing</code> function. <code class="literal">comparing</code> not only took anotherfunction in order to extract an index value, but also
                returns a new<code class="literal">Comparator</code>. You might think of a <code class="literal">Comparator</code> as an object, but it has onlya single abstract method, so it’s a functional interface.</p>
            <p>In fact, we can make a stronger statement than that. <code class="literal">Comparator</code> was inventedwhen a function was needed, but all Java had at the time was objects, so we madea type of class—an anonymous class—that we could treat
                like a function. Beingan object was always accidental. Functional interfaces are a step in thedirection that we actually want.</p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_good_use_of_lambda_expressions" style="clear: both">Good Use of Lambda Expressions</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="4_id332960"></a>When I first introduced lambda expressions, I gave the example of a callbackthat printed something out. That’s a perfectly valid lambda expression, but it’snot really helping us write simpler and more
                abstract code because it’s stilltelling the computer to perform an operation. Removing the boilerplate wasnice, but it’s not the only improvement we get with lambda expressions in Java8.</p>
            <p>The concepts introduced in this chapter let us write simpler code,in the sense that they describe operations on data by saying <span class="emphasis"><em>what</em></span>transformation is made rather than <span class="emphasis"><em>how</em></span>                the transformation occurs. This givesus code that has less potential for bugs and expresses the programmer’s intentdirectly.</p>
            <p><a class="indexterm" id="4_id332985"></a>Another aspect of getting to the <span class="emphasis"><em>what</em></span> and not the <span class="emphasis"><em>how</em></span> is the idea of a <span class="emphasis"><em>side effect–free</em></span>                function. These are important because we can understand the fullimplications of what the functions are doing just by looking at what values theyreturn.</p>
            <p>Functions with no side effects don’t change the state of anything else in theprogram or the outside world. The first lambda expression in this book hadside effects because it printed some output on the console—an <span class="emphasis"><em>observable</em></span>side
                effect of the function. What about the following example?</p>
           <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>   private ActionEvent lastEvent;
   private void registerHandler() {
    button.addActionListener((ActionEvent event) -&gt; {
     this.lastEvent = event;
    });
   }
</code></pre>
            <p>Here we save away the <code class="literal">event</code> parameter into a field. This is a more subtleway of generating a side effect: assigning to variables. You may notsee it directly in the output of your program, but it does change the
                program’sstate. There are limits to what Java lets you do in this regard. Take a lookat the assignment to <code class="literal">localEvent</code> in this code snippet:</p>
            <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>ActionEvent localEvent = null;
button.addActionListener(event -&gt; {
 localEvent = event;
});
</code></pre>
            <p>This example tries to assign the same <code class="literal">event</code> parameter into a local variable.There’s no need to send me errata emails—I know this won’t actually compile!That’s actually a deliberate choice on behalf of the designers:
                an attempt toencourage people to use lambda expressions to capture values rather thancapturing variables. Capturing values encourages people to write code that isfree from side effects by making it harder to do so. As mentioned in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html">Chapter 2</a>, eventhough local variables don’t need the <code class="literal">final</code> keyword in order to be used inlambda expressions,
                they still need to be <span class="emphasis"><em>effectively</em></span> <code class="literal">final</code>.</p>
            <p>Whenever you pass lambda expressions into the higher-order functions on the <code class="literal">Stream</code> interface, you should seek to avoid side effects. The only exception to this is the <code class="literal">forEach</code> method,
                which is a terminal operation.</p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_key_points_2" style="clear: both">Key Points</h2>
                    </div>
                </div>
            </div>
            <div class="itemizedlist">
                <ul class="itemizedlist">
                    <li class="listitem">Internal iteration is a way of iterating over a collection that delegatesmore control over the iteration to the collection.</li>
                    <li class="listitem">A <code class="literal">Stream</code> is the internal iteration analogue of an <code class="literal">Iterator</code>.</li>
                    <li class="listitem">Many common operations on collections can be performed by combining methods on<code class="literal">Stream</code> with lambda expressions.<a class="indexterm" id="4_id306300"></a><a class="indexterm" id="4_id306307"></a></li>
                </ul>
            </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_exercises_2" style="clear: both">Exercises</h2>
                    </div>
                </div>
            </div>
            <div class="note">
                <h3 class="title">Note</h3>
                <p>You can find the answers to these exercises on <a class="ulink" href="https://github.com/RichardWarburton/java-8-lambdas-exercises" target="_top">GitHub</a>.</p>
            </div>
            <div class="orderedlist">
                <ol class="orderedlist" type="1">
                    <li class="listitem">
                        <p class="simpara"><span class="emphasis"><em>Common Stream operations</em></span>. Implement the following:</p>
                        <div class="orderedlist">
                            <ol class="orderedlist" type="a">
                                <li class="listitem">A function that adds up numbers, i.e., <code class="literal">int addUp(Stream&lt;Integer&gt; numbers)</code></li>
                                <li class="listitem">A function that takes in artists and returns a list of strings with their names and places of origin</li>
                                <li class="listitem">A function that takes in albums and returns a list of albums with at most three tracks</li>
                            </ol>
                        </div>
                    </li>
                    <li class="listitem">
                        <p class="simpara"><span class="emphasis"><em>Iteration</em></span>. Convert this code sample from using external iteration to internal iteration:</p>
                     <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code> int totalMembers = 0;
 for (Artist artist: artists) {
  Stream &lt; Artist &gt; members = artist.getMembers();
  totalMembers += members.count();
 }
</code></pre>
                    </li>
                    <li class="listitem">
                        <p class="simpara"><span class="emphasis"><em>Evaluation</em></span>. Take a look at the signatures of these <code class="literal">Stream</code> methods. Are they eager or lazy?</p>
                        <div class="orderedlist">
                            <ol class="orderedlist" type="a">
                                <li class="listitem"><code class="literal">boolean anyMatch(Predicate&lt;? super T&gt; predicate);</code></li>
                                <li class="listitem"><code class="literal">Stream&lt;T&gt; limit(long maxSize);</code></li>
                            </ol>
                        </div>
                    </li>
                    <li class="listitem">
                        <p class="simpara"><span class="emphasis"><em>Higher-order functions</em></span>. Are these <code class="literal">Stream</code> functions higher order, and why?</p>
                        <div class="orderedlist">
                            <ol class="orderedlist" type="a">
                                <li class="listitem"><code class="literal">boolean anyMatch(Predicate&lt;? super T&gt; predicate);</code></li>
                                <li class="listitem"><code class="literal">Stream&lt;T&gt; limit(long maxSize);</code></li>
                            </ol>
                        </div>
                    </li>
                    <li class="listitem">
                        <p class="simpara"><span class="emphasis"><em>Pure functions.</em></span> Are these lambda expressions side effect-free, or do they mutate state?</p>
                        <pre class="programlisting"><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">+</code> <code class="mi">1</code></pre>
                        <p class="simpara"><a id="4_pure_function_2"></a>Here’s the example code:</p>
                        <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>AtomicInteger count = new AtomicInteger(0);
List &lt; String &gt; origins = album.musicians().forEach(musician -&gt; count.incAndGet();)
</code></pre>
                        <div class="orderedlist">
                            <ol class="orderedlist" type="a">
                                <li class="listitem">The lambda expression passed into <code class="literal">forEach</code> in the example.</li>
                            </ol>
                        </div>
                    </li>
                    <li class="listitem">Count the number of lowercase letters in a <code class="literal">String</code> (hint: look at the <code class="literal">chars</code> method on <code class="literal">String</code>).</li>
                    <li class="listitem">Find the <code class="literal">String</code> with the largest number of lowercase letters from a <code class="literal">List&lt;String&gt;</code>. You can return an <code class="literal">Optional&lt;String&gt;</code> to account for
                        the empty list case.</li>
                </ol>
            </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_advanced_exercises" style="clear: both">Advanced Exercises</h2>
                    </div>
                </div>
            </div>
            <div class="orderedlist">
                <ol class="orderedlist" type="1">
                    <li class="listitem">Write an implementation of the <code class="literal">Stream</code> function <code class="literal">map</code> using only <code class="literal">reduce</code> and lambda expressions. You can return a <code class="literal">List</code>                        instead of a <code class="literal">Stream</code> if you want.</li>
                    <li class="listitem">Write an implementation of the <code class="literal">Stream</code> function <code class="literal">filter</code> using only <code class="literal">reduce</code> and lambda expressions. Again, you can return a <code class="literal">List</code>                        instead of a <code class="literal">Stream</code> if you want.</li>
                </ol>
            </div>
        </div>
        </section>
        <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
        </div>
        </div>
        </section>
        </div>
        </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch04.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch04.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="5_"></a>

    <div class="application" id="container" style="height: auto;">
      <div class="js-toc">
        <section role="document">
          <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
              <div class="annotator-wrapper">
                    <section class="chapter" epub:type="chapter" id="libraries_chapter">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title">Chapter 4. Libraries</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="5_ix_ch04-asciidoc0"></a><a class="indexterm" id="5_ix_ch04-asciidoc1"></a>I’ve talked about how to write lambda expressions but so far haven’tcovered the other side of the fence: how to use them. This lesson
                            is important evenif you’re not writing a heavily functional library like streams. Even thesimplest application is still likely to have application code that couldbenefit from code as data.</p>
                        <p>Another Java 8 change that has altered the way that we need to think aboutlibraries is the introduction of <code class="literal">default</code> methods and static methods oninterfaces. This change means that methods on interfaces
                            can now have bodiesand contain code.</p>
                        <p>I’ll also fill in some gaps in this chapter, coveringtopics such as what happens when you overload methods with lambda expressionsand how to use primitives. These are important things to be aware of whenyou’re writing lambda-enabled
                            code.</p>
                        <div class="sect1">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title" id="_using_lambda_expressions_in_code" style="clear: both">Using Lambda Expressions in Code</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="5_id370022"></a>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html">Chapter 2</a>, I described how a lambda expression is given the type of
                                afunctional interface and how this type is inferred. From the point ofview of code calling the lambda expression, you can treat it identicallyto calling a method on an interface.</p>
                            <p>Let’s look at a concrete example framed in terms of logging frameworks. Severalcommonly used Java logging frameworks, including<a class="indexterm" id="5_id370065"></a><a class="indexterm" id="5_id370074"></a> <code class="literal">slf4j</code>                                and <code class="literal">log4j</code>, have methodsthat log output only when their logging level is set to a certain level or higher. So, theywill have a method like<a class="indexterm" id="5_id309903"></a> <code class="literal">void debug(String message)</code>                                that will log <code class="literal">message</code>if the level is at <code class="literal">debug</code>.</p>
                            <p><a class="indexterm" id="5_id309875"></a>Unfortunately, calculating the <code class="literal">message</code> to log frequently has a performance cost associated with it. Consequently, you end up with a situation in which people
                                start explicitly calling<a class="indexterm" id="5_id383769"></a> the Boolean <code class="literal">isDebugEnabled</code> method in order to optimize this performance cost. A code sample is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#debug_optimised">Example 4-1</a>.
                                Even though a direct call to <code class="literal">debug</code> would have avoided logging the text, it still would had to call the <code class="literal">expensiveOperation</code> method and also concatenate its output
                                to the message <code class="literal">String</code>, so the explicit <code class="literal">if</code> check still ends up being faster.</p>
                            <div class="example"><a id="5_debug_optimised"></a>
                                <div class="example-title">Example 4-1. A logger using isDebugEnabled to avoid performance overhead</div>
                                <div class="example-contents"><pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code><span style="color:#00f;font-weight:700">Logger</span> logger <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Logger</span>();
<span style="color:#00f;font-weight:700">if</span> (logger<span style="color:#00f;font-weight:700">.</span>isDebugEnabled()) {
 logger<span style="color:#00f;font-weight:700">.</span>debug(<span style="color:#036a07">Look at this: </span> <span style="color:#00f;font-weight:700">+</span> expensiveOperation());
}
</code></pre></div>

                            </div>
                            <p><a class="indexterm" id="5_id383796"></a>What we actually want to be able to do is pass in a lambda expression thatgenerates a <code class="literal">String</code> to be used as the message. This expression would be called only
                                ifthe <code class="literal">Logger</code> was actually at debug level or above. This approach would allow us torewrite the previous code example to look like the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#debug_optimised_lambda">Example 4-2</a>.</p>
                            <div class="example"><a id="5_debug_optimised_lambda"></a>
                                <div class="example-title">Example 4-2. Using lambda expressions to simplify logging code</div>
                                <div class="example-contents">
                                    <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code><span style="color:#00f;font-weight:700"></span><span style="color:#00f;font-weight:700">Logger</span> logger <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Logger</span>();
logger<span style="color:#00f;font-weight:700">.</span>debug(() <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#036a07">Look at this: </span> <span style="color:#00f;font-weight:700">+</span> expensiveOperation());</code></pre>
                                </div>
                        </div>
                        <p>So how do we implement this method from within our <code class="literal">Logger</code> class? From thelibrary point of view, we can just use the builtin <code class="literal">Supplier</code> functionalinterface, which has a single
                            <code class="literal">get</code> method. We can then call<code class="literal">isDebugEnabled</code> in order to find out whether to call this method and pass the resultinto our <code class="literal">debug</code> method if
                            it is enabled. The resulting code is shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#debug_lambda_implementation">Example 4-3</a>.</p>
                        <div class="example"><a id="5_debug_lambda_implementation"></a>
                            <div class="example-title">Example 4-3. The implementation of a lambda-enabled logger</div>
                            <div class="example-contents">
                                <pre class="programlisting"> <code class="kd"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> debug(<span style="color:#00f;font-weight:700">Supplier</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> message) {
    <span style="color:#00f;font-weight:700">if</span> (isDebugEnabled()) {
        debug(message<span style="color:#00f;font-weight:700">.</span>get());
    }
}</code></pre>
                            </div>
                        </div>
                        <p>Calling the<a class="indexterm" id="5_id342893"></a> <code class="literal">get()</code> method in this example corresponds to calling thelambda expression that was passed into the method to be called. This approachalso conveniently
                            works with<a class="indexterm" id="5_id342922"></a> anonymous inner classes, which allows you maintaina backward-compatible API if you have consumers of your code who can’t upgradeto Java 8 yet.</p>
                        <p>It’s important to remember that each of the different functional interfacescan have a different name for its actual method. So, if we were usinga <code class="literal">Predicate</code>, we would have to call <code class="literal">test</code>,
                            or if we were using <code class="literal">Function</code>,we would have to call <code class="literal">apply</code>.</p>
                </div>
                <div class="sect1">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h2 class="title" id="primitives_section" style="clear: both">Primitives</h2>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="5_ix_ch04-asciidoc2"></a><a class="indexterm" id="5_ix_ch04-asciidoc3"></a><a class="indexterm" id="5_ix_ch04-asciidoc4"></a>You might have noticed in the previous section that we skimmed overthe use of <span class="emphasis"><em>primitive</em></span>                        types. In Java we have a set ofparallel types—for example, <code class="literal">int</code> and <code class="literal">Integer</code>—where one is a primitivetype and the other a<a class="indexterm" id="5_id327403"></a> <span class="emphasis"><em>boxed</em></span>                        type. Primitive types are built into the languageand runtime environment as fundamental building blocks; boxed typesare just normal Java classes that wrap up the primitives.</p>
                    <p>Because Java generics are based around <span class="emphasis"><em>erasing</em></span> a generic parameter—inother words, pretending it’s an instance of <code class="literal">Object</code>—only the boxed typescan be used as generic
                        arguments. This is why if you want a list of integervalues in Java it will always be <code class="literal">List&lt;Integer&gt;</code> and not <code class="literal">List&lt;int&gt;</code>.</p>
                    <p>Unfortunately, because boxed types are objects, there is a memory overhead tothem. For example, although an <code class="literal">int</code> takes 4 bytes of memory, an <code class="literal">Integer</code> takes16 bytes. This gets
                        even worse when you start to look at arrays of numbers,as each element of a primitive array is just the size of the primitive,while each element of a boxed array is actually an in-memory pointer to anotherobject on the Java heap.
                        In the worst case, this might make an <code class="literal">Integer[]</code> takeup nearly six times more memory than an <code class="literal">int[]</code> of the same size.</p>
                    <p><a class="indexterm" id="5_id327426"></a>There is also a computational overhead when converting from aprimitive type to a boxed type, called<a class="indexterm" id="5_id327456"></a><a class="indexterm" id="5_id327453"></a> <span class="emphasis"><em>boxing</em></span>,
                        and vice versa, called<span class="emphasis"><em>unboxing</em></span>. For algorithms that perform lots of numerical operations, the cost of boxing and unboxing combined with theadditional memory bandwidth used by allocated boxed
                        objects can make thecode significantly slower.</p>
                    <p>As a consequence of these performance overheads, the streams librarydifferentiates between the primitive and boxed versions of some libraryfunctions. The<a class="indexterm" id="5_id327463"></a> <code class="literal">mapToLong</code>                        higher-order function and<a class="indexterm" id="5_id296101"></a> <code class="literal">ToLongFunction</code>, shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#ToLongFunction_diagram">Figure 4-1</a>,
                        are examples of this effort.<a class="indexterm" id="5_id296122"></a><a class="indexterm" id="5_id296128"></a><a class="indexterm" id="5_id296134"></a><a class="indexterm" id="5_id296140"></a><a class="indexterm" id="5_id296147"></a>Only
                        the <code class="literal">int</code>, <code class="literal">long</code>, and <code class="literal">double</code> types have been chosen as the focus of the primitive specialization implementation in Java 8 because the impact is
                        most noticeable innumerical algorithms.</p>
                    <div class="figure"><a id="5_ToLongFunction_diagram"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt="ToLongFunction" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0401.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0401.png" width="536"/></div>
                        </div>
                        <div class="figure-title">Figure 4-1. ToLongFunction</div>
                    </div>
                    <p>The primitive specializations have a very clear-cut naming convention. If thereturn type is a primitive, the interface is prefixed with <code class="literal">To</code> and theprimitive type, as in <code class="literal">ToLongFunction</code>                        (shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#ToLongFunction_diagram">Figure 4-1</a>).If the argument type is a primitive type, the name prefix is just the
                        typename, as in <code class="literal">LongFunction</code> (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#LongFunction_diagram">Figure 4-2</a>). If the higher-order function
                        uses aprimitive type, it is suffixed with <code class="literal">To</code> and the primitive type, as in <code class="literal">mapToLong</code>.</p>
                    <div class="figure"><a id="5_LongFunction_diagram"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt="LongFunction" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0402.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0402.png" width="536"/></div>
                        </div>
                        <div class="figure-title">Figure 4-2. LongFunction</div>
                    </div>
                    <p><a class="indexterm" id="5_id330704"></a>There are also specialized versions of <code class="literal">Stream</code> for these primitive types thatprefix the type name, such as<a class="indexterm" id="5_id330723"></a> <code class="literal">LongStream</code>.
                        In fact, methods like<code class="literal">mapToLong</code> don’t return a <code class="literal">Stream</code>; they return these specialized streams. Onthe specialized streams, the<a class="indexterm" id="5_id330743"></a><a class="indexterm" id="5_id330740"></a> <code class="literal">map</code> implementation is also specialized: it takes afunction called<a class="indexterm" id="5_id330765"></a> <code class="literal">LongUnaryOperator</code>, visible in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#LongUnaryOperator_diagram">Figure 4-3</a>,which maps a <code class="literal">long</code> to a <code class="literal">long</code>. It’s also
                        possible to get back from aprimitive stream to a boxed stream through higher-order function variations suchas<a class="indexterm" id="5_id370718"></a><a class="indexterm" id="5_id370722"></a> <code class="literal">mapToObj</code> and
                        the <code class="literal">boxed</code> method, which returns a stream of boxed objectssuch as <code class="literal">Stream&lt;Long&gt;</code>.</p>
                    <div class="figure"><a id="5_LongUnaryOperator_diagram"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt="LongUnaryOperator" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0403.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0403.png" width="577"/></div>
                        </div>
                        <div class="figure-title">Figure 4-3. LongUnaryOperator</div>
                    </div>
                    <p><a class="indexterm" id="5_id370771"></a>It’s a good idea to use the primitive specialized functions wherever possiblebecause of the performance benefits. You also get additional functionalityavailable on the specialized streams. This
                        allows you to avoid havingto implement common functionality and to use code that better conveys the intentof numerical operations. You can see an example of how to use this functionality in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#printTrackLengthStatistics">Example 4-4</a>.</p>
                    <div class="example"><a id="5_printTrackLengthStatistics"></a>
                        <div class="example-title">Example 4-4. Using summaryStatistics to understand track length data</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">void</span> printTrackLengthStatistics(<span style="color:#00f;font-weight:700">Album</span> album) {
    <span style="color:#00f;font-weight:700">IntSummaryStatistics</span> trackLengthStats <span style="color:#00f;font-weight:700">=</span> album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>mapToInt(track <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>track<span style="color:#00f;font-weight:700">.</span>getLength())<span style="color:#00f;font-weight:700">.</span>summaryStatistics();
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>printf(<span style="color:#036a07">Max: %d, Min: %d, Ave: %f, Sum: %d</span>, trackLengthStats<span style="color:#00f;font-weight:700">.</span>getMax(), trackLengthStats<span style="color:#00f;font-weight:700">.</span>getMin(), trackLengthStats<span style="color:#00f;font-weight:700">.</span>getAverage(), trackLengthStats<span style="color:#00f;font-weight:700">.</span>getSum());
}</pre></div>
                </div>
                <p><a class="indexterm" id="5_id330187"></a><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#printTrackLengthStatistics">Example 4-4</a> prints out a summary of track length informationto
                    the console. Instead of calculating that information ourselves, we map eachtrack to its length, using the primitive specialized <code class="literal">mapToInt</code> method. Because this method returns an <code class="literal">IntStream</code>,
                    we can call <code class="literal">summaryStatistics</code>, which calculates statistics such as the minimum, maximum, average, and sum values on the <code class="literal">IntStream</code>.</p>
                <p>These values are available on all the specialized streams, such as<code class="literal">DoubleStream</code> and <code class="literal">LongStream</code>. It’s also possible to calculate the individualsummary statistics if you don’t need
                    all of them through the <code class="literal">min</code>, <code class="literal">max</code>,<code class="literal">average</code>, and <code class="literal">sum</code> methods, which are all also available on all threeprimitive specialized
                    <code class="literal">Stream</code> variants.<a class="indexterm" id="5_id330214"></a><a class="indexterm" id="5_id330248"></a><a class="indexterm" id="5_id359993"></a></p>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="overload_resolution_sec" style="clear: both">Overload Resolution</h2>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="5_ix_ch04-asciidoc5"></a><a class="indexterm" id="5_ix_ch04-asciidoc6"></a>It’s possible in Java to <span class="emphasis"><em>overload</em></span> methods, so you have multiple methods withthe same name but different
                    signatures. This approach poses a problem for parameter-type inference because it means that there are several types that could beinferred. In these situations <code class="literal">javac</code> will pick the <span class="emphasis"><em>most specific</em></span>                    type foryou. For example, the method call in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#most_specific_overload_call">Example 4-5</a>, whenchoosing between the two methods
                    in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#most_specific_overload">Example 4-6</a>, prints out<code class="literal">String</code>, not <code class="literal">Object</code>.</p>
                <div class="example"><a id="5_most_specific_overload_call"></a>
                    <div class="example-title">Example 4-5. A method that could be dispatched to one of two methods</div>
                    <div class="example-contents">
                       <pre style="background:#fff;color:#000">overloadedMethod(<span style="color:#036a07">abc</span>);
</pre>
                    </div>
            </div>
            <div class="example"><a id="5_most_specific_overload"></a>
                <div class="example-title">Example 4-6. Two methods that are overloaded</div>
                <div class="example-contents">
                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> overloadedMethod(<span style="color:#00f;font-weight:700">Object</span> o) {
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>print(<span style="color:#036a07">Object</span>);
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> overloadedMethod(<span style="color:#00f;font-weight:700">String</span> s) {
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>print(<span style="color:#036a07">String</span>);
}
</pre>
                </div>
            </div>
            <p><a class="indexterm" id="5_id331076"></a>A <code class="literal">BinaryOperator</code> is special type of <code class="literal">BiFunction</code> for which the argumentsand the return type are all the same. For example, adding two integers wouldbe
                a <code class="literal">BinaryOperator</code>.</p>
            <p>Because lambda expressions have the types of their functional interfaces, the samerules apply when passing them as arguments. We can overload a method with the<code class="literal">BinaryOperator</code> and an interface that extends it. When
                calling these methods, Java will infer thetype of your lambda to be the most specific functional interface. For example,the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#overloadedMethod">Example 4-7</a>                prints out <code class="literal">IntegerBinaryOperator</code> whenchoosing between the two methods in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#most_specific_bifunction">Example 4-8</a>.</p>
            <div class="example"><a id="5_overloadedMethod"></a>
                <div class="example-title">Example 4-7. Another overloaded method call</div>
                <div class="example-contents">
                    <pre class="programlisting"><code class="n">overloadedMethod</code><code class="o">((</code><code class="n">x</code><code class="o">,</code> <code class="n">y</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code><code class="o">);</code></pre>
                </div>
    </div>
    <div class="example"><a id="5_most_specific_bifunction"></a>
        <div class="example-title">Example 4-8. A choice between two overloaded methods</div>
        <div class="example-contents">
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">IntegerBiFunction</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">BinaryOperator</span> &lt; <span style="font-style:italic">Integer</span> &gt; {}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> overloadedMethod(<span style="color:#00f;font-weight:700">BinaryOperator</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> lambda) {
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>print(<span style="color:#036a07">BinaryOperator</span>);
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> overloadedMethod(<span style="color:#00f;font-weight:700">IntegerBiFunction</span> lambda) {
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>print(<span style="color:#036a07">IntegerBinaryOperator</span>);
}
</pre>
        </div>
    </div>
    <p>Of course, when there are multiple method overloads, there isn’t always a clear “mostspecific type.” Take a look at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#overloaded_compile_fail">Example 4-9</a>.</p>
    <div class="example"><a id="5_overloaded_compile_fail"></a>
        <div class="example-title">Example 4-9. A compile failure due to overloaded methods</div>
        <div class="example-contents">
            <pre style="background:#fff;color:#000">overloadedMethod((x) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#585cf6;font-weight:700">true</span>);
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">IntPredicate</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">boolean</span> <span style="color:#0000a2;font-weight:700">test</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">value</span>);
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> overloadedMethod(<span style="color:#00f;font-weight:700">Predicate</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> predicate) {
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>print(<span style="color:#036a07">Predicate</span>);
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> overloadedMethod(<span style="color:#00f;font-weight:700">IntPredicate</span> predicate) {
    <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>print(<span style="color:#036a07">IntPredicate</span>);
}
</pre>
        </div>
        </div>
        <p><a class="indexterm" id="5_id353403"></a>The lambda expression passed into <code class="literal">overloadedMethod</code> is compatible with both a normal <code class="literal">Predicate</code> and the <code class="literal">IntPredicate</code>. There
            are method overloads for each of these options defined within this code block. In this case, <code class="literal">javac</code> will fail to compile the example, complaining that the lambda expression is an ambiguous method call: <code class="literal">IntPredicate</code>            doesn’t extend any <code class="literal">Predicate</code>, so the compiler isn’t able to infer that it’s more specific.</p>
        <p>The way to fix these situations is to cast the lambda expression to either<code class="literal">IntPredicate</code> or <code class="literal">Predicate&lt;Integer&gt;</code>, depending upon which behavior you wantto call. Of course, if you’ve designed
            the library yourself, you might conclude thatthis is a code smell and you should start renaming your overloadedmethods.</p>
        <p>In summary, the parameter types of a lambda are inferred from the<a class="indexterm" id="5_id383430"></a> <span class="emphasis"><em>target type</em></span>, and the inference follows these rules:</p>
        <div class="itemizedlist">
            <ul class="itemizedlist">
                <li class="listitem">If there is a single possible target type, the lambda expression infers the type from the corresponding argument on the functional interface.</li>
                <li class="listitem">If there are several possible target types, the most specific type is inferred.</li>
                <li class="listitem">If there are several possible target types and there is no most specific type, you must manually provide a type.<a class="indexterm" id="5_id383481"></a><a class="indexterm" id="5_id383449"></a></li>
            </ul>
        </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_functionalinterface" style="clear: both">@FunctionalInterface</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="5_id364666"></a><a class="indexterm" id="5_id364674"></a><a class="indexterm" id="5_id364685"></a>Although I talked about the criteria for what a functional interface actually isback in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch02.html">Chapter 2</a>,
                I haven’t yet mentioned the<code class="literal">@FunctionalInterface</code> annotation. This is an annotation that should beapplied to any interface that is intended to be used as a functional interface.</p>
            <p>What does that really mean? Well, there are some interfaces in Java that have only a single method but aren’t normally meant to be implemented by lambda expressions. For example, they might assume that the object has internal state and be
                interfaces with a single method only coincidentally. A couple of good examples are<a class="indexterm" id="5_id305877"></a><a class="indexterm" id="5_id364718"></a> <code class="literal">java.lang.Comparable</code> and <code class="literal">java.io.Closeable</code>.</p>
            <p>If a class is <code class="literal">Comparable</code>, it means there is a defined order betweeninstances, such as alphabetical order for strings. You don’t normallythink about functions themselves as being comparable objects because they
                lackfields and state, and if there are no fields and no state, what is there tosensibly compare?</p>
            <p>For an object to be <code class="literal">Closeable</code> it must hold an openresource, such as a file handle that needs to be closed at some point intime. Again, the interface being called cannot be a pure function becauseclosing a resource
                is really another example of mutating state.</p>
            <p>In contrast to <code class="literal">Closeable</code> and <code class="literal">Comparable</code>, all the new interfaces introducedin order to provide <code class="literal">Stream</code> interoperability are expected to be implemented bylambda
                expressions. They are really there to bundle up blocks of code as data.Consequently, they have the <code class="literal">@FunctionalInterface</code> annotation applied.</p>
            <p>Using the annotation compels <code class="literal">javac</code> to actually check whether the interface meetsthe criteria for being a functional interface. If the annotation is applied toan <code class="literal">enum</code>, <code class="literal">class</code>,
                or <code class="literal">annotation</code>, or if the type is an interface with morethan one single abstract method, then <code class="literal">javac</code> will generate an error message.This is quite helpful for being able to catch errors
                easily when refactoringyour code.</p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_binary_interface_compatibility" style="clear: both">Binary Interface Compatibility</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="5_id305934"></a><a class="indexterm" id="5_id305940"></a>As you saw in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>, one of the biggest API
                changes in Java 8 is to the collections library. As Java has evolved, it has maintained backward binary compatibility. In practical terms, this means that if you compiled a library or application with Java 1 through 7, it’ll run out of
                the box in Java 8.</p>
            <p>Of course, there are still bugs from time to time, but compared to many otherprogramming platforms, binary compatibility has been viewed as a key Javastrength. Barring the introduction of a new keyword, such as <code class="literal">enum</code>,
                there hasalso been an effort to maintain backward source compatibility. Herethe guarantee is that if you’ve got source code in Java 1-7, it’ll compile in Java 8.</p>
            <p><a class="indexterm" id="5_id373079"></a>These guarantees are really hard to maintain when you’re changing such a corelibrary component as the collections library. As a thought exercise,consider a concrete example. The <code class="literal">stream</code>                method was added to the<code class="literal">Collection</code> interface in Java 8, which means that any class that implements<code class="literal">Collection</code> must also have this method on it. For corelibrary classes, this problem
                can easily be solved by implementing that method (e.g., adding a <code class="literal">stream</code> method to<code class="literal">ArrayList</code>).</p>
            <p><a class="indexterm" id="5_id373085"></a>Unfortunately, this change still breaks binary compatibility because it meansthat any class outside of the JDK that implements <code class="literal">Collection</code>—say,<code class="literal">MyCustomList</code>—must
                also have implemented the <code class="literal">stream</code> method. In Java 8<code class="literal">MyCustomList</code> would no longer compile, and even if you had a compiled versionwhen you tried to load <code class="literal">MyCustomList</code>                into a JVM, it would result in anexception being thrown by your <code class="literal">ClassLoader</code>.</p>
            <p>This nightmare scenario of all third-party collections libraries being brokenhas been averted, but it did require the introduction of a new languageconcept: <span class="emphasis"><em>default methods</em></span>.</p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_default_methods" style="clear: both">Default Methods</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="5_ix_ch04-asciidoc7"></a><a class="indexterm" id="5_ix_ch04-asciidoc8"></a>So you’ve got your new <code class="literal">stream</code> method on <code class="literal">Collection</code>; how do you allow<code class="literal">MyCustomList</code>                to compile without ever having to know about its existence?The Java 8 approach to solving the problem is to allow <code class="literal">Collection</code> to say, “Ifany of my children don’t have a <code class="literal">stream</code> method,
                they can use this one.” Thesemethods on an interface are called<a class="indexterm" id="5_id319324"></a> <span class="emphasis"><em>default</em></span> methods. They can beused on any interface, functional or not.</p>
            <p>Another default method that has been added is the<a class="indexterm" id="5_id319329"></a><a class="indexterm" id="5_id319342"></a> <code class="literal">forEach</code> method on <code class="literal">Iterable</code>,which provides similar functionality
                to the <code class="literal">for</code> loop but lets you use a lambdaexpression as the body of the loop. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#iterable_foreach">Example 4-10</a>                shows how this could beimplemented in the JDK.</p>
            <div class="example"><a id="5_iterable_foreach"></a>
                <div class="example-title">Example 4-10. An example default method, showing how forEach might be implemented</div>
                <div class="example-contents">
                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">default</span> <span style="color:#00f;font-weight:700">void</span> forEach(<span style="color:#00f;font-weight:700">Consumer</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">?</span><span style="color:#318495">super</span> <span style="color:#00f;font-weight:700">T</span> <span style="color:#00f;font-weight:700">&gt;</span> action) {
        <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">T</span> t<span style="color:#00f;font-weight:700">:</span> <span style="color:#318495">this</span>) {
            action<span style="color:#00f;font-weight:700">.</span>accept(t);
        }
    }
</pre>
                </div>
            </div>
            <p>Now that you’re familiar with the idea that you can use lambda expressions by just calling methods on interfaces, this example should look pretty simple. It uses a regular <code class="literal">for</code> loop to iterate over the underlying
                <code class="literal">Iterable</code>, calling the <code class="literal">accept</code> method with each value.</p>
            <p><a class="indexterm" id="5_ix_ch04-asciidoc10"></a>If it’s so simple, why mention it? The important thing is that new <code class="literal">default</code>keyword right at the beginning of the code snippet. That tells <code class="literal">javac</code>                thatyou really want to add a method to an interface. Other than the addition ofa new keyword, <code class="literal">default</code> methods also have slightly different inheritance rulesto regular methods.</p>
            <p>The other big difference is that, unlike classes, interfaces don’t haveinstance fields, so <code class="literal">default</code> methods can modify their child classes only bycalling methods on them. This helps you avoid making assumptions
                about theimplementation of their children.</p>
            <div class="sect2">
                <div class="titlepage">
                    <div>
                        <div>
                            <h3 class="title" id="_default_methods_and_subclassing">Default Methods and Subclassing</h3>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="5_ix_ch04-asciidoc9"></a><a class="indexterm" id="5_ix_ch04-asciidoc11"></a><a class="indexterm" id="5_ix_ch04-asciidoc12"></a>There are some subtleties about the way that <code class="literal">default</code> methods
                    override andcan be overridden by other methods. Let’s look the simplest case to begin with:no overriding. In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#parent_interface">Example 4-11</a>,
                    our <code class="literal">Parent</code> interface defines a<code class="literal">welcome</code> method that sends a message when called. The <code class="literal">ParentImpl</code> classdoesn’t provide an implementation of <code class="literal">welcome</code>,
                    so it inherits the <code class="literal">default</code>method.</p>
                <div class="example"><a id="5_parent_interface"></a>
                    <div class="example-title">Example 4-11. The Parent interface; the welcome method is a default</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Parent</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">message</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">body</span>);
    <span style="color:#00f;font-weight:700">public</span>
default <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">welcome</span>() {
        message(<span style="color:#036a07">Parent: Hi!</span>);
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#0000a2;font-weight:700">getLastMessage</span>();
}
</pre>
                    </div>
                </div>
                <p>When we come to call this code, in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#parent_default_used">Example 4-12</a>, the <code class="literal">default</code> methodis called
                    and our assertion passes.</p>
                <div class="example"><a id="5_parent_default_used"></a>
                    <div class="example-title">Example 4-12. Using the default method from client code</div>
                    <div class="example-contents">
                       <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> parentDefaultUsed() {
    <span style="color:#00f;font-weight:700">Parent</span> parent <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ParentImpl</span>();
    parent<span style="color:#00f;font-weight:700">.</span>welcome();
    assertEquals(<span style="color:#036a07">Parent: Hi!</span>, parent<span style="color:#00f;font-weight:700">.</span>getLastMessage());
}
</pre>
                    </div>
                </div>
                <p>Now we can extend <code class="literal">Parent</code> with a <code class="literal">Child</code> interface, whose code is listed in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#child_interface">Example 4-13</a>.
                    <code class="literal">Child</code> implements its own <code class="literal">default welcome</code> method.As you would intuitively expect, the <code class="literal">default</code> method on <code class="literal">Child</code> overrides
                    the<code class="literal">default</code> method on <code class="literal">Parent</code>. In this example, again, the <code class="literal">ChildImpl</code> classdoesn’t provide an implementation of <code class="literal">welcome</code>,
                    so it inherits the <code class="literal">default</code>method.</p>
                <div class="example"><a id="5_child_interface"></a>
                    <div class="example-title">Example 4-13. Child interface that extends Parent</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Child</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">Parent</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span>
default <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">welcome</span>() {
        message(<span style="color:#036a07">Child: Hi!</span>);
    }
}
</pre>
                    </div>
                </div>
                <p>You can see the class hierarchy at this point in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#inheritance_simple_diagram">Figure 4-4</a>.</p>
                <div class="figure"><a id="5_inheritance_simple_diagram"></a>
                    <div class="figure-contents">
                        <div class="mediaobject"><img alt="A diagram showing the inheritance hierachy at this point" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0404.png" height="712" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0404.png" width="997"/></div>
                    </div>
                    <div class="figure-title">Figure 4-4. A diagram showing the inheritance hierarchy at this point</div>
                </div>
                <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#child_override_default">Example 4-14</a> calls this interface and consequently ends upsending the string <code class="literal">Child: Hi!</code>.</p>
                <div class="example"><a id="5_child_override_default"></a>
                    <div class="example-title">Example 4-14. Client code that calls our Child interface</div>
                    <div class="example-contents">
                       <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> childOverrideDefault() {
    <span style="color:#00f;font-weight:700">Child</span> child <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ChildImpl</span>();
    child<span style="color:#00f;font-weight:700">.</span>welcome();
    assertEquals(<span style="color:#036a07">Child: Hi!</span>, child<span style="color:#00f;font-weight:700">.</span>getLastMessage());
}
</pre>
                    </div>
            </div>
            <p>Now the <code class="literal">default</code> method is a<a class="indexterm" id="5_id381807"></a> virtual method—that is, the opposite of a staticmethod. What this means is that whenever it comes up against competition froma class method, the
                logic for determining which override to pick always choosesthe class. A simple example of this is shown in Examples <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#OverridingParent_code">4-15</a>                and <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#concrete_beats_default">4-16</a>, where the <code class="literal">welcome</code> method of <code class="literal">OverridingParent</code>is
                chosen over that of <code class="literal">Parent</code>.</p>
            <div class="example"><a id="5_OverridingParent_code"></a>
                <div class="example-title">Example 4-15. A parent class that overrides the default implementation of welcome</div>
                <div class="example-contents">
              <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">OverridingParent</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">ParentImpl</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">welcome</span>() {
        message(<span style="color:#036a07">Class Parent: Hi!</span>);
    }
}
</pre>
                </div>
            </div>
            <div class="example"><a id="5_concrete_beats_default"></a>
                <div class="example-title">Example 4-16. An example of a concrete method beating a default method</div>
                <div class="example-contents">
                 <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> concreteBeatsDefault() {
    <span style="color:#00f;font-weight:700">Parent</span> parent <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">OverridingParent</span>();
    parent<span style="color:#00f;font-weight:700">.</span>welcome();
    assertEquals(<span style="color:#036a07">Class Parent: Hi!</span>, parent<span style="color:#00f;font-weight:700">.</span>getLastMessage());
}
</pre>
                </div>
            </div>
            <p>Here’s a situation, presented in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#concrete_beats_closer_default">Example 4-18</a>, in whichyou might not expect the concrete class to
                override the <code class="literal">default</code> method.<code class="literal">OverridingChild</code> inherits both the <code class="literal">welcome</code> method from <code class="literal">Child</code> and the <code class="literal">welcome</code>                method from <code class="literal">OverridingParent</code> and doesn’t do anything itself.<code class="literal">OverridingParent</code> is chosen despite <code class="literal">OverridingChild</code> (the code in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#OverridingChild">Example 4-17</a>),
                being a more specific type because it’s a concrete methodfrom a class rather than a <code class="literal">default</code> method (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#inheritance_complex_diagram">Figure 4-5</a>).</p>
            <div class="example"><a id="5_OverridingChild"></a>
                <div class="example-title">Example 4-17. Again, our child interface overrides the default welcome method</div>
                <div class="example-contents">
                  <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">OverridingChild</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">OverridingParent</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">Child</span> {}
</pre>
                </div>
        </div>
        <div class="example"><a id="5_concrete_beats_closer_default"></a>
            <div class="example-title">Example 4-18. An example of a concrete method beating a default method that is more specific</div>
            <div class="example-contents">
              <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> concreteBeatsCloserDefault() {
    <span style="color:#00f;font-weight:700">Child</span> child <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">OverridingChild</span>();
    child<span style="color:#00f;font-weight:700">.</span>welcome();
    assertEquals(<span style="color:#036a07">Class Parent: Hi!</span>, child<span style="color:#00f;font-weight:700">.</span>getLastMessage());
}
</pre>
            </div>
        </div>
        <div class="figure"><a id="5_inheritance_complex_diagram"></a>
            <div class="figure-contents">
                <div class="mediaobject"><img alt="A diagram showing the complete inheritance hierachy" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0405.png" height="993" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0405.png" width="1000"/></div>
            </div>
            <div class="figure-title">Figure 4-5. A diagram showing the complete inheritance hierarchy</div>
        </div>
        <p>Put simply: <span class="emphasis"><em>class wins</em></span>. The motivation for this decision is that <code class="literal">default</code>methods are designed primarily to allow binary compatible API evolution.Allowing classes to win over any
            <code class="literal">default</code> methods simplifies a lot ofinheritance scenarios.</p>
        <p>Suppose we had a custom list implementation called<code class="literal">MyCustomList</code> and had implemented a custom <code class="literal">addAll</code> method, and the new<code class="literal">List</code> interface provided a <code class="literal">default addAll</code>            that delegated to the <code class="literal">add</code>method. If the <code class="literal">default</code> method wasn’t guaranteed to be overridden by this<code class="literal">addAll</code> method, we could break the existing implementation.
            <a class="indexterm" id="5_id393835"></a><a class="indexterm" id="5_id393824"></a><a class="indexterm" id="5_id393842"></a><a class="indexterm" id="5_id337060"></a><a class="indexterm" id="5_id337066"></a><a class="indexterm" id="5_id337073"></a></p>
        </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_multiple_inheritance" style="clear: both">Multiple Inheritance</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="5_id337095"></a><a class="indexterm" id="5_id337100"></a><a class="indexterm" id="5_id337108"></a>Because interfaces are subject to multiple inheritance, it’s possible to getinto situations where two interfaces both provide
                <code class="literal">default</code> methods withthe same signature. Here’s an example in which both a <code class="literal">Carriage</code> and a<code class="literal">Jukebox</code> provide a method to <code class="literal">rock</code>—in
                each case, for differentpurposes. We also have a <code class="literal">MusicalCarriage</code>, which is both a <code class="literal">Jukebox</code> (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#jukebox-example">Example 4-19</a>)and
                a <code class="literal">Carriage</code> (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#carriage-example">Example 4-20</a>) and tries to inherit the <code class="literal">rock</code>                method.</p>
            <div class="example"><a id="5_jukebox-example"></a>
                <div class="example-title">Example 4-19. Jukebox</div>
                <div class="example-contents">
                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Jukebox</span> {
    <span style="color:#00f;font-weight:700">public</span>
default <span style="color:#00f;font-weight:700">String</span> <span style="color:#0000a2;font-weight:700">rock</span>() {
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#036a07">... all over the world!</span>;
    }
}
</pre>
                </div>
            </div>
            <div class="example"><a id="5_carriage-example"></a>
                <div class="example-title">Example 4-20. Carriage</div>
                <div class="example-contents">
                  <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Carriage</span> {
    <span style="color:#00f;font-weight:700">public</span>
default <span style="color:#00f;font-weight:700">String</span> <span style="color:#0000a2;font-weight:700">rock</span>() {
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#036a07">... from side to side</span>;
    }
}
</pre>
                </div>
            </div>
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">MusicalCarriage</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">Carriage</span>,
<span style="font-style:italic">Jukebox</span> {}
</pre>
            <p>Because it’s not clear to <code class="literal">javac</code> which method it should inherit, this will just result in the compile error <code class="literal">class MusicalCarriage inherits unrelated defaults for rock() from types Carriage and Jukebox</code>.
                Of course, it’s possible to resolve this by implementing the <code class="literal">rock</code> method, shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#musicalcarriage-example">Example 4-21</a>.</p>
            <div class="example"><a id="5_musicalcarriage-example"></a>
                <div class="example-title">Example 4-21. Implementing the rock method</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">MusicalCarriage</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">Carriage</span>,
<span style="font-style:italic">Jukebox</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#0000a2;font-weight:700">rock</span>() {
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">Carriage</span><span style="color:#00f;font-weight:700">.</span><span style="color:#318495">super</span><span style="color:#00f;font-weight:700">.</span>rock();
    }
}
</pre>
                </div>
        </div>
        <p>This example uses the enhanced<a class="indexterm" id="5_id337759"></a><a class="indexterm" id="5_id304539"></a> <code class="literal">super</code> syntax in order to pick <code class="literal">Carriage</code> as its preferred <code class="literal">rock</code>            implementation. Previously, <code class="literal">super</code> acted as a reference to the parent class, but by using the <code class="literal">InterfaceName.super</code> variant it’s possible to specify a method from an inherited interface.</p>
        <div class="sect2">
            <div class="titlepage">
                <div>
                    <div>
                        <h3 class="title" id="_the_three_rules">The Three Rules</h3>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="5_id304287"></a><a class="indexterm" id="5_id304298"></a>If you’re ever unsure of what will happen with <code class="literal">default</code> methods or with multiple inheritance of behavior, there are three simple rules
                for handling conflicts:</p>
            <div class="orderedlist">
                <ol class="orderedlist" type="1">
                    <li class="listitem">Any class wins over any interface. So if there’s a method with a body, or an abstract declaration,in the superclass chain, we can ignore the interfaces completely.</li>
                    <li class="listitem">Subtype wins over supertype. If we have a situation in which two interfacesare competing to provide a <code class="literal">default</code> method and one interface extends theother, the subclass wins.</li>
                    <li class="listitem"><span class="emphasis"><em>No rule 3</em></span>. If the previous two rules don’t give us the answer, thesubclass must either implement the method or declare it <code class="literal">abstract</code>.</li>
                </ol>
            </div>
            <p>Rule 1 is what brings us compatibility with old code.</p>
            </div>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_tradeoffs" style="clear: both">Tradeoffs</h2>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="5_id304376"></a>These changes raise a bunch of issues regarding what an interfacereally is in Java 8, as you can define methods with code bodies on them. This means that interfaces now provide a form of multiple
                    inheritance that haspreviously been frowned upon and whose removal has been considered a usability advantageof Java over C++.</p>
                <p>No language feature is always good or always bad. Many would argue that thereal issue is multiple inheritance of state rather than just blocks of code,and as <code class="literal">default</code> methods avoid multiple inheritance of state,
                    they avoid theworst pitfalls of multiple inheritance in C++.</p>
                <p>It can also be very tempting to try and work around these limitations. Blog posts have already cropped up trying to implement full-on traits with multiple inheritance of state as well as <code class="literal">default</code> methods. Trying
                    to hack around the deliberate restrictions of Java 8 puts us back into the old pitfalls of C++.</p>
                <p>It’s also pretty clear that there’s still a distinction between interfaces andabstract classes. Interfaces give you multiple inheritance but no fields,while abstract classes let you inherit fields but you don’t get multipleinheritance.
                    When modeling your problem domain, you need tothink about this tradeoff, which wasn’t necessary in previous versions of Java.</p>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_static_methods_on_interfaces" style="clear: both">Static Methods on Interfaces</h2>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="5_id393489"></a><a class="indexterm" id="5_id393511"></a><a class="indexterm" id="5_id393528"></a>We’ve seen a lot of calling of <code class="literal">Stream.of</code> but haven’t gotten into its details yet. You may
                    recall that <code class="literal">Stream</code> is an interface, but this is a static method on an interface. This is another new language change that has made its way into Java 8, primarily in order to help library developers, but
                    with benefits for day-to-day application developers as well.</p>
                <p>An idiom that has accidentally developed over time is ending up with classesfull of static methods. Sometimes a class can be an appropriate location for<a class="indexterm" id="5_id333070"></a>utility code, such as the <code class="literal">Objects</code>                    class introduced in Java 7 thatcontained functionality that wasn’t specific to any particular class.</p>
                <p>Of course, when there’s a good semantic reason for a method torelate to a concept, it should always be put in the same class or interfacerather than hidden in a utility class to the side. This helps structure yourcode in a way that’s easier
                    for someone reading it to find the relevant method.</p>
                <p>For example, if you want to create a simple <code class="literal">Stream</code> of values, you would expectthe method to be located on <code class="literal">Stream</code>. Previously, this was impossible, and theaddition of a very interface-heavy
                    API in terms of <code class="literal">Stream</code> finally motivatedthe addition of static methods on interfaces.</p>
                <div class="note">
                    <h3 class="title">Note</h3>
                    <p>There are other methods on <code class="literal">Stream</code> and its primitive specialized variants. Specifically, <code class="literal">range</code> and <code class="literal">iterate</code> give us other ways of generating our own
                        streams.</p>
                </div>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="Optional_sec" style="clear: both">Optional</h2>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="5_id333116"></a><a class="indexterm" id="5_id333124"></a><a class="indexterm" id="5_id333132"></a>Something I’ve glossed over so far is that <code class="literal">reduce</code> can come in a couple of forms:the one we’ve
                    seen, which takes an initial value, and another variant, whichdoesn’t. When the initial value is left out, the first call to the reducer usesthe first two elements of the <code class="literal">Stream</code>. This is useful if there’s
                    no sensibleinitial value for a <code class="literal">reduce</code> operation and will return an instance of <code class="literal">Optional</code>.</p>
                <p><a class="indexterm" id="5_id333181"></a><code class="literal">Optional</code> is a new core library data type that is designed to provide a betteralternative to <code class="literal">null</code>. There’s quite a lot of hatred for the old
                    <code class="literal">null</code> value.Even the man who invented the concept, Tony Hoare, described it as “mybillion-dollar mistake.” That’s the trouble with being an influential computerscientist—you can make a billion-dollar mistake
                    without even seeing thebillion dollars yourself!</p>
                <p><code class="literal">null</code> is often used to represent the absence of a value, and this is the use case that <code class="literal">Optional</code> is replacing. The problem with using <code class="literal">null</code> in order to
                    represent absence is the dreaded<a class="indexterm" id="5_id354306"></a> <code class="literal">NullPointerException</code>. If you refer to a variable that is <code class="literal">null</code>, your code blows up. The goal of
                    <code class="literal">Optional</code> is twofold. First, it encourages the coder to make appropriate checks as to whether a variable is <code class="literal">null</code> in order to avoid bugs. Second, it documents values that are expected to be absent
                        in a class’s API. This makes it easier to see where the bodies are buried.</p>
                <p>Let’s take a look at the API for <code class="literal">Optional</code> in order to get a feel for how to use it. If you want to create an <code class="literal">Optional</code> instance from a value, there is a factory method called
                    <code class="literal">of</code>. The <code class="literal">Optional</code> is now a container for this value, which can be pulled out with <code class="literal">get</code>, as shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#optional_value_creation">Example 4-22</a>.</p>
                <div class="example"><a id="5_optional_value_creation"></a>
                    <div class="example-title">Example 4-22. Creating an Optional from a value</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Optional</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> a <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Optional</span><span style="color:#00f;font-weight:700">.</span>of(<span style="color:#036a07">a</span>);
assertEquals(<span style="color:#036a07">a</span>, a<span style="color:#00f;font-weight:700">.</span>get());
</pre>
                    </div>
            </div>
            <p>Because an <code class="literal">Optional</code> may also represent an absent value, there’s also a factory method called<a class="indexterm" id="5_id325979"></a><a class="indexterm" id="5_id325973"></a> <code class="literal">empty</code>, and
                you can convert a nullable value into an <code class="literal">Optional</code> using the<a class="indexterm" id="5_id325989"></a><a class="indexterm" id="5_id326000"></a> <code class="literal">ofNullable</code> method. Both of these are shown
                in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#optional_is_present">Example 4-23</a>, along with the use of the<a class="indexterm" id="5_id353679"></a><a class="indexterm" id="5_id353685"></a>                <code class="literal">isPresent</code> method (which indicates whether the <code class="literal">Optional</code> is holding a value).</p>
            <div class="example"><a id="5_optional_is_present"></a>
                <div class="example-title">Example 4-23. Creating an empty Optional and checking whether it contains a value</div>
                <div class="example-contents">
                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Optional</span> emptyOptional <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Optional</span><span style="color:#00f;font-weight:700">.</span>empty();
<span style="color:#00f;font-weight:700">Optional</span> alsoEmpty <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Optional</span><span style="color:#00f;font-weight:700">.</span>ofNullable(<span style="color:#585cf6;font-weight:700">null</span>);
assertFalse(emptyOptional<span style="color:#00f;font-weight:700">.</span>isPresent()); <span style="color:#06f;font-style:italic">// a is defined aboveassertTrue(a.isPresent());</span>

</pre>
                </div>
            </div>
            <p>One approach to using <code class="literal">Optional</code> is to guard any call to<a class="indexterm" id="5_id390921"></a> <code class="literal">get()</code> by checking<code class="literal">isPresent()</code>. A neater approach is to call
                the<a class="indexterm" id="5_id390938"></a> <code class="literal">orElse</code> method, whichprovides an alternative value in case the <code class="literal">Optional</code> is empty. If creating analternative value is computationally expensive,
                the<a class="indexterm" id="5_id390954"></a> <code class="literal">orElseGet</code> methodshould be used. This allows you to pass in a <code class="literal">Supplier</code> that is called only ifthe <code class="literal">Optional</code>                is genuinely empty. Both of these methods are demonstrated in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#optional_orElse">Example 4-24</a>.</p>
            <div class="example"><a id="5_optional_orElse"></a>
                <div class="example-title">Example 4-24. Using orElse and orElseGet</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000">assertEquals(<span style="color:#036a07">b</span>, emptyOptional<span style="color:#00f;font-weight:700">.</span>orElse(<span style="color:#036a07">b</span>));
assertEquals(<span style="color:#036a07">c</span>, emptyOptional<span style="color:#00f;font-weight:700">.</span>orElseGet(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#036a07">c</span>));
</pre>
                </div>
            </div>
            <p>Not only is <code class="literal">Optional</code> used in new Java 8 APIs, but it’s also just a regular classthat you can use yourself when writing domain classes. This is definitelysomething to think about when trying to avoid nullness-related
                bugs suchas uncaught exceptions.<a class="indexterm" id="5_id327501"></a><a class="indexterm" id="5_id327506"></a></p>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_key_points_3" style="clear: both">Key Points</h2>
                        </div>
                    </div>
                </div>
                <div class="itemizedlist">
                    <ul class="itemizedlist">
                        <li class="listitem">A significant performance advantage can be had by using primitive specializedlambda expressions and streams such as <code class="literal">IntStream</code>.</li>
                        <li class="listitem">Default methods are methods with bodies on interfaces prefixedwith the keyword <code class="literal">default</code>.</li>
                        <li class="listitem">The <code class="literal">Optional</code> class lets you avoid using <code class="literal">null</code> by modeling situationswhere a value may not be present.</li>
                    </ul>
                </div>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_exercises_3" style="clear: both">Exercises</h2>
                        </div>
                    </div>
                </div>
                <div class="orderedlist">
                    <ol class="orderedlist" type="1">
                        <li class="listitem">
                            <p class="simpara">Given the <code class="literal">Performance</code> interface in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#Performance_interface">Example 4-25</a>, add a method
                                called<code class="literal">getAllMusicians</code> that returns a <code class="literal">Stream</code> of the artists performing and, in the case of groups, any musicians who are members of those groups. For example, if
                                <code class="literal">getMusicians</code> returns <span class="emphasis"><em>The Beatles</em></span>, then you should return <span class="emphasis"><em>The Beatles</em></span> along with Lennon, McCartney, and so on.</p>
                            <div class="example"><a id="5_Performance_interface"></a>
                                <div class="example-title">Example 4-25. An interface denoting the concept of a musical performance</div>
                                <div class="example-contents">
                                  <pre style="background:#fff;color:#000"><span style="color:#06f;font-style:italic">/** A Performance by some musicians - e.g., an Album or Gig. */</span>
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Performance</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#0000a2;font-weight:700">getName</span>();
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Stream</span> &lt; <span style="color:#00f;font-weight:700">Artist</span> &gt; <span style="color:#0000a2;font-weight:700">getMusicians</span>();
}
</pre>
                                </div>
                </div>
                </li>
                <li class="listitem">Based on the resolution rules described earlier, can you ever override <code class="literal">equals</code> or <code class="literal">hashCode</code> in a <code class="literal">default</code> method?</li>
                <li class="listitem">Take a look at the <code class="literal">Artists</code> domain class in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#artists_class">Example 4-26</a>, which represents a group
                    of artists. Yourassignment is to refactor the <code class="literal">getArtist</code> method in order to return an <code class="literal">Optional&lt;Artist&gt;</code>. It contains an elementif the index is within range and is an empty
                    <code class="literal">Optional</code> otherwise. Remember that you also need to refactorthe <code class="literal">getArtistName</code> method, and it should retain the same behavior.</li>
                </ol>
            </div>
            <div class="example"><a id="5_artists_class"></a>
                <div class="example-title">Example 4-26. The Artists domain class, which represents more than one Artist</div>
                <div class="example-contents">
                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Artists</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> artists;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">Artists</span>(<span style="color:#00f;font-weight:700">List</span> &lt; <span style="color:#00f;font-weight:700">Artist</span> &gt; <span style="font-style:italic">artists</span>) {
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>artists <span style="color:#00f;font-weight:700">=</span> artists;
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#0000a2;font-weight:700">getArtist</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">index</span>) {
        <span style="color:#00f;font-weight:700">if</span> (index <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#0000cd">0</span> <span style="color:#00f;font-weight:700">||</span> index <span style="color:#00f;font-weight:700">&gt;=</span> artists<span style="color:#00f;font-weight:700">.</span>size()) {
            indexException(index);
        }
        <span style="color:#00f;font-weight:700">return</span> artists<span style="color:#00f;font-weight:700">.</span>get(index);
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">indexException</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">index</span>) {
        <span style="color:#00f;font-weight:700">throw</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">IllegalArgumentException</span>(index <span style="color:#00f;font-weight:700">+</span> <span style="color:#036a07"> doesn&apos;t correspond to an Artist</span>);
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#0000a2;font-weight:700">getArtistName</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">index</span>) {
        <span style="color:#00f;font-weight:700">try</span> {
            <span style="color:#00f;font-weight:700">Artist</span> artist <span style="color:#00f;font-weight:700">=</span> getArtist(index);
            <span style="color:#00f;font-weight:700">return</span> artist<span style="color:#00f;font-weight:700">.</span>getName();
        } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">IllegalArgumentException</span> e) {
            <span style="color:#00f;font-weight:700">return</span> <span style="color:#036a07">unknown</span>;
        }
    }
}
</pre>
                </div>
            </div>
            </div>
            <div class="sect1">
                <div class="titlepage">
                    <div>
                        <div>
                            <h2 class="title" id="_open_exercises" style="clear: both">Open Exercises</h2>
                        </div>
                    </div>
                </div>
                <div class="orderedlist">
                    <ol class="orderedlist" type="1">
                        <li class="listitem">Look through your work code base or an open source project you’refamiliar with and try to identify classes that have just static methodsthat could be moved to static methods on interfaces. It might be worthdiscussing with your
                            colleagues whether they agree or disagree with you.</li>
                    </ol>
                </div>
            </div>
            </section>
            <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
            </div>
          </div>
        </section>
      </div>
    </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch05.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch05.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="6_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="collectors_chp">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 5. Advanced Collections and Collectors</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="6_ix_ch05-asciidoc0"></a><a class="indexterm" id="6_ix_ch05-asciidoc1"></a>There’s a lot more to the collections library changes than I covered in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>.
                                It’s time to cover some of the more advanced collectionschanges, including the new <code class="literal">Collector</code> abstraction. I’ll also introduce methodreferences, which are a way of using existing code in lambda
                                expressions withlittle to no ceremony. They pay huge dividends when it comes to writing<code class="literal">Collection</code>-heavy code. More advanced topics within the collections librarywill also be covered, such as
                                element ordering within streams and other useful APIchanges.</p>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_method_references" style="clear: both">Method References</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="6_id358806"></a><a class="indexterm" id="6_id352178"></a><a class="indexterm" id="6_id352192"></a>A common idiom you may have noticed is the creation of a lambda expression that calls a method on its
                                    parameter.If we want a lambda expression that gets the name of an artist, we would write the following:</p>
                              <pre style="background:#fff;color:#000">artist <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">&gt;</span> artist<span style="color:#00f;font-weight:700">.</span>getName()
</pre>
                                <p>This is such a common idiom that there’s actually an abbreviated syntaxfor this that lets you reuse an existing method, called a <span class="emphasis"><em>methodreference</em></span>. If we were to write the previous lambda
                                    expression using amethod reference, it would look like this:</p>
                                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName
</pre>
                                <p>The standard form is <code class="literal">Classname::methodName</code>. Remember that even though it’s amethod, you don’t need to use brackets because you’re not actually calling themethod. You’re providing the equivalent
                                    of a lambda expression that can becalled in order to call the method. You can use method references in the sameplaces as lambda expressions.</p>
                                <p>You can also call constructors using the same abbreviated syntax.If you were to use a lambda expression to create an <code class="literal">Artist</code>, you might write:</p>
                               <pre style="background:#fff;color:#000">(name, nationality) <span style="color:#00f;font-weight:700">-</span><span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Artist</span>(name, nationality)
</pre>
                                <p>We can also write this using method references:</p>
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">new</span>
</pre>
                                <p><a class="indexterm" id="6_id368322"></a>This code is not only shorter but also a lot easier to read. <code class="literal">Artist::new</code>immediately tells you that you’re creating a new <code class="literal">Artist</code>                                    without your having to scanthe whole line of code. Another thing to notice here is that method referencesautomatically support multiple parameters, as long as you have the rightfunctional interface.</p>
                                <p>It’s also possible to create arrays using this method. Here is how you wouldcreate a <code class="literal">String</code> array:</p>
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">String</span>[]<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">new</span>
</pre>
                                <p>We’ll be using method references from this point onward where appropriate,so you’ll be seeing a lot more examples very soon. When we were first exploringthe Java 8 changes, a friend of mine said that method references “feel
                                    like cheating.”What he meant was that, having looked at how we can use lambda expressions to passcode around as if it were data, it felt like cheating to be able toreference a method directly.</p>
                                <p>It’s OK—it’s not cheating! You have to bear in mind that every time you write alambda expression that looks like <code class="literal">x -&gt; foo(x)</code>, it’s really doing the same thingas just the method <code class="literal">foo</code>                                    on its own. All method references do is provide asimpler syntax that takes advantage of this fact.</p>
                            </div>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_element_ordering" style="clear: both">Element Ordering</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="6_ix_ch05-asciidoc2"></a><a class="indexterm" id="6_ix_ch05-asciidoc3"></a>One topic I haven’t discussed so far that pertains to collections is howelements are ordered in streams. You might be familiar
                                    with the concept thatsome types of <code class="literal">Collection</code>, such as<a class="indexterm" id="6_id300327"></a> <code class="literal">List</code>, have a defined order, and collectionslike<a class="indexterm" id="6_id300382"></a> <code class="literal">HashSet</code> don’t. The situation with ordering becomes a little morecomplex with <code class="literal">Stream</code> operations.</p>
                                <p>A <code class="literal">Stream</code> intuitively presents an order because each element is operated upon,or encountered, in turn. We call this the<a class="indexterm" id="6_id300388"></a> <span class="emphasis"><em>encounter order</em></span>.
                                    How theencounter order is defined depends on both the source of the data and theoperations performed on the <code class="literal">Stream</code>.</p>
                                <p>When you create a <code class="literal">Stream</code> from a collection with a defined order, the <code class="literal">Stream</code>has a defined encounter order. As a consequence, <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#LIST_TO_STREAM">Example 5-1</a>                                    will alwayspass.</p>
                                <div class="example"><a id="6_LIST_TO_STREAM"></a>
                                    <div class="example-title">Example 5-1. The ordering assumption in this test will always work</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> numbers <span style="color:#00f;font-weight:700">=</span> asList(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">4</span>);
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> sameOrder <span style="color:#00f;font-weight:700">=</span> numbers<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>collect(toList());
assertEquals(numbers, sameOrder);
</pre>
                                    </div>
                                </div>
                                <p>If there’s no defined order to begin, the <code class="literal">Stream</code> produced by thatsource doesn’t have a defined order. A <code class="literal">HashSet</code> is an example of a collectionwithout a defined ordering,
                                    and because of that <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#HASHSET_TO_STREAM">Example 5-2</a> isn’tguaranteed to pass.</p>
                                <div class="example"><a id="6_HASHSET_TO_STREAM"></a>
                                    <div class="example-title">Example 5-2. The ordering assumption here isn’t guaranteed</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> numbers <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; &gt;(asList(<span style="color:#0000cd">4</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">1</span>));
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> sameOrder <span style="color:#00f;font-weight:700">=</span> numbers<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>collect(toList());
<span style="color:#06f;font-style:italic">// This may not pass    </span>
assertEquals(asList(<span style="color:#0000cd">4</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">1</span>), sameOrder);

</pre>
                                    </div>
                                </div>
                                <p>The purpose of streams isn’t just to convert from one collection toanother; it’s to be able to provide a common set of operations over data. Theseoperations may create an encounter order where there wasn’t one to begin
                                    with.Consider the code presented in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#HASHSET_TO_STREAM_SORTED">Example 5-3</a>.</p>
                                <div class="example"><a id="6_HASHSET_TO_STREAM_SORTED"></a>
                                    <div class="example-title">Example 5-3. Creating an encounter order</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> numbers <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; &gt;(asList(<span style="color:#0000cd">4</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">1</span>));
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> sameOrder <span style="color:#00f;font-weight:700">=</span> numbers<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>sorted()<span style="color:#00f;font-weight:700">.</span>collect(toList());
assertEquals(asList(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">4</span>), sameOrder);
</pre>
                                    </div>
                                </div>
                                <p>The encounter order is propagated across intermediate operations if it exists;for example, if we try to <code class="literal">map</code> values and there’s a defined encounter order, thenthat encounter order will be preserved.
                                    If there’s no encounter order onthe input <code class="literal">Stream</code>, there’s no encounter order on the output <code class="literal">Stream</code>.Consider the two snippets of code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#TO_STREAM_MAPPED">Example 5-4</a>.
                                    We can only makethe weaker <code class="literal">hasItem</code> assertions on the <code class="literal">HashSet</code> example because the lackof a defined encounter order from <code class="literal">HashSet</code> continues
                                    through the <code class="literal">map</code>.</p>
                                <div class="example"><a id="6_TO_STREAM_MAPPED"></a>
                                    <div class="example-title">Example 5-4. The ordering assumption in this test will always work</div>
                                    <div class="example-contents">
                                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> numbers <span style="color:#00f;font-weight:700">=</span> asList(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">2</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">4</span>);
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> stillOrdered <span style="color:#00f;font-weight:700">=</span> numbers<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(x <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>x <span style="color:#00f;font-weight:700">+</span> <span style="color:#0000cd">1</span>)<span style="color:#00f;font-weight:700">.</span>collect(toList());
<span style="color:#06f;font-style:italic">// Reliable encounter ordering    </span>
assertEquals(asList(<span style="color:#0000cd">2</span>, <span style="color:#0000cd">3</span>, <span style="color:#0000cd">4</span>, <span style="color:#0000cd">5</span>), stillOrdered);
<span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> unordered <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; &gt;(numbers);
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> stillUnordered <span style="color:#00f;font-weight:700">=</span> unordered<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(x <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>x <span style="color:#00f;font-weight:700">+</span> <span style="color:#0000cd">1</span>)<span style="color:#00f;font-weight:700">.</span>collect(toList());
<span style="color:#06f;font-style:italic">// Can&apos;t assume encounter ordering    </span>
assertThat(stillUnordered, hasItem(<span style="color:#0000cd">2</span>));
assertThat(stillUnordered, hasItem(<span style="color:#0000cd">3</span>));
assertThat(stillUnordered, hasItem(<span style="color:#0000cd">4</span>));
assertThat(stillUnordered, hasItem(<span style="color:#0000cd">5</span>));
</pre>
                                    </div>
                                </div>
                                <p>Some operations are more expensive on ordered streams. This problem can be solvedby eliminating ordering. To do so, call the stream’s<a class="indexterm" id="6_id301452"></a><a class="indexterm" id="6_id303203"></a> <code class="literal">unordered</code>method.
                                    Most operations, however, such as <code class="literal">filter</code>, <code class="literal">map</code>, and <code class="literal">reduce</code>, can operate veryefficiently on ordered streams.</p>
                                <p>This can cause unexpected behavior, for example, <code class="literal">forEach</code> provides no guarantees as to encounter order if you’re using parallel streams. (This will be discussed in more detail in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html">Chapter 6</a>.) If you require an ordering guarantee in these situations, then <code class="literal">forEachOrdered</code>                                    is your friend!<a class="indexterm" id="6_id303239"></a><a class="indexterm" id="6_id303229"></a></p>
                            </div>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_enter_the_collector" style="clear: both">Enter the Collector</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="6_ix_ch05-asciidoc4"></a><a class="indexterm" id="6_ix_ch05-asciidoc5"></a>Earlier, we used the <code class="literal">collect(toList())</code> idiom in order to produce lists out ofstreams. Obviously,
                                    a <code class="literal">List</code> is a very natural value to want to produce from a<code class="literal">Stream</code>, but it’s not the only value that you might want to compute. Perhaps youwant to generate a
                                    <code class="literal">Map</code> or a <code class="literal">Set</code>. Maybe you think it’s worth having a domainclass that abstracts the concept you want?</p>
                                <p>You’ve already learned that you can tell just from the signature of a <code class="literal">Stream</code>method whether it’s an eagerly evaluated terminal operation that can be used toproduce a value. A <code class="literal">reduce</code>                                    operation can be very suitable for this purpose.Sometimes you want to go further than <code class="literal">reduce</code> allows, though.</p>
                                <p>Enter the <span class="emphasis"><em>collector</em></span>, a general-purpose construct for producing complexvalues from streams. These can be used with any <code class="literal">Stream</code> by passingthem into the
                                    <code class="literal">collect</code> method.</p>
                                <p>The standard library provides a bunch of useful collectors out of the box, solet’s look at those first. In the code examples throughout this chapterthe collectors are statically imported from the <code class="literal">java.util.stream.Collectors</code>class.</p>
                                <div class="sect2">
                                    <div class="titlepage">
                                        <div>
                                            <div>
                                                <h3 class="title" id="_into_other_collections">Into Other Collections</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <p><a class="indexterm" id="6_id370867"></a>Some collectors just build up other collections. You’ve already seen the<a class="indexterm" id="6_id370887"></a> <code class="literal">toList</code>collector, which produces
                                        <code class="literal">java.util.List</code> instances. There’s also a<a class="indexterm" id="6_id370896"></a> <code class="literal">toSet</code>collector and a<a class="indexterm" id="6_id370907"></a> <code class="literal">toCollection</code>                                            collector, which produce instances of <code class="literal">Set</code> and<code class="literal">Collection</code>. I’ve talked a lot so far about chaining <code class="literal">Stream</code> operations, butthere
                                            are still times when you’ll want to produce a <code class="literal">Collection</code> as a final value—forexample:</p>
                                    <div class="itemizedlist">
                                        <ul class="itemizedlist">
                                            <li class="listitem">When passing your collection to existing code that is written to use collections</li>
                                            <li class="listitem">When creating a final value at the end of a chain of collections</li>
                                            <li class="listitem">When writing test case asserts that operate on a concrete collection</li>
                                        </ul>
                                    </div>
                                    <p>Normally when we create a collection, we specify the concrete type of the collectionby calling the appropriate constructor:</p>
                                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> artists <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ArrayList</span> &lt; &gt;();
</pre>
                                    <p>But when you’re calling <code class="literal">toList</code> or <code class="literal">toSet</code>, you don’t get to specify the concreteimplementation of the <code class="literal">List</code> or <code class="literal">Set</code>.
                                        Under the hood, the streams library is pickingan appropriate implementation for you. Later in this book I’ll talk about how youcan use the streams library to perform data parallel operations; collecting theresults
                                        of parallel operations can require a different type of <code class="literal">Set</code> to be producedthan if there were no requirement for thread safety.</p>
                                    <p>It might be the case that you wish to <code class="literal">collect</code> your values into a <code class="literal">Collection</code> ofa specific type if you require that type later. For example, perhaps you wantto
                                        use a<a class="indexterm" id="6_id379567"></a> <code class="literal">TreeSet</code> instead of allowing the framework to determine what type of<code class="literal">Set</code> implementation you get. You can do that
                                        using the <code class="literal">toCollection</code> collector,which takes a function to build the collection as its argument (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#TO_COLLECTION_TREESET">Example 5-5</a>).</p>
                                    <div class="example"><a id="6_TO_COLLECTION_TREESET"></a>
                                        <div class="example-title">Example 5-5. Collecting into a custom collection using toCollection</div>
                                        <div class="example-contents">
                                            <pre style="background:#fff;color:#000">stream<span style="color:#00f;font-weight:700">.</span>collect(toCollection(<span style="color:#00f;font-weight:700">TreeSet</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">new</span>));
</pre>
                                        </div>
                            </div>
                    </div>
                    <div class="sect2">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h3 class="title" id="_to_values">To Values</h3>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="6_id306370"></a>It’s also possible to collect into a single value using a collector. There are<a class="indexterm" id="6_id306389"></a><a class="indexterm" id="6_id306382"></a><code class="literal">maxBy</code>                            and <code class="literal">minBy</code> collectors that let you obtain a single value according tosome ordering. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#BIGGEST_GROUP">Example 5-6</a>                            shows how to find the band with the mostmembers. It defines a lambda expression that can map an artist to the numberof members. This is then used to define a comparator that is passed into the<code class="literal">maxBy</code>                            collector.</p>
                        <div class="example"><a id="6_BIGGEST_GROUP"></a>
                            <div class="example-title">Example 5-6. Finding the band with the most members</div>
                            <div class="example-contents">
                                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Optional</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> biggestGroup(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> artists) {
    <span style="color:#00f;font-weight:700">Function</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
    <span style="color:#00f;font-weight:700">Long</span> <span style="color:#00f;font-weight:700">&gt;</span> getCount <span style="color:#00f;font-weight:700">=</span> artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getMembers()<span style="color:#00f;font-weight:700">.</span>count();
    <span style="color:#00f;font-weight:700">return</span> artists<span style="color:#00f;font-weight:700">.</span>collect(maxBy(comparing(getCount)));
}
</pre>
                            </div>
                        </div>
                        <p>There’s also a <code class="literal">minBy</code>, which does what it says on the tin.</p>
                        <p>There are also collectors that implement common numerical operations.Let’s take a look at these by writing a collector to find the averagenumber of tracks on an album, as in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#averagingTracks">Example 5-7</a>.</p>
                        <div class="example"><a id="6_averagingTracks"></a>
                            <div class="example-title">Example 5-7. Finding the average number of tracks for a list of albums</div>
                            <div class="example-contents">
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">double</span> averageNumberOfTracks(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> albums) {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>collect(averagingInt(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getTrackList()<span style="color:#00f;font-weight:700">.</span>size()));
}
</pre>
                            </div>
                    </div>
                    <p>As usual, we kick off our pipeline with the <code class="literal">stream</code> method and <code class="literal">collect</code>the results. We then call the <code class="literal">averagingInt</code> method, which takes a lambdaexpression
                        in order to convert each element in the <code class="literal">Stream</code> into an <code class="literal">int</code>before averaging the values. There are also overloaded operations for the<code class="literal">double</code> and
                        <code class="literal">long</code> types, which let you convert your element into these typeof values.</p>
                    <p>Back in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html#primitives_section">Primitives</a>, we talked about how the primitive specializedvariants of streams, such as <code class="literal">IntStream</code>,
                        had additional functionality fornumerical operations. In fact, there are also a group of collectors that offersimilar functionality, in the vein of <code class="literal">averagingInt</code>. You can add up the valuesusing<a class="indexterm" id="6_id391020"></a> <code class="literal">summingInt</code> and friends. <a class="indexterm" id="6_id391036"></a> <code class="literal">SummaryStatistics</code> is collectible using<a class="indexterm" id="6_id391051"></a>
                        <code class="literal">summarizingInt</code> and its combinations.</p>
                </div>
                <div class="sect2">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h3 class="title" id="_partitioning_the_data">Partitioning the Data</h3>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="6_id391072"></a>Another common operation that you might want to do with a <code class="literal">Stream</code> ispartition it into two collections of values. For example, if you’ve got a<code class="literal">Stream</code>                        of artists, then you might wish to get all the artists who are soloartists—that is, who have no fellow band members—and all the artists who are bands. Oneapproach to doing this is to perform two different filters, one looking forsolo
                        artists and the other for bands.<a class="indexterm" id="6_id391082"></a></p>
                    <p>This approach has a couple of downsides, though. First, you’ll need two streams inorder to perform these two stream operations. Second, if you’ve got a longsequence of operations leading up to your filters, these will need to beperformed
                        twice over each stream. This also doesn’t result in clean code.</p>
                    <p>Consequently, there is a collector, <code class="literal">partitioningBy</code>, that takes a stream and partitions itscontents into two groups (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#jvld_0501">Figure 5-1</a>).
                        It uses a<a class="indexterm" id="6_id362671"></a> <code class="literal">Predicate</code> to determine whether an elementshould be part of the true group or the false group and returns a <code class="literal">Map</code> from
                        <code class="literal">Boolean</code> to a <code class="literal">List</code> of values. So, the <code class="literal">Predicate</code> returns <code class="literal">true</code> for allthe values in the <code class="literal">true</code> <code class="literal">List</code>                            and <code class="literal">false</code> for the other <code class="literal">List</code>.</p>
                    <div class="figure"><a id="6_jvld_0501"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt=".The partitioningBy Collector" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0501.png" height="533" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0501.png" width="824"/></div>
                        </div>
                        <div class="figure-title">Figure 5-1. The partitioningBy collector</div>
                    </div>
                    <p>We can use these features to split out bands (artists with more than onemember) from solo artists. In this case, our partitioning function tells uswhether the artist is a solo act. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#BANDS_AND_SOLO">Example 5-8</a>                        provides animplementation.</p>
                    <div class="example"><a id="6_BANDS_AND_SOLO"></a>
                        <div class="example-title">Example 5-8. Partitioning a stream of artists into bands and solo artists</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Boolean</span>,
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> bandsAndSolo(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> artists) {
    <span style="color:#00f;font-weight:700">return</span> artists<span style="color:#00f;font-weight:700">.</span>collect(partitioningBy(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>isSolo()));
}
</pre>
                        </div>
                    </div>
                    <p>We can also write this using method references, as demonstrated in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#BANDS_AND_SOLO_REF">Example 5-9</a>.</p>
                    <div class="example"><a id="6_BANDS_AND_SOLO_REF"></a>
                        <div class="example-title">Example 5-9. Partitioning up a stream of artists into bands and solo artists using a method reference</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Boolean</span>,
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> bandsAndSoloRef(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> artists) {
    <span style="color:#00f;font-weight:700">return</span> artists<span style="color:#00f;font-weight:700">.</span>collect(partitioningBy(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>isSolo));
}
</pre>
                        </div>
                    </div>
                </div>
                <div class="sect2">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h3 class="title" id="_grouping_the_data">Grouping the Data</h3>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="6_id374516"></a>There’s a natural way to generalize partitioning through altering the groupingoperation. It’s more general in the sense that instead of splitting up yourdata into <code class="literal">true</code>                        and <code class="literal">false</code> groups, you can use whatever values you want.Perhaps some code has given you a <code class="literal">Stream</code> of albums and you want to group themby the name of their main musician. You
                        might write some code like <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#ALBUMS_BY_ARTIST">Example 5-10</a>.</p>
                    <div class="example"><a id="6_ALBUMS_BY_ARTIST"></a>
                        <div class="example-title">Example 5-10. Grouping albums by their main artist</div>
                        <div class="example-contents">
                          <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> albumsByArtist(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> albums) {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>collect(groupingBy(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getMainMusician()));
}
</pre>
                        </div>
                    </div>
                    <p>As with the other examples, we’re calling <code class="literal">collect</code> on the <code class="literal">Stream</code> and passingin a <code class="literal">Collector</code>. Our<a class="indexterm" id="6_id389376"></a> <code class="literal">groupingBy</code>                        collector (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#jvld_0502">Figure 5-2</a>) takes a <code class="literal">classifier</code> function inorder to partition the
                        data, just like the <code class="literal">partitioningBy</code> collector took a<code class="literal">Predicate</code> to split it up into <code class="literal">true</code> and <code class="literal">false</code> values. Our classifier
                        is a<code class="literal">Function</code>—the same type that we use for the common <code class="literal">map</code> operation.</p>
                    <div class="figure"><a id="6_jvld_0502"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt=".The groupingBy Collector" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0502.png" height="533" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0502.png" width="733"/></div>
                        </div>
                        <div class="figure-title">Figure 5-2. The groupingBy collector</div>
                    </div>
                    <div class="note">
                        <h3 class="title">Note</h3>
                        <p>You might be familiar with<a class="indexterm" id="6_id373344"></a> <code class="literal">group by</code> from using SQL; here we have a methodwith a similar concept, but implemented in the idioms of the streams library.</p>
                    </div>
                </div>
                <div class="sect2">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h3 class="title" id="_strings">Strings</h3>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="6_id373367"></a><a class="indexterm" id="6_id373379"></a>A very common reason for collecting streams of data is to generate strings at theend. Let’s suppose that we want to put together a formatted list ofnames
                        of the artists involved in an album. So, for example, if our input albumis <span class="emphasis"><em>Let It Be</em></span>, then we’re expecting our output to look like <code class="literal">[George Harrison,John Lennon, Paul McCartney, Ringo Starr, The Beatles]</code>.</p>
                    <p>If we were to implement this before Java 8, we might have come up withsomething like <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#string_for_loop">Example 5-11</a>. Here,
                        we use a <code class="literal">StringBuilder</code> toaccumulate the values, iterating over the list. At each step, we pull out thenames of the artists and add them to the <code class="literal">StringBuilder</code>.</p>
                    <div class="example"><a id="6_string_for_loop"></a>
                        <div class="example-title">Example 5-11. Formatting artist names using a for loop</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">StringBuilder</span> builder <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringBuilder</span>(<span style="color:#036a07">[</span>);
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Artist</span> artist<span style="color:#00f;font-weight:700">:</span> artists) {
    <span style="color:#00f;font-weight:700">if</span> (builder<span style="color:#00f;font-weight:700">.</span>length() <span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#0000cd">1</span>) builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">, </span>);
    <span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> artist<span style="color:#00f;font-weight:700">.</span>getName();
    builder<span style="color:#00f;font-weight:700">.</span>append(name);
}
builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">]</span>);
<span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> builder<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
                        </div>
                    </div>
                    <p>Of course, this isn’t particularly great code. It’s pretty hard to see what it’sdoing without walking through it step by step. With Java 8 we can write<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#string_collectors_joining">Example 5-12</a>,
                        which makes our intent much clearer usingstreams and collectors.</p>
                    <div class="example"><a id="6_string_collectors_joining"></a>
                        <div class="example-title">Example 5-12. Formatting artist names using streams and collectors</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span><span style="color:#00f;font-weight:700">.</span>joining(<span style="color:#036a07">, </span>, <span style="color:#036a07">[</span>, <span style="color:#036a07">]</span>));
</pre>
                        </div>
                    </div>
                    <p>Here, we use a <code class="literal">map</code> to extract the artists’ names and then <code class="literal">collect</code> the <code class="literal">Stream</code>using<a class="indexterm" id="6_id363601"></a> <code class="literal">Collectors.joining</code>.
                        This method is a convenience for building upstrings from streams. It lets us provide a delimiter (which goes betweenelements), a prefix for our result, and a suffix for the result.</p>
                </div>
                <div class="sect2">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h3 class="title" id="_composing_collectors">Composing Collectors</h3>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="6_ix_ch05-asciidoc6"></a>Although the collectors we’ve seen so far are quite powerful, they becomesignificantly more so when composed with other collectors.</p>
                    <p>Previously we grouped albums by their main artist; now let’s consider the problemof counting the number of albums for each artist. A simple approach would beto apply the previous grouping and then count the values. You can see how
                        thatworks out in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#NUMBER_OF_ALBUMS_DUMB">Example 5-13</a>.</p>
                    <div class="example"><a id="6_NUMBER_OF_ALBUMS_DUMB"></a>
                        <div class="example-title">Example 5-13. A naive approach to counting the number of albums for each artist</div>
                        <div class="example-contents">
                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> albumsByArtist <span style="color:#00f;font-weight:700">=</span> albums<span style="color:#00f;font-weight:700">.</span>collect(groupingBy(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getMainMusician()));
<span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> numberOfAlbums <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashMap</span> &lt; &gt;();
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Entry</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>, <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> entry<span style="color:#00f;font-weight:700">:</span> albumsByArtist<span style="color:#00f;font-weight:700">.</span>entrySet()) {
    numberOfAlbums<span style="color:#00f;font-weight:700">.</span>put(entry<span style="color:#00f;font-weight:700">.</span>getKey(), entry<span style="color:#00f;font-weight:700">.</span>getValue()<span style="color:#00f;font-weight:700">.</span>size());
}
</pre>
                        </div>
                    </div>
                    <p>Hmm, it might have sounded like a simple approach, but it got a bit messy.This code is also imperative and doesn’t automatically parallelize.</p>
                    <p>What we want here is actually another collector that tells<a class="indexterm" id="6_id333592"></a> <code class="literal">groupingBy</code> thatinstead of building up a <code class="literal">List</code> of albums for each artist, it
                        should just count them.Conveniently, this is already in the core library and is called <code class="literal">counting</code>. So,we can rewrite the example into <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#NUMBER_OF_ALBUMS">Example 5-14</a>.</p>
                    <div class="example"><a id="6_NUMBER_OF_ALBUMS"></a>
                        <div class="example-title">Example 5-14. Using collectors to count the number of albums for each artist</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">Long</span> <span style="color:#00f;font-weight:700">&gt;</span> numberOfAlbums(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> albums) {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>collect(groupingBy(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getMainMusician(), counting()));
}
</pre>
                        </div>
                </div>
                <p>This form of <code class="literal">groupingBy</code> divides elements into <span class="emphasis"><em>buckets</em></span>. Each bucket gets associated with the key provided by the classifier function: <code class="literal">getMainMusician</code>.
                    The <code class="literal">groupingBy</code> operation then uses the downstream collector to collect each bucket and makes a map of the results.</p>
                <p>Let’s consider another example, in which instead of building up a grouping ofalbums, we just want their names. Again, one approach is to take our originalcollector and then fix up the resulting values in the <code class="literal">Map</code>.
                    <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#NAME_OF_ALBUMS_DUMB">Example 5-15</a>shows how we might do that.</p>
                <div class="example"><a id="6_NAME_OF_ALBUMS_DUMB"></a>
                    <div class="example-title">Example 5-15. A naive approach to finding the names of every album that an artist has produced</div>
                    <div class="example-contents">
                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> nameOfAlbumsDumb(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> albums) {
    <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> albumsByArtist <span style="color:#00f;font-weight:700">=</span> albums<span style="color:#00f;font-weight:700">.</span>collect(groupingBy(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getMainMusician()));
    <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> nameOfAlbums <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashMap</span> &lt; &gt;();
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Entry</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>, <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> entry<span style="color:#00f;font-weight:700">:</span> albumsByArtist<span style="color:#00f;font-weight:700">.</span>entrySet()) {
        nameOfAlbums<span style="color:#00f;font-weight:700">.</span>put(entry<span style="color:#00f;font-weight:700">.</span>getKey(), entry<span style="color:#00f;font-weight:700">.</span>getValue()<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Album</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>collect(toList()));
    }
    <span style="color:#00f;font-weight:700">return</span> nameOfAlbums;
}
</pre>
                    </div>
                </div>
                <p>Again, we can produce nicer, faster, and easier-to-parallelize code using another collector. We already know that we can group our albums by the main artist using the <code class="literal">groupingBy</code> collector, but that would output
                    a <code class="literal">Map&lt;Artist, List&lt;Album&gt;&gt;</code>. Instead of associating a list of albums with each <code class="literal">Artist</code>, we want to associate a list of strings, each of which is the name of an album.</p>
                <p>In this case, what we’re really trying to do is perform a <code class="literal">map</code> operation onthe list from the <code class="literal">Artist</code> to the album name. We can’t just use the <code class="literal">map</code> methodon
                    streams because this list is created by the <code class="literal">groupingBy</code> collector. Weneed a way of telling the <code class="literal">groupingBy</code> collector to <code class="literal">map</code> its list valuesas it’s
                    building up the result.</p>
                <p>Each collector is a recipe for building a final value. What we really want is arecipe to give to our recipe—<span class="emphasis"><em>another</em></span> collector. Thankfully, the boffins at<a class="indexterm" id="6_id307240"></a>Oracle
                    have thought of this use case and provided a collector called<a class="indexterm" id="6_id332045"></a> <code class="literal">mapping</code>.</p>
                <p>The <code class="literal">mapping</code> collector allows you to perform a <code class="literal">map</code>-like operation over yourcollector’s container. You also need to tell your <code class="literal">mapping</code> collector whatcollection
                    it needs to store the results in, which you can do with the <code class="literal">toList</code>collector. It’s turtles, I mean collectors, all the way down!</p>
                <p>Just like <code class="literal">map</code>, this takes an implementation of <code class="literal">Function</code>. If we refactorour code to use a second collector, we end up with <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#NAME_OF_ALBUMS">Example 5-16</a>.</p>
                <div class="example"><a id="6_NAME_OF_ALBUMS"></a>
                    <div class="example-title">Example 5-16. Using collectors to find the names of every album that an artist has produced</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> nameOfAlbums(<span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> albums) {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>collect(groupingBy(<span style="color:#00f;font-weight:700">Album</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getMainMusician, mapping(<span style="color:#00f;font-weight:700">Album</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName, toList())));
}
</pre>
                    </div>
        </div>
        <p>In both of these cases, we’ve used a second collector in order to collect a subpart of the final result. These collectors are called <span class="emphasis"><em>downstream</em></span> collectors. In the same way that a collector is a recipe for
            building a final value, a downstream collector is a recipe for building a part of that value, which is then used by the main collector. The way you can compose collectors like this makes them an even more powerful component in the streams
            library.</p>
        <p>The primitive specialized functions, such as<a class="indexterm" id="6_id342461"></a><a class="indexterm" id="6_id342457"></a> <code class="literal">averagingInt</code> or <code class="literal">summarizingLong</code>, are actually duplicate functionality
            over calling the method on the specialized stream themselves. The real motivation for them to exist is to be used as downstream collectors.<a class="indexterm" id="6_id342482"></a></p>
    </div>
    <div class="sect2">
        <div class="titlepage">
            <div>
                <div>
                    <h3 class="title" id="_refactoring_and_custom_collectors">Refactoring and Custom Collectors</h3>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="6_ix_ch05-asciidoc7"></a><a class="indexterm" id="6_ix_ch05-asciidoc8"></a><a class="indexterm" id="6_ix_ch05-asciidoc9"></a>Although the built-in Java collectors are good building blocks for common operations around streams,
            the collector framework is very generic. There is nothing special or magic about the ones that ship with the JDK, and you can build your own collectors very simply. That’s what we’ll look at now.</p>
        <p>You may recall when we looked at strings that we could write our example in Java 7, albeit inelegantly. Let’s take this example and slowly refactor it into a proper <code class="literal">String</code>-joining collector. There’s no need for you
            to use this code—the JDK provides a perfectly good <code class="literal">joining</code> collector—but it is quite an instructive example both of how custom collectors work and of how to refactor legacy code into Java 8.</p>
        <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#String_for_loop">Example 5-17</a> is a reminder of our Java 7 <code class="literal">String</code>-joining example.</p>
        <div class="example"><a id="6_String_for_loop"></a>
            <div class="example-title">Example 5-17. Using a for loop and a StringBuilder to pretty-print the names of artists</div>
            <div class="example-contents">
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">StringBuilder</span> builder <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringBuilder</span>(<span style="color:#036a07">[</span>);
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Artist</span> artist<span style="color:#00f;font-weight:700">:</span> artists) {
    <span style="color:#00f;font-weight:700">if</span> (builder<span style="color:#00f;font-weight:700">.</span>length() <span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#0000cd">1</span>) builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">, </span>);
    <span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> artist<span style="color:#00f;font-weight:700">.</span>getName();
    builder<span style="color:#00f;font-weight:700">.</span>append(name);
}
builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">]</span>);
<span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> builder<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
            </div>
        </div>
        <p>It’s pretty obvious that we can use the <code class="literal">map</code> operation to transformthe <code class="literal">Stream</code> of artists into a <code class="literal">Stream</code> of <code class="literal">String</code> names. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_1">Example 5-18</a>is a refactoring of this code to use streams and <code class="literal">map</code>.</p>
        <div class="example"><a id="6_refactor_1"></a>
            <div class="example-title">Example 5-18. Using a forEach and a StringBuilder to pretty-print the names of artists</div>
            <div class="example-contents">
              <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">StringBuilder</span> builder <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringBuilder</span>(<span style="color:#036a07">[</span>);
artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>forEach(name <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
    <span style="color:#00f;font-weight:700">if</span> (builder<span style="color:#00f;font-weight:700">.</span>length() <span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#0000cd">1</span>) builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">, </span>);
    builder<span style="color:#00f;font-weight:700">.</span>append(name);
});
builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">]</span>);
<span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> builder<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
            </div>
        </div>
        <p>This has made things a bit clearer in the sense that the mapping to names showsus what has been built up a bit more quickly. Unfortunately, there’s still thisvery large <code class="literal">forEach</code> block that doesn’t fit into our goal
            of writing code thatis easy to understand by composing high-level operations.</p>
        <p>Let’s put aside our goal of building a custom collector for a moment and justthink in terms of the existing operations that we have on streams. Theoperation that most closely matches what we’re doing in terms of building up a<code class="literal">String</code>            is the <code class="literal">reduce</code> operation. Refactoring <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_1">Example 5-18</a> to use thatresults in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_2">Example 5-19</a>.</p>
        <div class="example"><a id="6_refactor_2"></a>
            <div class="example-title">Example 5-19. Using a reduce and a StringBuilder to pretty-print the names of artists</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">StringBuilder</span> reduced <span style="color:#00f;font-weight:700">=</span> artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>reduce(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringBuilder</span>(), (builder, name) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
    <span style="color:#00f;font-weight:700">if</span> (builder<span style="color:#00f;font-weight:700">.</span>length() <span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#0000cd">0</span>) builder<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">, </span>);
    builder<span style="color:#00f;font-weight:700">.</span>append(name);
    <span style="color:#00f;font-weight:700">return</span> builder;
},
(left, right) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>left<span style="color:#00f;font-weight:700">.</span>append(right));
reduced<span style="color:#00f;font-weight:700">.</span>insert(<span style="color:#0000cd">0</span>, <span style="color:#036a07">[</span>);
reduced<span style="color:#00f;font-weight:700">.</span>append(<span style="color:#036a07">]</span>);
<span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> reduced<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
            </div>
        </div>
        <p>I had hoped that last refactor would help us make the code clearer. Unfortunately, it seems to be just as bad as before. Still, let’s see what’s going on. The <code class="literal">stream</code> and <code class="literal">map</code> calls are the
            same as in the previous example. Our <code class="literal">reduce</code> operation builds up the artist names, combined with <code class="literal">, </code> delimiters. We start with an empty <code class="literal">StringBuilder</code>—the
            identity of the <code class="literal">reduce</code>. Our next lambda expression combines a name with a builder. The third argument to <code class="literal">reduce</code> takes two <code class="literal">StringBuilder</code> instances and combines
            them. Our final step is to add the prefix at the beginning and the suffix at the end.</p>
        <p>For our next refactoring attempt, let’s try and stick with reduction but hide the mess—I mean, abstract away the details—behind a class that we’ll call a <code class="literal">StringCombiner</code>. Implementing this results in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_3">Example 5-20</a>.</p>
        <div class="example"><a id="6_refactor_3"></a>
            <div class="example-title">Example 5-20. Using a reduce and a custom StringCombiner to pretty-print the names of artists</div>
            <div class="example-contents">
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">StringCombiner</span> combined <span style="color:#00f;font-weight:700">=</span> artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>reduce(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringCombiner</span>(<span style="color:#036a07">, </span>, <span style="color:#036a07">[</span>, <span style="color:#036a07">]</span>), <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>add, <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>merge);
<span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> combined<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
            </div>
        </div>
        <p>Even though this looks quite different from the previous code example, it’s actually doing the exact same thing under the hood. We’re using <code class="literal">reduce</code> in order to combine names and delimiters into a <code class="literal">StringBuilder</code>.
            This time, though, the logic of adding elements is being delegated to the <code class="literal">StringCombiner.add</code> method and the logic of combining two different combiners is delegated to <code class="literal">StringCombiner.merge</code>.
            Let’s take a look at these methods now, beginning with the <code class="literal">add</code> method in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#stringcombiner_add">Example 5-21</a>.</p>
        <div class="example"><a id="6_stringcombiner_add"></a>
            <div class="example-title">Example 5-21. The add method of a StringCombiner returns itself with a new element appended</div>
            <div class="example-contents">
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">StringCombiner</span> add(<span style="color:#00f;font-weight:700">String</span> element) {
    <span style="color:#00f;font-weight:700">if</span> (areAtStart()) {
        builder<span style="color:#00f;font-weight:700">.</span>append(prefix);
    } <span style="color:#00f;font-weight:700">else</span> {
        builder<span style="color:#00f;font-weight:700">.</span>append(delim);
    }
    builder<span style="color:#00f;font-weight:700">.</span>append(element);
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#318495">this</span>;
}
</pre>
            </div>
    </div>
    <p><code class="literal">add</code> is implemented by delegating operations to an underlying <code class="literal">StringBuilder</code> instance. If we’re at the start of the combining operations, then we append our prefix; otherwise, we append the string
        that fits between our elements (the delimiter). We follow this up by appending the element. We return the <code class="literal">StringCombiner</code> object because this is the value that we’re pushing through our <code class="literal">reduce</code>        operation. The merging code, provided in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#stringcombiner_merge">Example 5-22</a>, delegates to appending operations on the <code class="literal">StringBuilder</code>.</p>
    <div class="example"><a id="6_stringcombiner_merge"></a>
        <div class="example-title">Example 5-22. The merge method of a StringCombiner combines the results of both StringCombiners</div>
        <div class="example-contents">
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">StringCombiner</span> merge(<span style="color:#00f;font-weight:700">StringCombiner</span> other) {
    builder<span style="color:#00f;font-weight:700">.</span>append(other<span style="color:#00f;font-weight:700">.</span>builder);
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#318495">this</span>;
}
</pre>
        </div>
        </div>
        <p>We’re nearly done with the <code class="literal">reduce</code> phase of refactoring, but there’s one small step remaining. We’re going to inline the <code class="literal">toString</code> to the end of the method call chain so that our entire sequence
            is method-chained. This is simply a matter of lining up the <code class="literal">reduce</code> code so that it’s ready to be converted into the Collector API (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_4">Example 5-23</a>).</p>
        <div class="example"><a id="6_refactor_4"></a>
            <div class="example-title">Example 5-23. Using a reduce and delegating to our custom StringCombiner</div>
            <div class="example-contents">
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>reduce(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringCombiner</span>(<span style="color:#036a07">, </span>, <span style="color:#036a07">[</span>, <span style="color:#036a07">]</span>), <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>add, <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>merge)<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
            </div>
            </div>
            <p>At this stage, we have some code that looks vaguely sane, but it’s quite hard toreuse this same combining operation in different parts of our code base. Sowe’re going to refactor our <code class="literal">reduce</code> operation into a
                <code class="literal">Collector</code>, whichwe can use anywhere in our application. I’ve called our <code class="literal">Collector</code>the <code class="literal">StringCollector</code>. Let’s refactor our code to use it in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_5">Example 5-24</a>.</p>
            <div class="example"><a id="6_refactor_5"></a>
                <div class="example-title">Example 5-24. Collecting strings using a custom StringCollector</div>
                <div class="example-contents">
                 <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringCollector</span>(<span style="color:#036a07">, </span>, <span style="color:#036a07">[</span>, <span style="color:#036a07">]</span>));
</pre>
                </div>
                </div>
                <p>Now that we’re delegating the whole of the <code class="literal">String</code>-joining behavior to acustom collector, our application code doesn’t need to understand anythingabout the internals of <code class="literal">StringCollector</code>.
                    It’s just another <code class="literal">Collector</code>like any in the core framework.</p>
                <p>We begin by implementing the <code class="literal">Collector</code> interface (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#StringCollector_class_def">Example 5-25</a>).
                    <code class="literal">Collector</code> is generic, so we need to determine a few types to interact with:</p>
                <div class="itemizedlist">
                    <ul class="itemizedlist">
                        <li class="listitem">The type of the element that we’ll be collecting, a <code class="literal">String</code></li>
                        <li class="listitem">Our accumulator type, <code class="literal">StringCombiner</code>, which you’ve already seen</li>
                        <li class="listitem">The result type, also a <code class="literal">String</code></li>
                    </ul>
                </div>
                <div class="example"><a id="6_StringCollector_class_def"></a>
                    <div class="example-title">Example 5-25. How to define a collector over strings</div>
                    <div class="example-contents">
                        <pre class="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StringCollector</code> <code class="kd">implements</code> <code class="n">Collector</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">StringCombiner</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="o">{</code></pre>
                    </div>
                </div>
                <p>A <code class="literal">Collector</code> is composed of four different components. First we have a <code class="literal">supplier</code>, which is a factory for making our container—in this case, a <code class="literal">StringCombiner</code>.
                    The analogue to this is the first argument provided to the <code class="literal">reduce</code> operation, which was the initial value of the <code class="literal">reduce</code> (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#StringCollector_supplier">Example 5-26</a>).</p>
                <div class="example"><a id="6_StringCollector_supplier"></a>
                    <div class="example-title">Example 5-26. A supplier is a factory for making our container</div>
                    <div class="example-contents">
                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Supplier</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">StringCombiner</span> <span style="color:#00f;font-weight:700">&gt;</span> supplier() {
    <span style="color:#00f;font-weight:700">return</span> () <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringCombiner</span>(delim, prefix, suffix);
}
</pre>
                    </div>
                    </div>
                    <p>Let’s step through this in diagram form while we’re walking through thecode so that we can see how things fit together. Because collectors can becollected in parallel, we will show a collecting operation where two containerobjects
                        (e.g., <code class="literal">StringCombiner</code>s) are used in parallel.</p>
                    <p>Each of the four components of our <code class="literal">Collector</code> are functions, so we’llrepresent them as arrows. The values in our <code class="literal">Stream</code> are circles, and the finalvalue we’re producing will be
                        an oval. At the start of the collect operationour supplier is used to create new container objects (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#jvld_0503">Figure 5-3</a>).</p>
                    <div class="figure"><a id="6_jvld_0503"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt=".Supplier" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0503.png" height="472" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0503.png" width="674"/></div>
                        </div>
                        <div class="figure-title">Figure 5-3. Supplier</div>
                        </div>
                        <p>Our collector’s <code class="literal">accumulator</code> performs the same job as the second argument to<code class="literal">reduce</code>. It takes the current element and the result of the precedingoperation and returns a new
                            value. We’ve already implemented this logic in the<code class="literal">add</code> method of our <code class="literal">StringCombiner</code>, so we just refer to that (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#StringCollector_accumulator">Example 5-27</a>).</p>
                        <div class="example"><a id="6_StringCollector_accumulator"></a>
                            <div class="example-title">Example 5-27. An accumulator is a function to fold the current element into the collector</div>
                            <div class="example-contents">
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">BiConsumer</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">StringCombiner</span>,
<span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> accumulator() {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>add;
}
</pre>
                            </div>
                            </div>
                            <p>Our accumulator is used to fold the stream’s values into the container objects (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#jvld_0504">Figure 5-4</a>).</p>
                            <div class="figure"><a id="6_jvld_0504"></a>
                                <div class="figure-contents">
                                    <div class="mediaobject"><img alt=".Accumulator" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0504.png" height="406" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0504.png" width="675"/></div>
                                </div>
                                <div class="figure-title">Figure 5-4. Accumulator</div>
                                </div>
                                <p>The <code class="literal">combine</code> method is an analogue of the third method of our <code class="literal">reduce</code>operation. If we have two containers, then we need to be able to merge themtogether. Again, we’ve
                                    already implemented this in a previous refactor step,so we just use the <code class="literal">StringCombiner.merge</code> method (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#StringCollector_combiner">Example 5-28</a>).</p>
                                <div class="example"><a id="6_StringCollector_combiner"></a>
                                    <div class="example-title">Example 5-28. A combiner merges together two containers</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">BinaryOperator</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">StringCombiner</span> <span style="color:#00f;font-weight:700">&gt;</span> combiner() {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>merge;
}
</pre>
                                    </div>
                                    </div>
                                    <p>During the collect operation, our container objects are pairwise merged using the defined <code class="literal">combiner</code> until we have only one container at the end (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#jvld_0505">Figure 5-5</a>).</p>
                                    <div class="figure"><a id="6_jvld_0505"></a>
                                        <div class="figure-contents">
                                            <div class="mediaobject"><img alt=".Combiner" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0505.png" height="482" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0505.png" width="675"/></div>
                                        </div>
                                        <div class="figure-title">Figure 5-5. Combiner</div>
                                        </div>
                                        <p>You might remember that the last step in our refactoring process, before we gotto collectors, was to put the <code class="literal">toString</code> method inline at the end of themethod chain. This converted our
                                            <code class="literal">StringCombiner</code> into the <code class="literal">String</code> that wereally wanted (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#jvld_0506">Figure 5-6</a>).</p>
                                        <div class="figure"><a id="6_jvld_0506"></a>
                                            <div class="figure-contents">
                                                <div class="mediaobject"><img alt=".Finisher" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0506.png" height="406" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0506.png" width="635"/></div>
                                            </div>
                                            <div class="figure-title">Figure 5-6. Finisher</div>
                                            </div>
                                            <p>Our collector’s <code class="literal">finisher</code> method performs the same purpose. We’ve alreadyfolded our mutable container over a <code class="literal">Stream</code> of values, but it’s not quite thefinal
                                                value that we want. The <code class="literal">finisher</code> gets called here, once, in order tomake that conversion. This is especially useful if we want to create animmutable final value, such as a
                                                <code class="literal">String</code>, but our container is mutable.</p>
                                            <p>In order to implement the <code class="literal">finisher</code> for this operation, we just delegate to the<code class="literal">toString</code> method that we’ve already written (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#StringCollector_finisher">Example 5-29</a>).</p>
                                            <div class="example"><a id="6_StringCollector_finisher"></a>
                                                <div class="example-title">Example 5-29. A finisher produces the final value returned by the collect operation</div>
                                                <div class="example-contents">
                                                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Function</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">StringCombiner</span>,
<span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> finisher() {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>toString;
}
</pre>
                                                </div>
                                                </div>
                                                <p>We create our final value from the one remaining container.</p>
                                                <p>There’s one aspect of collectors that I haven’t described so far: <span class="emphasis"><em>characteristics</em></span>. A characteristic is a <code class="literal">Set</code> of objects that describes
                                                    the <code class="literal">Collector</code>, allowing the framework to perform certain optimizations. It’s defined through a <code class="literal">characteristics</code> method.</p>
                                                <p>At this juncture, it’s worth reminding ourselves that this code has been written as an educational exercise and differs a little bit from the internal implementation of the <code class="literal">joining</code>                                                    collector. You may also be thinking that the <code class="literal">StringCombiner</code> class is looking quite useful. Don’t worry—you don’t need to write that either! Java 8 contains a <code class="literal">java.util.StringJoiner</code>                                                    class that performs a similar role and has a similar API.</p>
                                                <p>The main goals of going through this exercise are not only to show how custom collectors work, but also to allow you to write your own collector. This is especially useful if you have a domain class that
                                                    you want to build up from an operation on a collection and none of the standard collectors will build it for you.</p>
                                                <p>In the case of our <code class="literal">StringCollector</code>, the container that we were using to collect values was different from the final value that we were trying to create (a <code class="literal">String</code>).
                                                    This is especially common if you’re trying to collect immutable values rather than mutable ones, because otherwise each step of the collection operation would have to create a new value.</p>
                                                <p>It’s entirely possible for the final value that you’re collecting to be thesame as the container you’ve been folding your values into all along. In fact,this is what happens when the final value that you’re
                                                    collecting is a<code class="literal">Collection</code>, such as with the <code class="literal">toList</code> collector.</p>
                                                <p>In this case, your <code class="literal">finisher</code> method needs to do nothing to its container object. More formally, we can say that the <code class="literal">finisher</code> method is the <code class="literal">identity</code>                                                    function: it returns the value passed as an argument. If this is the case, then your <code class="literal">Collector</code> will exhibit the <code class="literal">IDENTITY_FINISH</code> characteristic
                                                    and should declare it using the <code class="literal">characteristics</code> method.<a class="indexterm" id="6_id302262"></a><a class="indexterm" id="6_id302283"></a><a class="indexterm" id="6_id302232"></a></p>
                                                </div>
                                                <div class="sect2">
                                                    <div class="titlepage">
                                                        <div>
                                                            <div>
                                                                <h3 class="title" id="_reduction_as_a_collector">Reduction as a Collector</h3>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p><a class="indexterm" id="6_id310045"></a><a class="indexterm" id="6_id326802"></a>As you’ve just seen, custom collectors aren’t that hard to write, but if you’re thinking about writing one in order to collect
                                                        into a domain class it is worth examining the alternatives. The most obvious is to build one or more collection objects and then pass them into the constructor of your domain class. This is really
                                                        simple and suitable if your domain class is a composite containing different collections.</p>
                                                    <p>Of course, if your domain class isn’t just a composite and needs to perform some calculation based on the existing data, then that isn’t a suitable route. Even in this situation, though, you don’t necessarily
                                                        need to build up a custom collector. You can use the <code class="literal">reducing</code> collector, which gives us a generic implementation of the reduction operation over streams. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#reducing_collector">Example 5-30</a> shows how we might write our <code class="literal">String</code>-processing
                                                        example using the <code class="literal">reducing</code> collector.</p>
                                                    <div class="example"><a id="6_reducing_collector"></a>
                                                        <div class="example-title">Example 5-30. Reducing is a convenient way of making custom collectors</div>
                                                        <div class="example-contents">
                                                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> artists<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Artist</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getName)<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span><span style="color:#00f;font-weight:700">.</span>reducing(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringCombiner</span>(<span style="color:#036a07">, </span>, <span style="color:#036a07">[</span>, <span style="color:#036a07">]</span>), name <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">StringCombiner</span>(<span style="color:#036a07">, </span>, <span style="color:#036a07">[</span>, <span style="color:#036a07">]</span>)<span style="color:#00f;font-weight:700">.</span>add(name), <span style="color:#00f;font-weight:700">StringCombiner</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>merge))<span style="color:#00f;font-weight:700">.</span>toString();
</pre>
                                                        </div>
                                                    </div>
                                                    <p>This is very similar to the <code class="literal">reduce</code>-based implementation I covered in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#refactor_3">Example 5-20</a>,
                                                        which is what you might expect given the name. The keydifference is the second argument to <code class="literal">Collectors.reducing</code>; we are creating adedicated <code class="literal">StringCombiner</code>                                                        for each element in the stream. If you are shockedor disgusted at this, you should be! This is highly inefficient and one of thereasons why I chose to write a custom collector.<a class="indexterm" id="6_id389888"></a>
                                                        <a class="indexterm" id="6_id389896"></a>
                                                    </p>
                                                </div>
                                                </div>
                                                <div class="sect1">
                                                    <div class="titlepage">
                                                        <div>
                                                            <div>
                                                                <h2 class="title" id="_collection_niceties" style="clear: both">Collection Niceties</h2>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p><a class="indexterm" id="6_ix_ch05-asciidoc10"></a><a class="indexterm" id="6_ix_ch05-asciidoc11"></a>The introduction of lambda expressions has also enabled other collectionmethods to be introduced. Let’s
                                                        have a look at some useful changes that havebeen made to<a class="indexterm" id="6_id389956"></a> <code class="literal">Map</code>.</p>
                                                    <p>A common requirement when building up a <code class="literal">Map</code> is to compute a valuefor a given key. A classic example of this is when implementing acache. The traditional idiom is to try and
                                                        retrieve a value fromthe <code class="literal">Map</code> and then create it, if it’s not already there.</p>
                                                    <p>If we defined our cache as <code class="literal">Map&lt;String, Artist&gt; artistCache</code> and were wanting to look up artists using an expensive database operation, we might write something like
                                                        <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#ARTIST_CACHE_OLD">Example 5-31</a>.</p>
                                                    <div class="example"><a id="6_ARTIST_CACHE_OLD"></a>
                                                        <div class="example-title">Example 5-31. Caching a value using an explicit null check</div>
                                                        <div class="example-contents">
                                                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Artist</span> getArtist(<span style="color:#00f;font-weight:700">String</span> name) {
    <span style="color:#00f;font-weight:700">Artist</span> artist <span style="color:#00f;font-weight:700">=</span> artistCache<span style="color:#00f;font-weight:700">.</span>get(name);
    <span style="color:#00f;font-weight:700">if</span> (artist <span style="color:#00f;font-weight:700">==</span> <span style="color:#585cf6;font-weight:700">null</span>) {
        artist <span style="color:#00f;font-weight:700">=</span> readArtistFromDB(name);
        artistCache<span style="color:#00f;font-weight:700">.</span>put(name, artist);
    }
    <span style="color:#00f;font-weight:700">return</span> artist;
}
</pre>
                                                        </div>
                                                    </div>
                                                    <p>Java 8 introduces a new <code class="literal">computeIfAbsent</code> method that takes a lambda tocompute the new value if it doesn’t already exist. So, we can rewritethe previous block of code into
                                                        <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#ARTIST_CACHE_COMPUTE">Example 5-32</a>.</p>
                                                    <div class="example"><a id="6_ARTIST_CACHE_COMPUTE"></a>
                                                        <div class="example-title">Example 5-32. Caching a value using computeIfAbsent</div>
                                                        <div class="example-contents">
                                                         <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Artist</span> getArtist(<span style="color:#00f;font-weight:700">String</span> name) {
    <span style="color:#00f;font-weight:700">return</span> artistCache<span style="color:#00f;font-weight:700">.</span>computeIfAbsent(name, <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>readArtistFromDB);
}
</pre>
                                                        </div>
                                                    </div>
                                                    <p>You may want variants of this code that don’t perform computation only if the value is absent; the new <code class="literal">compute</code> and <code class="literal">computeIfPresent</code> methods on
                                                        the <code class="literal">Map</code> interface are useful for these cases.</p>
                                                    <p>At some point in your career, you might have tried to iterate over a <code class="literal">Map</code>. Historically, the approach was to use the <code class="literal">values</code> method to get a
                                                        <code class="literal">Set</code> of entries and then iterate over them. This tended to result in fairly hard-to-read code. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#COUNT_ALBUMS_VALUES_UGLY">Example 5-33</a>                                                            shows an approach from earlier in the chapter of creating a new <code class="literal">Map</code> counting the number of albums associated with each artist.</p>
                                                    <div class="example"><a id="6_COUNT_ALBUMS_VALUES_UGLY"></a>
                                                        <div class="example-title">Example 5-33. An ugly way to iterate over all entries of a Map</div>
                                                        <div class="example-contents">
                                                         <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> countOfAlbums <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashMap</span> &lt; &gt;();
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Map</span><span style="color:#00f;font-weight:700">.</span><span style="color:#00f;font-weight:700">Entry</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>, <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> entry<span style="color:#00f;font-weight:700">:</span> albumsByArtist<span style="color:#00f;font-weight:700">.</span>entrySet()) {
    <span style="color:#00f;font-weight:700">Artist</span> artist <span style="color:#00f;font-weight:700">=</span> entry<span style="color:#00f;font-weight:700">.</span>getKey();
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> albums <span style="color:#00f;font-weight:700">=</span> entry<span style="color:#00f;font-weight:700">.</span>getValue();
    countOfAlbums<span style="color:#00f;font-weight:700">.</span>put(artist, albums<span style="color:#00f;font-weight:700">.</span>size());
}
</pre>
                                                        </div>
                                                    </div>
                                                    <p>Thankfully, a new <code class="literal">forEach</code> method has been introduced that takes a <code class="literal">BiConsumer</code> (two values enter, nothing leaves) and produces easier-to-read code
                                                        through internal iteration, which I introduced in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html#internal_iteration_section">From External Iteration to Internal Iteration</a>.
                                                        An equivalent code sample is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch05.html#COUNT_ALBUMS_VALUES_FOREACH">Example 5-34</a>.
                                                        <a class="indexterm" id="6_id336163"></a><a class="indexterm" id="6_id336171"></a></p>
                                                    <div class="example"><a id="6_COUNT_ALBUMS_VALUES_FOREACH"></a>
                                                        <div class="example-title">Example 5-34. Using internal iteration over all entries of a Map</div>
                                                        <div class="example-contents">
                                                          <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span>,
<span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> countOfAlbums <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashMap</span> &lt; &gt;();
albumsByArtist<span style="color:#00f;font-weight:700">.</span>forEach((artist, albums) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
    countOfAlbums<span style="color:#00f;font-weight:700">.</span>put(artist, albums<span style="color:#00f;font-weight:700">.</span>size());
});
</pre>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="sect1">
                                                    <div class="titlepage">
                                                        <div>
                                                            <div>
                                                                <h2 class="title" id="_key_points_4" style="clear: both">Key Points</h2>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="itemizedlist">
                                                        <ul class="itemizedlist">
                                                            <li class="listitem">Method references are a lightweight syntax for referring to methods and look like this: <code class="literal">ClassName::methodName</code>.</li>
                                                            <li class="listitem">Collectors let us compute the final values of streams and are the mutable analogue of the <code class="literal">reduce</code> method.</li>
                                                            <li class="listitem">Java 8 provides out-of-the-box support for collecting into many collection types and the ability to build custom collectors.<a class="indexterm" id="6_id336420"></a><a class="indexterm" id="6_id336427"></a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="sect1">
                                                    <div class="titlepage">
                                                        <div>
                                                            <div>
                                                                <h2 class="title" id="_exercises_4" style="clear: both">Exercises</h2>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="orderedlist">
                                                        <ol class="orderedlist" type="1">
                                                            <li class="listitem">
                                                                <p class="simpara"><span class="emphasis"><em>Method references.</em></span> Take a look back at the examples in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>                                                                    and try rewriting the following using method references:</p>
                                                                <div class="orderedlist">
                                                                    <ol class="orderedlist" type="a">
                                                                        <li class="listitem">The <code class="literal">map</code> to uppercase</li>
                                                                        <li class="listitem">The implementation of <code class="literal">count</code> using <code class="literal">reduce</code></li>
                                                                        <li class="listitem">The <code class="literal">flatMap</code> approach to concatenating lists</li>
                                                                    </ol>
                                                                </div>
                                                            </li>
                                                            <li class="listitem">
                                                                <p class="simpara"><span class="emphasis"><em>Collectors.</em></span></p>
                                                                <div class="orderedlist">
                                                                    <ol class="orderedlist" type="a">
                                                                        <li class="listitem">
                                                                            <p class="simpara">Find the artist with the longest name. You should implement this using a <code class="literal">Collector</code> and the <code class="literal">reduce</code> higher-order function
                                                                                from <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>. Then compare the differences in your implementation:
                                                                                which was easier to write and which was easier to read? The following example should return <code class="literal">Stuart Sutcliffe</code>:</p>
                                                                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> names <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Stream</span><span style="color:#00f;font-weight:700">.</span>of(<span style="color:#036a07">John Lennon</span>, <span style="color:#036a07">Paul McCartney</span>, <span style="color:#036a07">George Harrison</span>, <span style="color:#036a07">Ringo Starr</span>, <span style="color:#036a07">Pete Best</span>, <span style="color:#036a07">Stuart Sutcliffe</span>);
</pre>
                                                                        </li>
                                                                        <li class="listitem">
                                                                            <p class="simpara">Given a <code class="literal">Stream</code> where each element is a word, count the number of times each word appears. So, if you were given the following input, you would return
                                                                                a <code class="literal">Map</code> of <code class="literal">[John → 3, Paul → 2, George → 1]</code>:</p>
                                                                         <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> names <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Stream</span><span style="color:#00f;font-weight:700">.</span>of(<span style="color:#036a07">John</span>, <span style="color:#036a07">Paul</span>, <span style="color:#036a07">George</span>, <span style="color:#036a07">John</span>, <span style="color:#036a07">Paul</span>, <span style="color:#036a07">John</span>);
</pre>
                                                                        </li>
                                                                        <li class="listitem">Implement <code class="literal">Collectors.groupingBy</code> as a custom collector. You don’t need to provide a downstream collector, so just implementing the simplest variant is
                                                                            fine. If you look at the JDK source code, you’re cheating! Hint: you might want to start with <code class="literal">public class GroupingBy&lt;T, K&gt; implements Collector&lt;T, Map&lt;K, List&lt;T&gt;&gt;, Map&lt;K, List&lt;T&gt;&gt;&gt;</code>.
                                                                            This is an advanced exercise, so you might want to attempt it last.</li>
                                                                    </ol>
                                                                </div>
                                                            </li>
                                                            <li class="listitem">
                                                                <p class="simpara"><span class="emphasis"><em>Map enhancements.</em></span></p>
                                                                <p class="simpara">Efficiently calculate a Fibonacci sequence using just the <code class="literal">computeIfAbsent</code> method on a <code class="literal">Map</code>. By “efficiently,” I mean that you don’t
                                                                    repeatedly recalculate the Fibonacci sequence of smaller numbers.</p>
                                                            </li>
                                                        </ol>
                                                    </div>
                                                </div>
                                                </section>
                                                <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
                                                </div>
                                                </div>
                                                </section>
                                                </div>
                                                </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch06.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch06.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="7_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="parallelism_chp">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 6. Data Parallelism</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="7_ix_ch06-asciidoc0"></a>I’ve previously made a lot of references to the idea that it’s easier to write parallel code in Java 8. This is because we can use lambda expressions in combination with the streams
                                library, introduced in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>, to say what we want our program to do, regardless of whether it’s sequential
                                or parallel. I know that sounds a lot like what you’ve been doing in Java for years, but there’s a difference between saying what you want to compute and saying how to compute it.</p>
                            <p>The big shift between external and internal iteration (also discussed in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>) did make it easier to write
                                simple and clean code, but here’s the other big benefit: now we don’t have to manually control the iteration. It doesn’t need to be performed sequentially. We express the what and, by changing a single method call, we can
                                get a library to figure out the how.</p>
                            <p>The changes to your code are surprisingly unobtrusive, so the majority of this chapter won’t be talking about how your code changes. Instead, I’ll explain why you might want to go parallel and when you’ll get performance improvements.
                                It’s also worth noting that this chapter isn’t a general text on performance in Java; we’ll just be looking at the easy wins provided in Java 8.</p>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_parallelism_versus_concurrency" style="clear: both">Parallelism Versus Concurrency</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="7_ix_ch06-asciidoc1"></a><a class="indexterm" id="7_ix_ch06-asciidoc2"></a>After a quick scan over the table of contents of this book, you might have noticed this chapter with the word <span class="emphasis"><em>parallelism</em></span>                                    in the title and also <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html">Chapter 9</a>, which has <span class="emphasis"><em>concurrency</em></span> in the title.
                                    Don’t worry—I haven’t repeated the same material in an attempt to justify charging you more for this book! Concurrency and parallelism are different things that can be leveraged to achieve different aims.</p>
                                <p><a class="indexterm" id="7_id308730"></a><a class="indexterm" id="7_id308685"></a>Concurrency arises when two tasks are making progress at overlapping timeperiods. Parallelism arises when two tasks are happening at literally
                                    the sametime, such as on a multicore CPU. If a program is undertaking two tasks andthey are being given small slices of a single CPU core’s time, then it isexhibiting concurrency but not parallelism. This difference
                                    is shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#concurrency_vs_parallelism">Figure 6-1</a>.</p>
                                <div class="figure"><a id="7_concurrency_vs_parallelism"></a>
                                    <div class="figure-contents">
                                        <div class="mediaobject"><img alt=".Comparison of Concurrency and Parallelism" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0601.png" height="853" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0601.png" width="556"/></div>
                                    </div>
                                    <div class="figure-title">Figure 6-1. Comparison of concurrency and parallelism</div>
                                </div>
                                <p>The goal of parallelism is to reduce the runtime of a specific task by breakingit down into smaller components and performing them in parallel. This doesn’tmean that you won’t do as much work as you would if you were running
                                    themsequentially—you are just getting more horses to pull the same cart for ashorter time period. In fact, it’s usually the case that running a task inparallel requires more work to be done by the CPU than running it
                                    sequentiallywould.</p>
                                <p>In this chapter, we’re looking at a very specific form of parallelism called<span class="emphasis"><em>data parallelism</em></span>. In data parallelism, we achieve parallelism by splitting upthe data to be operated on
                                    and assigning a single processing unit to each chunk ofdata. If we’re to extend our horses-pulling-carts analogy, it would be liketaking half of the goods inside our cart and putting them into another cart foranother
                                    horse to pull, with both horses taking an identical route to thedestination.</p>
                                <p>Data parallelism works really well when you want to perform the same operationon a lot of data. The problem needs be decomposed in a way that will work onsubsections of the data, and then the answers from each subsection
                                    can becomposed at the end.</p>
                                <p><a class="indexterm" id="7_id383856"></a><a class="indexterm" id="7_id308848"></a>Data parallelism is often contrasted with <span class="emphasis"><em>task parallelism</em></span>, in which eachindividual thread of execution
                                    can be doing a totally different task. Probablythe most commonly encountered task parallelism is a Java EE applicationcontainer. Each thread not only can be dealing with processing a different user,but also could be
                                    performing different tasks for a user, such as logging in oradding an item to a shopping cart.<a class="indexterm" id="7_id308767"></a><a class="indexterm" id="7_id308793"></a></p>
                            </div>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_why_is_parallelism_important" style="clear: both">Why Is Parallelism Important?</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="7_id383872"></a><a class="indexterm" id="7_id308741"></a>Historically, we could all rely on the clock frequency of a CPU getting fasterover time. Intel’s 8086 processor, introduced in 1979, started
                                    at a 5 MHzclock rate, and by the time the Pentium chip was introduced in 1993 speeds hadreached 60 MHz. Improved sequential performance continued through theearly 2000s.</p>
                                <p><a class="indexterm" id="7_id308752"></a>Over the last decade, however, mainstream chip manufacturers have been moving increasingly toward heavily multicore processors. At the time of writing, it’s not uncommon for servers
                                    to be shipping with 32 or 64 cores spread over several physical processing units. This trend shows no sign of abating soon.</p>
                                <p>This influences the design of software. Instead of being able to rely onimproved CPU clock speeds to increase the computational capacity of existingcode, we need to be able to take advantage of modern CPU architectures.
                                    Theonly way to do this is by writing parallel programs.</p>
                                <p>I appreciate you’ve probably heard this message before. In fact, it’s one that’s been blasted out by many conference speakers, book authors, and consultants over the years. The implications of<a class="indexterm" id="7_id383913"></a>                                    <span class="emphasis"><em>Amdahl’s Law</em></span> were what really made me take note of the importance of parallelism.</p>
                                <p>Amdahl’s Law is a simple rule that predicts the theoretical maximum speedupof a program on a machine with multiple cores. If we take a program that isentirely serial and parallelize only half of it, then the maximum speeduppossible,
                                    regardless of how many cores we throw at the problem, is 2×. Given alarge number of cores—and we’re already into that territory—the execution time ofa problem is going to be dominated by the serial part of that problem.</p>
                                <p>When you start to think of performance in these terms, optimizing any jobthat is bound by computational work rapidly becomes a matter of ensuring thatit effectively utilizes the available hardware. Of course, not every
                                    job isbound by computational work, but in this chapter we’ll be focusing on thatkind of problem.</p>
                            </div>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="parallel_stream_operations" style="clear: both">Parallel Stream Operations</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="7_ix_ch06-asciidoc3"></a><a class="indexterm" id="7_ix_ch06-asciidoc4"></a>Making an operation execute in parallel using the streams library is amatter of changing a single method call. If you already
                                    have a <code class="literal">Stream</code> object,then you can call its<a class="indexterm" id="7_id383906"></a><a class="indexterm" id="7_id383886"></a> <code class="literal">parallel</code> method in order to make it
                                    parallel. If<a class="indexterm" id="7_id383997"></a><a class="indexterm" id="7_id384001"></a>you’re creating a <code class="literal">Stream</code> from a <code class="literal">Collection</code>, you can call the<code class="literal">parallelStream</code>                                    method in order to create a parallel stream from the get-go.</p>
                                <p>Let’s look at a simple example in order to make things concrete.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#SerialArraySum">Example 6-1</a> calculates the
                                    total length of a sequence of albums. Ittransforms each album into its component tracks, then gets into the length of eachtrack, and then sums them.</p>
                                <div class="example"><a id="7_SerialArraySum"></a>
                                    <div class="example-title">Example 6-1. Serial summing of album track lengths</div>
                                    <div class="example-contents">
                                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">int</span> serialArraySum() {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>flatMap(<span style="color:#00f;font-weight:700">Album</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getTracks)<span style="color:#00f;font-weight:700">.</span>mapToInt(<span style="color:#00f;font-weight:700">Track</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getLength)<span style="color:#00f;font-weight:700">.</span>sum();
}
</pre>
                                    </div>
                                </div>
                                <p>We go parallel by making the call to <code class="literal">parallelStream</code>, as shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#ParallelArraySum">Example 6-2</a>;
                                    all the rest of the code is identical. Going parallel <span class="emphasis"><em>just works</em></span>.</p>
                                <div class="example"><a id="7_ParallelArraySum"></a>
                                    <div class="example-title">Example 6-2. Parallel summing of album track lengths</div>
                                    <div class="example-contents">
                                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">int</span> parallelArraySum() {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>parallelStream()<span style="color:#00f;font-weight:700">.</span>flatMap(<span style="color:#00f;font-weight:700">Album</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getTracks)<span style="color:#00f;font-weight:700">.</span>mapToInt(<span style="color:#00f;font-weight:700">Track</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>getLength)<span style="color:#00f;font-weight:700">.</span>sum();
}
</pre>
                                    </div>
                                </div>
                                <p>I know the immediate instinct upon hearing this is to go out andreplace every call to <code class="literal">stream</code> with a call to <code class="literal">parallelStream</code> because it’s soeasy. Hold your horses
                                    for a moment! Obviously it’s important to make gooduse of parallelism in order to get the most from your hardware, but the kind ofdata parallelism we get from the streams library is only one form.</p>
                                <p><a class="indexterm" id="7_id388659"></a>The question we really want to ask ourselves is whether it’s faster to run our<code class="literal">Stream</code>-based code sequentially or in parallel, and that’s not a questionwith
                                    an easy answer. If we look back at the previous example, where wefigure out the total running time of a list of albums, depending upon thecircumstances we can make the sequential or parallel versions faster.</p>
                                <p>When benchmarking the code in Examples <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#SerialArraySum">6-1</a> and <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#ParallelArraySum">6-2</a>                                    on a 4-core machine with 10 albums, the sequential code was 8× faster. Upon expanding the number of albums to 100, they were both equally fast, and by the time we hit 10,000 albums, the parallel code was 2.5× faster.</p>
                                <div class="note">
                                    <h3 class="title">Note</h3>
                                    <p>Any specific benchmark figures in this chapter are listed only to make apoint. If you try to replicate these results on your hardware, you may get drasticallydifferent outcomes.</p>
                            </div>
                            <p>The size of the input stream isn’t the only factor to think about when decidingwhether there’s a parallel speedup. It’s possible to get varying performancenumbers based upon how you wrote your code and how many cores are available.We’ll
                                look at this in a bit more detail in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#parallel_performance_section">Performance</a>,but first let’s look at a more complex
                                example.<a class="indexterm" id="7_id388748"></a><a class="indexterm" id="7_id388755"></a></p>
                    </div>
                    <div class="sect1">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title" id="_simulations" style="clear: both">Simulations</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="7_ix_ch06-asciidoc5"></a><a class="indexterm" id="7_ix_ch06-asciidoc6"></a>The kinds of problems that parallel stream libraries excel at are those thatinvolve simple operations processing a lot of data, such
                            as simulations. In thissection, we’ll be building a simple simulation to understand dice throws, butthe same ideas and approach can be used on larger and more realistic problems.</p>
                        <p>The kind of simulation we’ll be looking at here is a <span class="emphasis"><em>Monte Carlo</em></span> simulation.Monte Carlo simulations work by running the same simulation many times overwith different random seeds on every
                            run. The results of each run are recordedand aggregated in order to build up a comprehensive simulation. They have manyuses in engineering, finance, and scientific computing.</p>
                        <p>If we throw a fair die twice and add up the number of dots on the winning side,we’ll get a number between 2 and 12. This must be at least 2 because the fewestnumber of dots on each side is 1 and there are two dice. The maximum
                            score is12, as the highest number you can score on each die is 6. We want to try andfigure out what the probability of each number between 2 and 12 is.</p>
                        <p>One approach to solving this problem is to add up all the differentcombinations of dice rolls that can get us each value. For example, the only waywe can get 2 is by rolling 1 and then 1 again. There are 36 different possiblecombinations,
                            so the probability of the two sides adding up to 2 is 1 in 36, or 1/36.</p>
                        <p>Another way of working it out is to simulate rolling two dice using random numbers between 1 and 6, adding up the number of times that each result was picked, and dividing by the number of rolls. This is actually a really simple
                            Monte Carlo simulation. The more times we simulate rolling the dice, the more closely we approximate the actual result—so we really want to do it a lot.</p>
                        <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#ParallelDiceRolls">Example 6-3</a> shows how we can implement the Monte Carlo approach using the streams library.
                            <code class="literal">N</code> represents the number of simulations we’ll be running, and at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-12"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>                                we use the <code class="literal">IntStream</code> range function to create a stream of size <code class="literal">N</code>. At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-13"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>                                we call the <code class="literal">parallel</code> method in order to use the parallel version of the streams framework. The <code class="literal">twoDiceThrows</code> function simulates throwing two dice and returns the
                                sum of their results. We use the <code class="literal">mapToObj</code> method in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-14"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>                                in order to use this function on our data stream.</p>
                        <div class="example"><a id="7_ParallelDiceRolls"></a>
                            <div class="example-title">Example 6-3. Parallel Monte Carlo simulation of dice rolling</div>
                            <div class="example-contents">
                               
                                
                                
                                
                                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span>,
<span style="color:#00f;font-weight:700">Double</span> <span style="color:#00f;font-weight:700">&gt;</span> parallelDiceRolls() {
    <span style="color:#00f;font-weight:700">double</span> fraction <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">1.0</span> <span style="color:#00f;font-weight:700">/</span> <span style="color:#00f;font-weight:700">N</span>;
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">IntStream</span><span style="color:#00f;font-weight:700">.</span>range(<span style="color:#0000cd">0</span>, <span style="color:#00f;font-weight:700">N</span>) <a id="7_CO1-12"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/><span style="color:#00f;font-weight:700">.</span>parallel()<span style="color:#00f;font-weight:700"><a id="7_CO1-13"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>.</span>mapToObj(twoDiceThrows())<span style="color:#00f;font-weight:700"> <a id="7_CO1-14"></a><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/>.</span>collect(groupingBy(side <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>side<a id="7_CO1-15"></a><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/>, summingDouble(n <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>fraction))) <a id="7_CO1-16"></a><img alt="5" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/>;
}
</pre>
                                
                                
                                
                            </div>
                        </div>
                        <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-15"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></a>                            we have a <code class="literal">Stream</code> of all the simulation results we need to combine. We use the <code class="literal">groupingBy</code> collector, introduced in the previous chapter, in order to aggregate all results
                            that are equal. I said we were going to count the number of times each number occured and divide by <code class="literal">N</code>. In the streams framework, it’s actually easier to map numbers to <code class="literal">1/N</code>                            and add them, which is exactly the same. This is accomplished in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-16"><img alt="5" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/></a>                            through the <code class="literal">summingDouble</code> function. The <code class="literal">Map&lt;Integer, Double&gt;</code> that gets returned at the end maps each sum of sides thrown to its probability.</p>
                        <p>I’ll admit it’s not totally trivial code, but implementing a parallel Monte Carlo simulation in five lines of code is pretty neat. Importantly, because the more simulations we run, the more closey we approximate the real answer,
                            we’ve got a real incentive to run a lot of simulations. This is also a good use for parallelism as it’s an implementation that gets good parallel speedup.</p>
                        <p>I won’t go through the implementation details, but for comparison <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#ManualDiceRolls">Example 6-4</a> lists the same parallel
                            Monte Carlo simulation implemented by hand. The majority of the code implementation deals with spawning, scheduling, and awaiting the completion of jobs within a thread pool. None of these issues needs to be directly addressed
                            when using the parallel streams library.</p>
                        <div class="example"><a id="7_ManualDiceRolls"></a>
                            <div class="example-title">Example 6-4. Simulating dice rolls by manually implementing threading</div>
                            <div class="example-contents">
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">ManualDiceRolls</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">int</span> <span style="color:#c5060b;font-weight:700">N</span> <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">100000000</span>;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">double</span> fraction;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Map</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span>,
    <span style="color:#00f;font-weight:700">Double</span> <span style="color:#00f;font-weight:700">&gt;</span> results;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">int</span> numberOfThreads;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">ExecutorService</span> executor;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">int</span> workPerThread;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">main</span>(<span style="color:#00f;font-weight:700">String</span>[] <span style="font-style:italic">args</span>) {
        <span style="color:#00f;font-weight:700">ManualDiceRolls</span> roles <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ManualDiceRolls</span>();
        roles<span style="color:#00f;font-weight:700">.</span>simulateDiceRoles();
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">ManualDiceRolls</span>() {
        fraction <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">1.0</span> <span style="color:#00f;font-weight:700">/</span> <span style="color:#00f;font-weight:700">N</span>;
        results <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ConcurrentHashMap</span> &lt; &gt;();
        numberOfThreads <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Runtime</span><span style="color:#00f;font-weight:700">.</span>getRuntime()<span style="color:#00f;font-weight:700">.</span>availableProcessors();
        executor <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Executors</span><span style="color:#00f;font-weight:700">.</span>newFixedThreadPool(numberOfThreads);
        workPerThread <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">N</span> <span style="color:#00f;font-weight:700">/</span> numberOfThreads;
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">simulateDiceRoles</span>() {
        <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">?</span><span style="color:#00f;font-weight:700">&gt;&gt;</span>futures <span style="color:#00f;font-weight:700">=</span> submitJobs();
        awaitCompletion(futures);
        printResults();
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">printResults</span>() {
        results<span style="color:#00f;font-weight:700">.</span>entrySet()<span style="color:#00f;font-weight:700">.</span>forEach(<span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>println);
    }
    <span style="color:#00f;font-weight:700">private</span> List <span style="color:#00f;font-weight:700">&lt; <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt; ?</span>&gt;</span>&gt;<span style="color:#0000a2;font-weight:700">submitJobs</span>() {
        <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">?</span><span style="color:#00f;font-weight:700">&gt;&gt;</span>futures <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ArrayList</span> &lt; &gt;();
        <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> i <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>; i <span style="color:#00f;font-weight:700">&lt;</span> numberOfThreads; i<span style="color:#00f;font-weight:700">++</span>) {
            futures<span style="color:#00f;font-weight:700">.</span>add(executor<span style="color:#00f;font-weight:700">.</span>submit(makeJob()));
        }
        <span style="color:#00f;font-weight:700">return</span> futures;
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">Runnable</span> <span style="color:#0000a2;font-weight:700">makeJob</span>() {
        <span style="color:#00f;font-weight:700">return</span> () <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
            <span style="color:#00f;font-weight:700">ThreadLocalRandom</span> random <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">ThreadLocalRandom</span><span style="color:#00f;font-weight:700">.</span>current();
            <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> i <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>; i <span style="color:#00f;font-weight:700">&lt;</span> workPerThread; i<span style="color:#00f;font-weight:700">++</span>) {
                <span style="color:#00f;font-weight:700">int</span> entry <span style="color:#00f;font-weight:700">=</span> twoDiceThrows(random);
                accumulateResult(entry);
            }
        };
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">accumulateResult</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">entry</span>) {
        results<span style="color:#00f;font-weight:700">.</span>compute(entry, (key, previous) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>previous <span style="color:#00f;font-weight:700">==</span> <span style="color:#585cf6;font-weight:700">null</span> <span style="color:#00f;font-weight:700">?</span> fraction<span style="color:#00f;font-weight:700">:</span> previous <span style="color:#00f;font-weight:700">+</span> fraction);
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">int</span> <span style="color:#0000a2;font-weight:700">twoDiceThrows</span>(<span style="color:#00f;font-weight:700">ThreadLocalRandom</span> <span style="font-style:italic">random</span>) {
        <span style="color:#00f;font-weight:700">int</span> firstThrow <span style="color:#00f;font-weight:700">=</span> random<span style="color:#00f;font-weight:700">.</span>nextInt(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">7</span>);
        <span style="color:#00f;font-weight:700">int</span> secondThrow <span style="color:#00f;font-weight:700">=</span> random<span style="color:#00f;font-weight:700">.</span>nextInt(<span style="color:#0000cd">1</span>, <span style="color:#0000cd">7</span>);
        <span style="color:#00f;font-weight:700">return</span> firstThrow <span style="color:#00f;font-weight:700">+</span> secondThrow;
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">awaitCompletion</span>(<span style="color:#00f;font-weight:700">List</span> &lt; <span style="color:#00f;font-weight:700">Future</span> &lt; ?&gt;&gt;<span style="font-style:italic">futures</span>) {
        futures<span style="color:#00f;font-weight:700">.</span>forEach((future) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
            <span style="color:#00f;font-weight:700">try</span> {
                future<span style="color:#00f;font-weight:700">.</span>get();
            } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">InterruptedException</span> <span style="color:#00f;font-weight:700">|</span> <span style="color:#00f;font-weight:700">ExecutionException</span> e) {
                e<span style="color:#00f;font-weight:700">.</span>printStackTrace();
            }
        });
        executor<span style="color:#00f;font-weight:700">.</span>shutdown();
    }
}
</pre>
                            </div>
                        </div>
                    </div>
                    <div class="sect1">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title" id="_caveats" style="clear: both">Caveats</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="7_id380872"></a><a class="indexterm" id="7_id380879"></a><a class="indexterm" id="7_id380886"></a>I said earlier that using parallel streams “just works,” but that’s being alittle cheeky. You can run existing
                            code in parallel with little modification,but only if you’ve written idiomatic code. There are a few rules and restrictionsthat need to be obeyed in order to make optimal use of the parallel streams framework.</p>
                        <p><a class="indexterm" id="7_id396586"></a><a class="indexterm" id="7_id396590"></a><a class="indexterm" id="7_id396599"></a>Previously, when calling <code class="literal">reduce</code> our initial element could be any value, butfor this
                            operation to work correctly in parallel, it needs to be the<a class="indexterm" id="7_id396612"></a> <span class="emphasis"><em>identity</em></span>value of the combining function. The identity value leaves all otherelements
                            the same when reduced with them. For example, if we’re summingelements with our <code class="literal">reduce</code> operation, the combining function is <code class="literal">(acc,element) -&gt; acc + element</code>. The initial
                            element must be <code class="literal">0</code>, because anynumber <code class="literal">x</code> added to <code class="literal">0</code> returns <code class="literal">x</code>.</p>
                        <p>The other caveat specific to <code class="literal">reduce</code> is that the combining function must be<span class="emphasis"><em>associative</em></span>. This means that the order in which the combining function isapplied doesn’t
                            matter as long the values of the sequence aren’t changed.Confused? Don’t worry! Take a look at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#associativity_example">Example 6-5</a>,
                            which shows howwe can rearrange the order in which we apply + and <code class="literal">*</code> to a sequence ofvalues and get the same result.</p>
                        <div class="example"><a id="7_associativity_example"></a>
                            <div class="example-title">Example 6-5. + and * are associative</div>
                            <div class="example-contents">
                                <pre class="programlisting"><code class="o">(</code><code class="mi">4</code> <code class="o">+</code> <code class="mi">2</code><code class="o">)</code> <code class="o">+</code> <code class="mi">1</code> <code class="o">=</code> <code class="mi">4</code> <code class="o">+</code> <code class="o">(</code><code class="mi">2</code> <code class="o">+</code> <code class="mi">1</code><code class="o">)</code> <code class="o">=</code> <code class="mi">7</code><code class="o">(</code><code class="mi">4</code> <code class="o">*</code> <code class="mi">2</code><code class="o">)</code> <code class="o">*</code> <code class="mi">1</code> <code class="o">=</code> <code class="mi">4</code> <code class="o">*</code> <code class="o">(</code><code class="mi">2</code> <code class="o">*</code> <code class="mi">1</code><code class="o">)</code> <code class="o">=</code> <code class="mi">8</code></pre>
                            </div>
                        </div>
                        <p><a class="indexterm" id="7_id396697"></a>One thing to avoid is trying to hold locks. The streams framework deals withany necessary synchronization itself, so there’s no need to lock your datastructures. If you do try to hold locks
                            on any data structure that thestreams library is using, such as the source collection of an operation,you’re likely to run into trouble.</p>
                        <p>I explained earlier that you could convert any existing <code class="literal">Stream</code> to be aparallel stream using the <code class="literal">parallel</code> method call. If you’ve been looking atthe API itself while reading
                            the book, you may have noticed a<a class="indexterm" id="7_id347609"></a><a class="indexterm" id="7_id347596"></a><code class="literal">sequential</code> method as well. When a stream pipeline is evaluated, there is nomixed mode:
                            the orientation is either parallel or sequential. If a pipeline hascalls to both <code class="literal">parallel</code> and <code class="literal">sequential</code>, the last call wins.</p>
                    </div>
                    <div class="sect1">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h2 class="title" id="parallel_performance_section" style="clear: both">Performance</h2>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="7_ix_ch06-asciidoc7"></a><a class="indexterm" id="7_ix_ch06-asciidoc8"></a>I briefly mentioned before that there were a number of factors thatinfluenced whether parallel streams were faster or slower than sequentialstreams;
                            let’s take a look at those factors now. Understanding what works welland what doesn’t will help you to make an informed decision about how and whento use parallel streams. There are five important factors that influence parallelstreams
                            performance that we’ll be looking at:</p>
                        <div class="variablelist">
                            <dl><dt><span class="term"><a class="indexterm" id="7_id347679"></a>Data size</span></dt>
                                <dd>There is a difference in the efficiency of the parallel speedup due to the size of the input data. There’s an overhead to decomposing the problem to be executed in parallel and merging the results. This makes it worth doing
                                    only when there’s enough data that execution of a streams pipeline takes a while. We explored this back in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#parallel_stream_operations">Parallel Stream Operations</a>.</dd><dt><span class="term">Source data structure</span></dt>
                                <dd>Each pipeline of operations operates on some initial data source; this is usually a collection. It’s easier to split out subsections of different data sources, and this cost affects how much parallel speedup you can get
                                    when executing your pipeline.</dd><dt><span class="term">Packing</span></dt>
                                <dd>Primitives are faster to operate on than boxed values.</dd><dt><span class="term">Number of cores</span></dt>
                                <dd>The extreme case here is that you have only a single core available to operate upon, so it’s not worth going parallel. Obviously, the more cores you have access to, the greater your potential speedup is. In practice, what
                                    counts isn’t just the number of cores allocated to your machine; it’s the number of cores that are available for your machine to use at runtime. This means factors such as other processes executing simultaneously or
                                    thread affinity (forcing threads to execute on certain cores or CPUs) will affect performance.</dd><dt><span class="term">Cost per element</span></dt>
                                <dd>Like data size, this is part of the battle between time spent executing in parallel and overhead of decomposition and merging. The more time spent operating on each element in the stream, the better performance you’ll get
                                    from going parallel.</dd>
                            </dl>
                        </div>
                        <p>When using the parallel streams framework, it can be helpful to understand howproblems are decomposed and merged. This gives us a good insight into what isgoing on under the hood without having to understand all the details of
                            theframework.</p>
                        <p>Let’s take a look at how a concrete example is decomposed and merged.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#addIntegers">Example 6-6</a> shows some code that
                            performs parallel integer addition.</p>
                        <div class="example"><a id="7_addIntegers"></a>
                            <div class="example-title">Example 6-6. Parallel integer addition</div>
                            <div class="example-contents">
                              <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">int</span> addIntegers(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> values) {
    <span style="color:#00f;font-weight:700">return</span> values<span style="color:#00f;font-weight:700">.</span>parallelStream()<span style="color:#00f;font-weight:700">.</span>mapToInt(i <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>i)<span style="color:#00f;font-weight:700">.</span>sum();
}
</pre>
                            </div>
                        </div>
                        <p>Under the hood, parallel streams back onto the fork/join framework. The<span class="emphasis"><em>fork</em></span> stage recursively splits up a problem. Then each chunk isoperated upon in parallel. Finally, the <span class="emphasis"><em>join</em></span>                            stage merges the resultsback together.</p>
                        <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#fork_join">Figure 6-2</a> shows how this might apply to <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#addIntegers">Example 6-6</a>.</p>
                        <div class="figure"><a id="7_fork_join"></a>
                            <div class="figure-contents">
                                <div class="mediaobject"><img alt=".Decomposing and merging using Fork/Join" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0602.png" height="789" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0602.png" width="854"/></div>
                            </div>
                            <div class="figure-title">Figure 6-2. Decomposing and merging using fork/join</div>
                    </div>
                    <p>Let’s assume that the streams framework is splitting up our work to operate in parallel on a four-core machine:</p>
                    <div class="orderedlist">
                        <ol class="orderedlist" type="1">
                            <li class="listitem">Our data source is decomposed into four chunks of elements.</li>
                            <li class="listitem">We perform leaf computation work in parallel on each thread in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#addIntegers">Example 6-6</a>. This involves mapping each
                                <code class="literal">Integer</code> to an <code class="literal">int</code> and alsosumming a quarter of the values in each thread. Ideally, we want to spend as much ofour time as possible in leaf computation work because
                                it’s the perfect case for parallelism.</li>
                            <li class="listitem">We merge the results. In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#addIntegers">Example 6-6</a> this is just a <code class="literal">sum</code> operation, butit
                                might involve any kind of <code class="literal">reduce</code>, <code class="literal">collect</code>, or terminal operation.</li>
                        </ol>
                    </div>
                    <p>Given the way problems are decomposed, the nature of the initial source isextremely important in influencing the performance of this decomposition.Intuitively, the ease with which we can repeatedly split a data structure in halfcorresponds
                        to how fast it can be operated upon. Splitting in half also meansthat the values to be operated upon need to split equally.</p>
                    <p>We can split up common data sources from the core library into three maingroups by performance characteristics:</p>
                    <div class="variablelist">
                        <dl><dt><span class="term">The good</span></dt>
                            <dd>An<a class="indexterm" id="7_id348093"></a><a class="indexterm" id="7_id348104"></a><a class="indexterm" id="7_id348110"></a> <code class="literal">ArrayList</code>, an array, or the <code class="literal">IntStream.range</code> constructor.
                                These data sources all support random access, which means they can be split up arbitrarily with ease.</dd><dt><span class="term">The okay</span></dt>
                            <dd>The<a class="indexterm" id="7_id348142"></a><a class="indexterm" id="7_id348154"></a> <code class="literal">HashSet</code> and <code class="literal">TreeSet</code>. You can’t easily decompose these with perfect amounts of balance,
                                but most of the time it’s possible to do so.</dd><dt><span class="term">The bad</span></dt>
                            <dd>Some data structures just don’t split well; for example, they may take <span class="emphasis"><em>O</em></span>(<span class="emphasis"><em>N</em></span>) time to decompose. Examples here include a<a class="indexterm" id="7_id348203"></a>
                                <a class="indexterm" id="7_id348204"></a><a class="indexterm" id="7_id348210"></a><a class="indexterm" id="7_id348216"></a> <code class="literal">LinkedList</code>, which is computationally hard to split in half. Also, <code class="literal">Streams.iterate</code>                                    and <code class="literal">BufferedReader.lines</code> have unknown length at the beginning, so it’s pretty hard to estimate when to split these sources.</dd>
                        </dl>
                    </div>
                    <p>The influence of the initial data structure can be huge. To take an extremeexample, benchmarking a parallel sum over 10,000 integers revealed an<code class="literal">ArrayList</code> to be 10 times faster than a <code class="literal">LinkedList</code>.
                        This isn’t to say thatyour business logic will exhibit the same performance characteristics, but itdoes demonstrate how influential these things can be. It’s also far more likelythat data structures such as a <code class="literal">LinkedList</code>                        that have poor decompositionswill also be slower when run in parallel.</p>
                    <p>Ideally, once the streams framework has decomposed the problem into smaller chunks,we’ll be able to operate on each chunk in its own thread, withno further communication or contention between threads. Unfortunately, realitycan get
                        the way of the ideal at times!</p>
                    <p><a class="indexterm" id="7_id348267"></a><a class="indexterm" id="7_id348258"></a><a class="indexterm" id="7_id348282"></a><a class="indexterm" id="7_id348288"></a><a class="indexterm" id="7_id348296"></a>When we’re talking about the kinds of
                        operations in our stream pipeline that letus operate on chunks individually, we can differentiate between twotypes of stream operations: <span class="emphasis"><em>stateless</em></span> and <span class="emphasis"><em>stateful</em></span>.
                        Stateless operationsneed to maintain no concept of state over the whole operation; statefuloperations have the overhead and constraint of maintaining state.</p>
                    <p>If you can get away with using stateless operations, then you will get betterparallel performance. Examples of stateless operations include <code class="literal">map</code>, <code class="literal">filter</code>,and <code class="literal">flatMap</code>;
                        <code class="literal">sorted</code>, <code class="literal">distinct</code>, and <code class="literal">limit</code> are stateful.</p>
                    <div class="note">
                        <h3 class="title">Note</h3>
                        <p>Performance-test your own code. The advice in this section offers rules ofthumb about what performance characteristics should be investigated, butnothing beats measuring and profiling.<a class="indexterm" id="7_id348355"></a><a class="indexterm" id="7_id348350"></a></p>
                    </div>
                </div>
                <div class="sect1">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h2 class="title" id="_parallel_array_operations" style="clear: both">Parallel Array Operations</h2>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="7_id348412"></a><a class="indexterm" id="7_id348418"></a><a class="indexterm" id="7_id348426"></a>Java 8 includes a couple of other parallel array operations that utilize lambdaexpressions outside of the streams
                        framework. Like the operations on thestreams framework, these are data parallel operations. Let’s look at howwe can use these operations to solve problems that are hard to do in the streamsframework.</p>
                    <p><a class="indexterm" id="7_id348481"></a>These operations are all located on the utility class <code class="literal">Arrays</code>, which also containsa bunch of other useful array-related functionality from previous Java versions.There
                        is a summary in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#parallel_array_operations">Table 6-1</a>.<a class="indexterm" id="7_id348437"></a><a class="indexterm" id="7_id348468"></a></p>
                    <div class="table"><a id="7_parallel_array_operations"></a>
                        <div class="table-title">Table 6-1. Parallel operations on arrays</div>
                        <div class="table-contents">
                            <table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; ">
                                <colgroup>
                                    <col class="col_1">
                                    <col class="col_2">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Name </td>
                                        <td style="border-bottom: 0.5pt solid ; ">Operation</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                            <p><code class="literal">parallelPrefix</code></p>
                                        </td>
                                        <td style="border-bottom: 0.5pt solid ; ">
                                            <p>Calculates running totals of the values of an array given an arbitrary function</p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                            <p><code class="literal">parallelSetAll</code></p>
                                        </td>
                                        <td style="border-bottom: 0.5pt solid ; ">
                                            <p>Updates the values in an array using a lambda expression</p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border-right: 0.5pt solid ; ">
                                            <p><code class="literal">parallelSort</code></p>
                                        </td>
                                        <td>
                                            <p>Sorts elements in parallel</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                </div>
                <p>You may have written code similar to <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#imperativeInitilize">Example 6-7</a> before, where you initialize anarray using a <code class="literal">for</code>                    loop. In this case, we initialize every element to its index in the array.</p>
                <div class="example"><a id="7_imperativeInitilize"></a>
                    <div class="example-title">Example 6-7. Initializing an array using a for loop</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">double</span>[] imperativeInitilize(<span style="color:#00f;font-weight:700">int</span> size) {
    <span style="color:#00f;font-weight:700">double</span>[] values <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">double</span>[size];
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> i <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>; i <span style="color:#00f;font-weight:700">&lt;</span> values<span style="color:#00f;font-weight:700">.</span>length; i<span style="color:#00f;font-weight:700">++</span>) {
        values[i] <span style="color:#00f;font-weight:700">=</span> i;
    }
    <span style="color:#00f;font-weight:700">return</span> values;
}
</pre>
                    </div>
                </div>
                <p><a class="indexterm" id="7_id348600"></a><a class="indexterm" id="7_id348857"></a>We can use the <code class="literal">parallelSetAll</code> method in order to do this easily inparallel. An example of this code is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#parallelInitialize">Example 6-8</a>. Weprovide an array to operate on and a lambda expression, which calculates thevalue given the index. In
                    our example they are the same value. One thing tonote about these methods is that they alter the array that ispassed into the operation, rather than creating a new copy.</p>
                <div class="example"><a id="7_parallelInitialize"></a>
                    <div class="example-title">Example 6-8. Initializing an array using a parallel array operation</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">double</span>[] parallelInitialize(<span style="color:#00f;font-weight:700">int</span> size) {
    <span style="color:#00f;font-weight:700">double</span>[] values <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">double</span>[size];
    <span style="color:#00f;font-weight:700">Arrays</span><span style="color:#00f;font-weight:700">.</span>parallelSetAll(values, i <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>i);
    <span style="color:#00f;font-weight:700">return</span> values;
}
</pre>
                    </div>
                </div>
                <p><a class="indexterm" id="7_id348892"></a><a class="indexterm" id="7_id402918"></a>The <code class="literal">parallelPrefix</code> operation, on the other hand, is much more useful forperforming accumulation-type calculations over time series
                    of data. Itmutates an array, replacing each element with the <span class="emphasis"><em>sum</em></span> of that element and its predecessors. I use the term “sum” loosely—it doesn’t need to beaddition; it could be any <code class="literal">BinaryOperator</code>.</p>
                <p>An example operation that can be calculated by prefix sums is a simple moving average. This takes a rolling window over a time series and produces an average for each instance of that window. For example, if our series of input data is
                    <code class="literal">0, 1, 2, 3, 4, 3.5</code>, then the simple moving average of size 3 is <code class="literal">1, 2, 3, 3.5</code>. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#simpleMovingAverage">Example 6-9</a>                    shows how we can use a prefix sum in order to calculate a moving average.</p>
                <div class="example"><a id="7_simpleMovingAverage"></a>
                    <div class="example-title">Example 6-9. Calculating a simple moving average</div>
                    <div class="example-contents">
                        
                        
                        
                        
                        
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">double</span>[] simpleMovingAverage(<span style="color:#00f;font-weight:700">double</span>[] values, <span style="color:#00f;font-weight:700">int</span> n) {
    <span style="color:#00f;font-weight:700">double</span>[] sums <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Arrays</span><span style="color:#00f;font-weight:700">.</span>copyOf(values, values<span style="color:#00f;font-weight:700">.</span>length);<a id="7_CO1-17"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>
    <span style="color:#00f;font-weight:700">Arrays</span><span style="color:#00f;font-weight:700">.</span>parallelPrefix(sums, <span style="color:#00f;font-weight:700">Double</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>sum);<a id="7_CO1-18"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>
    <span style="color:#00f;font-weight:700">int</span> start <span style="color:#00f;font-weight:700">=</span> n <span style="color:#00f;font-weight:700">-</span> <span style="color:#0000cd">1</span>;
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">IntStream</span><span style="color:#00f;font-weight:700">.</span>range(start, sums<span style="color:#00f;font-weight:700">.</span>length)<span style="color:#00f;font-weight:700"><a id="7_CO1-19"></a><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/>.</span>mapToDouble(i <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        <span style="color:#00f;font-weight:700">double</span> prefix <span style="color:#00f;font-weight:700">=</span> i <span style="color:#00f;font-weight:700">==</span> start <span style="color:#00f;font-weight:700">?</span> <span style="color:#0000cd">0</span> <span style="color:#00f;font-weight:700">:</span> sums[i <span style="color:#00f;font-weight:700">-</span> n];
        <span style="color:#00f;font-weight:700">return</span> (sums[i] <span style="color:#00f;font-weight:700">-</span> prefix) <span style="color:#00f;font-weight:700">/</span> n;<a id="7_CO1-20"></a><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/>
    })<span style="color:#00f;font-weight:700">.</span>toArray();<a id="7_CO1-21"></a><img alt="5" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/>
}
</pre>
                        
                    </div>
                </div>
                <p>It’s quite complex, so I’ll go through how this works in a few steps. The input parameter <code class="literal">n</code> is the size of the time window we’re calculating our moving average over. At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-17"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>                    we take a copy of our input data. Because our prefix calculation is a mutating operation, we do this to avoid altering the original source.</p>
                <p>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-18"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>                    we apply the prefix operation, adding up values in the process. So now our <code class="literal">sums</code> variable holds the running total of the sums so far. For example, given the input <code class="literal">0, 1, 2, 3, 4, 3.5</code>,
                    it would hold <code class="literal">0.0, 1.0, 3.0, 6.0, 10.0, 13.5</code>.</p>
                <p>Now that we have the complete running totals, we can find the sum over the time window by subtracting the running total at the beginning of the time window. The average is this divided by <code class="literal">n</code>. We can do this
                    calculation using the existing streams library, so let’s use it! We kick off the stream in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-19"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>                    by using <code class="literal">Intstream.range</code> to get a stream ranging over the indices of the values we want.</p>
                <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-20"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></a>                    we subtract away the running total at the start and then do the divisionin order to get the average. It’s worth noting that there’s an edge case for therunning total at element n – 1, where there is no running total to subtractto begin
                    with. Finally, at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#CO1-21"><img alt="5" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/></a>,
                    we convert the <code class="literal">Stream</code> back to an array.</p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_key_points_5" style="clear: both">Key Points</h2>
                    </div>
                </div>
            </div>
            <div class="itemizedlist">
                <ul class="itemizedlist">
                    <li class="listitem">Data parallelism is a way to split up work to be done on many cores at the sametime.</li>
                    <li class="listitem">If we use the streams framework to write our code, we can utilize data parallelismby calling the <code class="literal">parallel</code> or <code class="literal">parallelStream</code> methods.</li>
                    <li class="listitem">The five main factors influencing performance are the data size, the source datastructure, whether the values are packed, the number of available cores, and howmuch processing time is spent on each element.<a class="indexterm" id="7_id403613"></a></li>
                </ul>
            </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_exercises_5" style="clear: both">Exercises</h2>
                    </div>
                </div>
            </div>
            <div class="orderedlist">
                <ol class="orderedlist" type="1">
                    <li class="listitem">
                        <p class="simpara">The code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#sequentialSumOfSquares">Example 6-10</a> sequentially sums the squares of numbers in a <code class="literal">Stream</code>.
                            Make it run in parallel using streams.</p>
                        <div class="example"><a id="7_sequentialSumOfSquares"></a>
                            <div class="example-title">Example 6-10. Sequentially summing the squares of numbers in a list</div>
                            <div class="example-contents">
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">int</span> sequentialSumOfSquares(<span style="color:#00f;font-weight:700">IntStream</span> range) {
    <span style="color:#00f;font-weight:700">return</span> range<span style="color:#00f;font-weight:700">.</span>map(x <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>x <span style="color:#00f;font-weight:700">*</span> x)<span style="color:#00f;font-weight:700">.</span>sum();
}
</pre>
                            </div>
                        </div>
                    </li>
                    <li class="listitem">
                        <p class="simpara">The code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#buggyMultiplyThrough">Example 6-11</a> multiplies every number in a list together and multiplies the result
                            by 5. This works finesequentially, but has a bug when running in parallel. Make the code run in parallel using streams and fix the bug.</p>
                        <div class="example"><a id="7_buggyMultiplyThrough"></a>
                            <div class="example-title">Example 6-11. A buggy way of multiplying every number in a list together and multiplying the result by 5</div>
                            <div class="example-contents">
                                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">int</span> multiplyThrough(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> linkedListOfNumbers) {
    <span style="color:#00f;font-weight:700">return</span> linkedListOfNumbers<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>reduce(<span style="color:#0000cd">5</span>, (acc, x) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>x <span style="color:#00f;font-weight:700">*</span> acc);
}
</pre>
                            </div>
                        </div>
                    </li>
                    <li class="listitem">
                        <p class="simpara">The code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html#slowSumOfSquares">Example 6-12</a> also calculates the sum of the squares of numbers in a list. You should
                            try to improve the performanceof this code <span class="emphasis"><em>without</em></span> degrading its quality. I’m only looking for you to make a couple of simple changes.</p>
                        <div class="example"><a id="7_slowSumOfSquares"></a>
                            <div class="example-title">Example 6-12. Slow implementation of summing the squares of numbers in a list</div>
                            <div class="example-contents">
                                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">int</span> slowSumOfSquares() {
    <span style="color:#00f;font-weight:700">return</span> linkedListOfNumbers<span style="color:#00f;font-weight:700">.</span>parallelStream()<span style="color:#00f;font-weight:700">.</span>map(x <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>x <span style="color:#00f;font-weight:700">*</span> x)<span style="color:#00f;font-weight:700">.</span>reduce(<span style="color:#0000cd">0</span>, (acc, x) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>acc <span style="color:#00f;font-weight:700">+</span> x);
}
</pre>
                            </div>
                        </div>
                        <div class="note">
                            <h3 class="title">Note</h3>
                            <p>Make sure to run the benchmark code multiple times when timing. The sample code provided on GitHub comes with a benchmark harness that you can use.</p>
                        </div>
                    </li>
                </ol>
            </div>
        </div>
        </section>
    </div>
    </div>
    </section>
    </div>
    </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch07.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch07.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="8_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="testing_chp">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 7. Testing, Debugging, and Refactoring</h2>
                                    </div>
                                </div>
                            </div>
                            <p>The rising popularity of techniques such as refactoring, <a class="indexterm" id="8_id404269"></a>test-driven development (TDD), and <a class="indexterm" id="8_id404266"></a>continuous integration (CI) mean that if we’re going
                                to use lambda expressions in our day-to-day programming, we need to understand how to test code using them and written with them.</p>
                            <p>A wealth of material has been written on how to test and debug computerprograms, and this chapter isn’t going to revisit all that material. If you’reinterested in learning how to do TDD properly, I highly recommend thebooks
                                <a class="indexterm" id="8_id404277"></a><a class="indexterm" id="8_id404280"></a> <span class="emphasis"><em>Test-Driven Development</em></span> by Kent Beck and<a class="indexterm" id="8_id404292"></a><a class="indexterm" id="8_id404309"></a><a class="indexterm" id="8_id404314"></a>                                    <span class="emphasis"><em>Growing Object-Oriented Software, Guided by Tests</em></span> by Steve Freeman and Nat Pryce (both from Addison-Wesley).</p>
                            <p>I am going to cover techniques specific to using lambdaexpressions in your code, and when you might not want to (directly) use lambdaexpressions at all. I’ll also talk about some appropriate techniques fordebugging programs
                                that heavily use lambda expressions and streams.</p>
                            <p>We’re first going to look at some examples of how to refactor an existingcode base into using lambda expressions. I’ve talked a bit already about how todo local refactoring operations, such as replacing a <code class="literal">for</code>                                loop with a streamoperation. Here we’ll take a more in-depth look at how non-collection codecan be improved.</p>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_lambda_refactoring_candidates" style="clear: both">Lambda Refactoring Candidates</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="8_ix_ch07-asciidoc0"></a><a class="indexterm" id="8_ix_ch07-asciidoc1"></a>The process of refactoring code to take advantage of lambdas has been given thesnazzy name<a class="indexterm" id="8_id404397"></a>                                    <span class="emphasis"><em>point lambdafication</em></span> (pronounced <span class="emphasis"><em>lambda-fi-cation</em></span>, practitionersof this process being<a class="indexterm" id="8_id404398"></a> “lamb-di-fiers”
                                    or “responsible developers”). It’s aprocess that has happened within the Java core libraries for Java 8. Whenyou’re choosing how to model the internal design of your application, it’s alsoreally worth considering which
                                    API methods to expose in this way.</p>
                                <p>There are a few key heuristics that can help you out when identifying an appropriate place to lambdify your application or library code. Each of these can be considered a localized antipattern or code smell that you’re
                                    fixing through point lambdification.</p>
                                <div class="sect2">
                                    <div class="titlepage">
                                        <div>
                                            <div>
                                                <h3 class="title" id="_in_out_in_out_shake_it_all_about">In, Out, In, Out, Shake It All About</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <p><a class="indexterm" id="8_id404407"></a>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#debug_optimised_refactor">Example 7-1</a>, I’ve repeated our example
                                        code from <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch04.html">Chapter 4</a> aboutlogging statements. You’ll see that it’s pulling out the Boolean value from
                                        <a class="indexterm" id="8_id404459"></a><code class="literal">isDebugEnabled</code> only to check it and then call a method on the <code class="literal">Logger</code>.If you find that your code is repeatedly querying and operating on an objectonly
                                            to push a value back into that object at the end, then that code belongs in the class of the object that you’re modifying.</p>
                                    <div class="example"><a id="8_debug_optimised_refactor"></a>
                                        <div class="example-title">Example 7-1. A logger using isDebugEnabled to avoid performance overhead</div>
                                        <div class="example-contents">
                                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Logger</span> logger <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Logger</span>();
<span style="color:#00f;font-weight:700">if</span> (logger<span style="color:#00f;font-weight:700">.</span>isDebugEnabled()) {
    logger<span style="color:#00f;font-weight:700">.</span>debug(<span style="color:#036a07">Look at this: </span> <span style="color:#00f;font-weight:700">+</span> expensiveOperation());
}
</pre>
                                        </div>
                                    </div>
                                    <p>Logging is a good example of where this has historically been difficult to achieve, because in different locations you’re trying to provide different behavior. In this case, the behavior is building up a message string
                                        that will differ depending upon where in your program you’re logging and what information you’re trying to log.</p>
                                    <p>This antipattern can be easily solved by passing in code as data. Instead ofquerying an object and then setting a value on it, you can pass in a lambdaexpression that represents the relevant behavior by computing a
                                        value. I’vealso repeated the code solution in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#debug_optimised_lambda_refactor">Example 7-2</a>, as areminder.
                                        The lambda expression gets called if we’re at a debug level and thelogic for checking this call remains inside of the <code class="literal">Logger</code> itself.</p>
                                    <div class="example"><a id="8_debug_optimised_lambda_refactor"></a>
                                        <div class="example-title">Example 7-2. Using lambda expressions to simplify logging code</div>
                                        <div class="example-contents">
                                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Logger</span> logger <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Logger</span>();
logger<span style="color:#00f;font-weight:700">.</span>debug(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#036a07">Look at this: </span> <span style="color:#00f;font-weight:700">+</span> expensiveOperation());
</pre>
                                        </div>
                                    </div>
                                    <p>Logging is also a demonstration of using lambda expressions to do better object-oriented programming (OOP). A key OOP concept is to encapsulate local state, such as the level of the logger. This isn’t normally encapsulated
                                        very well, as <code class="literal">isDebugEnabled</code> exposes its state. If you use the lambda-based approach, then the code outside of the logger doesn’t need to check the level at all.</p>
                                </div>
                                <div class="sect2">
                                    <div class="titlepage">
                                        <div>
                                            <div>
                                                <h3 class="title" id="_the_lonely_override">The Lonely Override</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <p><a class="indexterm" id="8_id404726"></a><a class="indexterm" id="8_id404743"></a><a class="indexterm" id="8_id404752"></a>In this code smell, you subclass solely to override a single method. The<code class="literal">ThreadLocal</code>                                        class is a good example of this. <code class="literal">ThreadLocal</code> allows us tocreate a factory that generates at most one value per thread. This is an easyway of ensuring that a thread-unsafe class can be
                                        safely used in a concurrentenvironment. For example, if we need to look up an artist from the databasebut want to do it once per thread, then we might write something like the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#threadlocal-example">Example 7-3</a>.</p>
                                    <div class="example"><a id="8_threadlocal-example"></a>
                                        <div class="example-title">Example 7-3. Looking up an artist from the database</div>
                                        <div class="example-contents">
                                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">ThreadLocal</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> thisAlbum <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ThreadLocal</span> &lt; <span style="color:#00f;font-weight:700">Album</span> &gt; () {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">protected</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#0000a2;font-weight:700">initialValue</span>() {
        <span style="color:#00f;font-weight:700">return</span> database<span style="color:#00f;font-weight:700">.</span>lookupCurrentAlbum();
    }
};
</pre>
                                        </div>
                                </div>
                                <p>In Java 8 we can use the factory method <code class="literal">withInitial</code> and pass in a<code class="literal">Supplier</code> instance that deals with the creation, as shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#withinitial-example">Example 7-4</a>.</p>
                                <div class="example"><a id="8_withinitial-example"></a>
                                    <div class="example-title">Example 7-4. Using the factory method</div>
                                    <div class="example-contents">
                                     <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">ThreadLocal</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span> thisAlbum <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">ThreadLocal</span><span style="color:#00f;font-weight:700">.</span>withInitial(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>database<span style="color:#00f;font-weight:700">.</span>lookupCurrentAlbum());
</pre>
                                    </div>
                            </div>
                            <p>There are a few reasons why the second example would be consideredpreferable to the first. For a start, any existing instance of <code class="literal">Supplier&lt;Album&gt;</code>can be used here without needing to be repackaged
                                for this specific case, so itencourages reuse and composition.</p>
                            <p>It’s also shorter to write, which is an advantage if and only if all otherthings are equal. More important, it’s shorter because it’s a lot cleaner:when reading the code, the signal-to-noise ratio is lower. This means you spendmore
                                time solving the actual problem at hand and less time dealing withsubclassing boilerplate. It also has the advantage that it’s one fewer class thatyour JVM has to load.</p>
                            <p>It’s also a lot clearer to anyone who tries to read the code what its intent is.If you try to read out loud the words in the second example, you can easilyhear what it’s saying. You definitely can’t say this of the first example.</p>
                            <p>Interestingly, this wasn’t an antipattern previously to Java 8—it was theidiomatic way of writing this code, in the same way that using anonymous innerclasses to pass around behavior wasn’t an antipattern, just the only way
                                ofexpressing what you wanted in Java code. As the language evolves, so do theidioms that you use when programming.</p>
                    </div>
                    <div class="sect2">
                        <div class="titlepage">
                            <div>
                                <div>
                                    <h3 class="title" id="behavioural_wet">Behavioral Write Everything Twice</h3>
                                </div>
                            </div>
                        </div>
                        <p><a class="indexterm" id="8_ix_ch07-asciidoc2"></a><a class="indexterm" id="8_ix_ch07-asciidoc3"></a><span class="emphasis"><em>Write Everything Twice</em></span> (WET) is the opposite of the well-known <span class="emphasis"><em>Don’t RepeatYourself</em></span>                            (DRY) pattern. This code smell crops up in situations where yourcode ends up in repetitive boilerplate that produces more code that needs to betested, is harder to refactor, and is brittle to change.</p>
                        <p>Not all WET situations are suitable candidates for point lambdification. Insome situations, couple duplication can be the only alternative to having anoverly closely coupled system. There’s a good heuristic for situations whereWET
                            suggests it’s time to add some point lambdification into your application.Try adding lambdas where you want to perform a similar overall pattern buthave a different behavior from one variant to another.</p>
                        <p>Let’s look at a more concrete example. On top of our music domain, I’ve decidedto add a simple <code class="literal">Order</code> class that calculates useful properties about somealbums that a user wants to buy. We’re going to
                            count the number of musicians,number of tracks, and running time of our <code class="literal">Order</code>. If we were using imperativeJava, we would write some code like <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#OrderImperative_body">Example 7-5</a>.</p>
                        <div class="example"><a id="8_OrderImperative_body"></a>
                            <div class="example-title">Example 7-5. An imperative implementation of our Order class</div>
                            <div class="example-contents">
                               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countRunningTime() {
    <span style="color:#00f;font-weight:700">long</span> count <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Album</span> album<span style="color:#00f;font-weight:700">:</span> albums) {
        <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Track</span> track<span style="color:#00f;font-weight:700">:</span> album<span style="color:#00f;font-weight:700">.</span>getTrackList()) {
            count <span style="color:#00f;font-weight:700">+=</span> track<span style="color:#00f;font-weight:700">.</span>getLength();
        }
    }
    <span style="color:#00f;font-weight:700">return</span> count;
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countMusicians() {
    <span style="color:#00f;font-weight:700">long</span> count <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Album</span> album<span style="color:#00f;font-weight:700">:</span> albums) {
        count <span style="color:#00f;font-weight:700">+=</span> album<span style="color:#00f;font-weight:700">.</span>getMusicianList()<span style="color:#00f;font-weight:700">.</span>size();
    }
    <span style="color:#00f;font-weight:700">return</span> count;
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countTracks() {
    <span style="color:#00f;font-weight:700">long</span> count <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Album</span> album<span style="color:#00f;font-weight:700">:</span> albums) {
        count <span style="color:#00f;font-weight:700">+=</span> album<span style="color:#00f;font-weight:700">.</span>getTrackList()<span style="color:#00f;font-weight:700">.</span>size();
    }
    <span style="color:#00f;font-weight:700">return</span> count;
}
</pre>
                            </div>
                    </div>
                    <p>In each case, we’ve got the boilerplate code of adding some code for each albumto the total—for example, the length of each track or the number ofmusicians. We’re failing at reusing common concepts and also leaving ourselvesmore code
                        to test and maintain. We can shorten and tighten this code byrewriting it using the <code class="literal">Stream</code> abstraction and the Java 8 collections library.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#OrderStreams_body">Example 7-6</a>                        is what we would come up with if we directly translatedthe imperative code to streams.</p>
                    <div class="example"><a id="8_OrderStreams_body"></a>
                        <div class="example-title">Example 7-6. A refactor of our imperative Order class to use streams</div>
                        <div class="example-contents">
                         <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countRunningTime() {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>mapToLong(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>mapToLong(track <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>track<span style="color:#00f;font-weight:700">.</span>getLength())<span style="color:#00f;font-weight:700">.</span>sum())<span style="color:#00f;font-weight:700">.</span>sum();
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countMusicians() {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>mapToLong(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getMusicians()<span style="color:#00f;font-weight:700">.</span>count())<span style="color:#00f;font-weight:700">.</span>sum();
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countTracks() {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>mapToLong(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>count())<span style="color:#00f;font-weight:700">.</span>sum();
}
</pre>
                        </div>
                    </div>
                    <p>It still suffers from the same reuse and readability issues, because there are certain abstractions and commonalities that are onlyexpressible in domain terms. The streams library won’t provide a method for you to count the number
                        of a certain thing per album—that’s the kind of domain method that you should be writing yourself. It’s also the kind of domain method that was very hard to write before Java 8 because it’s doing a different thing for each method.</p>
                    <p>Let’s think about how we’re going to implement such a function. We’re going toreturn a <code class="literal">long</code> with the count of some feature for all the albums. We alsoneed to take in some kind of lambda expression that
                        tells us what the numberfor each album is. This means we need a method parameter that returns us a<code class="literal">long</code> for each album; conveniently, there is already a <code class="literal">ToLongFunction</code>in
                        the Java 8 core libraries. As shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#ToLongFunction_diagram_2">Figure 7-1</a>, itis parameterized by its argument type,
                        so we’re using<code class="literal">ToLongFunction&lt;Album&gt;</code>.</p>
                    <div class="figure"><a id="8_ToLongFunction_diagram_2"></a>
                        <div class="figure-contents">
                            <div class="mediaobject"><img alt="ToLongFunction" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0401.png" height="162" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0401.png" width="536"/></div>
                        </div>
                        <div class="figure-title">Figure 7-1. ToLongFunction</div>
                    </div>
                    <p>Now that we’ve made these decisions, the body of the method follows naturally. We takea <code class="literal">Stream</code> of the albums, map each album to a <code class="literal">long</code>, and then sum them.When we implement the
                        consumer-facing methods such as <code class="literal">countTracks</code>, we pass ina lambda expression with behavior specific to that domain method. In thiscase, we’re mapping the album to the number of tracks. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#OrderDomain_body">Example 7-7</a> iswhat our code looks like when we’ve converted the code to use this domain-appropriate method.</p>
                    <div class="example"><a id="8_OrderDomain_body"></a>
                        <div class="example-title">Example 7-7. A refactor of our Order class to use domain-level methods</div>
                        <div class="example-contents">
                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countFeature(<span style="color:#00f;font-weight:700">ToLongFunction</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Album</span> <span style="color:#00f;font-weight:700">&gt;</span>
function) {
    <span style="color:#00f;font-weight:700">return</span> albums<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>mapToLong(function)<span style="color:#00f;font-weight:700">.</span>sum();
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countTracks() {
    <span style="color:#00f;font-weight:700">return</span> countFeature(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>count());
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countRunningTime() {
    <span style="color:#00f;font-weight:700">return</span> countFeature(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getTracks()<span style="color:#00f;font-weight:700">.</span>mapToLong(track <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>track<span style="color:#00f;font-weight:700">.</span>getLength())<span style="color:#00f;font-weight:700">.</span>sum());
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countMusicians() {
    <span style="color:#00f;font-weight:700">return</span> countFeature(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>album<span style="color:#00f;font-weight:700">.</span>getMusicians()<span style="color:#00f;font-weight:700">.</span>count());
}
</pre>
                        </div>
                </div>
        </div>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_unit_testing_lambda_expressions" style="clear: both">Unit Testing Lambda Expressions</h2>
                </div>
            </div>
        </div>
        <div class="note">
            <h3 class="title">Note</h3>
            <p><a class="indexterm" id="8_id406779"></a><a class="indexterm" id="8_id406787"></a><a class="indexterm" id="8_id406793"></a><a class="indexterm" id="8_id406800"></a><a class="indexterm" id="8_ix_ch07-asciidoc4"></a><a class="indexterm" id="8_ix_ch07-asciidoc5"></a>Unit
                testing is a method of testing individual chunks of code to ensure thatthey are behaving as intended.</p>
        </div>
        <p>Usually, when writing a unit test you call a method in your test code thatgets called in your application. Given some inputs and possibly test doubles,you call these methods to test a certain behavior happening and then specifythe changes you
            expect to result from this behavior.</p>
        <p><a class="indexterm" id="8_id406834"></a>Lambda expressions pose a slightly different challenge when unit testing code.Because they don’t have a name, it’s impossible to directly call them in your testcode.</p>
        <p>You could choose to copy the body of the lambda expression into your test andthen test that copy, but this approach has the unfortunate side effect of not actuallytesting the behavior of your implementation. If you change the implementationcode,
            your test will still pass even though the implementation isperforming a different task.</p>
        <p>There are two viable solutions to this problem. The first is to view thelambda expression as a block of code within its surrounding method. If youtake this approach, you should be testing the behavior of the surroundingmethod, not the lambda expression
            itself. Let’s take look<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#testing_to_uppercase">Example 7-8</a>, which gives an example method for converting a list ofstrings into their
            uppercase equivalents.</p>
        <div class="example"><a id="8_testing_to_uppercase"></a>
            <div class="example-title">Example 7-8. Converting strings into their uppercase equivalents</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> allToUpperCase(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> words) {
    <span style="color:#00f;font-weight:700">return</span> words<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(string <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>string<span style="color:#00f;font-weight:700">.</span>toUpperCase())<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span>. <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> toList());
}
</pre>
            </div>
        </div>
        <p>The only thing that the lambda expression in this body of code does is directlycall a core Java method. It’s really not worth the effort of testing this lambdaexpression as an independent unit of code at all, since the behavior is sosimple.</p>
        <p>If I were to unit test this code, I would focus on the behavior of themethod. For example, <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#test_convert_multiple_words">Example 7-9</a>            is a test that if thereare multiple words in the stream, they are all converted to their uppercaseequivalents.</p>
        <div class="example"><a id="8_test_convert_multiple_words"></a>
            <div class="example-title">Example 7-9. Testing conversion of words to uppercase equivalents</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> multipleWordsToUppercase() {
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> input <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Arrays</span><span style="color:#00f;font-weight:700">.</span>asList(<span style="color:#036a07">a</span>, <span style="color:#036a07">b</span>, <span style="color:#036a07">hello</span>);
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> result <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Testing</span><span style="color:#00f;font-weight:700">.</span>allToUpperCase(input);
    assertEquals(asList(<span style="color:#036a07">A</span>, <span style="color:#036a07">B</span>, <span style="color:#036a07">HELLO</span>), result);
}
</pre>
            </div>
        </div>
        <p>Sometimes you want to use a lambda expression that exhibits complexfunctionality. Perhaps it has a number of corner cases or a role involvingcalculating a highly important function in your domain. You really want totest for behavior specific to
            that body of code, but it’s in a lambdaexpression and you’ve got no way of referencing it.</p>
        <p>As an example problem, let’s look at a method that is slightly more complexthan converting a list of strings to uppercase. Instead, we’ll be converting thefirst character of a string to uppercase and leaving the rest as is. If we wereto write
            this using streams and lambda expressions, we might write something like<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#firstToUpperCase_lambda">Example 7-10</a>. Our lambda expression
            doing the conversion is at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#CO1-22"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>.</p>
        <div class="example"><a id="8_firstToUpperCase_lambda"></a>
            <div class="example-title">Example 7-10. Convert first character of all list elements to uppercase</div>
            <div class="example-contents">
               
                
                
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> elementFirstToUpperCaseLambdas(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> words) {
    <span style="color:#00f;font-weight:700">return</span> words<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(value <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{<a id="8_CO1-22"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>
        <span style="color:#0000cd">1</span> <span style="color:#00f;font-weight:700">char</span> firstChar <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Character</span><span style="color:#00f;font-weight:700">.</span>toUpperCase(value<span style="color:#00f;font-weight:700">.</span>charAt(<span style="color:#0000cd">0</span>));
        <span style="color:#00f;font-weight:700">return</span> firstChar <span style="color:#00f;font-weight:700">+</span> value<span style="color:#00f;font-weight:700">.</span>substring(<span style="color:#0000cd">1</span>);
    })<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span>. <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> toList());
}
</pre>
            </div>
    </div>
    <p>Should we want to test this, we’d need to fire in a list and test the output for every single example we wanted to test. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#twoLetterStringConvertedToUppercaseLambdas">Example 7-11</a>provides
        an example of how cumbersome this approach becomes. Don’t worry—there is asolution!</p>
    <div class="example"><a id="8_twoLetterStringConvertedToUppercaseLambdas"></a>
        <div class="example-title">Example 7-11. Testing that in a two-character string, only the first character is converted to uppercase</div>
        <div class="example-contents">
          <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> twoLetterStringConvertedToUppercaseLambdas() {
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> input <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Arrays</span><span style="color:#00f;font-weight:700">.</span>asList(<span style="color:#036a07">ab</span>);
    <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> result <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Testing</span><span style="color:#00f;font-weight:700">.</span>elementFirstToUpperCaseLambdas(input);
    assertEquals(asList(<span style="color:#036a07">Ab</span>), result);
}
</pre>
        </div>
    </div>
    <p><span class="emphasis"><em>Don’t</em></span> use a lambda expression. I know that might appear to be strange advicein a book about how to use lambda expressions, but square pegs don’t fit intoround holes very well. Having accepted this, we’re bound
        to ask how we canstill unit test our code and have the benefit of lambda-enabled libraries.</p>
    <p><span class="emphasis"><em>Do</em></span> use<a class="indexterm" id="8_id407943"></a> method references. Any method that would have been written as alambda expression can also be written as a normal method and then directlyreferenced elsewhere in code
        using method references.</p>
    <p>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#firstToUpperCase_reference">Example 7-12</a> I’ve refactored out the lambda expressioninto its own method. This is then used by the main
        method, which dealswith converting the list of strings.</p>
    <div class="example"><a id="8_firstToUpperCase_reference"></a>
        <div class="example-title">Example 7-12. Converting the first character to uppercase and applying it to a list</div>
        <div class="example-contents">
        
            
            
            
            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> elementFirstToUppercase(<span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> words) {
    <span style="color:#00f;font-weight:700">return</span> words<span style="color:#00f;font-weight:700">.</span>stream()<span style="color:#00f;font-weight:700">.</span>map(<span style="color:#00f;font-weight:700">Testing</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>firstToUppercase)<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span>. <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> toList());
}
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">String</span> firstToUppercase(<span style="color:#00f;font-weight:700">String</span> value) { <a id="8_CO1-23"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>
    <span style="color:#0000cd">1</span> <span style="color:#00f;font-weight:700">char</span> firstChar <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Character</span><span style="color:#00f;font-weight:700">.</span>toUpperCase(value<span style="color:#00f;font-weight:700">.</span>charAt(<span style="color:#0000cd">0</span>));
    <span style="color:#00f;font-weight:700">return</span> firstChar <span style="color:#00f;font-weight:700">+</span> value<span style="color:#00f;font-weight:700">.</span>substring(<span style="color:#0000cd">1</span>);
}
</pre>
        </div>
    </div>
    <p>Having extracted the method that actually performs string processing, we cancover all the corner cases by testing that method on its own. The sametest case in its new, simplified form is shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#twoLetterStringConvertedToUppercase">Example 7-13</a>.
        <a class="indexterm" id="8_id408016"></a><a class="indexterm" id="8_id408354"></a></p>
    <div class="example"><a id="8_twoLetterStringConvertedToUppercase"></a>
        <div class="example-title">Example 7-13. The two-character test applied to a single method</div>
        <div class="example-contents">
           <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> twoLetterStringConvertedToUppercase() {
    <span style="color:#00f;font-weight:700">String</span> input <span style="color:#00f;font-weight:700">=</span> <span style="color:#036a07">ab</span>;
    <span style="color:#00f;font-weight:700">String</span> result <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Testing</span><span style="color:#00f;font-weight:700">.</span>firstToUppercase(input);
    assertEquals(<span style="color:#036a07">Ab</span>, result);
}
</pre>
        </div>
    </div>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_using_lambda_expressions_in_test_doubles" style="clear: both">Using Lambda Expressions in Test Doubles</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="8_ix_ch07-asciidoc6"></a><a class="indexterm" id="8_ix_ch07-asciidoc7"></a><a class="indexterm" id="8_ix_ch07-asciidoc8"></a>A pretty common part of writing unit tests is to use <span class="emphasis"><em>test doubles</em></span>            todescribe the expected behavior of other components of the system. This isuseful because unit testing tries to test a class or method in isolation of theother components of your code base, and test doubles allow you to implement thisisolation
            in terms of tests.</p>
        <div class="note">
            <h3 class="title">Note</h3>
            <p>Even though test doubles are frequently referred to as<a class="indexterm" id="8_id408591"></a><a class="indexterm" id="8_id408596"></a> <span class="emphasis"><em>mocks</em></span>, actually both stubs and mocks are types of test double. The
                difference is that mocks allow you to verify the code’s behavior. The best place to understand more about this is<a class="indexterm" id="8_id408621"></a><a class="indexterm" id="8_id408614"></a> <a class="ulink" href="http://martinfowler.com/articles/mocksArentStubs.html" target="_top">Martin Fowler’s article</a> on the subject.</p>
        </div>
        <p>One of the simplest ways to use lambda expressions in test code is to implement lightweight stubs. This is really easy and natural to implement if the collaborator to be stubbed is already a functional interface.</p>
        <p>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#behavioural_wet">Behavioral Write Everything Twice</a>, I discussed how to refactor our common domain logic intoa <code class="literal">countFeature</code>            method that used a lambda expression to implement differentcounting behavior. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#can_count_albums">Example 7-14</a> shows how we might
            go about unit testing part of itsbehavior.</p>
        <div class="example"><a id="8_can_count_albums"></a>
            <div class="example-title">Example 7-14. Using a lambda expression as a test double by passing it to countFeature</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Test</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> canCountFeatures() {
    <span style="color:#00f;font-weight:700">OrderDomain</span> order <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">OrderDomain</span>(asList(newAlbum(<span style="color:#036a07">Exile on Main St.</span>), newAlbum(<span style="color:#036a07">Beggars Banquet</span>), newAlbum(<span style="color:#036a07">Aftermath</span>), newAlbum(<span style="color:#036a07">Let it Bleed</span>)));
    assertEquals(<span style="color:#0000cd">8</span>, order<span style="color:#00f;font-weight:700">.</span>countFeature(album <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#0000cd">2</span>));
}
</pre>
            </div>
        </div>
        <p>The expected behavior is that the <code class="literal">countFeature</code> method returns the sum ofsome number for each album it’s passed. So here I’m passing in four differentalbums, and the stub in my test is returning a count of 2 features
            for eachalbum. I assert that the method returns 8—that is, 2×4. If you expect topass a lambda expression into your code, then it’s usually the right thing tohave your test also pass in a lambda expression.</p>
        <p>Most test doubles end up being the result of more complex expectation setting.In these situations, frameworks such as<a class="indexterm" id="8_id408911"></a> <span class="emphasis"><em>Mockito</em></span> are often used to easilygenerate test doubles.
            Let’s consider a simple example in which we want toproduce a test double for a <code class="literal">List</code>. Instead of returning the size of the <code class="literal">List</code>,we want to return the size of another <code class="literal">List</code>.
            When mocking the <code class="literal">size</code> methodof the <code class="literal">List</code>, we don’t want to specify just a single answer. We want our answer toperform some operation, so we pass in a lambda expression (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#mockito_lambdas">Example 7-15</a>).</p>
        <div class="example"><a id="8_mockito_lambdas"></a>
            <div class="example-title">Example 7-15. Using a lambda expression in conjunction with the Mockito library</div>
            <div class="example-contents">
              <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> list <span style="color:#00f;font-weight:700">=</span> mock(<span style="color:#00f;font-weight:700">List</span><span style="color:#00f;font-weight:700">.</span>class);
when(list<span style="color:#00f;font-weight:700">.</span>size())<span style="color:#00f;font-weight:700">.</span>thenAnswer(inv <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>otherList<span style="color:#00f;font-weight:700">.</span>size());
assertEquals(<span style="color:#0000cd">3</span>, list<span style="color:#00f;font-weight:700">.</span>size());
</pre>
            </div>
        </div>
        <p>Mockito uses an<a class="indexterm" id="8_id409141"></a> <code class="literal">Answer</code> interface that lets you provide alternativeimplementation behavior. In other words, it already supports our familiarfriend: passing code as data. We can
            use a lambda expression here because<code class="literal">Answer</code> is, conveniently, a functional interface.<a class="indexterm" id="8_id409164"></a><a class="indexterm" id="8_id409156"></a><a class="indexterm" id="8_id409170"></a></p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_lazy_evaluation_versus_debugging" style="clear: both">Lazy Evaluation Versus Debugging</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="8_id409214"></a><a class="indexterm" id="8_id409222"></a>Using a debugger typically involves stepping through statements of yourprogram or attaching breakpoints. Sometimes you might encounter situationsusing the streams library
            where debugging becomes a little bit more complex,because the iteration is controlled by the library and many stream operationsare lazily evaluated.</p>
        <p>In the traditional imperative view of the world, in which code is a sequence ofactions that achieve a goal, introspecting state after or before an actionmakes perfect sense. In Java 8, you still have access to all your existingIDE debugging tools,
            but sometimes you need to tweak your approach alittle in order to achieve good results.</p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_logging_and_printing" style="clear: both">Logging and Printing</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="8_id409274"></a><a class="indexterm" id="8_id409234"></a>Let’s say you’re performing a series of operations on a collection and you’retrying to debug the code; you want to see what the result of an individualoperation is.
            One thing you could do is print out the collection value aftereach step. This is pretty hard with the Streams framework, as intermediatesteps are lazily evaluated.</p>
        <p>Let’s take a look at how we might log intermediate values by taking a look atan imperative version of our nationality report from <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>.In
            case you’ve forgotten, and who doesn’t sometimes, this is code thattries to find the country of origin for every artist on an album. In<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#imperative_nationality_report">Example 7-16</a>            we’re going to log each of the nationalitiesthat we find.</p>
        <div class="example"><a id="8_imperative_nationality_report"></a>
            <div class="example-title">Example 7-16. Logging intermediate values in order to debug a for loop</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> nationalities <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HashSet</span> &lt; &gt;();
<span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">Artist</span> artist<span style="color:#00f;font-weight:700">:</span> album<span style="color:#00f;font-weight:700">.</span>getMusicianList()) {
    <span style="color:#00f;font-weight:700">if</span> (artist<span style="color:#00f;font-weight:700">.</span>getName()<span style="color:#00f;font-weight:700">.</span>startsWith(<span style="color:#036a07">The</span>)) {
        <span style="color:#00f;font-weight:700">String</span> nationality <span style="color:#00f;font-weight:700">=</span> artist<span style="color:#00f;font-weight:700">.</span>getNationality();
        <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">Found nationality: </span> <span style="color:#00f;font-weight:700">+</span> nationality);
        nationalities<span style="color:#00f;font-weight:700">.</span>add(nationality);
    }
}
<span style="color:#00f;font-weight:700">return</span> nationalities;
</pre>
            </div>
        </div>
        <p>Now we could use the <code class="literal">forEach</code> method to print out the values from the stream,which would also cause it to be evaluated. However, this way has the downside that wecan’t continue to operate on that stream, because streams
            can only be used once.If we really want to use this approach, we need to recreate the stream. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#foreach_logging_nationality_report">Example 7-17</a>            shows how ugly this can get.</p>
        <div class="example"><a id="8_foreach_logging_nationality_report"></a>
            <div class="example-title">Example 7-17. Using a naive forEach to log intermediate values</div>
            <div class="example-contents">
              <pre style="background:#fff;color:#000">album<span style="color:#00f;font-weight:700">.</span>getMusicians()<span style="color:#00f;font-weight:700">.</span>filter(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getName()<span style="color:#00f;font-weight:700">.</span>startsWith(<span style="color:#036a07">The</span>))<span style="color:#00f;font-weight:700">.</span>map(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getNationality())<span style="color:#00f;font-weight:700">.</span>forEach(nationality <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">Found: </span> <span style="color:#00f;font-weight:700">+</span> nationality));
<span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> nationalities <span style="color:#00f;font-weight:700">=</span> album<span style="color:#00f;font-weight:700">.</span>getMusicians()<span style="color:#00f;font-weight:700">.</span>filter(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getName()<span style="color:#00f;font-weight:700">.</span>startsWith(<span style="color:#036a07">The</span>))<span style="color:#00f;font-weight:700">.</span>map(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getNationality())<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span>. <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> toSet());
</pre>
            </div>
        </div>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_the_solution_peek" style="clear: both">The Solution: peek</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="8_id410064"></a><a class="indexterm" id="8_id410071"></a>Fortunately, the streams library contains a method that lets you look at eachvalue in turn and also lets you continue to operate on the same underlyingstream. It’s called
            <code class="literal">peek</code>. In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch07.html#peek_nationality_report">Example 7-18</a>, we have rewrittenthe previous example using
            <code class="literal">peek</code> in order to print out the stream values withouthaving to repeat the pipeline of stream operations.</p>
        <div class="example"><a id="8_peek_nationality_report"></a>
            <div class="example-title">Example 7-18. Using peek to log intermediate values</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> nationalities <span style="color:#00f;font-weight:700">=</span> album<span style="color:#00f;font-weight:700">.</span>getMusicians()<span style="color:#00f;font-weight:700">.</span>filter(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getName()<span style="color:#00f;font-weight:700">.</span>startsWith(<span style="color:#036a07">The</span>))<span style="color:#00f;font-weight:700">.</span>map(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getNationality())<span style="color:#00f;font-weight:700">.</span>peek(nation <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">Found nationality: </span> <span style="color:#00f;font-weight:700">+</span> nation))<span style="color:#00f;font-weight:700">.</span>collect(<span style="color:#00f;font-weight:700">Collectors</span>. <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> toSet());
</pre>
            </div>
        </div>
        <p>It’s also possible to use the <code class="literal">peek</code> method to output to existing logging systemssuch as<a class="indexterm" id="8_id410407"></a><a class="indexterm" id="8_id410409"></a><a class="indexterm" id="8_id410414"></a> <code class="literal">log4j</code>,
            <code class="literal">java.util.logging</code>, or <code class="literal">slf4j</code> in exactly the same way.</p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_midstream_breakpoints" style="clear: both">Midstream Breakpoints</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="8_id410444"></a><a class="indexterm" id="8_id410452"></a>Logging is just one of many tricks that the <code class="literal">peek</code> method has up its sleeve. Toallow us to debug a stream element by element, as we might
            debug a loop step bystep, a breakpoint can be set on the body of the <code class="literal">peek</code> method.</p>
        <p>In this case, <code class="literal">peek</code> can just have an empty body that you set a breakpoint in.Some debuggers won’t let you set a breakpoint in an empty body, in which case I just map a value to itself in order to be able to set the
            breakpoint.It’s not ideal, but it works fine.</p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_key_points_6" style="clear: both">Key Points</h2>
                </div>
            </div>
        </div>
        <div class="itemizedlist">
            <ul class="itemizedlist">
                <li class="listitem">Consider how lambda expressions can help when refactoring legacy code: thereare common patterns.</li>
                <li class="listitem">If you want to unit test a lambda expression of any complexity, extract it to aregular method.</li>
                <li class="listitem">The <code class="literal">peek</code> method is very useful for logging out intermediate values whendebugging.</li>
            </ul>
        </div>
    </div>
    </section>
    <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
    </div>
    </div>
    </section>
    </div>
    </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch08.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch08.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="9_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="design_chp">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 8. Design and Architectural Principles</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="blockquote">
                                <blockquote class="blockquote">
                                    <p>The critical design tool for software development is a mind well educated in design principles. It is not…technology.</p>
                                    <div class="attribution">
                                        <p>—<span class="attribution">Craig Larman</span></p>
                                    </div>
                                </blockquote>
                            </div>
                            <p><a class="indexterm" id="9_ix_ch08-asciidoc0"></a><a class="indexterm" id="9_ix_ch08-asciidoc3"></a><a class="indexterm" id="9_ix_ch08-asciidoc4"></a>I’ve already established that lambda expressions are a fairly simple change tothe
                                Java language and that there are a bunch of ways that we can use them withinthe standard JDK libraries. Most Java code isn’t written by the core JDKdevelopers—it’s written by people like you. In order to use lambda expressionsin
                                the most beneficial way possible, you need to start introducing them intoyour existing code base. They are just another tool in the belt of a professionalJava developer, no different from an interface or a class.</p>
                            <p>In this chapter, we’re going to explore how to use to use lambda expressions to implement the <span class="emphasis"><em>SOLID</em></span> principles that provide guidelines toward good object-oriented programming. There are
                                also many existing design patterns that can be improved by the use of lambda expressions, and we’ll take a look at a smattering of those.</p>
                            <p><a class="indexterm" id="9_id410601"></a>When coding with teammates at work, I’m sure you’ve come across a situationwhere you’ve implemented some feature or fixed a bug, and you were pretty happywith the way that you had done
                                it, but soon after someone else took a look at thesame code—perhaps during a code review—and they weren’t so happy with it! It’spretty common to have this kind of disagreement over what really constitutesgood code or bad
                                code.</p>
                            <p>Most of the time when people are disagreeing, they are pushing a matter of opinion.The reviewer would have done it another way. It’s not necessarily that he isright or wrong, or that you are right or wrong. When you welcome
                                lambdas intoyour life, there’s another topic to think about. It’s not that they are a difficultfeature or a big point of contention as much as they are just another design issuethat people can discuss or disagree on.</p>
                            <p>This chapter is here to help! I’ll try to put forth some well-grounded principles andpatterns upon which you can compose maintainable and reliable software—notjust to use the shiny new JDK libraries, but to use lambda expressions
                                in your owndomain architecture and applications.</p>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_lambda_enabled_design_patterns" style="clear: both">Lambda-Enabled Design Patterns</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="9_ix_ch08-asciidoc6"></a>One of the other bastions of design we’re all familiar with is the idea of<a class="indexterm" id="9_id410638"></a> <span class="emphasis"><em>design patterns</em></span>. Patterns
                                    documentreusable templates that solve common problems in software architecture. If you spot a problem and you’re familiar with an appropriate pattern, then you can takethe pattern and apply it to your situation. In
                                    a sense, patterns codify whatpeople consider to be a best-practice approach to a given problem.</p>
                                <p>Of course, no practice is ever the best practice forever. A common example isthe<a class="indexterm" id="9_id410653"></a> once-popular singleton pattern, which enforces the creation of only one instance of anobject. Over
                                    the last decade, this has been roundly criticized for makingapplications more brittle and harder to test. <a class="indexterm" id="9_id410706"></a>As the Agile software movementhas made testing of applications more important,
                                    the issues with the singletonpattern have made it an<a class="indexterm" id="9_id410720"></a> <span class="emphasis"><em>antipattern</em></span>: a pattern you should never use.</p>
                                <p>In this section, I’m not going to talk about how patterns have becomeobsolete. We’re instead going to look at how existing design patterns have becomebetter, simpler, or in some cases implementable in a different way. In
                                    allcases, the language changes in Java 8 are the driving factor behind the patternchanging.</p>
                                <div class="sect2">
                                    <div class="titlepage">
                                        <div>
                                            <div>
                                                <h3 class="title" id="_command_pattern">Command Pattern</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <p><a class="indexterm" id="9_ix_ch08-asciidoc7"></a><a class="indexterm" id="9_ix_ch08-asciidoc8"></a>A <span class="emphasis"><em>command object</em></span> is an object that encapsulates all the information required tocall
                                        another method later. The <span class="emphasis"><em>command pattern</em></span> is a way of using this objectin order to write generic code that sequences and executes methods based onruntime decisions. There are
                                        four classes that take part in the commandpattern,<a class="indexterm" id="9_id410761"></a><a class="indexterm" id="9_id410781"></a><a class="indexterm" id="9_id410792"></a><a class="indexterm" id="9_id410798"></a> as shown
                                        in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#jvld_0801">Figure 8-1</a>:</p>
                                    <div class="variablelist">
                                        <dl><dt><span class="term">Receiver</span></dt>
                                            <dd>Performs the actual work</dd><dt><span class="term">Command</span></dt>
                                            <dd>Encapsulates all the information required to call the receiver</dd><dt><span class="term">Invoker</span></dt>
                                            <dd>Controls the sequencing and execution of one or more commands</dd><dt><span class="term">Client</span></dt>
                                            <dd>Creates concrete command instances</dd>
                                        </dl>
                                    </div>
                                    <div class="figure"><a id="9_jvld_0801"></a>
                                        <div class="figure-contents">
                                            <div class="mediaobject"><img alt=".The Command Pattern" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0801.png" height="638" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0801.png" width="663"/></div>
                                        </div>
                                        <div class="figure-title">Figure 8-1. The command pattern</div>
                                    </div>
                                    <p><a class="indexterm" id="9_id410904"></a>Let’s look at a concrete example of the command pattern and see how it improveswith lambda expressions. Suppose we have a GUI <code class="literal">Editor</code> component thathas
                                        actions upon it that we’ll be calling, such as <code class="literal">open</code> or <code class="literal">save</code>, like in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Editor">Example 8-1</a>.
                                        We want to implement<a class="indexterm" id="9_id410918"></a> macro functionality—that is, a series ofoperations that can be recorded and then run later as a single operation. Thisis our receiver.</p>
                                    <div class="example"><a id="9_Editor"></a>
                                        <div class="example-title">Example 8-1. Common functions a text editor may have</div>
                                        <div class="example-contents">
                                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Editor</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">save</span>();
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">open</span>();
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">close</span>();
}
</pre>
                                        </div>
                                    </div>
                                    <p>In this example, each of the operations, such as <code class="literal">open</code> and <code class="literal">save</code>, are commands.We need a generic command interface to fit these different operationsinto. I’ll
                                        call this interface <code class="literal">Action</code>, as it represents performing asingle action within our domain. This is the interface that all our commandobjects implement (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Action_interface">Example 8-2</a>).</p>
                                    <div class="example"><a id="9_Action_interface"></a>
                                        <div class="example-title">Example 8-2. All our actions implement the Action interface</div>
                                        <div class="example-contents">
                                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Action</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">perform</span>();
}
</pre>
                                        </div>
                                </div>
                                <p>We can now implement our <code class="literal">Action</code> interface for each of the operations. All these classes need to do is call a single method on our <code class="literal">Editor</code> and wrap this call into
                                    our <code class="literal">Action</code> interface. I’ll name the classes after the operations that they wrap, with the appropriate class naming convention—so, the <code class="literal">save</code> method corresponds
                                    to a class called <code class="literal">Save</code>. Examples <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#SaveAction">8-3</a> and <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#OpenAction">8-4</a>                                    are our command objects.</p>
                                <div class="example"><a id="9_SaveAction"></a>
                                    <div class="example-title">Example 8-3. Our save action delegates to the underlying method call on Editor</div>
                                    <div class="example-contents">
                                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Save</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">Action</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Editor</span> editor;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">Save</span>(<span style="color:#00f;font-weight:700">Editor</span> <span style="font-style:italic">editor</span>) {
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>editor <span style="color:#00f;font-weight:700">=</span> editor;
    }<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">perform</span>() {
        editor<span style="color:#00f;font-weight:700">.</span>save();
    }
}
</pre>
                                    </div>
                                </div>
                                <div class="example"><a id="9_OpenAction"></a>
                                    <div class="example-title">Example 8-4. Our open action also delegates to the underlying method call on Editor</div>
                                    <div class="example-contents">
                                     <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Open</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">Action</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Editor</span> editor;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">Open</span>(<span style="color:#00f;font-weight:700">Editor</span> <span style="font-style:italic">editor</span>) {
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>editor <span style="color:#00f;font-weight:700">=</span> editor;
    }<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">perform</span>() {
        editor<span style="color:#00f;font-weight:700">.</span>open();
    }
}
</pre>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="9_id411620"></a>Now we can implement our <code class="literal">Macro</code> class. This class can <code class="literal">record</code> actions andrun them as a group. We use a <code class="literal">List</code>                                    to store the sequence of actions and thencall <code class="literal">forEach</code> in order to execute each <code class="literal">Action</code> in turn. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Macro">Example 8-5</a>                                    is our invoker.</p>
                                <div class="example"><a id="9_Macro"></a>
                                    <div class="example-title">Example 8-5. A macro consists of a sequence of actions that can be invoked in turn</div>
                                    <div class="example-contents">
                                  <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Macro</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Action</span> <span style="color:#00f;font-weight:700">&gt;</span> actions;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">Macro</span>() {
        actions <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ArrayList</span> &lt; &gt;();
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">record</span>(<span style="color:#00f;font-weight:700">Action</span> <span style="font-style:italic">action</span>) {
        actions<span style="color:#00f;font-weight:700">.</span>add(action);
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">run</span>() {
        actions<span style="color:#00f;font-weight:700">.</span>forEach(<span style="color:#00f;font-weight:700">Action</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>perform);
    }
}
</pre>
                                    </div>
                                </div>
                                <p>When we come to build up a macro programmatically, we add an instance of eachcommand that has been recorded to the <code class="literal">Macro</code> object. We can then just run themacro and it will call each of the commands
                                    in turn. As a lazy programmer, Ilove the ability to define common workflows as macros. Did I say “lazy”? I meantfocused on improving my productivity. The <code class="literal">Macro</code> object is our client codeand
                                    is shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#classBasedCommand">Example 8-6</a>.</p>
                                <div class="example"><a id="9_classBasedCommand"></a>
                                    <div class="example-title">Example 8-6. Building up a macro with the command pattern</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Macro</span> macro = <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Macro</span>();
macro.record(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Open</span>(editor));
macro.record(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Save</span>(editor));
macro.record(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Close</span>(editor));
macro.run();
</pre>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="9_id412174"></a><a class="indexterm" id="9_id412182"></a>How do lambda expressions help? Actually, all our command classes, such as<code class="literal">Save</code> and <code class="literal">Open</code>,
                                    are really just lambda expressions wanting to get out oftheir shells. They are blocks of behavior that we’re creating classes inorder to pass around. This whole pattern becomes a lot simpler with lambdaexpressions because
                                    we can entirely dispense with these classes.<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#lambdaBasedCommand">Example 8-7</a> shows how to use our
                                    <code class="literal">Macro</code> class without these commandclasses and with lambda expressions instead.</p>
                                <div class="example"><a id="9_lambdaBasedCommand"></a>
                                    <div class="example-title">Example 8-7. Using lambda expressions to build up a macro</div>
                                    <div class="example-contents">
                                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Macro</span> macro <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Macro</span>();
macro<span style="color:#00f;font-weight:700">.</span>record(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>editor<span style="color:#00f;font-weight:700">.</span>open());
macro<span style="color:#00f;font-weight:700">.</span>record(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>editor<span style="color:#00f;font-weight:700">.</span>save());
macro<span style="color:#00f;font-weight:700">.</span>record(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>editor<span style="color:#00f;font-weight:700">.</span>close());
macro<span style="color:#00f;font-weight:700">.</span>run();
</pre>
                                    </div>
                                </div>
                                <p>In fact, we can do this even better by recognizing that each of these lambdaexpressions is performing a single method call. So, we can actually usemethod references in order to wire the editor’s commands to the macroobject
                                    (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#referenceBasedCommand">Example 8-8</a>).</p>
                                <div class="example"><a id="9_referenceBasedCommand"></a>
                                    <div class="example-title">Example 8-8. Using method references to build up a macro</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Macro</span> macro <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Macro</span>();
macro<span style="color:#00f;font-weight:700">.</span>record(editor<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>open);
macro<span style="color:#00f;font-weight:700">.</span>record(editor<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>save);
macro<span style="color:#00f;font-weight:700">.</span>record(editor<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>close);
macro<span style="color:#00f;font-weight:700">.</span>run();
</pre>
                                    </div>
                                </div>
                                <p>The command pattern is really just a poor man’s lambda expression to beginwith. By using actual lambda expressions or method references, we can clean upthe code, reducing the amount of boilerplate required and making the
                                    intent ofthe code more obvious.</p>
                                <p>Macros are just one example of how we can use the command pattern. It’sfrequently used in implementing component-based GUI systems, undo functions,thread pools, transactions, and wizards.</p>
                                <div class="note">
                                    <h3 class="title">Note</h3>
                                    <p>There is already a functional interface with the same structure as our interface <code class="literal">Action</code> in core<a class="indexterm" id="9_id412643"></a> Java—<code class="literal">Runnable</code>.We could
                                        have chosen to use that in our macro class, but in this case it seemed more appropriate to consider an <code class="literal">Action</code>to be part of the vocabulary of our domain and create our own interface.
                                        <a class="indexterm" id="9_id412659"></a><a class="indexterm" id="9_id412655"></a></p>
                                </div>
                            </div>
                            <div class="sect2">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h3 class="title" id="_strategy_pattern">Strategy Pattern</h3>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="9_ix_ch08-asciidoc9"></a><a class="indexterm" id="9_ix_ch08-asciidoc10"></a>The strategy pattern is a way of changing the algorithmic behavior of softwarebased upon a runtime decision. How you implement
                                    the strategy pattern dependsupon your circumstances, but in all cases the main idea is to be able to define acommon problem that is solved by different algorithms and then encapsulate allthe algorithms behind the same
                                    programming interface.</p>
                                <p>An example algorithm we might want to encapsulate is compressing files. We’llgive our users the choice of compressing our files using either the<a class="indexterm" id="9_id412701"></a><a class="indexterm" id="9_id412708"></a>                                    <span class="emphasis"><em>zip</em></span>algorithm or the <span class="emphasis"><em>gzip</em></span> algorithm and implement a generic <code class="literal">Compressor</code> classthat can compress using either algorithm.</p>
                                <p>First we need to define the API for our strategy (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#jvld_0802">Figure 8-2</a>), which I’ll call<code class="literal">CompressionStrategy</code>.
                                    Each of our compression algorithms will implement thisinterface. They have the <code class="literal">compress</code> method, which takes and returns an<code class="literal">OutputStream</code>. The returned <code class="literal">OutputStream</code>                                    is a compressed version of theinput (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#CompressionStrategy">Example 8-9</a>).</p>
                                <div class="figure"><a id="9_jvld_0802"></a>
                                    <div class="figure-contents">
                                        <div class="mediaobject"><img alt=".The Strategy Pattern" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0802.png" height="638" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0802.png" width="582"/></div>
                                    </div>
                                    <div class="figure-title">Figure 8-2. The strategy pattern</div>
                                </div>
                                <div class="example"><a id="9_CompressionStrategy"></a>
                                    <div class="example-title">Example 8-9. Defining a strategy interface for compressing data</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">CompressionStrategy</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">OutputStream</span> <span style="color:#0000a2;font-weight:700">compress</span>(<span style="color:#00f;font-weight:700">OutputStream</span> <span style="font-style:italic">data</span>) <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">IOException</span>;
}
</pre>
                                    </div>
                                </div>
                                <p>We have two concrete implementations of this interface, one for gzip and onefor ZIP, which use the built-in Java classes to write gzip (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#GzipCompressionStrategy">Example 8-10</a>)
                                    and ZIP (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#ZipCompressionStrategy">Example 8-11</a>) files.</p>
                                <div class="example"><a id="9_GzipCompressionStrategy"></a>
                                    <div class="example-title">Example 8-10. Using the gzip algorithm to compress data</div>
                                    <div class="example-contents">
                                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">GzipCompressionStrategy</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">CompressionStrategy</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">OutputStream</span> <span style="color:#0000a2;font-weight:700">compress</span>(<span style="color:#00f;font-weight:700">OutputStream</span> <span style="font-style:italic">data</span>) <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">IOException</span> {
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">GZIPOutputStream</span>(data);
    }
}
</pre>
                                    </div>
                                </div>
                                <div class="example"><a id="9_ZipCompressionStrategy"></a>
                                    <div class="example-title">Example 8-11. Using the zip algorithm to compress data</div>
                                    <div class="example-contents">
                                      <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">ZipCompressionStrategy</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">CompressionStrategy</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">OutputStream</span> <span style="color:#0000a2;font-weight:700">compress</span>(<span style="color:#00f;font-weight:700">OutputStream</span> <span style="font-style:italic">data</span>) <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">IOException</span> {
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ZipOutputStream</span>(data);
    }
}
</pre>
                                    </div>
                                </div>
                                <p>Now we can implement our <code class="literal">Compressor</code> class, which is the <span class="emphasis"><em>context</em></span> in which we use our strategy. This has a <code class="literal">compress</code> method on
                                    it that takes input and output files and writes a compressed version of the input file to the output file. It takes the <code class="literal">CompressionStrategy</code> as a constructor parameter that its calling code
                                    can use to make a runtime choice as to which compression strategy to use—for example, getting user input that would make the decision (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Compressor">Example 8-12</a>).</p>
                                <div class="example"><a id="9_Compressor"></a>
                                    <div class="example-title">Example 8-12. Our compressor is provided with a compression strategy at construction time</div>
                                    <div class="example-contents">
                                       <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Compressor</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">CompressionStrategy</span> strategy;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">Compressor</span>(<span style="color:#00f;font-weight:700">CompressionStrategy</span> <span style="font-style:italic">strategy</span>) {
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>strategy <span style="color:#00f;font-weight:700">=</span> strategy;
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">compress</span>(<span style="color:#00f;font-weight:700">Path</span> <span style="font-style:italic">inFile</span>, <span style="color:#00f;font-weight:700">File</span> <span style="font-style:italic">outFile</span>) <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">IOException</span> {
        <span style="color:#00f;font-weight:700">try</span> (<span style="color:#00f;font-weight:700">OutputStream</span> outStream <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">FileOutputStream</span>(outFile)) {
            <span style="color:#00f;font-weight:700">Files</span><span style="color:#00f;font-weight:700">.</span>copy(inFile, strategy<span style="color:#00f;font-weight:700">.</span>compress(outStream));
        }
    }
}
</pre>
                                    </div>
                            </div>
                            <p>If we have a traditional implementation of the strategy pattern, then we canwrite client code that creates a new <code class="literal">Compressor</code> with whichever strategy wewant (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#classBasedExample">Example 8-13</a>).</p>
                            <div class="example"><a id="9_classBasedExample"></a>
                                <div class="example-title">Example 8-13. Instantiating the Compressor using concrete strategy classes</div>
                                <div class="example-contents">
                                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Compressor</span> gzipCompressor <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Compressor</span>(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">GzipCompressionStrategy</span>());
gzipCompressor<span style="color:#00f;font-weight:700">.</span>compress(inFile, outFile);
<span style="color:#00f;font-weight:700">Compressor</span> zipCompressor <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Compressor</span>(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ZipCompressionStrategy</span>());
zipCompressor<span style="color:#00f;font-weight:700">.</span>compress(inFile, outFile);
</pre>
                                </div>
                    </div>
                    <p><a class="indexterm" id="9_id413808"></a><a class="indexterm" id="9_id413815"></a>As with the command pattern discussed earlier, using either lambdaexpressions or method references allows us to remove a whole layer ofboilerplate code from
                        this pattern. In this case, we can remove each of theconcrete strategy implementations and refer to a method that implementsthe algorithm. Here the algorithms are represented by the constructors of therelevant <code class="literal">OutputStream</code>                        implementation. We can totally dispense with the<code class="literal">GzipCompressionStrategy</code> and <code class="literal">ZipCompressionStrategy</code> classes when taking thisapproach. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#lambdaBasedExample">Example 8-14</a>                        is what the code would look like if we usedmethod references.<a class="indexterm" id="9_id413848"></a><a class="indexterm" id="9_id413843"></a></p>
                    <div class="example"><a id="9_lambdaBasedExample"></a>
                        <div class="example-title">Example 8-14. Instantiating the Compressor using method references</div>
                        <div class="example-contents">
                           <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Compressor</span> gzipCompressor <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Compressor</span>(<span style="color:#00f;font-weight:700">GZIPOutputStream</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">new</span>);
gzipCompressor<span style="color:#00f;font-weight:700">.</span>compress(inFile, outFile);
<span style="color:#00f;font-weight:700">Compressor</span> zipCompressor <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Compressor</span>(<span style="color:#00f;font-weight:700">ZipOutputStream</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">new</span>);
zipCompressor<span style="color:#00f;font-weight:700">.</span>compress(inFile, outFile);
</pre>
                        </div>
                    </div>
                </div>
                <div class="sect2">
                    <div class="titlepage">
                        <div>
                            <div>
                                <h3 class="title" id="_observer_pattern">Observer Pattern</h3>
                            </div>
                        </div>
                    </div>
                    <p><a class="indexterm" id="9_ix_ch08-asciidoc11"></a><a class="indexterm" id="9_ix_ch08-asciidoc12"></a>The observer pattern is another behavioral pattern that can be improved andsimplified through the use of lambda expressions. In the observer
                        pattern, anobject, called the<a class="indexterm" id="9_id414111"></a> <span class="emphasis"><em>subject</em></span>, maintains a list of other objects, which are its<span class="emphasis"><em>observers</em></span>. When the state
                        of the subject changes, its observers arenotified. It is heavily used in MVC-based GUI toolkits in order to allow viewcomponents to be updated when state changes in the model without couplingthe two classes together.</p>
                    <p>Seeing GUI components update is a bit boring, so the subject thatwe’ll be observing is the moon! Both NASA and some aliens want to keep trackof things landing on the moon. NASA wants to make sure itsApollo astronauts have landed safely;
                        the aliens want toinvade Earth when NASA is distracted.</p>
                    <p><a class="indexterm" id="9_id414099"></a>Let’s start by defining the API of our observers, which I’ll give the name<code class="literal">LandingObserver</code>. This has a single <code class="literal">observeLanding</code> method, which
                        will becalled when something lands on the moon (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#LandingObserver">Example 8-15</a>).</p>
                    <div class="example"><a id="9_LandingObserver"></a>
                        <div class="example-title">Example 8-15. An interface for observing organizations that land on the moon</div>
                        <div class="example-contents">
                          <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">LandingObserver</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">observeLanding</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">name</span>);
}
</pre>
                        </div>
                    </div>
                    <p>Our subject class is the <code class="literal">Moon</code>, which keeps a list of <code class="literal">LandingObserver</code>instances, notifies them of landings, and can add new <code class="literal">LandingObserver</code>instances
                        to spy on the <code class="literal">Moon</code> object (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Moon">Example 8-16</a>).</p>
                    <div class="example"><a id="9_Moon"></a>
                        <div class="example-title">Example 8-16. Our Moon domain class—not as pretty as the real thing</div>
                        <div class="example-contents">
                         <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Moon</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">LandingObserver</span> <span style="color:#00f;font-weight:700">&gt;</span> observers <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">ArrayList</span> &lt; &gt;();
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">land</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">name</span>) {
        <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">LandingObserver</span> observer<span style="color:#00f;font-weight:700">:</span> observers) {
            observer<span style="color:#00f;font-weight:700">.</span>observeLanding(name);
        }
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">startSpying</span>(<span style="color:#00f;font-weight:700">LandingObserver</span> <span style="font-style:italic">observer</span>) {
        observers<span style="color:#00f;font-weight:700">.</span>add(observer);
    }
}
</pre>
                        </div>
                    </div>
                    <p>We have two concrete implementations of the <code class="literal">LandingObserver</code> class thatrepresent the aliens’ (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Aliens">Example 8-17</a>)
                        and NASA’s views (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Nasa">Example 8-18</a>) of the landing event. As mentionedearlier, they both have different interpretations
                        of what this situationbrings them.</p>
                    <div class="example"><a id="9_Aliens"></a>
                        <div class="example-title">Example 8-17. The aliens can observe people landing on the moon</div>
                        <div class="example-contents">
                            <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Aliens</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">LandingObserver</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">observeLanding</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">name</span>) {
        <span style="color:#00f;font-weight:700">if</span> (name<span style="color:#00f;font-weight:700">.</span>contains(<span style="color:#036a07">Apollo</span>)) {
            <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">They&apos;re distracted, lets invade earth!</span>);
        }
    }
}
</pre>
                        </div>
                    </div>
                    <div class="example"><a id="9_Nasa"></a>
                        <div class="example-title">Example 8-18. NASA can also observe people landing on the moon</div>
                        <div class="example-contents">
                          <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Nasa</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">LandingObserver</span> {<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">observeLanding</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">name</span>) {
        <span style="color:#00f;font-weight:700">if</span> (name<span style="color:#00f;font-weight:700">.</span>contains(<span style="color:#036a07">Apollo</span>)) {
            <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">We made it!</span>);
        }
    }
}
</pre>
                        </div>
                    </div>
                    <p><a class="indexterm" id="9_id414991"></a><a class="indexterm" id="9_id415000"></a>In a similar vein to the previous patterns, in our traditional example ourclient code specifically wires up a layer of boilerplate classes that don’tneed
                        to exist if we use lambda expressions (see Examples <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Moon_classBasedExample">8-19</a> and <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Moon_lambdaBasedExample">8-20</a>).</p>
                    <div class="example"><a id="9_Moon_classBasedExample"></a>
                        <div class="example-title">Example 8-19. Client code building up a Moon using classes and things landing on it</div>
                        <div class="example-contents">
                      <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Moon</span> moon <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Moon</span>();
moon<span style="color:#00f;font-weight:700">.</span>startSpying(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Nasa</span>());
moon<span style="color:#00f;font-weight:700">.</span>startSpying(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Aliens</span>());
moon<span style="color:#00f;font-weight:700">.</span>land(<span style="color:#036a07">An asteroid</span>);
moon<span style="color:#00f;font-weight:700">.</span>land(<span style="color:#036a07">Apollo 11</span>);
</pre>
                        </div>
                </div>
                <div class="example"><a id="9_Moon_lambdaBasedExample"></a>
                    <div class="example-title">Example 8-20. Client code building up a Moon using lambdas and things landing on it</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">Moon</span> moon <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Moon</span>();
moon<span style="color:#00f;font-weight:700">.</span>startSpying(name <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
    <span style="color:#00f;font-weight:700">if</span> (name<span style="color:#00f;font-weight:700">.</span>contains(<span style="color:#036a07">Apollo</span>)) <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">We made it!</span>);
});
moon<span style="color:#00f;font-weight:700">.</span>startSpying(name <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
    <span style="color:#00f;font-weight:700">if</span> (name<span style="color:#00f;font-weight:700">.</span>contains(<span style="color:#036a07">Apollo</span>)) <span style="color:#00f;font-weight:700">System</span><span style="color:#00f;font-weight:700">.</span>out<span style="color:#00f;font-weight:700">.</span>println(<span style="color:#036a07">They&apos;re distracted, lets invade earth!</span>);
});
moon<span style="color:#00f;font-weight:700">.</span>land(<span style="color:#036a07">An asteroid</span>);
moon<span style="color:#00f;font-weight:700">.</span>land(<span style="color:#036a07">Apollo 11</span>);
</pre>
                    </div>
                </div>
                <p>One thing to think about with both the observer and the strategy patterns is thatwhether to go down the lambda design route or the class route depends a lot onthe complexity of the strategy or observer code that needs to be implemented.In
                    the cases I’ve presented here, the code is simple in nature, just a methodcall or two, and fits the new language features well. In some situations, though, theobserver can be a complex class in and of itself, and in those situations
                    tryingto squeeze a lot of code into one method can lead to poor readability.</p>
                <div class="note">
                    <h3 class="title">Note</h3>
                    <p>In some respects, <span class="emphasis"><em>trying to squeeze a lot of code into one method leads to poor readability</em></span> is the golden rule governing how to apply lambda expressions. The only reason I haven’t pushed this
                        so much is that it’s also the golden rule of writing normal methods!<a class="indexterm" id="9_id415244"></a><a class="indexterm" id="9_id415585"></a></p>
                </div>
        </div>
        <div class="sect2">
            <div class="titlepage">
                <div>
                    <div>
                        <h3 class="title" id="_template_method_pattern">Template Method Pattern</h3>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="9_ix_ch08-asciidoc13"></a><a class="indexterm" id="9_ix_ch08-asciidoc14"></a>A pretty common situation when developing software is having a commonalgorithm with a set of differing specifics. We want to require thedifferent
                implementations to have a common pattern in order toensure that they’re following the same algorithm and also to make the codeeasier to understand. Once you understand the overall pattern, youcan more easily understand each implementation.</p>
            <p>The template method pattern is designed for these kinds of situations. Youroverall algorithm design is represented by an<a class="indexterm" id="9_id415657"></a> <span class="emphasis"><em>abstract class</em></span>. This has aseries of abstract
                methods that represent customized steps in the algorithm,while any common code can be kept in this class. Each variant of the algorithmis implemented by a<a class="indexterm" id="9_id415658"></a> <span class="emphasis"><em>concrete class</em></span>                that overrides the abstract methodsand provides the relevant implementation.</p>
            <p>Let’s think through a scenario in order to make this clearer. As a bank, we’re going to be giving out loans to members of the public, companies, and employees. These categories have a fairly similar loan application process—you check the identity,
                credit history, and income history. You get this information from different sources and apply different criteria. For example, you might check the identity of a person by looking at an existing bill to her house, but companies have an
                official registrar such as the SEC in the US or Companies House in the UK.</p>
            <p>We can start to model this in code with an abstract <code class="literal">LoanApplication</code> classthat controls the algorithmic structure and holds common code for reporting thefindings of the loan application. There are then concrete
                subclasses for eachof our different categories of applicant: <code class="literal">CompanyLoanApplication</code>,<code class="literal">PersonalLoanApplication</code>, and <code class="literal">EmployeeLoanApplication</code>. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#LoanApplication">Example 8-21</a> shows what our<code class="literal">LoanApplication</code> class would look like.</p>
            <div class="example"><a id="9_LoanApplication"></a>
                <div class="example-title">Example 8-21. The process of applying for a loan using the template method pattern</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">abstract</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">LoanApplication</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">checkLoanApplication</span>() <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">ApplicationDenied</span> {
        checkIdentity();
        checkCreditHistory();
        checkIncomeHistory();
        reportFindings();
    }
    <span style="color:#00f;font-weight:700">protected</span> <span style="color:#00f;font-weight:700">abstract</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">checkIdentity</span>() <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
    <span style="color:#00f;font-weight:700">protected</span> <span style="color:#00f;font-weight:700">abstract</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">checkIncomeHistory</span>() <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
    <span style="color:#00f;font-weight:700">protected</span> <span style="color:#00f;font-weight:700">abstract</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">checkCreditHistory</span>() <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">reportFindings</span>() {
</pre>
                </div>
            </div>
            <p><code class="literal">CompanyLoanApplication</code> implements <code class="literal">checkIdentity</code> by looking upinformation in a company registration database, such as Companies House.<code class="literal">checkIncomeHistory</code>                would involve assessing existing profit and lossstatements and balance sheets for the firm. <code class="literal">checkCreditHistory</code> would lookinto existing bad and outstanding debts.</p>
            <p><code class="literal">PersonalLoanApplication</code> implements <code class="literal">checkIdentity</code> by analyzing thepaper statements that the client has been required to provide in order to checkthat the client’s address exists.
                <code class="literal">checkIncomeHistory</code> involves assessing pay slips andchecking whether the person is still employed. <code class="literal">checkCreditHistory</code> delegates to anexternal credit payment provider.</p>
            <p><code class="literal">EmployeeLoanApplication</code> is just <code class="literal">PersonalLoanApplication</code> with noemployment history checking. Conveniently, our bank already checks all itsemployees’ income histories when hiring them
                (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#EmployeeLoanApplication">Example 8-22</a>).</p>
            <div class="example"><a id="9_EmployeeLoanApplication"></a>
                <div class="example-title">Example 8-22. A special case of an an employee applying for a loan</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">EmployeeLoanApplication</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">PersonalLoanApplication</span> {
    <span style="color:#00f;font-weight:700">@Override</span>
    <span style="color:#00f;font-weight:700">protected</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">checkIncomeHistory</span>() {
        <span style="color:#06f;font-style:italic">// They work for us!   </span>
    }
}
</pre>
                </div>
            </div>
            <p><a class="indexterm" id="9_id416162"></a><a class="indexterm" id="9_id416169"></a>With lambda expressions and method references, we can think about the templatemethod pattern in a different light and also implement it differently. Whatthe template
                method pattern is really trying to do is compose asequence of method calls in a certain order. If we represent the functions asfunctional interfaces and then use lambda expressions or method references toimplement those interfaces, we
                can gain a huge amount of flexibility over usinginheritance to build up our algorithm. Let’s look at how we would implement our<code class="literal">LoanApplication</code> algorithm this way, in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#LoanApplication_lambdas">Example 8-23</a>!</p>
            <div class="example"><a id="9_LoanApplication_lambdas"></a>
                <div class="example-title">Example 8-23. The special case of an employee applying for a loan</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">LoanApplication</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Criteria</span> identity;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Criteria</span> creditHistory;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Criteria</span> incomeHistory;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">LoanApplication</span>(<span style="color:#00f;font-weight:700">Criteria</span> <span style="font-style:italic">identity</span>, <span style="color:#00f;font-weight:700">Criteria</span> <span style="font-style:italic">creditHistory</span>, <span style="color:#00f;font-weight:700">Criteria</span> <span style="font-style:italic">incomeHistory</span>) {
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>identity <span style="color:#00f;font-weight:700">=</span> identity;
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>creditHistory <span style="color:#00f;font-weight:700">=</span> creditHistory;
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>incomeHistory <span style="color:#00f;font-weight:700">=</span> incomeHistory;
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">checkLoanApplication</span>() <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">ApplicationDenied</span> {
        identity<span style="color:#00f;font-weight:700">.</span>check();
        creditHistory<span style="color:#00f;font-weight:700">.</span>check();
        incomeHistory<span style="color:#00f;font-weight:700">.</span>check();
        reportFindings();
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">reportFindings</span>() {
</pre>                </div>
        </div>
        <p>As you can see, instead of having a series of abstract methods we’ve got fieldscalled <code class="literal">identity</code>, <code class="literal">creditHistory</code>, and <code class="literal">incomeHistory</code>. Each of these fieldsimplements
            our <code class="literal">Criteria</code> functional interface. The <code class="literal">Criteria</code> interfacechecks a criterion and throws a domain exception if there’s an error in passingthe criterion. We could have chosen to return
            a domain class from the <code class="literal">check</code>method in order to denote failure or success, but continuing with an exceptionfollows the broader pattern set out in the original implementation (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#LoanApplication_Criteria">Example 8-24</a>).</p>
        <div class="example"><a id="9_LoanApplication_Criteria"></a>
            <div class="example-title">Example 8-24. A Criteria functional interface that throws an exception if our application fails</div>
            <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Criteria</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">check</span>() <span style="color:#00f;font-weight:700">throws</span> <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
}
</pre>            </div>
    </div>
    <p>The advantage of choosing this approach over the inheritance-based patternis that instead of tying the implementation of this algorithm into the<code class="literal">LoanApplication</code> hierarchy, we can be much more flexible about where to delegatethe
        functionality to. For example, we may decide that our <code class="literal">Company</code> class shouldbe responsible for all criteria checking. The <code class="literal">Company</code> class would then havea series of signatures like <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#checkSignatures">Example 8-25</a>.</p>
    <div class="example"><a id="9_checkSignatures"></a>
        <div class="example-title">Example 8-25. The criteria methods on a Company</div>
        <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> checkIdentity() throws <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> checkProfitAndLoss() throws <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
<span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> checkHistoricalDebt() throws <span style="color:#00f;font-weight:700">ApplicationDenied</span>;
</pre>        </div>
    </div>
    <p>Now all our <code class="literal">CompanyLoanApplication</code> class needs to do is pass in method referencesto those existing methods, as shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#CompanyLoanApplication_lambda">Example 8-26</a>.</p>
    <div class="example"><a id="9_CompanyLoanApplication_lambda"></a>
        <div class="example-title">Example 8-26. Our CompanyLoanApplication specifies which methods provide each criterion</div>
        <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">CompanyLoanApplication</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">LoanApplication</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">CompanyLoanApplication</span>(<span style="color:#00f;font-weight:700">Company</span> <span style="font-style:italic">company</span>) {
        <span style="color:#318495">super</span>(company<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>checkIdentity, company<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>checkHistoricalDebt, company<span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>checkProfitAndLoss);
    }
}
</pre>        </div>
        </div>
        <p>A motivating reason to delegate the behavior to our <code class="literal">Company</code> class is thatlooking up information about company identity differs between countries. Inthe UK, Companies House provides a canonical location for registering
            companyinformation, but in the US this differs from state to state.</p>
        <p>Using functional interfaces to implement the criteria doesn’t preclude us fromplacing implementation within the subclasses, either. We can explicitly use alambda expression to place implementation within these classes, or usea method reference
            to the current class.</p>
        <p>We also don’t need to enforce inheritance between <code class="literal">EmployeeLoanApplication</code> and<code class="literal">PersonalLoanApplication</code> to be able to reuse the functionality of<code class="literal">EmployeeLoanApplication</code>            in <code class="literal">PersonalLoanApplication</code>. We can pass inreferences to the same methods. Whether they do genuinely subclass each othershould really be determined by whether loans to employees are a specialcase of loans to people
            or a different type of loan. So, using this approach could allow us to model the underlying problem domainmore closely.<a class="indexterm" id="9_id417120"></a><a class="indexterm" id="9_id417149"></a><a class="indexterm" id="9_id417143"></a></p>
        </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_lambda_enabled_domain_specific_languages" style="clear: both">Lambda-Enabled Domain-Specific Languages</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="9_ix_ch08-asciidoc15"></a><a class="indexterm" id="9_ix_ch08-asciidoc16"></a><a class="indexterm" id="9_ix_ch08-asciidoc17"></a>A <span class="emphasis"><em>domain-specific language</em></span> (DSL) is a programming language
                focused ona particular part of a software system. They are usually small and frequentlyless expressive than a general-purpose language, such as Java, for mostprogramming tasks. DSLs are highly specialized: by trading off being good ateverything,
                they get to be good at something.</p>
            <p><a class="indexterm" id="9_id417210"></a><a class="indexterm" id="9_id417217"></a><a class="indexterm" id="9_id417223"></a>It’s usual to split up DSLs into two different categories:<span class="emphasis"><em>internal</em></span> and <span class="emphasis"><em>external</em></span>.
                An external DSL is one that iswritten separately from the source code of your program and then parsed andimplemented separately. For example,<a class="indexterm" id="9_id417234"></a><a class="indexterm" id="9_id417243"></a><a class="indexterm" id="9_id417255"></a> Cascading Style Sheets (CSS) and regular expressions are commonlyused external DSLs.</p>
            <p>Internal DSLs are embedded into the programming languagethat they are written in. If you’ve used<a class="indexterm" id="9_id417262"></a> mocking libraries, such as<a class="indexterm" id="9_id417274"></a><a class="indexterm" id="9_id417280"></a>                JMock orMockito, or a <a class="indexterm" id="9_id417289"></a>SQL builder API such as<a class="indexterm" id="9_id417297"></a><a class="indexterm" id="9_id417304"></a> JOOQ or Querydsl, then you’ll be familiarwith internal DSLs. In one sense,
                they’re just regularlibraries that have an API designed to be fluent. Despite their simplicity,internal DSLs are valued because they can be a powerfultool for making your code more succinct and easier to read. Ideally, codewritten in a
                DSL reads like statements made withinthe problem domain that it is reflecting.</p>
            <p>The introduction of lambda expressions makes it easier to implement DSLs that are fluent and adds another tool to the belt of those wanting to experiment in the DSL arena. We’ll investigate those issues by building a DSL for performing<a class="indexterm" id="9_id417365"></a> behavior-driven development (BDD) called <span class="emphasis"><em>LambdaBehave</em></span>.</p>
            <p><a class="indexterm" id="9_id417319"></a><a class="indexterm" id="9_id417331"></a>BDD is a variant of test-driven development (TDD) that shifts the emphasisonto talking about the behavior of the program rather than simply the teststhat it needs
                to pass. Our design is inspired by the JavaScript BDD framework<a class="indexterm" id="9_id417361"></a>Jasmine, which has been getting heavy use in frontend circles. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#jasmine-example">Example 8-27</a>                is a simpleJasmine suite that shows you how to create tests using Jasmine.</p>
            <div class="example"><a id="9_jasmine-example"></a>
                <div class="example-title">Example 8-27. Jasmine</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000">describe(<span style="color:#036a07">A suite is just a function</span>,
function() {
    it(<span style="color:#036a07">and so is a spec</span>,
    function() {
        var a <span style="color:#00f;font-weight:700">=</span> <span style="color:#585cf6;font-weight:700">true</span>;
        expect(a)<span style="color:#00f;font-weight:700">.</span>toBe(<span style="color:#585cf6;font-weight:700">true</span>);
    });
});
</pre>                </div>
            </div>
            <p>I appreciate that if you’re not familiar with JavaScript, this may seemconfusing. We will be going through the concepts at a gentler pace as webuild a Java 8 equivalent next. Just remember that the syntax for a lambdaexpression in JavaScript
                is <code class="literal">function() { … }</code>.</p>
            <p>Let’s take a look at each of the concepts in turn:</p>
            <div class="itemizedlist">
                <ul class="itemizedlist">
                    <li class="listitem">Each<a class="indexterm" id="9_id417544"></a><a class="indexterm" id="9_id417565"></a> <span class="emphasis"><em>spec</em></span> describes a single behavior that your program exhibits.</li>
                    <li class="listitem">An<a class="indexterm" id="9_id417582"></a><a class="indexterm" id="9_id417593"></a> <span class="emphasis"><em>expectation</em></span> is a way of describing the behavior of the application. You will find expectations in specs.</li>
                    <li class="listitem">Groups of specs are combined into a<a class="indexterm" id="9_id417611"></a><a class="indexterm" id="9_id417622"></a> <span class="emphasis"><em>suite</em></span>.</li>
                </ul>
            </div>
            <p>Each of these concepts has an equivalent in a traditional testing framework,such as<a class="indexterm" id="9_id417648"></a> JUnit. A spec is similar to a test method, an expectation is similarto an assertion, and a suite is similar to a test
                class.</p>
            <div class="sect2">
                <div class="titlepage">
                    <div>
                        <div>
                            <h3 class="title" id="_a_dsl_in_java">A DSL in Java</h3>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="9_id417658"></a>Let’s look at an example of what we’re aiming for with our Java-based BDDframework. <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#StackSpec">Example 8-28</a>                    is a specification of some of the behaviors of a<code class="literal">Stack</code>.</p>
                <div class="example"><a id="9_StackSpec"></a>
                    <div class="example-title">Example 8-28. Some stories to specify a Stack</div>
                    <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">StackSpec</span> {
    {
        describe(<span style="color:#036a07">a stack</span>, it <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
            it<span style="color:#00f;font-weight:700">.</span>should(<span style="color:#036a07">be empty when created</span>, expect <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
                expect<span style="color:#00f;font-weight:700">.</span>that(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Stack</span>())<span style="color:#00f;font-weight:700">.</span>isEmpty();
            });
            it<span style="color:#00f;font-weight:700">.</span>should(<span style="color:#036a07">push new elements onto the top of the stack</span>, expect <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
                <span style="color:#00f;font-weight:700">Stack</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> stack <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Stack</span> &lt; &gt;();
                stack<span style="color:#00f;font-weight:700">.</span>push(<span style="color:#0000cd">1</span>);
                expect<span style="color:#00f;font-weight:700">.</span>that(stack<span style="color:#00f;font-weight:700">.</span>get(<span style="color:#0000cd">0</span>))<span style="color:#00f;font-weight:700">.</span>isEqualTo(<span style="color:#0000cd">1</span>);
            });
            it<span style="color:#00f;font-weight:700">.</span>should(<span style="color:#036a07">pop the last element pushed onto the stack</span>, expect <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
                <span style="color:#00f;font-weight:700">Stack</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> stack <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Stack</span> &lt; &gt;();
                stack<span style="color:#00f;font-weight:700">.</span>push(<span style="color:#0000cd">2</span>);
                stack<span style="color:#00f;font-weight:700">.</span>push(<span style="color:#0000cd">1</span>);
                expect<span style="color:#00f;font-weight:700">.</span>that(stack<span style="color:#00f;font-weight:700">.</span>pop())<span style="color:#00f;font-weight:700">.</span>isEqualTo(<span style="color:#0000cd">2</span>);
            });
        });
    }
}
</pre>                    </div>
                </div>
                <p>We start off our suite of specifications using the<a class="indexterm" id="9_id418290"></a><a class="indexterm" id="9_id418291"></a> <code class="literal">describe</code> verb. Then wegive our suite a name that tells us what it’s describing
                    the behavior of;here, we’ve picked <code class="literal">a stack</code>.</p>
                <p>Each of specifications reads as closely to an English sentence as possible.They all start with the prefix <code class="literal">it.should</code>, with <code class="literal">it</code> referring to the object whose behaviorwe’re describing.
                    There is then a plain English sentence that tells us what the behavior is that we’re thinking about. We can then describeexpectations of the behavior of our object, which all start with the <code class="literal">expect.that</code>prefix.</p>
                <p>When we check our specifications, we get a simple command-line report that tellsus which pass or fail. You’ll notice that “pop the last element pushed ontothe stack” expected <code class="literal">pop</code> to be equal to <code class="literal">2</code>,
                    not <code class="literal">1</code>, so it has failed:</p>
                <pre class="screen">a stack    should pop the last element pushed onto the stack[expected:<a id="9_CO1-24"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/> but was:<a id="9_CO1-25"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>]    should be empty when created    should push new elements onto the top of the stack</pre>
            </div>
            <div class="sect2">
                <div class="titlepage">
                    <div>
                        <div>
                            <h3 class="title" id="_how_we_got_there">How We Got There</h3>
                        </div>
                    </div>
                </div>
                <p><a class="indexterm" id="9_ix_ch08-asciidoc18"></a>So now that you’ve seen the kind of fluency we can get in our DSLs using lambdaexpressions, let’s have a look at how I implemented the framework under thehood. Hopefully this will give you
                    an idea of how easy it is to implement thiskind of framework yourself.</p>
                <p>The first thing I saw when I started describing behavior was the <code class="literal">describe</code> verb. This is really just a statically imported method. It creates an instance of our <code class="literal">Description</code> class
                    for the suite and delegates handling the specification to it. The <code class="literal">Description</code> class corresponds to the <code class="literal">it</code> parameters in our specification language (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Lets_describe">Example 8-29</a>).</p>
                <div class="example"><a id="9_Lets_describe"></a>
                    <div class="example-title">Example 8-29. The describe method that starts the definition of a specification</div>
                    <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">void</span> describe(<span style="color:#00f;font-weight:700">String</span> name, <span style="color:#00f;font-weight:700">Suite</span> behavior) {
    <span style="color:#00f;font-weight:700">Description</span> description <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Description</span>(name);
    behavior<span style="color:#00f;font-weight:700">.</span>specifySuite(description);
}
</pre>                    </div>
            </div>
            <p>Each suite has its code description implemented by the user using a lambdaexpression. This means that we need a <code class="literal">Suite</code> functional interface, shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Suite">Example 8-30</a>,
                to represent a suite of specifications. You’ll notice italso takes a <code class="literal">Description</code> object as an argument, which we passed into it fromthe <code class="literal">describe</code> method.</p>
            <div class="example"><a id="9_Suite"></a>
                <div class="example-title">Example 8-30. Each suite of tests is a lambda expression implementing this interface</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Suite</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">specifySuite</span>(<span style="color:#00f;font-weight:700">Description</span> <span style="font-style:italic">description</span>);
}
</pre>                </div>
            </div>
            <p>Not only are suites represented by lambda expressions in our DSL, butso are individual specifications. They also need a<a class="indexterm" id="9_id418683"></a> functional interface,which I’ll call <code class="literal">Specification</code>                (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Specification">Example 8-31</a>). The variable called <code class="literal">expect</code> in our codesample is an instance of
                our <code class="literal">Expect</code> class, which I’ll describe later.</p>
            <div class="example"><a id="9_Specification"></a>
                <div class="example-title">Example 8-31. Each specification is a lambda expression implementing this interface</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">Specification</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">specifyBehaviour</span>(<span style="color:#00f;font-weight:700">Expect</span> <span style="font-style:italic">expect</span>);
}
</pre>                </div>
            </div>
            <p>The <code class="literal">Description</code> instance we’ve been passing around comes in handy at thispoint. We want our users to be able to fluently name their specifications withthe <code class="literal">it.should</code> clause. This means
                our <code class="literal">Description</code> class needs a <code class="literal">should</code>method (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Description_should">Example 8-32</a>).
                This is where the real work gets done, as this is the method thatactually executes the lambda expression by calling its<a class="indexterm" id="9_id418838"></a><a class="indexterm" id="9_id418814"></a> <code class="literal">specifySuite</code>                method.Specifications will tell us they have failed by throwing the standard Java<code class="literal">AssertionError</code>, and we consider any other <code class="literal">Throwable</code> to be an error.</p>
            <div class="example"><a id="9_Description_should"></a>
                <div class="example-title">Example 8-32. Our specification lambda expressions get passed into the should method</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> should(<span style="color:#00f;font-weight:700">String</span> description, <span style="color:#00f;font-weight:700">Specification</span> specification) {
    <span style="color:#00f;font-weight:700">try</span> {
        <span style="color:#00f;font-weight:700">Expect</span> expect <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Expect</span>();
        specification<span style="color:#00f;font-weight:700">.</span>specifyBehaviour(expect);
        <span style="color:#00f;font-weight:700">Runner</span><span style="color:#00f;font-weight:700">.</span>current<span style="color:#00f;font-weight:700">.</span>recordSuccess(suite, description);
    } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">AssertionError</span> cause) {
        <span style="color:#00f;font-weight:700">Runner</span><span style="color:#00f;font-weight:700">.</span>current<span style="color:#00f;font-weight:700">.</span>recordFailure(suite, description, cause);
    } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">Throwable</span> cause) {
        <span style="color:#00f;font-weight:700">Runner</span><span style="color:#00f;font-weight:700">.</span>current<span style="color:#00f;font-weight:700">.</span>recordError(suite, description, cause);
    }
}
</pre>                </div>
            </div>
            <p>When our specifications want to describe an actual expectation, they use the<code class="literal">expect.that</code> clause. This means that our<a class="indexterm" id="9_id418876"></a><a class="indexterm" id="9_id419279"></a> <code class="literal">Expect</code>                class needs to have amethod called <code class="literal">that</code> for users to call, shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#Expect_Expect">Example 8-33</a>.
                This wrapsup the object that gets passed in and can then expose fluent methods such as<code class="literal">isEqualTo</code> that throw the appropriate assertions if there’s a specificationfailure.</p>
            <div class="example"><a id="9_Expect_Expect"></a>
                <div class="example-title">Example 8-33. The start of the fluent expect chain</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">Expect</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">BoundExpectation</span> <span style="color:#0000a2;font-weight:700">that</span>(<span style="color:#00f;font-weight:700">Object</span> <span style="font-style:italic">value</span>) {
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">BoundExpectation</span>(value);
    } <span style="color:#06f;font-style:italic">// Rest of class omitted</span>
    
</pre>                </div>
            </div>
            <p>You may have noticed one more detail that I’ve so far ignored and that has nothing to do with lambda expressions. Our <code class="literal">StackSpec</code> class didn’t have any methods directly implemented on it, and I wrote the code inside.
                I’ve been a bit sneaky here and used double braces at the beginning and end of the class definition:</p>
            <pre class="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StackSpec</code> <code class="o">{{</code>    <code class="o">...</code><code class="o">}}</code></pre>
            <p>These start an anonymous constructor that lets us execute an arbitrary block of Java code, so it’s really just like writing out the constructor in full, but with a bit less boilerplate.I could have written the following instead:</p>
            <pre class="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StackSpec</code> <code class="o">{</code>    <code class="kd">public</code> <code class="nf">StackSpec</code><code class="o">()</code> <code class="o">{</code>        <code class="o">...</code>    <code class="o">}</code><code class="o">}</code></pre>
            <p>There’s a lot more work involved in implementing a complete BDD framework, butthe purpose of this section is just to show you how to use lambda expressionsto create more fluent domain-specific languages. I’ve covered the parts of theDSL that
                interact with lambda expressions in order to give you a flavor of howto implement this kind of DSL.<a class="indexterm" id="9_id419483"></a></p>
        </div>
        <div class="sect2">
            <div class="titlepage">
                <div>
                    <div>
                        <h3 class="title" id="_evaluation">Evaluation</h3>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="9_id419561"></a><a class="indexterm" id="9_id419571"></a>One aspect of fluency is the idea that your DSL is IDE-friendly. In otherwords, you can remember a minimal amount of knowledge and then usecode completion to fill
                in the gaps in memory. This is why we use and pass itthe <code class="literal">Description</code> and <code class="literal">Expect</code> objects. The other alternative would have beento have static imports for methods called <code class="literal">it</code>                or <code class="literal">expect</code>, which is an approachused in some DSLs. If you pass the object into your lambda expression ratherthan requiring a static import, it makes it easier for a competent IDE userto code complete his way
                to working code.</p>
            <p>The only thing a user needs to remember is the call to <code class="literal">describe</code>. Thebenefits of such an approach might not be obvious purely from reading this text,but I encourage you to test out the framework in a small sample
                project and seefor yourself.</p>
            <p>The other thing to notice is that most testing frameworks provide a bunch ofannotations and use external <span class="emphasis"><em>magic</em></span> or reflection. We didn’t need to resort tosuch tricks. We can directly represent behavior
                in our DSLs using lambdaexpressions and treat these as regular Java methods.<a class="indexterm" id="9_id419587"></a><a class="indexterm" id="9_id419634"></a><a class="indexterm" id="9_id419647"></a></p>
        </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_lambda_enabled_solid_principles" style="clear: both">Lambda-Enabled SOLID Principles</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="9_ix_ch08-asciidoc19"></a><a class="indexterm" id="9_ix_ch08-asciidoc20"></a>The SOLID principles are a set of basic principles for designing OO programs. The name itself is a acronym, with each of the five principles
                named after one of the letters: Single responsibility, Open/closed, Liskov substitution, Interface segregation, and Dependency inversion. The principles act as a set of guidelines to help you implement code that is easy to maintain and
                extend over time.</p>
            <p>Each of the principles corresponds to a set of potential code smells that canexist in your code, and they offer a route out of the problems that they cause. Manybooks have been written on this topic, and I’m not going to cover theprinciples
                in comprehensive detail. I will, however, look at how three of theprinciples can be applied in the context of lambda expressions. In theJava 8 context, some of the principles can be extended beyond their originallimitations.</p>
            <div class="sect2">
                <div class="titlepage">
                    <div>
                        <div>
                            <h3 class="title" id="_the_single_responsibility_principle">The Single Responsibility Principle</h3>
                        </div>
                    </div>
                </div>
                <p><span class="emphasis"><em>Every class or method in your program should have only a single reason to change.</em></span></p>
                <p><a class="indexterm" id="9_ix_ch08-asciidoc21"></a><a class="indexterm" id="9_ix_ch08-asciidoc22"></a>An inevitable fact of software development is that requirements change overtime. Whether because a new feature needs to be added, your understanding
                    ofyour problem domain or customer has changed, or you need things tobe faster, over time software must evolve.</p>
                <p>When the requirements of your software change, the responsibilities of theclasses and methods that implement these requirements also change. If you havea class that has more than one responsibility, when a responsibilitychanges the resulting
                    code changes can affect the other responsibilities that the classpossesses. This possibly introduces bugs and also impedes the ability of thecode base to evolve.</p>
                <p>Let’s consider a simple example program that generates a <code class="literal">BalanceSheet</code>. The program needs to tabulate the <code class="literal">BalanceSheet</code> from a list of assets and render the <code class="literal">BalanceSheet</code>                    to a PDF report. If the implementer chose to put both the responsibilities of tabulation and rendering into one class, then that class would have two reasons for change. You might wish to change the rendering in order to generate an
                    alternative output, such as HTML. You might also wish to change the level of detail in the <code class="literal">BalanceSheet</code> itself. This is a good motivation to decompose this problem at the high level into two classes: one
                    to tabulate the <code class="literal">BalanceSheet</code> and one to render it.</p>
                <p>The single responsibility principle is stronger than that, though. A classshould not just have a single responsibility: it should also encapsulate it.In other words, if I want to change the output format, then I should have tolook at only
                    the rendering class and not at the tabulation class.</p>
                <p>This is part of the idea of a design exhibiting strong<a class="indexterm" id="9_id419838"></a><a class="indexterm" id="9_id419713"></a> <span class="emphasis"><em>cohesion</em></span>. A class iscohesive if its methods and fields should be
                    treated together becausethey are closely related. If you tried to divide up a cohesive class, youwould result in accidentally coupling the classes that you have just created.</p>
                <p>Now that you’re familiar with the single responsibility principle, the question arises,what does this have to do with lambda expressions? Well Lambda expressionsmake it a lot easier to implement the single responsibility principle at themethod
                    level. Let’s take a look at some code that counts the number of primenumbers up to a certain value (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#srp_imperative_single_method">Example 8-34</a>).</p>
                <div class="example"><a id="9_srp_imperative_single_method"></a>
                    <div class="example-title">Example 8-34. Counting prime numbers with multiple responsibilities in a method</div>
                    <div class="example-contents">
                        <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countPrimes(<span style="color:#00f;font-weight:700">int</span> upTo) {
    <span style="color:#00f;font-weight:700">long</span> tally <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> i <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">1</span>; i <span style="color:#00f;font-weight:700">&lt;</span> upTo; i<span style="color:#00f;font-weight:700">++</span>) {
        <span style="color:#00f;font-weight:700">boolean</span> isPrime <span style="color:#00f;font-weight:700">=</span> <span style="color:#585cf6;font-weight:700">true</span>;
        <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> j <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">2</span>; j <span style="color:#00f;font-weight:700">&lt;</span> i; j<span style="color:#00f;font-weight:700">++</span>) {
            <span style="color:#00f;font-weight:700">if</span> (i <span style="color:#00f;font-weight:700">%</span> j <span style="color:#00f;font-weight:700">==</span> <span style="color:#0000cd">0</span>) {
                isPrime <span style="color:#00f;font-weight:700">=</span> <span style="color:#585cf6;font-weight:700">false</span>;
            }
        }
        <span style="color:#00f;font-weight:700">if</span> (isPrime) {
            tally<span style="color:#00f;font-weight:700">++</span>;
        }
    }
    <span style="color:#00f;font-weight:700">return</span> tally;
}
</pre>
                    </div>
            </div>
            <p>It’s pretty obvious that we’re really doing two things in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#srp_imperative_single_method">Example 8-34</a>:we’re counting numbers with
                a certainproperty and we’re checking whether a number is a prime. As shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#srp_imperative_refactored">Example 8-35</a>, we can
                easily refactor this to split apart these two responsibilities.</p>
            <div class="example"><a id="9_srp_imperative_refactored"></a>
                <div class="example-title">Example 8-35. Counting prime numbers after refactoring out the isPrime check</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countPrimes(<span style="color:#00f;font-weight:700">int</span> upTo) {
    <span style="color:#00f;font-weight:700">long</span> tally <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">0</span>;
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> i <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">1</span>; i <span style="color:#00f;font-weight:700">&lt;</span> upTo; i<span style="color:#00f;font-weight:700">++</span>) {
        <span style="color:#00f;font-weight:700">if</span> (isPrime(i)) {
            tally<span style="color:#00f;font-weight:700">++</span>;
        }
    }
    <span style="color:#00f;font-weight:700">return</span> tally;
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">boolean</span> isPrime(<span style="color:#00f;font-weight:700">int</span> number) {
    <span style="color:#00f;font-weight:700">for</span> (<span style="color:#00f;font-weight:700">int</span> i <span style="color:#00f;font-weight:700">=</span> <span style="color:#0000cd">2</span>; i <span style="color:#00f;font-weight:700">&lt;</span> number; i<span style="color:#00f;font-weight:700">++</span>) {
        <span style="color:#00f;font-weight:700">if</span> (number <span style="color:#00f;font-weight:700">%</span> i <span style="color:#00f;font-weight:700">==</span> <span style="color:#0000cd">0</span>) {
            <span style="color:#00f;font-weight:700">return</span> <span style="color:#585cf6;font-weight:700">false</span>;
        }
    }
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#585cf6;font-weight:700">true</span>;
}
</pre>
                </div>
            </div>
            <p>Unfortunately, we’re still left in a situation where our code has two responsibilities.For the most part, our code here is dealing with looping over numbers. If we followthe single responsibility principle, then iteration should be encapsulated
                elsewhere.There’s also a good practical reason to improve this code. If we want to count thenumber of primes for a very large <code class="literal">upTo</code> value, then we want to be able to performthis operation in parallel. That’s
                right—the threading model is a responsibilityof the code!</p>
            <p>We can refactor our code to use the Java 8 streams library (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#SingleResponsibilityPrinciple_functional">Example 8-36</a>), which
                delegates the responsibility for controlling the loop to the library itself. Here we use the <code class="literal">range</code> method to count the numbers between <code class="literal">0</code> and <code class="literal">upTo</code>,
                <code class="literal">filter</code> them to check that they really are prime, and then <code class="literal">count</code> the result.</p>
            <div class="example"><a id="9_SingleResponsibilityPrinciple_functional"></a>
                <div class="example-title">Example 8-36. Refactoring the prime checking to use streams</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countPrimes(<span style="color:#00f;font-weight:700">int</span> upTo) {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">IntStream</span><span style="color:#00f;font-weight:700">.</span>range(<span style="color:#0000cd">1</span>, upTo)<span style="color:#00f;font-weight:700">.</span>filter(<span style="color:#318495">this</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>isPrime)<span style="color:#00f;font-weight:700">.</span>count();
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">boolean</span> isPrime(<span style="color:#00f;font-weight:700">int</span> number) {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">IntStream</span><span style="color:#00f;font-weight:700">.</span>range(<span style="color:#0000cd">2</span>, number)<span style="color:#00f;font-weight:700">.</span>allMatch(x <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>(number <span style="color:#00f;font-weight:700">%</span> x) <span style="color:#00f;font-weight:700">!=</span> <span style="color:#0000cd">0</span>);
}
</pre>
                </div>
            </div>
            <p>If we want to speed up the time it takes to perform this operation at the expense of usingmore CPU resources, we can use the <code class="literal">parallelStream</code> method without changing any of theother code (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#SingleResponsibilityPrinciple_parallel_functional">Example 8-37</a>).</p>
            <div class="example"><a id="9_SingleResponsibilityPrinciple_parallel_functional"></a>
                <div class="example-title">Example 8-37. The streams-based prime checking running in parallel</div>
                <div class="example-contents">
                 <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">long</span> countPrimes(<span style="color:#00f;font-weight:700">int</span> upTo) {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">IntStream</span><span style="color:#00f;font-weight:700">.</span>range(<span style="color:#0000cd">1</span>, upTo)<span style="color:#00f;font-weight:700">.</span>parallel()<span style="color:#00f;font-weight:700">.</span>filter(<span style="color:#318495">this</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>isPrime)<span style="color:#00f;font-weight:700">.</span>count();
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">boolean</span> isPrime(<span style="color:#00f;font-weight:700">int</span> number) {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">IntStream</span><span style="color:#00f;font-weight:700">.</span>range(<span style="color:#0000cd">2</span>, number)<span style="color:#00f;font-weight:700">.</span>allMatch(x <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>(number <span style="color:#00f;font-weight:700">%</span> x) <span style="color:#00f;font-weight:700">!=</span> <span style="color:#0000cd">0</span>);
}
</pre>
                </div>
        </div>
        <p>So, we can use higher-order functions in order to help us easily implementthe single responsibility principle.<a class="indexterm" id="9_id421157"></a><a class="indexterm" id="9_id421478"></a></p>
        </div>
        <div class="sect2">
            <div class="titlepage">
                <div>
                    <div>
                        <h3 class="title" id="_the_open_closed_principle">The Open/Closed Principle</h3>
                    </div>
                </div>
            </div>
            <div class="blockquote">
                <blockquote class="blockquote">
                    <p>Software entities should be open for extension, but closed for modification.</p>
                    <div class="attribution">
                        <p>—<span class="attribution">Bertrand Meyer</span></p>
                    </div>
                </blockquote>
            </div>
            <p><a class="indexterm" id="9_ix_ch08-asciidoc23"></a><a class="indexterm" id="9_ix_ch08-asciidoc24"></a>The overarching goal of the open/closed principle is similar to that of the singleresponsibility principle: to make your software less brittle
                to change. Again, theproblem is that a single feature request or change to your software can ripplethrough the code base in a way that is likely to introduce new bugs. The open/closedprinciple is an effort to avoid that problem by ensuring
                that existing classes can beextended without their internal implementation being modified.</p>
            <p>When you first hear about the open/closed principle, it sounds like a bit of a pipe dream. How canyou extend the functionality of a class without having to change its implementation?The actual answer is that you rely on an abstraction and
                can plug in new functionality that fits into this abstraction. Let’s think through a concrete example.</p>
            <p>We’re writing a software program that measures information about system performanceand graphs the results of these measurements. For example, we might have a graphthat plots how much time the computer spends in user space, kernel space, and
                performingI/O. I’ll call the class that has the responsibility for displaying these metrics<code class="literal">MetricDataGraph</code>.</p>
            <p>One way of designing the <code class="literal">MetricDataGraph</code> class would be to have each of the new metricpoints pushed into it from the agent that gathers the data. So, its public API wouldlook something like <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#metricdatagraph-example">Example 8-38</a>.</p>
            <div class="example"><a id="9_metricdatagraph-example"></a>
                <div class="example-title">Example 8-38. The MetricDataGraph public API</div>
                <div class="example-contents">
                    <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">MetricDataGraph</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">updateUserTime</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">value</span>);
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">updateSystemTime</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">value</span>);
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">updateIoTime</span>(<span style="color:#00f;font-weight:700">int</span> <span style="font-style:italic">value</span>);
}
</pre>
                </div>
        </div>
        <p>But this would mean that every time we wanted to add in a new set of time points to the plot, we wouldhave to modify the <code class="literal">MetricDataGraph</code> class. We can resolve this issue by introducing anabstraction, which I’ll call
            a <code class="literal">TimeSeries</code>, that represents a series of points in time.Now our <code class="literal">MetricDataGraph</code> API can be simplified to not depend upon the different typesof metric that it needs to display, as shown
            in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#timeseries-example">Example 8-39</a>.</p>
        <div class="example"><a id="9_timeseries-example"></a>
            <div class="example-title">Example 8-39. Simplified MetricDataGraph API</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">MetricDataGraph</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">addTimeSeries</span>(<span style="color:#00f;font-weight:700">TimeSeries</span> <span style="font-style:italic">values</span>);
}
</pre>
            </div>
        </div>
        <p>Each set of metric data can then implement the <code class="literal">TimeSeries</code> interface and beplugged in. For example, we might have concrete classes called<code class="literal">UserTimeSeries</code>, <code class="literal">SystemTimeSeries</code>,
            and <code class="literal">IoTimeSeries</code>. If we wanted to add, say,the amount of CPU time that gets stolen from a machine if it’s virtualized, thenwe would add a new implementation of <code class="literal">TimeSeries</code> called
            <code class="literal">StealTimeSeries</code>.<code class="literal">MetricDataGraph</code> has been extended but hasn’t been modified.</p>
        <p>Higher-order functions also exhibit the same property of being open forextension, despite being closed for modification. A good example of this isthe<a class="indexterm" id="9_id421864"></a> <code class="literal">ThreadLocal</code> class that we
            encountered earlier. The <code class="literal">ThreadLocal</code> classprovides a variable that is special in the sense that each thread has a single copyfor it to interact with. Its static <code class="literal">withInitial</code> method is
            a higher-orderfunction that takes a lambda expression that represents a factory forproducing an initial value.</p>
        <p>This implements the open/closed principle because we can get new behavior outof <code class="literal">ThreadLocal</code> without modifying it. We pass in a different factorymethod to <code class="literal">withInitial</code> and get an instance
            of <code class="literal">ThreadLocal</code> withdifferent behavior. For example, we can use <code class="literal">ThreadLocal</code> to produce a<code class="literal">DateFormatter</code> that is thread-safe with the code in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#ocp_local_formatter">Example 8-40</a>.</p>
        <div class="example"><a id="9_ocp_local_formatter"></a>
            <div class="example-title">Example 8-40. A ThreadLocal date formatter</div>
            <div class="example-contents">
                <pre style="background:#fff;color:#000"><span style="color:#06f;font-style:italic">// One implementation</span>
<span style="color:#00f;font-weight:700">ThreadLocal</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">DateFormat</span> <span style="color:#00f;font-weight:700">&gt;</span> localFormatter <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">ThreadLocal</span><span style="color:#00f;font-weight:700">.</span>withInitial(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">SimpleDateFormat</span>());
<span style="color:#06f;font-style:italic">// UsageDateFormat </span>
formatter <span style="color:#00f;font-weight:700">=</span> localFormatter<span style="color:#00f;font-weight:700">.</span>get();
</pre>
            </div>
        </div>
        <p>We can also generate completely different behavior by passing in a differentlambda expression. For example, in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#ocp_local_thread_id">Example 8-41</a>            we’re creating a unique identifier foreach Java thread that is sequential.</p>
        <div class="example"><a id="9_ocp_local_thread_id"></a>
            <div class="example-title">Example 8-41. A ThreadLocal identifier</div>
            <div class="example-contents">
                <pre style="background:#fff;color:#000"><span style="color:#06f;font-style:italic">// Or...</span>
<span style="color:#00f;font-weight:700">AtomicInteger</span> threadId <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">AtomicInteger</span>();
<span style="color:#00f;font-weight:700">ThreadLocal</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Integer</span> <span style="color:#00f;font-weight:700">&gt;</span> localId <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">ThreadLocal</span><span style="color:#00f;font-weight:700">.</span>withInitial(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>threadId<span style="color:#00f;font-weight:700">.</span>getAndIncrement());
<span style="color:#06f;font-style:italic">// Usageint </span>
idForThisThread <span style="color:#00f;font-weight:700">=</span> localId<span style="color:#00f;font-weight:700">.</span>get();
</pre>
            </div>
        </div>
        <p><a class="indexterm" id="9_id422078"></a><a class="indexterm" id="9_id422242"></a>Another interpretation of the open/closed principle that doesn’t followin the traditional vein is the idea that immutable objects implement theopen/closed principle.
            An immutable object is one that can’t be modifiedafter it is created.</p>
        <p>The term “immutability” can have two potential interpretations<a class="indexterm" id="9_id422265"></a><a class="indexterm" id="9_id422259"></a>:<span class="emphasis"><em>observable immutability</em></span> or <span class="emphasis"><em>implementation immutability</em></span>.
            Observableimmutability means that from the perspective of any other object, a class isimmutable; implementation immutability means that the object never mutates.Implementation immutability implies observable immutability, but the inverseisn’t
            necessarily true.</p>
        <p>A good example of a class that proclaims its immutability but actually is onlyobservably immutable is<a class="indexterm" id="9_id422299"></a> <code class="literal">java.lang.String</code>, as it caches the hash code thatit computes the first time
            its <code class="literal">hashCode</code> method is called. This is entirelysafe from the perspective of other classes because there’s no way for them toobserve the difference between it being computed in the constructor every timeor cached.</p>
        <p>I mention immutable objects in the context of a book on lambda expressionsbecause they are a fairly familiar concept within functional programming, whichis the same area that lambda expressions have come from. They naturally fitinto the style
            of programming that I’m talking about in this book.</p>
        <p>Immutable objects implement the open/closed principle in the sense that becausetheir internal state can’t be modified, it’s safe to add new methods to them.The new methods can’t alter the internal state of the object, so they areclosed for modification,
            but they are adding behavior, so they are open toextension. Of course, you still need to be careful in order to avoid modifyingstate elsewhere in your program.</p>
        <p>Immutable objects are also of particular interest because they are inherentlythread-safe. There is no internal state to mutate, so they can be sharedbetween different threads.</p>
        <p>If we reflect on these different approaches, it’s pretty clear thatwe’ve diverged quite a bit from the traditional open/closed principle. In fact,when Bertrand Meyer first introduced the principle,<a class="indexterm" id="9_id422327"></a> he defined
            it sothat the class itself couldn’t ever be altered after being completed. Within amodern<a class="indexterm" id="9_id422346"></a> Agile developer environment it’s pretty clear that the idea of a classbeing complete is fairly outmoded. Business
            requirements and usage of theapplication may dictate that a class be used for something that it wasn’tintended to be used for. That’s not a reason to ignore the open/closedprinciple though, just a good example of how these principles should
            be takenas guidelines and heuristics rather than followed religiously or to theextreme.</p>
        <p><a class="indexterm" id="9_id422342"></a>A final point that I think is worth reflecting on is that in the context ofJava 8, interpreting the open/closed principle as advocating an abstractionthat we can plug multiple classes into or advocating higher-order
            functions amounts to the same thing. Because our abstraction needs to be represented by eitheran interface or an abstract class upon which methods are called, this approachto the open/closed principle is really just a usage of polymorphism.</p>
        <p>In Java 8, any lambda expression that gets passed into a higher-order functionis represented by a functional interface. The higher-order function calls itssingle method, which leads to different behavior depending upon which lambdaexpression gets
            passed in. Again, under the hood we’re using polymorphism inorder to implement the open/closed principle.<a class="indexterm" id="9_id422392"></a><a class="indexterm" id="9_id422387"></a></p>
        </div>
        <div class="sect2">
            <div class="titlepage">
                <div>
                    <div>
                        <h3 class="title" id="_the_dependency_inversion_principle">The Dependency Inversion Principle</h3>
                    </div>
                </div>
            </div>
            <p><span class="emphasis"><em>Abstractions should not depend on details; details should depend on abstractions.</em></span></p>
            <p><a class="indexterm" id="9_ix_ch08-asciidoc25"></a><a class="indexterm" id="9_ix_ch08-asciidoc26"></a>One of the ways in which we can make rigid and fragile programs that are resistant to change is by coupling high-level business logic and low-level
                code that is designed to glue modules together. This is because these are two different concerns that may change over time.</p>
            <p>The goal of the dependency inversion principle is to allow programmers to writehigh-level business logic that is independent of low-level glue code. Thisallows us to reuse the high-level code in a way that is abstract of the detailsupon which
                it depends. This modularity and reuse goes both ways: we cansubstitute in different details in order to reuse the high-level code, and wecan reuse the implementation details by layering alternative businesslogic on top.</p>
            <p>Let’s look at a concrete example of how the dependency inversion principle istraditionally used by thinking through the high-level decomposition involved inimplementing an application that builds up an address book automatically. Ourapplication
                takes in a sequence of electronic business cards as input andaccumulates our address book in some storage mechanism.</p>
            <p>It’s fairly obvious that we can separate this code into three basicmodules:</p>
            <div class="itemizedlist">
                <ul class="itemizedlist">
                    <li class="listitem">The business card reader that understands an electronic business card format</li>
                    <li class="listitem">The address book storage that stores data into a text file</li>
                    <li class="listitem">The accumulation module that takes useful information from the business cards and puts it into the address book</li>
                </ul>
            </div>
            <p>We can visualize the relationship between these modules as shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#jvld_0803">Figure 8-3</a>.</p>
            <div class="figure"><a id="9_jvld_0803"></a>
                <div class="figure-contents">
                    <div class="mediaobject"><img alt=".Dependencies" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0803.png" height="382" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0803.png" width="582"/></div>
                </div>
                <div class="figure-title">Figure 8-3. Dependencies</div>
            </div>
            <p>In this system, while reuse of the accumulation model is more complex, the business card reader and the addressbook storage do not depend on any other components. We can therefore easily reuse them inanother system. We can also change them;
                for example, we mightwant to use a different reader, such as reading from people’s Twitterprofiles, or we might want to store our address book in something other thana text file, such as a database.</p>
            <p>In order to give ourselves the flexibility to change these components within oursystem, we need to ensure that the implementation of our accumulation moduledoesn’t depend upon the specific details of either the business card readeror the address
                book storage. So, we introduce an abstraction for readinginformation and an abstraction for writing information. The implementation ofour accumulation module depends upon these abstractions. We can pass in thespecific details of these
                implementations at runtime. This is the dependencyinversion principle at work.</p>
            <p>In the context of lambda expressions, many of the higher-order functions thatwe’ve encountered enable a dependency inversion. A function such as <code class="literal">map</code>allows us to reuse code for the general concept of transforming
                a stream ofvalues between different specific transformations. The <code class="literal">map</code> function doesn’tdepend upon the details of any of these specific transformations, but upon anabstraction. In this case, the abstraction
                is the functional interface<code class="literal">Function</code>.</p>
            <p>A more complex example of dependency inversion is resource management. Obviously, there are lots of resources that can be managed, such as database connections, thread pools, files, and network connections. I’ll use files as an example because
                they are a relatively simple resource, but the principle can easily be applied to more complex resources within your application.</p>
            <p>Let’s look at some code that extracts headings from a hypothetical markup languagewhere each heading is designated by being suffixed with a colon (<code class="literal">:</code>). Our method isgoing to extract the headings from a file by reading
                the file, looking ateach of the lines in turn, filtering out the headings, and then closing thefile. We shall also wrap any <code class="literal">Exception</code> related to the file I/O into afriendly domain exception called a <code class="literal">HeadingLookupException</code>.
                The code lookslike <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#dip_nodip_headings">Example 8-42</a>.</p>
            <div class="example"><a id="9_dip_nodip_headings"></a>
                <div class="example-title">Example 8-42. Parsing the headings out of a file</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> findHeadings(<span style="color:#00f;font-weight:700">Reader</span> input) {
    <span style="color:#00f;font-weight:700">try</span> (<span style="color:#00f;font-weight:700">BufferedReader</span> reader <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">BufferedReader</span>(input)) {
        <span style="color:#00f;font-weight:700">return</span> reader<span style="color:#00f;font-weight:700">.</span>lines()<span style="color:#00f;font-weight:700">.</span>filter(line <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>line<span style="color:#00f;font-weight:700">.</span>endsWith(<span style="color:#036a07">:</span>))<span style="color:#00f;font-weight:700">.</span>map(line <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>line<span style="color:#00f;font-weight:700">.</span>substring(<span style="color:#0000cd">0</span>, line<span style="color:#00f;font-weight:700">.</span>length() <span style="color:#00f;font-weight:700">-</span> <span style="color:#0000cd">1</span>))<span style="color:#00f;font-weight:700">.</span>collect(toList());
    } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">IOException</span> e) {
        <span style="color:#00f;font-weight:700">throw</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">HeadingLookupException</span>(e);
    }
}
</pre>
                </div>
            </div>
            <p>Unfortunately, our heading-finding code is coupled with the resource-management and file-handling code. What we really want to do is write some code that finds the headings and delegates the details of a file to another method. We can use
                a <code class="literal">Stream&lt;String&gt;</code> as the abstraction we want to depend upon rather than a file. A <code class="literal">Stream</code> is much safer and less open to abuse. We also want to be able to a pass in a function
                that creates our domain exception if there’s a problem with the file. This approach, shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#dip_refactored_headings">Example 8-43</a>,
                allows us to segregate the domain-level error handling from the resource management–level error handling.</p>
            <div class="example"><a id="9_dip_refactored_headings"></a>
                <div class="example-title">Example 8-43. The domain logic with file handling split out</div>
                <div class="example-contents">
                   <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> findHeadings(<span style="color:#00f;font-weight:700">Reader</span> input) {
    <span style="color:#00f;font-weight:700">return</span> withLinesOf(input, lines <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>lines<span style="color:#00f;font-weight:700">.</span>filter(line <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>line<span style="color:#00f;font-weight:700">.</span>endsWith(<span style="color:#036a07">:</span>))<span style="color:#00f;font-weight:700">.</span>map(line <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>line<span style="color:#00f;font-weight:700">.</span>substring(<span style="color:#0000cd">0</span>, line<span style="color:#00f;font-weight:700">.</span>length() <span style="color:#00f;font-weight:700">-</span> <span style="color:#0000cd">1</span>))<span style="color:#00f;font-weight:700">.</span>collect(toList()), <span style="color:#00f;font-weight:700">HeadingLookupException</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">new</span>);
}
</pre>
                </div>
            </div>
            <p>I expect that you’re now wondering what that <code class="literal">withLinesOf</code> method looks like! It’s shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch08.html#dip_with_lines_Of">Example 8-44</a>.</p>
            <div class="example"><a id="9_dip_with_lines_Of"></a>
                <div class="example-title">Example 8-44. The definition of withLinesOf</div>
                <div class="example-contents">
                 <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">T</span> <span style="color:#00f;font-weight:700">&gt;</span> <span style="color:#00f;font-weight:700">T</span> withLinesOf(<span style="color:#00f;font-weight:700">Reader</span> input, <span style="color:#00f;font-weight:700">Function</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Stream</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> , <span style="color:#00f;font-weight:700">T</span> <span style="color:#00f;font-weight:700">&gt;</span> handler, <span style="color:#00f;font-weight:700">Function</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">IOException</span>, <span style="color:#00f;font-weight:700">RuntimeException</span> <span style="color:#00f;font-weight:700">&gt;</span> error) {
    <span style="color:#00f;font-weight:700">try</span> (<span style="color:#00f;font-weight:700">BufferedReader</span> reader <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">BufferedReader</span>(input)) {
        <span style="color:#00f;font-weight:700">return</span> handler<span style="color:#00f;font-weight:700">.</span>apply(reader<span style="color:#00f;font-weight:700">.</span>lines());
    } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">IOException</span> e) {
        <span style="color:#00f;font-weight:700">throw</span> error<span style="color:#00f;font-weight:700">.</span>apply(e);
    }
}
</pre>
                </div>
        </div>
        <p><code class="literal">withLinesOf</code> takes in a reader that handles the underlying file I/O. Thisis wrapped up in <code class="literal">BufferedReader</code>, which lets us read the file line by line.The <code class="literal">handler</code>            function represents the body of whatever code we want to usewith this function. It takes the <code class="literal">Stream</code> of the file’s lines as its argument.We also take another handler called <code class="literal">error</code> that
            gets called when there’san exception in the I/O code. This constructs whatever domain exception wewant. This exception then gets thrown in the event of a problem.</p>
        <p>To summarize, higher-order functions provide an inversion of control, whichis a form of dependency inversion. We can easily use them with lambdaexpressions. The other thing to note with the dependency inversion principleis that the abstraction
            that we depend upon doesn’t have to be an <code class="literal">interface</code>.Here we’ve relied upon the existing <code class="literal">Stream</code> as an abstraction over rawreader and file handling. This approach also fits into the way
            that resourcemanagement is performed in functional languages—usually a higher-order functionmanages the resource and takes a callback function that is applied toan open resource, which is closed afterward. In fact, if lambda expressions hadbeen
            available at the time, it’s arguable that the <code class="literal">try-with-resources</code> featureof Java 7 could have been implemented with a single library function.<a class="indexterm" id="9_id423816"></a><a class="indexterm" id="9_id423779"></a>
            <a class="indexterm" id="9_id423820"></a><a class="indexterm" id="9_id423753"></a></p>
        </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_further_reading" style="clear: both">Further Reading</h2>
                    </div>
                </div>
            </div>
            <p>A lot of the discussion in this chapter has delved into broader designissues, looking at the whole of your program rather than just local issuesrelated to a single method. This is an area that we’ve just touched the surfaceof due to the lambda
                expressions focus of this book. There are a number ofother books covering related topic areas that are worth investigating if you’reinterested in more detail.</p>
            <p>The SOLID principles have long been emphasized by<a class="indexterm" id="9_id423791"></a> “Uncle” Bob Martin, who has both written and presented extensively on the topic. If you want to osmose some of his knowledge for free, a series of articles
                on each of the principles is available on the<a class="indexterm" id="9_id423393"></a> <a class="ulink" href="http://www.objectmentor.com/resources/publishedArticles.html" target="_top">Object Mentor</a> website, under the topic “Design
                Patterns.”</p>
            <p>If you are interested in a more comprehensive understanding of domain-specific languages, both internal and external,<a class="indexterm" id="9_id423807"></a><a class="indexterm" id="9_id423852"></a><a class="indexterm" id="9_id423849"></a>
                <span class="emphasis"><em>Domain-Specific Languages</em></span> by Martin Fowler with Rebecca Parsons (Addison-Wesley) is recommended reading.<a class="indexterm" id="9_id423877"></a><a class="indexterm" id="9_id423874"></a><a class="indexterm" id="9_id423882"></a></p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_key_points_7" style="clear: both">Key Points</h2>
                    </div>
                </div>
            </div>
            <div class="itemizedlist">
                <ul class="itemizedlist">
                    <li class="listitem">Lambda expressions can be used to make many existing design patternssimpler and more readable, especially the command pattern.</li>
                    <li class="listitem">There is more flexibility to the kind of domain-specific languagesyou can create with Java 8.</li>
                    <li class="listitem">New opportunities open up for applying the SOLID principles in Java 8.</li>
                </ul>
            </div>
        </div>
        </section>
        </div>
        </div>
        </section>
        </div>
        </div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch09.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch09.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="10_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="concurrency_chp">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 9. Lambda-Enabled Concurrency</h2>
                                    </div>
                                </div>
                            </div>
                            <p><a class="indexterm" id="10_ix_ch09-asciidoc0"></a><a class="indexterm" id="10_ix_ch09-asciidoc1"></a>I’ve already talked a bit about data parallelism, but in this chapterI’m going to cover how we can use lambda expressions to write
                                concurrentapplications that efficiently perform message passing and nonblocking I/O.</p>
                            <p>Some of the examples in this chapter are written using the<a class="indexterm" id="10_id423984"></a><a class="indexterm" id="10_id423992"></a> <a class="ulink" href="http://vertx.io/" target="_top">Vert.x</a> and <a class="ulink" href="https://github.com/Netflix/RxJava" target="_top">RxJava</a> frameworks. The principles are more general, though, and can be used in other frameworks and in your own code without you necessarily needing frameworks
                                at all.</p>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_why_use_nonblocking_i_o" style="clear: both">Why Use Nonblocking I/O?</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="10_id424016"></a><a class="indexterm" id="10_id424028"></a>When I introduced parallelism, I talked a lot about trying to usea lot of cores efficiently. That approach is really helpful, but when trying
                                    to processa lot of data, it’s not the only threading model that you might want to use.</p>
                                <p>Let’s suppose you’re trying to write a chat service that handles a very highnumber of users. Every time a user connects to your service, a TCPconnection to your server is opened. If you follow a traditional threadingmodel,
                                    every time you want to write some data to your user, you would call amethod that sends the user the data. This method call would block the thread thatyou’re running on.</p>
                                <p><a class="indexterm" id="10_id424094"></a>This approach to I/O, called <span class="emphasis"><em>blocking I/O</em></span>, is fairly common and fairly easy tounderstand because the interaction with users follows a normal
                                    sequential flowof control through your program. The downside is that when you start lookingat scaling your system to a significant number of users, you need to start asignificant number of threads on your server in
                                    order to service them. That approachjust doesn’t scale well.</p>
                                <p><a class="indexterm" id="10_id424047"></a><span class="emphasis"><em>Nonblocking I/O</em></span>—or, as it’s sometimes called,<a class="indexterm" id="10_id424104"></a> <span class="emphasis"><em>asynchronous I/O</em></span>—can
                                    be used to process many concurrent network connections without havingan individual thread service each connection. Unlike with blocking I/O, the methods to read and write data to your chat clients return immediately.
                                    The actual I/O processing is happening in a separate thread, and you are free to perform some useful work in the meantime. How you choose to use these saved CPU cycles may range from reading more data from another client
                                    to ticking over your Minecraft server!</p>
                                <p>I’ve so far avoided presenting any code to show the ideas because the concept of blocking versus nonblocking I/O can be implemented in a number of different ways in terms of the API. The<a class="indexterm" id="10_id424121"></a>
                                    <a class="indexterm" id="10_id424067"></a> Java standard library presents a nonblocking I/O API in the form of<a class="indexterm" id="10_id424086"></a><a class="indexterm" id="10_id424138"></a> NIO (New I/O). The original version of NIO uses the concept of a
                                        <a class="indexterm" id="10_id424158"></a> <code class="literal">Selector</code>, which lets a thread manage multiple channels of communication, such as the network socket that’s used to write to your chat client.</p>
                                <p>This approach never proved particularly popular with Java developers and resultedin code that was fairly hard to understand and debug. With the introduction of lambdaexpressions, it becomes idiomatic to design and develop
                                    APIs that don’t havethese deficiencies.</p>
                            </div>
                            <div class="sect1">
                                <div class="titlepage">
                                    <div>
                                        <div>
                                            <h2 class="title" id="_callbacks" style="clear: both">Callbacks</h2>
                                        </div>
                                    </div>
                                </div>
                                <p><a class="indexterm" id="10_ix_ch09-asciidoc2"></a><a class="indexterm" id="10_ix_ch09-asciidoc3"></a>To demonstrate the principles of this approach, we’re going toimplement a dead simple chat application—no bells and no whistles.
                                    In thisapplication, users can send and receive messages to and from each other. Theyare required to set names for themselves when they first connect.</p>
                                <p><a class="indexterm" id="10_id424249"></a>We’re going to implement the chat application using the Vert.x framework andintroduce the necessary techniques as we go along. Let’s start by writing somecode that receives TCP connections,
                                    as demonstrated in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#RECEIVE_TCP">Example 9-1</a>.</p>
                                <div class="example"><a id="10_RECEIVE_TCP"></a>
                                    <div class="example-title">Example 9-1. Receiving TCP connections</div>
                                    <div class="example-contents">
                                     <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">ChatVerticle</span> <span style="color:#00f;font-weight:700">extends</span> <span style="font-style:italic">Verticle</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">start</span>() {
        vertx<span style="color:#00f;font-weight:700">.</span>createNetServer()<span style="color:#00f;font-weight:700">.</span>connectHandler(socket <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
            container<span style="color:#00f;font-weight:700">.</span>logger()<span style="color:#00f;font-weight:700">.</span>info(<span style="color:#036a07">socket connected</span>);
            socket<span style="color:#00f;font-weight:700">.</span>dataHandler(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">User</span>(socket, <span style="color:#318495">this</span>));
        })<span style="color:#00f;font-weight:700">.</span>listen(10_000);
        container<span style="color:#00f;font-weight:700">.</span>logger()<span style="color:#00f;font-weight:700">.</span>info(<span style="color:#036a07">ChatVerticle started</span>);
    }
}
</pre>
                                    </div>
                                </div>
                                <p>You can think of a<a class="indexterm" id="10_id424237"></a><a class="indexterm" id="10_id424538"></a> <code class="literal">Verticle</code> as being a bit like a<a class="indexterm" id="10_id424552"></a> <code class="literal">Servlet</code>—it’s
                                    the atomicunit of deployment in the Vert.x framework. The entry point to the code is the<code class="literal">start</code> method, which is a bit like a <code class="literal">main</code> method in a regular Java program.
                                    In ourchat app, we just use it to set up a server that accepts TCP connections.</p>
                                <p><a class="indexterm" id="10_id424583"></a><a class="indexterm" id="10_id424565"></a><a class="indexterm" id="10_id424571"></a>We pass in a lambda expression to the <code class="literal">connectHandler</code> method, which gets calledwhenever
                                    someone connects to our chat app. This is a callback and worksin a similar way to the Swing callbacks I talked about way back in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch01.html">Chapter 1</a>.The
                                    benefit of this approach is that the application doesn’t control the threadingmodel—the Vert.x framework can deal with managing threads and all the associatedcomplexity, and all we need to do is think in terms of events
                                    and callbacks.</p>
                                <p><a class="indexterm" id="10_id424629"></a><a class="indexterm" id="10_id424606"></a>Our application registers another callback using the <code class="literal">dataHandler</code> method.This is a callback that gets called whenever
                                    some data is read from thesocket. In this case, we want to provide more complex functionality, so insteadof passing in a lambda expression we use a regular class, <code class="literal">User</code>, and let itimplement
                                    the necessary functional interface. The callback into our <code class="literal">User</code> classis listed in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#User_HANDLE">Example 9-2</a>.</p>
                                <div class="example"><a id="10_User_HANDLE"></a>
                                    <div class="example-title">Example 9-2. Handling user connections</div>
                                    <div class="example-contents">
                                      <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">User</span> <span style="color:#00f;font-weight:700">implements</span> <span style="font-style:italic">Handler</span> &lt; <span style="font-style:italic">Buffer</span> &gt; {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">static</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Pattern</span> newline <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Pattern</span><span style="color:#00f;font-weight:700">.</span>compile(<span style="color:#036a07">&quot;<span style="color:#26b31a">\\</span>n&quot;</span>);
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">NetSocket</span> socket;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Set</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> names;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">EventBus</span> eventBus;
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">Optional</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> name;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">User</span>(<span style="color:#00f;font-weight:700">NetSocket</span> <span style="font-style:italic">socket</span>, <span style="color:#00f;font-weight:700">Verticle</span> <span style="font-style:italic">verticle</span>) {
        <span style="color:#00f;font-weight:700">Vertx</span> vertx <span style="color:#00f;font-weight:700">=</span> verticle<span style="color:#00f;font-weight:700">.</span>getVertx();
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>socket <span style="color:#00f;font-weight:700">=</span> socket;
        names <span style="color:#00f;font-weight:700">=</span> vertx<span style="color:#00f;font-weight:700">.</span>sharedData()<span style="color:#00f;font-weight:700">.</span>getSet(<span style="color:#036a07">names</span>);
        eventBus <span style="color:#00f;font-weight:700">=</span> vertx<span style="color:#00f;font-weight:700">.</span>eventBus();
        name <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">Optional</span><span style="color:#00f;font-weight:700">.</span>empty();
    }<span style="color:#00f;font-weight:700">@Override</span> <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">handle</span>(<span style="color:#00f;font-weight:700">Buffer</span> <span style="font-style:italic">buffer</span>) {
        newline<span style="color:#00f;font-weight:700">.</span>splitAsStream(buffer<span style="color:#00f;font-weight:700">.</span>toString())<span style="color:#00f;font-weight:700">.</span>forEach(line <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
            <span style="color:#00f;font-weight:700">if</span> (<span style="color:#00f;font-weight:700">!</span>name<span style="color:#00f;font-weight:700">.</span>isPresent()) setName(line);
            <span style="color:#00f;font-weight:700">else</span> handleMessage(line);
        });
    } <span style="color:#06f;font-style:italic">// Class continues...</span>
    
</pre>
                                    </div>
                            </div>
                            <p>The <code class="literal">buffer</code> contains the data that has been written down the networkconnection to us. We’re using a newline-separated, text-based protocol, so wewant to convert this to a <code class="literal">String</code>                                and then split it based upon those newlines.</p>
                            <p><a class="indexterm" id="10_id424700"></a><a class="indexterm" id="10_id425395"></a>We have a regular expression to match newline characters, which is a<code class="literal">java.util.regex.Pattern</code> instance called <code class="literal">newline</code>.
                                Conveniently, Java’s<a class="indexterm" id="10_id425407"></a><code class="literal">Pattern</code> class has had a <code class="literal">splitAsStream</code> method added in Java 8 that lets ussplit a<a class="indexterm" id="10_id425431"></a>                                <code class="literal">String</code> using the regular expression and have a stream of values,consisting of the values between each split.</p>
                            <p>The first thing our users do when they connect to our chat server is set theirnames. If we don’t know the user’s <code class="literal">name</code>, then we delegate to the logic forsetting the name; otherwise, we handle our
                                message like a normal chat message.</p>
                            <p>We also need a way of receiving messages from other users and passing them onto our chat client so the recipients can read them. In order to implement this, at thesame time that we set the name of the current user we also register
                                anothercallback that writes these messages (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#REGISTER_CHAT">Example 9-3</a>).</p>
                            <div class="example"><a id="10_REGISTER_CHAT"></a>
                                <div class="example-title">Example 9-3. Registering for chat messages</div>
                                <div class="example-contents">
<pre style="background:#fff;color:#000">eventBus<span style="color:#00f;font-weight:700">.</span>registerHandler(name, (<span style="color:#00f;font-weight:700">Message</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> msg) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
    sendClient(msg<span style="color:#00f;font-weight:700">.</span>body());
});
</pre>                                </div>
                            </div>
                            <p>This code is actually taking advantage of Vert.x’s<a class="indexterm" id="10_id425596"></a><a class="indexterm" id="10_id425592"></a> <span class="emphasis"><em>event bus</em></span>, which allows us to sendmessages between verticles
                                in a nonblocking fashion (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#jvld_0901">Figure 9-1</a>). The <code class="literal">registerHandler</code>method
                                allows us to associate a handler with a certain address, so when amessage is sent to that address the handler gets called with the message as itsargument. Here we use the username as the address.</p>
                            <div class="figure"><a id="10_jvld_0901"></a>
                                <div class="figure-contents">
                                    <div class="mediaobject"><img alt=".Eventbus Sending" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0901.png" height="294" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0901.png" width="714"/></div>
                                </div>
                                <div class="figure-title">Figure 9-1. Event bus sending</div>
                            </div>
                            <p>By registering handlers at addresses and sending messages to them, it’s possibleto build up very sophisticated and/or decoupled sets of services that react inan entirely nonblocking fashion. Note that within our design, we
                                share nostate.</p>
                            <p>Vert.x’s event bus lets us send a variety of types of message over it,but all of them will be wrapped in a<a class="indexterm" id="10_id425664"></a><a class="indexterm" id="10_id425660"></a> <code class="literal">Message</code> object.
                                Point-to-pointmessaging is available through the <code class="literal">Message</code> objects themselves; they may hold areply handler for the sender of the <code class="literal">Message</code> object. Because in this case
                                wewant the actual body of the message—that is, the text itself—we just called the<code class="literal">body</code> method. We’ll send this text message to the receiving user’s chatclient, implemented by writing the message
                                down the TCP connection.</p>
                            <p>When our application wants to send a message from one user to another, it sendsthat message to the address that represents the other user (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#SEND_CHAT">Example 9-4</a>).
                                Again, this is that user’susername.</p>
                            <div class="example"><a id="10_SEND_CHAT"></a>
                                <div class="example-title">Example 9-4. Sending chat messages</div>
                                <div class="example-contents">
<pre style="background:#fff;color:#000">eventBus<span style="color:#00f;font-weight:700">.</span>send(user, name<span style="color:#00f;font-weight:700">.</span>get() <span style="color:#00f;font-weight:700">+</span> <span style="color:#036a07">&gt;</span> <span style="color:#00f;font-weight:700">+</span> message);
</pre>                                </div>
                            </div>
                            <p><a class="indexterm" id="10_id425794"></a><a class="indexterm" id="10_id425803"></a><a class="indexterm" id="10_id425812"></a>Let’s extend this very basic chat server to broadcast messages and followers. There are two new commands that
                                we need to implement in order for this to work:</p>
                            <div class="itemizedlist">
                                <ul class="itemizedlist">
                                    <li class="listitem">An exclamation mark representing the broadcast command, which sends all of its following text to any following users. For example, if bob typed “!hello followers”, then all of his followers would receive “bob&gt;hello
                                        followers”.</li>
                                    <li class="listitem">The follow command, which follows a specified user suffixed to the command, as in “follow bob”.</li>
                                </ul>
                            </div>
                            <p>Once we’ve parsed out the commands, we’re going to implement the<code class="literal">broadcastMessage</code> and <code class="literal">followUser</code> methods, which correspond to each of thesecommands.</p>
                            <p>There’s a different pattern of communication here as well. Instead of just having to send messages to a single user, you now have the ability to publish to multiple users. Fortunately, Vert.x’s event bus also lets us publish
                                a message to multiple handlers (see <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#jvld_0902">Figure 9-2</a>). This lets us use a similar overarching approach.</p>
                            <div class="figure"><a id="10_jvld_0902"></a>
                                <div class="figure-contents">
                                    <div class="mediaobject"><img alt=".Eventbus Publishing" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0902.png" height="294" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0902.png" width="715"/></div>
                                </div>
                                <div class="figure-title">Figure 9-2. Event bus publishing</div>
                    </div>
                    <p>The only code difference is that we use the <code class="literal">publish</code> method on the event busrather than the <code class="literal">send</code> method. To avoid overlapping with the existingaddresses whenever a user uses
                        the <code class="literal">!</code> command, it gets published to the user’sname suffixed with <code class="literal">.followers</code>. So, for example, when bob publishes a messageit goes to any handler registered on <code class="literal">bob.followers</code>                        (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#BROADCAST">Example 9-5</a>).</p>
                    <div class="example"><a id="10_BROADCAST"></a>
                        <div class="example-title">Example 9-5. Broadcasting messages to followers</div>
                        <div class="example-contents">
                          <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> broadcastMessage(<span style="color:#00f;font-weight:700">String</span> message) {
    <span style="color:#00f;font-weight:700">String</span> name <span style="color:#00f;font-weight:700">=</span> <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>name<span style="color:#00f;font-weight:700">.</span>get();
    eventBus<span style="color:#00f;font-weight:700">.</span>publish(name <span style="color:#00f;font-weight:700">+</span> <span style="color:#036a07">.followers</span>, name <span style="color:#00f;font-weight:700">+</span> <span style="color:#036a07">&gt;</span> <span style="color:#00f;font-weight:700">+</span> message);
}
</pre>
                        </div>
                    </div>
                    <p>When it comes to the handler, we want to do the same operation that we performedearlier when registering sends: pass that message along to the client (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#RECEIVE_BROADCAST">Example 9-6</a>).</p>
                    <div class="example"><a id="10_RECEIVE_BROADCAST"></a>
                        <div class="example-title">Example 9-6. Receiving the broadcast messages</div>
                        <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> followUser(<span style="color:#00f;font-weight:700">String</span> user) {
    eventBus<span style="color:#00f;font-weight:700">.</span>registerHandler(user <span style="color:#00f;font-weight:700">+</span> <span style="color:#036a07">.followers</span>, (<span style="color:#00f;font-weight:700">Message</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span> <span style="color:#00f;font-weight:700">&gt;</span> message) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        sendClient(message<span style="color:#00f;font-weight:700">.</span>body());
    });
}
</pre>                        </div>
                </div>
                <div class="note">
                    <h3 class="title">Note</h3>
                    <p>If you send to an address and there are multiple handlers listening on that address, a round-robin selector is used to decide which handler receives your message. This means that you need to be a bit careful when registering addresses.
                        <a class="indexterm" id="10_id426320"></a><a class="indexterm" id="10_id426316"></a></p>
                </div>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="_message_passing_architectures" style="clear: both">Message Passing Architectures</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="10_id426342"></a><a class="indexterm" id="10_id426353"></a>What I’ve been describing here is a message passing–based architecture that I’ve implemented using a simple chat client. The details of the chat client are much
                less important than the overall pattern, so let’s talk about message passing itself.</p>
            <p><a class="indexterm" id="10_id426361"></a>The first thing to note is that this is a no-shared-state design. Allcommunication between our verticles is done by sending messages over ourevent bus. This means that we don’t need to protect any shared
                state, sowe don’t need any kind of locks or use of the <code class="literal">synchronized</code> keyword in ourcode base at all. Concurrency is much simpler.</p>
            <p>In order to ensure that we aren’t sharing any state between verticles, we’veactually imposed a few constraints on the types of messages being sent over theevent bus. The example messages that we passed over the event bus in this casewere plain
                old Java strings. These are immutable by design, which means that wecan safely send them between verticles. Because the receiving handler can’tmodify the state of the <code class="literal">String</code>, it can’t interfere with the behavior
                of thesender.</p>
            <p>Vert.x doesn’t restrict us to sending strings as messages, though; we canuse more complex<a class="indexterm" id="10_id426410"></a><a class="indexterm" id="10_id426391"></a><a class="indexterm" id="10_id426404"></a><a class="indexterm" id="10_id426414"></a>                JSON objects or even build our own binary messages usingthe <code class="literal">Buffer</code> class. These aren’t immutable messages, which means that ifwe just naively passed them around, our message senders and message handlerscould
                share state by writing or reading through these messages.</p>
            <p>The Vert.x framework avoids this problem by copying any mutable message themoment that you send it. That way the receiver gets the correct value, but youstill aren’t sharing state. Regardless of whether you’re using the Vert.x framework, it’s
                really important that you don’t let your messages be an accidentalsource of shared state. Completely immutable messages are the simplest way ofdoing this, but copying the message also solves the problem.</p>
            <p><a class="indexterm" id="10_id426427"></a><a class="indexterm" id="10_id426440"></a>The verticle model of development also lets us implement a concurrent systemthat is easy to test. This is because each verticle can be tested inisolation by sending
                messages in and expecting results to be returned. We canthen compose a complex system out of individually tested components withoutincurring as many problems in integrating the components as we would if theywere communicating via shared
                mutable state. Of course, end-to-end tests arestill useful for making sure that your system does what your users expect ofit!</p>
            <p>Message passing–based systems also make it easier to isolate failure scenariosand write reliable code. If there is an error within a message handler, we havethe choice of restarting its local verticle without having to restart theentire JVM.</p>
            <p>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch06.html">Chapter 6</a>, we looked at how you can use lambda expressions in conjunction withthe streams library in order to build data parallel
                code. That lets us useparallelism in order to process large amounts of data faster. Messagepassing and reactive programming, which we’ll look at later in this chapter,are at the other end of the spectrum. We’re looking at concurrency situationsin
                which we want to have many more units of I/O work, such as connected chatclients, than we have threads running in parallel. In both cases, thesolution is the same: use lambda expressions to represent the behavior andbuild APIs that manage
                the concurrency for you. Smarter libraries meansimpler application code.</p>
        </div>
        <div class="sect1">
            <div class="titlepage">
                <div>
                    <div>
                        <h2 class="title" id="pyramid_of_doom" style="clear: both">The Pyramid of Doom</h2>
                    </div>
                </div>
            </div>
            <p><a class="indexterm" id="10_ix_ch09-asciidoc4"></a><a class="indexterm" id="10_ix_ch09-asciidoc5"></a>You’ve seen how we can use callbacks and events to produce nonblockingconcurrent code, but I haven’t mentioned the elephant in the room. If youwrite
                code with lots of callbacks, it becomes very hard to read, evenwith lambda expressions. Let’s take a look at a more concrete example in orderto understand this problem better.</p>
            <p>While developing the chat server I wrote a series of tests that described thebehavior of the verticle from the point of view of the client. The code forthis is listed in the <code class="literal">messageFriend</code> test in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#Chat_MESSAGE_FRIEND">Example 9-7</a>.</p>
            <div class="example"><a id="10_Chat_MESSAGE_FRIEND"></a>
                <div class="example-title">Example 9-7. A test of whether two friends in our chat server can talk to each other</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> messageFriend() {
    withModule(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        withConnection(richard <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
            richard<span style="color:#00f;font-weight:700">.</span>dataHandler(data <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
                assertEquals(<span style="color:#036a07">bob&gt;oh its you!</span>, data<span style="color:#00f;font-weight:700">.</span>toString());
                moduleTestComplete();
            });
            richard<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">&quot;richard<span style="color:#26b31a">\n</span>&quot;</span>);
            withConnection(bob <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
                bob<span style="color:#00f;font-weight:700">.</span>dataHandler(data <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
                    assertEquals(<span style="color:#036a07">richard&gt;hai</span>, data<span style="color:#00f;font-weight:700">.</span>toString());
                    bob<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">richard&lt;oh its you!</span>);
                });
                bob<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">&quot;bob<span style="color:#26b31a">\n</span>&quot;</span>);
                vertx<span style="color:#00f;font-weight:700">.</span>setTimer(<span style="color:#0000cd">6</span>, id <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>richard<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">bob&lt;hai</span>));
            });
        });
    });
}
</pre>                </div>
            </div>
            <p>I connect two clients, richard and bob, then richard says “hai” to bob and bobreplies “oh it’s you!” I’ve refactored out common code to make a connection,but even then you’ll notice that the nested callbacks are beginning to turninto a
                <span class="emphasis"><em>pyramid of doom</em></span>. They are stretching rightward across the screen, a bit like a pyramid sitting on its side (don’t look at me—I didn’t comeup with the name!). This is a pretty well known antipattern,which makes it hard for
                    a user to read and understand the code. It alsostretches the logic of the code between multiple methods.</p>
            <p><a class="indexterm" id="10_id427054"></a>In the last chapter, I discussed how we could use lambda expressions to manage resources by passing a lambda expression into a <code class="literal">with</code> method. You’ll notice in this test that
                I’ve used this pattern in couple of places. We’ve got a <code class="literal">withModule</code> method that deploys the current Vert.x module, runs some code, and shuts the module down. We’ve also got a <code class="literal">withConnection</code>                method that connects to the <code class="literal">ChatVerticle</code> and then closes down the connection when it’s done with it.</p>
            <p>The benefit of using these <code class="literal">with</code> method calls here rather than using <code class="literal">try-with-resources</code> is that they fit into the nonblocking threading model that we’re using in this chapter. We can
                try and refactor this code a bit in order to make it easier to understand, as in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#Chat_MESSAGE_FRIEND_REFACTOR">Example 9-8</a>.</p>
            <div class="example"><a id="10_Chat_MESSAGE_FRIEND_REFACTOR"></a>
                <div class="example-title">Example 9-8. A test of whether two friends in our chat server can talk to each other, split into different methods</div>
                <div class="example-contents">
<pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Testpublic</span> <span style="color:#00f;font-weight:700">void</span> canMessageFriend() {
    withModule(<span style="color:#318495">this</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>messageFriendWithModule);
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> messageFriendWithModule() {
    withConnection(richard <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        checkBobReplies(richard);
        richard<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">&quot;richard<span style="color:#26b31a">\n</span>&quot;</span>);
        messageBob(richard);
    });
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> messageBob(<span style="color:#00f;font-weight:700">NetSocket</span> richard) {
    withConnection(messageBobWithConnection(richard));
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">Handler</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">NetSocket</span> <span style="color:#00f;font-weight:700">&gt;</span> messageBobWithConnection(<span style="color:#00f;font-weight:700">NetSocket</span> richard) {
    <span style="color:#00f;font-weight:700">return</span> bob <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        checkRichardMessagedYou(bob);
        bob<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">&quot;bob<span style="color:#26b31a">\n</span>&quot;</span>);
        vertx<span style="color:#00f;font-weight:700">.</span>setTimer(<span style="color:#0000cd">6</span>, id <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>richard<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">bob&lt;hai</span>));
    };
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> checkRichardMessagedYou(<span style="color:#00f;font-weight:700">NetSocket</span> bob) {
    bob<span style="color:#00f;font-weight:700">.</span>dataHandler(data <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        assertEquals(<span style="color:#036a07">richard&gt;hai</span>, data<span style="color:#00f;font-weight:700">.</span>toString());
        bob<span style="color:#00f;font-weight:700">.</span>write(<span style="color:#036a07">richard&lt;oh its you!</span>);
    });
}
<span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">void</span> checkBobReplies(<span style="color:#00f;font-weight:700">NetSocket</span> richard) {
    richard<span style="color:#00f;font-weight:700">.</span>dataHandler(data <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        assertEquals(<span style="color:#036a07">bob&gt;oh its you!</span>, data<span style="color:#00f;font-weight:700">.</span>toString());
        moduleTestComplete();
    });
}
</pre>                </div>
        </div>
        <p>The aggressive refactoring in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#Chat_MESSAGE_FRIEND_REFACTOR">Example 9-8</a> has solved thepyramid of doom problem, but at the expense of
            splitting up the logic ofthe single test into several methods. Instead of one method having a singleresponsibility, we have several sharing a responsibility between them! Ourcode is still hard to read, just for a different reason.</p>
        <p>The more operations you want to chain or compose, the worse this problem gets.We need a better solution.<a class="indexterm" id="10_id427915"></a><a class="indexterm" id="10_id427928"></a></p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_futures" style="clear: both">Futures</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="10_ix_ch09-asciidoc6"></a><a class="indexterm" id="10_ix_ch09-asciidoc7"></a>Another option when trying to build up complex sequences of concurrentoperations is to use what’s known as a <code class="literal">Future</code>. A
            <code class="literal">Future</code> is an IOUfor a value. Instead of a method returning a value, it returns the <code class="literal">Future</code>.The <code class="literal">Future</code> doesn’t have the value when it’s first created, but
            it can beexchanged for the value later on, like an IOU.</p>
        <p>You extract the value of the <code class="literal">Future</code> by calling its<a class="indexterm" id="10_id427997"></a> <code class="literal">get</code> method, whichblocks until the value is ready. Unfortunately, <code class="literal">Future</code>s
            end up withcomposability issues, just like callbacks. We’ll take a quick look at theissues that you can encounter.</p>
        <p>The scenario we’ll be considering is looking up information about an <code class="literal">Album</code>from some external web services. We need to find the list of tracks associatedwith a given <code class="literal">Album</code> and also a list
            of artists. We also need to ensurethat we have sufficient credentials to access each of the services. So we need tolog in, or at least make sure that we’re already logged in.</p>
        <p><a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#future_lookupByName">Example 9-9</a> is an implementation of this problem using the existing<code class="literal">Future</code> API. We
            start out at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-26"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>            by logging into the track and artistservices. Each of these login actions returns a <code class="literal">Future&lt;Credentials&gt;</code> objectwith the login information. The <code class="literal">Future</code> interface is generic, so
            <code class="literal">Future&lt;Credentials&gt;</code> can be read as an IOU for a <code class="literal">Credentials</code> object.</p>
        <div class="example"><a id="10_future_lookupByName"></a>
            <div class="example-title">Example 9-9. Downloading album information from some external web services using Futures</div>
            <div class="example-contents">
               
                
                <pre style="background:#fff;color:#000">@<span style="color:#00f;font-weight:700">Overridepublic</span> <span style="color:#00f;font-weight:700">Album</span> lookupByName(<span style="color:#00f;font-weight:700">String</span> albumName) {
    <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Credentials</span> <span style="color:#00f;font-weight:700">&gt;</span> trackLogin <span style="color:#00f;font-weight:700">=</span> loginTo(<span style="color:#036a07">track</span>);<a id="10_CO1-26"></a><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>
    <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Credentials</span> <span style="color:#00f;font-weight:700">&gt;</span> artistLogin <span style="color:#00f;font-weight:700">=</span> loginTo(<span style="color:#036a07">artist</span>);<a id="10_CO1-27"></a><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>
    <span style="color:#00f;font-weight:700">try</span> {
        <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Track</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> tracks <span style="color:#00f;font-weight:700">=</span> lookupTracks(albumName, trackLogin<span style="color:#00f;font-weight:700">.</span>get());
        <span style="color:#00f;font-weight:700">Future</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> artists <span style="color:#00f;font-weight:700">=</span> lookupArtists(albumName, artistLogin<span style="color:#00f;font-weight:700">.</span>get());
        <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Album</span>(albumName, tracks<span style="color:#00f;font-weight:700">.</span>get(), artists<span style="color:#00f;font-weight:700">.</span>get());<a id="10_CO1-28"></a><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/>
    } <span style="color:#00f;font-weight:700">catch</span>(<span style="color:#00f;font-weight:700">InterruptedException</span> <span style="color:#00f;font-weight:700">|</span> <span style="color:#00f;font-weight:700">ExecutionException</span> e) {
        <span style="color:#00f;font-weight:700">throw</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">AlbumLookupException</span>(e<span style="color:#00f;font-weight:700">.</span>getCause()); <a id="10_CO1-29"></a><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/>
    }
}
</pre>
            </div>
        </div>
        <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-27"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>            we make our calls to look up the tracks andartists given the login credentials and call <code class="literal">get</code> on both of theselogin credentials in order to get them out of the <code class="literal">Future</code>s. At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-28"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>            we build upour new <code class="literal">Album</code> to return, again calling <code class="literal">get</code> in order to block on theexisting <code class="literal">Future</code>s. If there’s an exception, it gets thrown, so we have topropagate
            it through a domain exception at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-29"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></a>.</p>
        <p><a class="indexterm" id="10_id428636"></a>As you’ll have noticed, if you want to pass the result of one <code class="literal">Future</code> into thebeginning of another piece of work, you end up blocking the thread ofexecution. This can be become
            a performance limitation because instead of workbeing executed in parallel it is (accidentally) run in serial.</p>
        <p>What this means in the case of <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#future_lookupByName">Example 9-9</a> is that we can’t starteither of the calls to the lookup services until
            we’ve logged into both of them.This is pretty unnecessary: <code class="literal">lookupTracks</code> only needs its login credentials,and <code class="literal">lookupArtists</code> should only need to wait for its login credentials. Thebreakdown
            of which actions need to wait for others to complete isshown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#future_example_img">Figure 9-3</a>.</p>
        <p>We could take the blocking <code class="literal">get</code> calls and drag them down into theexecution body of <code class="literal">lookupTracks</code> and <code class="literal">lookupArtists</code>. This would solve theproblem, but would also
            result in uglier code and an inability to reuse credentialsbetween multiple calls.</p>
        <div class="figure"><a id="10_future_example_img"></a>
            <div class="figure-contents">
                <div class="mediaobject"><img alt="Both lookup actions don’t need to wait for both login actions" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0903.png" height="367" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0903.png" width="1000"/></div>
            </div>
            <div class="figure-title">Figure 9-3. Both lookup actions don’t need to wait for both login actions</div>
        </div>
        <p>What we really want here is a way of acting on the result of a <code class="literal">Future</code>,<span class="emphasis"><em>without</em></span> having to make a blocking <code class="literal">get</code> call. We want to combine a<code class="literal">Future</code>            with a callback.</p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_completable_futures" style="clear: both">Completable Futures</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="10_ix_ch09-asciidoc8"></a><a class="indexterm" id="10_ix_ch09-asciidoc9"></a><a class="indexterm" id="10_ix_ch09-asciidoc10"></a><a class="indexterm" id="10_ix_ch09-asciidoc11"></a>The solution to these issues arrives in the form
            of the <code class="literal">CompletableFuture</code>.This combines the IOU idea of a <code class="literal">Future</code> with using callbacks to handleevent-driven work. The key point about the <code class="literal">CompletableFuture</code>            is that you cancompose different instances in a way that doesn’t result in the pyramid ofdoom.</p>
        <div class="note">
            <h3 class="title">Note</h3>
            <p>You might have encountered the concept behind the <code class="literal">CompletableFuture</code> before;various other languages call them a<a class="indexterm" id="10_id428848"></a><a class="indexterm" id="10_id428837"></a> <span class="emphasis"><em>deferred object</em></span>                or a <span class="emphasis"><em>promise</em></span>. In the<a class="indexterm" id="10_id428860"></a><a class="indexterm" id="10_id428867"></a><a class="indexterm" id="10_id428873"></a>Google Guava Library and the Spring Framework these are referred
                to as<code class="literal">ListenableFuture</code>s.</p>
        </div>
        <p>I’ll illustrate some usage scenarios by rewriting <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#future_lookupByName">Example 9-9</a>to use <code class="literal">CompletableFuture</code>,
            rather than <code class="literal">Future</code>, as in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#completable_lookupByName">Example 9-10</a>.</p>
        <div class="example"><a id="10_completable_lookupByName"></a>
            <div class="example-title">Example 9-10. Downloading album information from some external web services using CompletableFutures</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Album</span> lookupByName(<span style="color:#00f;font-weight:700">String</span> albumName) {
    <span style="color:#00f;font-weight:700">CompletableFuture</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">List</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;&gt;</span> artistLookup <span style="color:#00f;font-weight:700">=</span> loginTo(<span style="color:#036a07">artist</span>)<span style="color:#00f;font-weight:700">.</span>thenCompose(artistLogin <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>lookupArtists(albumName, artistLogin));
    <span style="color:#0000cd"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></span>
    <span style="color:#00f;font-weight:700">return</span> loginTo(<span style="color:#036a07">track</span>)<span style="color:#00f;font-weight:700">.</span>thenCompose(trackLogin <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>lookupTracks(albumName, trackLogin)) <span style="color:#0000cd"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>.</span>thenCombine(artistLookup, (tracks, artists) <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span><span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">Album</span>(albumName, tracks, artists)) <span style="color:#0000cd"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/>.</span>join();
    <span style="color:#0000cd"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></span>
}
</pre>
            </div>
        </div>
        <p><a class="indexterm" id="10_id429313"></a><a class="indexterm" id="10_id429320"></a>In <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#completable_lookupByName">Example 9-10</a> <code class="literal">loginTo</code>,
            <code class="literal">lookupArtists</code>, and<code class="literal">lookupTracks</code> all return a <code class="literal">CompletableFuture</code> instead of a <code class="literal">Future</code>. The key“trick” to the <code class="literal">CompletableFuture</code>            API is to register lambda expressions andchain higher-order functions. The methods are different, but the concept isincredibly similar to the Streams API design.</p>
        <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-30"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>            we use the <code class="literal">thenCompose</code> method to transform our <code class="literal">Credentials</code>into a <code class="literal">CompletableFuture</code> that contains the artists. This is a bit like taking anIOU for money
            from a friend and spending the money on Amazon when you getit. You don’t immediately get a new book—you just get an email from Amazonsaying that your book is on its way: a different form of IOU.</p>
        <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-31"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>            we again use <code class="literal">thenCompose</code> and the <code class="literal">Credentials</code> from our Track API loginin order to generate a <code class="literal">CompletableFuture</code> of tracks. We introduce a new method,<a class="indexterm" id="10_id429404"></a><a class="indexterm" id="10_id429411"></a><code class="literal">thenCombine</code>, at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-32"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>.
            This takes the result from a <code class="literal">CompletableFuture</code> and combinesit with another <code class="literal">CompletableFuture</code>. The combining operation is provided by theend user as a lambda expression. We want to take
            our tracks and artists and buildup an <code class="literal">Album</code> object, so that’s what we do.</p>
        <p>At this point, it’s worth reminding yourself that just like with the Streams API,we’re not actually doing things; we’re building up a recipe that says how to do things.Our method can’t guarantee that the <code class="literal">CompletableFuture</code>            has completed until oneof the final methods is called. Because <code class="literal">CompletableFuture</code> implements <code class="literal">Future</code>,we could just call the <code class="literal">get</code> method again. <code class="literal">CompletableFuture</code>            contains the<a class="indexterm" id="10_id429441"></a><a class="indexterm" id="10_id429471"></a><code class="literal">join</code> method, which is called at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-33"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></a>            and does the same job. It doesn’t have aload of the nasty checked exceptions that hindered our use of <code class="literal">get</code>.</p>
        <p>You’ve probably got the basic idea of how to use <code class="literal">CompletableFuture</code>, butcreating them is another matter. There are two different aspects of creating a<code class="literal">CompletableFuture</code>: creating the object
            itself and actually completing it bygiving it the value that it owes its client code.</p>
        <p>As <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#completable_createFuture">Example 9-11</a> shows, it’s pretty easy to create a<code class="literal">CompletableFuture</code> object.
            You just call its constructor! This object can nowbe handed out to client code for chaining operations. We alsokeep a reference to this object in order to process the work on another thread.</p>
        <div class="example"><a id="10_completable_createFuture"></a>
            <div class="example-title">Example 9-11. Completing a future by providing a value</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">CompletableFuture</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> createFuture(<span style="color:#00f;font-weight:700">String</span> id) {
    <span style="color:#00f;font-weight:700">CompletableFuture</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> future <span style="color:#00f;font-weight:700">=</span> <span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">CompletableFuture</span> &lt; &gt;();
    startJob(future);
    <span style="color:#00f;font-weight:700">return</span> future;
}
</pre>
            </div>
        </div>
        <p>Once we’ve performed the work that needs to be done on whatever thread we’reusing, we need to tell the <code class="literal">CompletableFuture</code> what value itrepresents. Remember that this work can by done through a number of differentthreading
            models. For example, <a class="indexterm" id="10_id429707"></a><a class="indexterm" id="10_id429687"></a>we can <code class="literal">submit</code> a task to an <code class="literal">ExecutorService</code>,use an event loop-based system such as
            Vert.x, or just spin up a <code class="literal">Thread</code>and do work on it. As shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#completable_complete">Example 9-12</a>,
            in order to tell the<code class="literal">CompletableFuture</code> that it’s ready, you call the<a class="indexterm" id="10_id429724"></a><a class="indexterm" id="10_id429730"></a> <code class="literal">complete</code> method. It’s timeto pay back
            the IOU.</p>
        <div class="example"><a id="10_completable_complete"></a>
            <div class="example-title">Example 9-12. Completing a future by providing a value</div>
            <div class="example-contents">
                <pre class="programlisting"><code class="n">future</code><code class="o">.</code><code class="na">complete</code><code class="o">(</code><code class="n">artist</code><code class="o">);</code></pre>
            </div>
        </div>
        <div class="figure"><a id="10_completable_diagram"></a>
            <div class="figure-contents">
                <div class="mediaobject"><img alt="A completable future is an I-owe-you which can be processed by handlers" data-mfp-src="/library/view/java-8-lambdas/9781449370831/images/jvld_0904.png" height="650" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/images/jvld_0904.png" width="636"/></div>
            </div>
            <div class="figure-title">Figure 9-4. A completable future is an IOU that can be processed by handlers</div>
        </div>
        <p>Of course, a very common usage of <code class="literal">CompletableFuture</code> is to asynchronously runa block of code. This code completes and returns a value. In order to avoidlots of people having to implement the same code over and over
            again,there is a useful factory method for creating a <code class="literal">CompletableFuture</code>, shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#completable_lookupTrack">Example 9-13</a>,
            called<a class="indexterm" id="10_id429830"></a><a class="indexterm" id="10_id429839"></a> <code class="literal">supplyAsync</code>.</p>
        <div class="example"><a id="10_completable_lookupTrack"></a>
            <div class="example-title">Example 9-13. Example code for asynchronously creating a CompletableFuture</div>
            <div class="example-contents">
             
                
                
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">CompletableFuture</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Track</span> <span style="color:#00f;font-weight:700">&gt;</span> lookupTrack(<span style="color:#00f;font-weight:700">String</span> id) {
    <span style="color:#00f;font-weight:700">return</span> <span style="color:#00f;font-weight:700">CompletableFuture</span><span style="color:#00f;font-weight:700">.</span>supplyAsync(() <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>{
        <span style="color:#06f;font-style:italic">// Some expensive work is done here <img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>        </span>
        <span style="color:#06f;font-style:italic">// ...        </span>
        <span style="color:#00f;font-weight:700">return</span> track;
        <span style="color:#0000cd"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></span>
    },
    service);
    <span style="color:#0000cd"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></span>
}
</pre>
            </div>
        </div>
        <p>The <code class="literal">supplyAsync</code> method takes a <code class="literal">Supplier</code> that gets executed. The key point,shown at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-34"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>,
            is that this <code class="literal">Supplier</code> can do some time-consuming work withoutblocking the current thread—thus the <span class="emphasis"><em>Async</em></span> in the method name. The valuereturned at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-35"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a>            is used to complete the <code class="literal">CompletableFuture</code>. At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-36"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>            weprovide an<a class="indexterm" id="10_id430059"></a><a class="indexterm" id="10_id430068"></a> <code class="literal">Executor</code>, called <code class="literal">service</code>, that tells the <code class="literal">CompletableFuture</code>where
            to perform the work. If no <code class="literal">Executor</code> is provided, it just uses the samefork/join thread pool that parallel streams execute on.</p>
        <p>Of course, not every IOU has a happy ending. Sometimes we encounterexceptional circumstances and can’t pay our debts. As<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#completable_completeExceptionally">Example 9-14</a>            demonstrates, the <code class="literal">CompletableFuture</code> APIaccounts for these situations by letting you<a class="indexterm" id="10_id430096"></a><a class="indexterm" id="10_id430098"></a> <code class="literal">completeExceptionally</code>.
            This canbe called as an alternative to <code class="literal">complete</code>. You shouldn’t call both <code class="literal">complete</code>and <code class="literal">completeExceptionally</code> on a <code class="literal">CompletableFuture</code>,
            though.</p>
        <div class="example"><a id="10_completable_completeExceptionally"></a>
            <div class="example-title">Example 9-14. Completing a future if there’s an error</div>
            <div class="example-contents">
               <pre style="background:#fff;color:#000">future<span style="color:#00f;font-weight:700">.</span>completeExceptionally(<span style="color:#00f;font-weight:700">new</span> <span style="color:#00f;font-weight:700">AlbumLookupException</span>(<span style="color:#036a07">Unable to find </span> <span style="color:#00f;font-weight:700">+</span> name));
</pre>
            </div>
        </div>
        <p>A complete investigation of the <code class="literal">CompletableFuture</code> API is rather beyond thescope of this chapter, but in many ways it is a hidden goodie bag. There arequite a few useful methods in the API for composing and combining
            differentinstances of <code class="literal">CompletableFuture</code> in pretty much any way imaginable. Besides, bynow you should be familiar with the fluent style of chaining sequences ofhigher-order functions to tell the computer what to
            do.</p>
        <p>Let’s take a brief look at a few of those use cases:</p>
        <div class="itemizedlist">
            <ul class="itemizedlist">
                <li class="listitem">If you want to end your chain with a block of code that returns nothing,such as a<a class="indexterm" id="10_id430227"></a><a class="indexterm" id="10_id430236"></a> <code class="literal">Consumer</code> or <code class="literal">Runnable</code>,
                    then take a look at<a class="indexterm" id="10_id430263"></a><a class="indexterm" id="10_id430273"></a><a class="indexterm" id="10_id430281"></a><a class="indexterm" id="10_id430288"></a> <code class="literal">thenAccept</code> and <code class="literal">thenRun</code>.</li>
                <li class="listitem">Transforming the value of the <code class="literal">CompletableFuture</code>, a bit like using the <code class="literal">map</code> methodon <code class="literal">Stream</code>, can be achieved using<a class="indexterm" id="10_id430321"></a>
                    <a class="indexterm" id="10_id430330"></a> <code class="literal">thenApply</code>.</li>
                        <li class="listitem">If you want to convert situations in which your <code class="literal">CompletableFuture</code> has completedwith an exception, the<a class="indexterm" id="10_id430345"></a><a class="indexterm" id="10_id430361"></a> <code class="literal">exceptionally</code>                            method allows you to recover byregistering a function to make an alternative value.</li>
                        <li class="listitem">If you need to do a <code class="literal">map</code> that takes account of both theexceptional case and regular use cases, use <code class="literal">handle</code>.</li>
                        <li class="listitem">When trying to figure out what is happening with your <code class="literal">CompletableFuture</code>, youcan use the<a class="indexterm" id="10_id430398"></a><a class="indexterm" id="10_id430410"></a><a class="indexterm" id="10_id430418"></a>
                            <a class="indexterm" id="10_id430423"></a> <code class="literal">isDone</code> and <code class="literal">isCompletedExceptionally</code> methods.</li>
            </ul>
        </div>
        <p><code class="literal">CompletableFuture</code> is really useful for building up concurrent work, but it’snot the only game in town. We’re now going to look at a related concept thatoffers a bit more flexibility in exchange for more complex code.
            <a class="indexterm" id="10_id430466"></a><a class="indexterm" id="10_id430473"></a><a class="indexterm" id="10_id430447"></a><a class="indexterm" id="10_id430454"></a><a class="indexterm" id="10_id430460"></a><a class="indexterm" id="10_id430480"></a></p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_reactive_programming" style="clear: both">Reactive Programming</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="10_ix_ch09-asciidoc12"></a><a class="indexterm" id="10_ix_ch09-asciidoc13"></a>The concept behind a <code class="literal">CompletableFuture</code> can be generalized from single valuesto complete streams of data using
            <span class="emphasis"><em>reactive programming</em></span>. Reactive programmingis actually a form of declarative programming that lets us program in terms ofchanges and data flows that get automatically propagated.</p>
        <p>You can think of a spreadsheet as a commonly used example of reactive programming. If you enter <code class="literal">=B1+5</code> in cell <code class="literal">C1</code>, it tells the spreadsheet to add <code class="literal">5</code> to the contents
            of cell <code class="literal">B1</code> and put the result in <code class="literal">C1</code>. In addition, the spreadsheet reacts to any future changes in <code class="literal">B1</code> and updates the value in <code class="literal">C1</code>.</p>
        <p><a class="indexterm" id="10_id430564"></a>The RxJava library is a port of these reactive ideas onto the JVM. We won’t be going into the library in huge amounts of depth here, just covering the key concepts.</p>
        <p><a class="indexterm" id="10_id430583"></a>RxJava introduces a class called <code class="literal">Observable</code> that represents a sequence ofevents that you can react to. It’s an IOU for a sequence. There is astrong connection between an
            <code class="literal">Observable</code> and the <code class="literal">Stream</code> interface that weencountered in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch03.html">Chapter 3</a>.</p>
        <p>In both cases we build up recipes for performing work by chaining higher-orderfunctions and use lambda expressions in order to associate behavior with thesegeneral operations. In fact, many of the operations defined on an <code class="literal">Observable</code>are
            the same as on a <code class="literal">Stream</code>: <code class="literal">map</code>, <code class="literal">filter</code>, <code class="literal">reduce</code>.</p>
        <p><a class="indexterm" id="10_id430634"></a><a class="indexterm" id="10_id430644"></a>The big difference between the approaches is the use case. Streams are designedto build up computational workflows over in-memory collections. RxJava, on theother hand,
            is designed to compose and sequence asynchronous and event-basedsystems. Instead of pulling data out, it gets pushed in. Another way ofthinking about RxJava is that it is to a sequence of values what a<code class="literal">CompletableFuture</code>            is to a single value.</p>
        <p>Our concrete example this time around is searching for an artist and is shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#RxExamples_search">Example 9-15</a>. The <code class="literal">search</code>            method filters the results by name andnationality. It keeps a local cache of artist names but must look up otherartist information, such as nationality, from external services.</p>
        <div class="example"><a id="10_RxExamples_search"></a>
            <div class="example-title">Example 9-15. Searching for an artist by name and nationality</div>
            <div class="example-contents">
            
                
                
                <pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">Observable</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> search(<span style="color:#00f;font-weight:700">String</span> searchedName, <span style="color:#00f;font-weight:700">String</span> searchedNationality, <span style="color:#00f;font-weight:700">int</span> maxResults) {
    <span style="color:#00f;font-weight:700">return</span> getSavedArtists() <span style="color:#0000cd"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/>.</span>filter(name <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>name<span style="color:#00f;font-weight:700">.</span>contains(searchedName)) <span style="color:#0000cd"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/>.</span>flatMap(<span style="color:#318495">this</span><span style="color:#00f;font-weight:700">:</span><span style="color:#00f;font-weight:700">:</span>lookupArtist) <span style="color:#0000cd"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/>.</span>filter(artist <span style="color:#00f;font-weight:700">-</span> <span style="color:#00f;font-weight:700">&gt;</span>artist<span style="color:#00f;font-weight:700">.</span>getNationality() <span style="color:#0000cd"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/>.</span>contains(searchedNationality))<span style="color:#00f;font-weight:700">.</span>take(maxResults);
    <span style="color:#0000cd"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/></span>
}
</pre>
            </div>
        </div>
        <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-37"><img alt="1" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/1.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/1.png" width="12"/></a>            we get an <code class="literal">Observable</code> of the saved artist names. The higher-orderfunctions on the <code class="literal">Observable</code> class are similar to those on the <code class="literal">Stream</code>interface, so at
            <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-38"><img alt="2" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/2.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/2.png" width="12"/></a> and <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-40"><img alt="4" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/4.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/4.png" width="12"/></a>                we’re able to<a class="indexterm" id="10_id431044"></a><a class="indexterm" id="10_id431051"></a> <code class="literal">filter</code> by artist name andnationality, in a similar manner as if we were using a <code class="literal">Stream</code>.</p>
        <p>At <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-39"><img alt="3" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/3.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/3.png" width="12"/></a>            we replace each name with its <code class="literal">Artist</code> object. If this were as simple ascalling its constructor, we would obviously use the<a class="indexterm" id="10_id431090"></a><a class="indexterm" id="10_id431086"></a> <code class="literal">map</code>            operation. But in thiscase we need to compose a sequence of calls to external web services, each ofwhich may be done in its own thread or on a thread pool. Consequently, we needto replace each name with an <code class="literal">Observable</code>            representing one or more artists. Sowe use the<a class="indexterm" id="10_id431112"></a><a class="indexterm" id="10_id431113"></a> <code class="literal">flatMap</code> operation.</p>
        <p>We also need to limit ourselves to <code class="literal">maxResults</code> number of results in our search.To implement this at <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#CO1-41"><img alt="5" data-mfp-src="/library/view/java-8-lambdas/9781449370831/callouts/5.png" height="12" src="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/callouts/5.png" width="12"/></a>,
            we call the<a class="indexterm" id="10_id431135"></a><a class="indexterm" id="10_id431149"></a> <code class="literal">take</code> method on <code class="literal">Observable</code>.</p>
        <p>As you can see, the API is quite stream-like in usage. The big difference isthat while a <code class="literal">Stream</code> is designed to compute final results, the RxJava APIacts more like <code class="literal">CompletableFuture</code> in its
            threading model.</p>
        <p>In <code class="literal">CompletableFuture</code> we had to pay the IOU by calling <code class="literal">complete</code> witha value. Because an <code class="literal">Observable</code> represents a stream of events, we need theability to push
            multiple values; <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#RxExamples_completing_observable">Example 9-16</a> showshow to do this.</p>
        <div class="example"><a id="10_RxExamples_completing_observable"></a>
            <div class="example-title">Example 9-16. Pushing values into an Observable and completing it</div>
            <div class="example-contents">
        <pre style="background:#fff;color:#000">observer<span style="color:#00f;font-weight:700">.</span>onNext(<span style="color:#036a07">a</span>);observer<span style="color:#00f;font-weight:700">.</span>onNext(<span style="color:#036a07">b</span>);observer<span style="color:#00f;font-weight:700">.</span>onNext(<span style="color:#036a07">c</span>);observer<span style="color:#00f;font-weight:700">.</span>onCompleted();
</pre>
            </div>
        </div>
        <p>We call<a class="indexterm" id="10_id431207"></a><a class="indexterm" id="10_id431331"></a> <code class="literal">onNext</code> repeatedly, once for each element in the <code class="literal">Observable</code>. Wecan do this in a loop and on whatever
            thread of execution we want to producethe values from. Once we have finished with whatever work is needed to generatethe events, we call<a class="indexterm" id="10_id431341"></a><a class="indexterm" id="10_id431353"></a> <code class="literal">onCompleted</code>            to signal the end of the <code class="literal">Observable</code>.As well as the full-blown streaming approach, there are also several staticconvenience factory methods for creating <code class="literal">Observable</code> instances from futures,iterables,
            and arrays.</p>
        <p>In a similar manner to <code class="literal">CompletableFuture</code>, the <code class="literal">Observable</code> API also allows forfinishing with an exceptional event. We can use the<a class="indexterm" id="10_id431397"></a><a class="indexterm" id="10_id431393"></a>            <code class="literal">onError</code> method, shown in<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#RxExamples_error_observable">Example 9-17</a>, in order to signal an error. The
            functionalityhere is a little different from <code class="literal">CompletableFuture</code>—you can still get all theevents up until an exception occurs, but in both cases you either end normallyor end exceptionally.</p>
        <div class="example"><a id="10_RxExamples_error_observable"></a>
            <div class="example-title">Example 9-17. Notifying your Observable that an error has occurred</div>
            <div class="example-contents">
                <pre class="programlisting"><code class="n">observer</code><code class="o">.</code><code class="na">onError</code><code class="o">(</code><code class="k">new</code> <code class="n">Exception</code><code class="o">());</code></pre>
            </div>
        </div>
        <p>As with <code class="literal">CompletableFuture</code>, I’ve only given a flavor of how and where to use the <code class="literal">Observable</code> API here. If you want more details, read the project’s<a class="indexterm" id="10_id431486"></a>
            <a class="ulink" href="https://github.com/Netflix/RxJava/wiki/Getting-Started" target="_top">comprehensive documentation</a>. RxJava is also beginning to be integrated into the existing ecosystem of Java libraries. The enterprise integration framework<a class="indexterm" id="10_id431514"></a><a class="indexterm" id="10_id431500"></a> Apache
                Camel, for example, has added a module called <a class="ulink" href="http://camel.apache.org/rx.html" target="_top">Camel RX</a> that gives the ability to use RxJava with its framework. <a class="indexterm" id="10_id431524"></a>The Vert.x
                project has also started a project to <a class="ulink" href="https://github.com/vert-x/mod-rxvertx" target="_top">Rx-ify</a> its API.<a class="indexterm" id="10_id431528"></a><a class="indexterm" id="10_id431539"></a></p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_when_and_where" style="clear: both">When and Where</h2>
                </div>
            </div>
        </div>
        <p><a class="indexterm" id="10_id431554"></a>Throughout this chapter, I’ve talked about how to use nonblocking and event-based systems. Is that to say that everyone should just go out tomorrow and throw away their existing Java EE or Spring enterprise
            web applications? The answer is most definitely no.</p>
        <p>Even accounting for <code class="literal">CompletableFuture</code> and RxJava being relatively new,there is still an additional level of complexity when using these idioms.They’re simpler than using explicit futures and callbacks everywhere, butfor
            many problems the traditional blocking web application development isjust fine. If it ain’t broke, don’t fix it.</p>
        <p>Of course, that’s not to say that reading this chapter was a waste of your afternoon! Event-driven, reactive applications are growing in popularity and are frequently a great way to model the problems in your domain. The<a class="indexterm" id="10_id431614"></a>            <a class="ulink" href="http://www.reactivemanifesto.org/" target="_top">Reactive Manifesto</a> advocates building more applications in this style, and if it’s right for you, then you should. There are two scenarios in particular in which you
            might want to think in terms of reacting to events rather than blocking.</p>
        <p>The first is when your business domain is phrased in terms of events. Aclassic example here is<a class="indexterm" id="10_id431604"></a> Twitter, a service for subscribing to streams oftext messages. Your users are sending messages between one another,
            so bymaking your application event-driven, you are accurately modeling the businessdomain. Another example might be an application that tries to plot the priceof shares. Each new price update can be modeled as an event.</p>
        <p>The second obvious use case is a situation where your application needs toperform many I/O operations simultaneously. In these situations, performingblocking I/O requires too many threads to be spawned simultaneously. Thisresults in too many locks
            in contention and too much context switching.If you want to deal with thousands of concurrent connections or more, it’susually better to go nonblocking.</p>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_key_points_8" style="clear: both">Key Points</h2>
                </div>
            </div>
        </div>
        <div class="itemizedlist">
            <ul class="itemizedlist">
                <li class="listitem">Event-driven architectures are easy to implement usinglambda-based callbacks.</li>
                <li class="listitem">A <code class="literal">CompletableFuture</code> represents an IOU for a value.They can be easily composed and combined using lambdas.</li>
                <li class="listitem">An <code class="literal">Observable</code> extends the idea of a <code class="literal">CompletableFuture</code> tostreams of data.<a class="indexterm" id="10_id431636"></a><a class="indexterm" id="10_id431643"></a></li>
            </ul>
        </div>
    </div>
    <div class="sect1">
        <div class="titlepage">
            <div>
                <div>
                    <h2 class="title" id="_exercises_6" style="clear: both">Exercises</h2>
                </div>
            </div>
        </div>
        <p>There’s really only one exercise for this chapter, and it requires refactoring some code to use a <code class="literal">CompletableFuture</code>. We’ll start outwith the <code class="literal">BlockingArtistAnalyzer</code> class shown in <a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#BlockingArtistAnalyser">Example 9-18</a>. This class takes the names of two artists, looks up the <code class="literal">Artist</code> objects from
            the names, and returns <code class="literal">true</code> if the first artist has more members and <code class="literal">false</code> otherwise. It is injected with an <code class="literal">artistLookupService</code> that may take some time
            to look upthe <code class="literal">Artist</code> in question. Because <code class="literal">BlockingArtistAnalyzer</code> blocks on this servicetwice sequentially, the analyzer can be slow; the goal of our exercise is tospeed it up.</p>
        <div class="example"><a id="10_BlockingArtistAnalyser"></a>
            <div class="example-title">Example 9-18. The BlockingArtistAnalyzer tells its clients which Artist has more members</div>
            <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">class</span> <span style="text-decoration:underline">BlockingArtistAnalyzer</span> {
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">final</span> <span style="color:#00f;font-weight:700">Function</span> <span style="color:#00f;font-weight:700">&lt;</span> <span style="color:#00f;font-weight:700">String</span>,
    <span style="color:#00f;font-weight:700">Artist</span> <span style="color:#00f;font-weight:700">&gt;</span> artistLookupService;
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#0000a2;font-weight:700">BlockingArtistAnalyzer</span>(<span style="color:#00f;font-weight:700">Function</span> &lt; <span style="color:#00f;font-weight:700">String</span>, <span style="color:#00f;font-weight:700">Artist</span> &gt; <span style="font-style:italic">artistLookupService</span>) {
        <span style="color:#318495">this</span><span style="color:#00f;font-weight:700">.</span>artistLookupService <span style="color:#00f;font-weight:700">=</span> artistLookupService;
    }
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">boolean</span> <span style="color:#0000a2;font-weight:700">isLargerGroup</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">artistName</span>, <span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">otherArtistName</span>) {
        <span style="color:#00f;font-weight:700">return</span> getNumberOfMembers(artistName) <span style="color:#00f;font-weight:700">&gt;</span> getNumberOfMembers(otherArtistName);
    }
    <span style="color:#00f;font-weight:700">private</span> <span style="color:#00f;font-weight:700">long</span> <span style="color:#0000a2;font-weight:700">getNumberOfMembers</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">artistName</span>) {
        <span style="color:#00f;font-weight:700">return</span> artistLookupService<span style="color:#00f;font-weight:700">.</span>apply(artistName)<span style="color:#00f;font-weight:700">.</span>getMembers()<span style="color:#00f;font-weight:700">.</span>count();
    }
}
</pre>            </div>
    </div>
    <p>The first part of this exercise is to refactor the blocking return code to usea callback interface. In this case, we’ll be using a <code class="literal">Consumer&lt;Boolean&gt;</code>.Remember that <code class="literal">Consumer</code> is a functional
        interface that ships with the JVM thataccepts a value and returns <code class="literal">void</code>. Your mission, should you choose to accept it,is to alter <code class="literal">BlockingArtistAnalyzer</code> so that it implements <code class="literal">ArtistAnalyzer</code>        (<a class="xref" href="https://learning.oreilly.com/library/view/java-8-lambdas/9781449370831/ch09.html#ArtistAnalyser">Example 9-19</a>).</p>
    <div class="example"><a id="10_ArtistAnalyser"></a>
        <div class="example-title">Example 9-19. The ArtistAnalyzer that you need to make BlockingArtistAnalyzer implement</div>
        <div class="example-contents">
<pre style="background:#fff;color:#000"><span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">interface</span> <span style="text-decoration:underline">ArtistAnalyzer</span> {
    <span style="color:#00f;font-weight:700">public</span> <span style="color:#00f;font-weight:700">void</span> <span style="color:#0000a2;font-weight:700">isLargerGroup</span>(<span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">artistName</span>, <span style="color:#00f;font-weight:700">String</span> <span style="font-style:italic">otherArtistName</span>, <span style="color:#00f;font-weight:700">Consumer</span> &lt; <span style="color:#00f;font-weight:700">Boolean</span> &gt; <span style="font-style:italic">handler</span>);
}
</pre>
        </div>
    </div>
    <p>Now that we have an API that fits into the callback model, we can remove the needfor both of the blocking lookups to happen at the same time. You should refactor the<code class="literal">isLargerGroup</code> method so that they can operate concurrently
        using the <code class="literal">CompletableFuture</code>class.</p>
    </div>
    </section>
    <div class="annotator-outer annotator-viewer viewer annotator-hide"> </div>
    </div>
    </div>
    </section>
    </div>
    </div>
    <div class="font-flyout"></div>



<hr/>
<!--if IE]><![endif]-->

<!--if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"            itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"data-offline-url="/"data-url="/library/view/java-8-lambdas/9781449370831/ch10.html"data-csrf-cookie="csrfsafari"data-highlight-privacy=""  data-user-id="3866890"  data-user-uuid="72b95c3c-5b13-4319-82fa-5c73754754ca"  data-username="levinxccai"  data-account-type="B2B"    data-activated-trial-date="11/06/2017"  data-archive="9781449370831"  data-publishers="O&#39;Reilly Media, Inc."  data-htmlfile-name="ch10.html"  data-epub-title="Java 8 Lambdas" data-debug=0 data-testing=0><![endif]-->
<!--if gt IE 8]><!-->

<!--![endif]-->




<a name="11_"></a>

    <div class="application" id="container" style="height: auto;">
        <div class="js-toc">
            <section role="document">
                <div id="sbo-rt-content" style="max-width:72.5em; transform: none;">
                    <div class="annotator-wrapper">
                        <section class="chapter" epub:type="chapter" id="_moving_forward">
                            <div class="titlepage">
                                <div>
                                    <div>
                                        <h2 class="title">Chapter 10. Moving Forward</h2>
                                    </div>
                                </div>
                            </div>
                            <p>In many ways, Java as a language has stood the test of time well. It’s still anincredibly popular platform and a good choice for developing enterprisebusiness software. A vast array of open source libraries and frameworks havebeen
                                developed, solving every problem from how to write a modular and complex webapplication<a class="indexterm" id="11_id432358"></a> (Spring) right down to getting basic date and time arithmetic right<a class="indexterm" id="11_id432375"></a>(Jodatime).
                                The tooling in space from IDEs such as<a class="indexterm" id="11_id432384"></a><a class="indexterm" id="11_id432381"></a> Eclipse and Intellij rightthrough to build systems like<a class="indexterm" id="11_id432398"></a><a class="indexterm" id="11_id432395"></a><a class="indexterm" id="11_id432404"></a> gradle and maven is unrivaled.</p>
                            <p>Unfortunately, over the years Java has acquired a bit of a reputation as a staid development choice that has failed to evolve with the times, in part because it has been popular for a long period of time; familiarity breeds
                                contempt. And of course, there have been genuine issues around the evolution of Java. The decision to maintain backward compatibility, despite its benefits, has complicated this.</p>
                            <p><a class="indexterm" id="11_id432418"></a><a class="indexterm" id="11_id432425"></a>Fortunately, the arrival of Java 8 signals not just an incremental improvementin the language but a step change in its development. Unlike Java 6
                                and 7, thisrelease doesn’t equate to a few minor library improvements. I fully expect andhope that future releases of Java will continue the rapid pace of improvement seen withJava 8. That’s not just because I’ve enjoyed
                                writing a book on the topic! Ireally do think that there is a long way to go in terms of improving thefundamental task of programming: making code easier to read, clarifying itsintent, making it easier to write high-performance
                                code. My only regret is thatthere isn’t enough space in this concluding chapter to detail the fullpotential of future releases.</p>
                            <p>We’re nearing the end of this book, but I hope we’re not nearing the end ofyour time with Java 8. I’ve covered a bunch of different ways you can uselambda expressions: better collections library code, data parallelism,simpler
                                and cleaner code, and finally concurrency. I’ve explained thewhy, what, and how, but it is still up to you to put everything into practice.In this spirit, here is a series of open exercises to which there are no rightand
                                wrong answers. Undertaking them can help guide your ongoing learningexperience:</p>
                            <div class="itemizedlist">
                                <ul class="itemizedlist">
                                    <li class="listitem">Explain what lambda expressions are and why they should be of interest to another programmer. This could be a friend or a coworker.</li>
                                    <li class="listitem">Start a trial deployment of your work product on Java 8. If you’ve already got your unit tests running under the<a class="indexterm" id="11_id432507"></a> Jenkins CI system, then it’s <a class="ulink" href="http://bit.ly/1gCKWPl" target="_top">very easy</a> to run the same build under multiple Java versions.</li>
                                    <li class="listitem">Start refactoring a bit of legacy code in a real product to use streams and collectors. This could be an open source project you’re interested in or maybe even your work product if the trial deployment went well. If
                                        you aren’t ready to move wholesale, then perhaps prototyping things on a different branch is a good way to start.</li>
                                    <li class="listitem">Do you have any concurrency problems or large-scale data-processing code? If so, try to prototype a refactor in order to use either streams for data parallelism or some of the new concurrency features in<a class="indexterm" id="11_id432514"></a><a class="indexterm" id="11_id432538"></a> RxJava or <code class="literal">CompletableFuture</code>.</li>
                                    <li class="listitem">
                                        <p class="simpara">Have a look at the design and architecture of a code base you know really well:</p>
                                        <div class="itemizedlist">
                                            <ul class="itemizedlist">
                                                <li class="listitem">Could it be implemented better at a macro level?</li>
                                                <li class="listitem">Can you simplify the design?</li>
                                                <li class="listitem">Can you reduce the amount of code needed to implement a feature?</li>
                                                <li class="listitem">Can the code be made easier to read?</li>
                                            </ul>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </section>
                    </div>
                </div>
            </section>
        </div>
    </div>
</body>

</html>